(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{bAoC:function(e,t,o){"use strict";o.r(t),o.d(t,"TechniquesModule",(function(){return V}));var n=o("ofXK"),s=o("tyNb"),c=o("PCNd"),a=o("Ydvz"),r=o("fXoL"),l=o("zg9e"),i=o("FKbk"),b=o("zdH2"),d=o("CquY"),p=o("xE8d");let u=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return h(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-authentication"]],features:[r.tb],decls:1140,vars:122,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/authentication.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","authentication"],["rel","nofollow","target","_blank","href","https://github.com/jaredhanson/passport"],["rel","nofollow","target","_blank","href","https://jwt.io/"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/session"],["rel","nofollow","target","_blank","href","http://www.passportjs.org/packages/"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/19-auth-jwt"],["appAnchor","","id","authentication-requirements"],["rel","nofollow","target","_blank","href","https://tools.ietf.org/html/rfc6750"],["rel","nofollow","target","_blank","href","https://github.com/jaredhanson/passport-local"],[1,"language-bash"],[1,"warning"],["appAnchor","","id","implementing-passport-strategies"],[1,"filename"],["app46791e540535b7b3465c9fb3b5b036fc89902eb0",""],[1,"language-typescript"],["appcabd9d7303c9f61c7ca4d7d0c79898b67a1e51d5",""],["appc0d3af50797d73d3d1f7d140e4950cdb304ccc01",""],[1,"Warning"],["rel","nofollow","target","_blank","href","https://github.com/kelektiv/node.bcrypt.js#readme"],["app97ea6f7c51a17dbd8dfaad1c897dc733c2edee4e",""],["appAnchor","","id","implementing-passport-local"],["appdc7726f2afbda3138295c393a28f4f255487bda2",""],[1,"info"],["rel","nofollow","target","_blank","href","http://www.passportjs.org/docs/configure/"],["href","exception-filters"],["appc3cf83877ee85e2765e8fef7e8a815cc87453ced",""],["appAnchor","","id","built-in-passport-guards"],["href","guards"],["appAnchor","","id","login-route"],["appf79017d962b75a658a62b6e04d956aa4dfba0491",""],["rel","nofollow","target","_blank","href","https://curl.haxx.se/"],["app228233317b3a8e2dfed5f437200fe2d7589ce039",""],["appAnchor","","id","jwt-functionality"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/jwt"],["appfc9364ea08c61279c958023387cf12e6fc193062",""],["app54b9f1a65ab83f9124d6d2000e5754fe63e69b76",""],["appca44f4a2cf848c68ab77404f3f69f54d2a7a1bf1",""],["rel","nofollow","target","_blank","href","https://github.com/nestjs/jwt/blob/master/README.md"],["rel","nofollow","target","_blank","href","https://github.com/auth0/node-jsonwebtoken#usage"],["app52c7ac48ce67026b134335cd08f38bdbb27170e7",""],["appAnchor","","id","implementing-passport-jwt"],["rel","nofollow","target","_blank","href","https://github.com/mikenicholson/passport-jwt"],["app5cf78215feba04aa5e92f1cf3f8fd5f1d4f73e8c",""],["rel","nofollow","target","_blank","href","https://github.com/mikenicholson/passport-jwt#configure-strategy"],["rel","nofollow","target","_blank","href","https://github.com/mikenicholson/passport-jwt#extracting-the-jwt-from-the-request"],["appc57ea19fc2360e3e0a3f305d44015acfbbaa5e49",""],["appfb44a8310ca88891e1d35358c493b6dec5c6c084",""],["appAnchor","","id","implement-protected-route-and-jwt-strategy-guards"],["app36fb5c0ab1694f4db7da7a54e6af0e5fd4ad23ac",""],["appAnchor","","id","default-strategy"],["appAnchor","","id","request-scoped-strategies"],["routerLink","/fundamentals/injection-scopes"],["routerLink","/fundamentals/module-ref"],["href","/fundamentals/module-ref#getting-current-sub-tree"],["appAnchor","","id","extending-guards"],["appAnchor","","id","customize-passport"],["rel","nofollow","target","_blank","href","http://www.passportjs.org/docs/oauth/"],["appAnchor","","id","named-strategies"],["appAnchor","","id","graphql"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/graphql/quick-start"]],template:function(e,t){if(1&e){r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"Authentication"),r.Hb(),r.Ib(7,"p"),r.lc(8,"Authentication is an "),r.Ib(9,"strong"),r.lc(10,"essential"),r.Hb(),r.lc(11," part of most applications. There are many different approaches and strategies to handle authentication. The approach taken for any project depends on its particular application requirements. This chapter presents several approaches to authentication that can be adapted to a variety of different requirements."),r.Hb(),r.Ib(12,"p"),r.Ib(13,"a",6),r.lc(14,"Passport"),r.Hb(),r.lc(15," is the most popular node.js authentication library, well-known by the community and successfully used in many production applications. It's straightforward to integrate this library with a "),r.Ib(16,"strong"),r.lc(17,"Nest"),r.Hb(),r.lc(18," application using the "),r.Ib(19,"code"),r.lc(20,"@nestjs/passport"),r.Hb(),r.lc(21," module. At a high level, Passport executes a series of steps to:"),r.Hb(),r.Ib(22,"ul"),r.Ib(23,"li"),r.lc(24,'Authenticate a user by verifying their "credentials" (such as username/password, JSON Web Token ('),r.Ib(25,"a",7),r.lc(26,"JWT"),r.Hb(),r.lc(27,"), or identity token from an Identity Provider)"),r.Hb(),r.Ib(28,"li"),r.lc(29,"Manage authenticated state (by issuing a portable token, such as a JWT, or creating an "),r.Ib(30,"a",8),r.lc(31,"Express session"),r.Hb(),r.lc(32,")"),r.Hb(),r.Ib(33,"li"),r.lc(34,"Attach information about the authenticated user to the "),r.Ib(35,"code"),r.lc(36,"Request"),r.Hb(),r.lc(37," object for further use in route handlers"),r.Hb(),r.Hb(),r.Ib(38,"p"),r.lc(39,"Passport has a rich ecosystem of "),r.Ib(40,"a",9),r.lc(41,"strategies"),r.Hb(),r.lc(42," that implement various authentication mechanisms. While simple in concept, the set of Passport strategies you can choose from is large and presents a lot of variety. Passport abstracts these varied steps into a standard pattern, and the "),r.Ib(43,"code"),r.lc(44,"@nestjs/passport"),r.Hb(),r.lc(45," module wraps and standardizes this pattern into familiar Nest constructs."),r.Hb(),r.Ib(46,"p"),r.lc(47,"In this chapter, we'll implement a complete end-to-end authentication solution for a RESTful API server using these powerful and flexible modules. You can use the concepts described here to implement any Passport strategy to customize your authentication scheme. You can follow the steps in this chapter to build this complete example. You can find a repository with a completed sample app "),r.Ib(48,"a",10),r.lc(49,"here"),r.Hb(),r.lc(50,"."),r.Hb(),r.Ib(51,"h4",11),r.Ib(52,"span"),r.lc(53,"Authentication requirements"),r.Hb(),r.Hb(),r.Ib(54,"p"),r.lc(55,"Let's flesh out our requirements. For this use case, clients will start by authenticating with a username and password. Once authenticated, the server will issue a JWT that can be sent as a "),r.Ib(56,"a",12),r.lc(57,"bearer token in an authorization header"),r.Hb(),r.lc(58," on subsequent requests to prove authentication. We'll also create a protected route that is accessible only to requests that contain a valid JWT."),r.Hb(),r.Ib(59,"p"),r.lc(60,"We'll start with the first requirement: authenticating a user. We'll then extend that by issuing a JWT. Finally, we'll create a protected route that checks for a valid JWT on the request."),r.Hb(),r.Ib(61,"p"),r.lc(62,"First we need to install the required packages. Passport provides a strategy called "),r.Ib(63,"a",13),r.lc(64,"passport-local"),r.Hb(),r.lc(65," that implements a username/password authentication mechanism, which suits our needs for this portion of our use case."),r.Hb(),r.Ib(66,"pre"),r.Ib(67,"code",14),r.lc(68,"\n$ npm install --save @nestjs/passport passport passport-local\n$ npm install --save-dev @types/passport-local"),r.Hb(),r.Hb(),r.Ib(69,"blockquote",15),r.Ib(70,"strong"),r.lc(71,"Notice"),r.Hb(),r.lc(72," For "),r.Ib(73,"strong"),r.lc(74,"any"),r.Hb(),r.lc(75," Passport strategy you choose, you'll always need the "),r.Ib(76,"code"),r.lc(77,"@nestjs/passport"),r.Hb(),r.lc(78," and "),r.Ib(79,"code"),r.lc(80,"passport"),r.Hb(),r.lc(81," packages. Then, you'll need to install the strategy-specific package (e.g., "),r.Ib(82,"code"),r.lc(83,"passport-jwt"),r.Hb(),r.lc(84," or "),r.Ib(85,"code"),r.lc(86,"passport-local"),r.Hb(),r.lc(87,") that implements the particular authentication strategy you are building. In addition, you can also install the type definitions for any Passport strategy, as show above with "),r.Ib(88,"code"),r.lc(89,"@types/passport-local"),r.Hb(),r.lc(90,", which provides assistance while writing TypeScript code.\n"),r.Hb(),r.Ib(91,"h4",16),r.Ib(92,"span"),r.lc(93,"Implementing Passport strategies"),r.Hb(),r.Hb(),r.Ib(94,"p"),r.lc(95,"We're now ready to implement the authentication feature. We'll start with an overview of the process used for "),r.Ib(96,"strong"),r.lc(97,"any"),r.Hb(),r.lc(98," Passport strategy. It's helpful to think of Passport as a mini framework in itself. The elegance of the framework is that it abstracts the authentication process into a few basic steps that you customize based on the strategy you're implementing. It's like a framework because you configure it by supplying customization parameters (as plain JSON objects) and custom code in the form of callback functions, which Passport calls at the appropriate time. The "),r.Ib(99,"code"),r.lc(100,"@nestjs/passport"),r.Hb(),r.lc(101," module wraps this framework in a Nest style package, making it easy to integrate into a Nest application. We'll use "),r.Ib(102,"code"),r.lc(103,"@nestjs/passport"),r.Hb(),r.lc(104," below, but first let's consider how "),r.Ib(105,"strong"),r.lc(106,"vanilla Passport"),r.Hb(),r.lc(107," works."),r.Hb(),r.Ib(108,"p"),r.lc(109,"In vanilla Passport, you configure a strategy by providing two things:"),r.Hb(),r.Ib(110,"ol"),r.Ib(111,"li"),r.lc(112,"A set of options that are specific to that strategy. For example, in a JWT strategy, you might provide a secret to sign tokens."),r.Hb(),r.Ib(113,"li"),r.lc(114,'A "verify callback", which is where you tell Passport how to interact with your user store (where you manage user accounts). Here, you verify whether a user exists (and/or create a new user), and whether their credentials are valid. The Passport library expects this callback to return a full user if the validation succeeds, or a null if it fails (failure is defined as either the user is not found, or, in the case of passport-local, the password does not match).'),r.Hb(),r.Hb(),r.Ib(115,"p"),r.lc(116,"With "),r.Ib(117,"code"),r.lc(118,"@nestjs/passport"),r.Hb(),r.lc(119,", you configure a Passport strategy by extending the "),r.Ib(120,"code"),r.lc(121,"PassportStrategy"),r.Hb(),r.lc(122," class. You pass the strategy options (item 1 above) by calling the "),r.Ib(123,"code"),r.lc(124,"super()"),r.Hb(),r.lc(125," method in your subclass, optionally passing in an options object. You provide the verify callback (item 2 above) by implementing a "),r.Ib(126,"code"),r.lc(127,"validate()"),r.Hb(),r.lc(128," method in your subclass."),r.Hb(),r.Ib(129,"p"),r.lc(130,"We'll start by generating an "),r.Ib(131,"code"),r.lc(132,"AuthModule"),r.Hb(),r.lc(133," and in it, an "),r.Ib(134,"code"),r.lc(135,"AuthService"),r.Hb(),r.lc(136,":"),r.Hb(),r.Ib(137,"pre"),r.Ib(138,"code",14),r.lc(139,"\n$ nest g module auth\n$ nest g service auth"),r.Hb(),r.Hb(),r.Ib(140,"p"),r.lc(141,"As we implement the "),r.Ib(142,"code"),r.lc(143,"AuthService"),r.Hb(),r.lc(144,", we'll find it useful to encapsulate user operations in a "),r.Ib(145,"code"),r.lc(146,"UsersService"),r.Hb(),r.lc(147,", so let's generate that module and service now:"),r.Hb(),r.Ib(148,"pre"),r.Ib(149,"code",14),r.lc(150,"\n$ nest g module users\n$ nest g service users"),r.Hb(),r.Hb(),r.Ib(151,"p"),r.lc(152,"Replace the default contents of these generated files as shown below. For our sample app, the "),r.Ib(153,"code"),r.lc(154,"UsersService"),r.Hb(),r.lc(155," simply maintains a hard-coded in-memory list of users, and a find method to retrieve one by username. In a real app, this is where you'd build your user model and persistence layer, using your library of choice (e.g., TypeORM, Sequelize, Mongoose, etc.)."),r.Hb(),r.Ib(156,"span",17),r.lc(157),r.Ub(158,"extension"),r.Gb(159,"app-tabs",null,18),r.Hb(),r.Ib(161,"pre"),r.Ib(162,"code",19),r.lc(163,"\nimport { Injectable } from '@nestjs/common';\n\nexport type User = any;\n\n@Injectable()\nexport class UsersService {\n  private readonly users: User[];\n\n  constructor() {\n    this.users = [\n      {\n        userId: 1,\n        username: 'john',\n        password: 'changeme',\n      },\n      {\n        userId: 2,\n        username: 'chris',\n        password: 'secret',\n      },\n      {\n        userId: 3,\n        username: 'maria',\n        password: 'guess',\n      },\n    ];\n  }\n\n  async findOne(username: string): Promise<User | undefined> {\n    return this.users.find(user => user.username === username);\n  }\n}"),r.Hb(),r.Hb(),r.Ib(164,"pre"),r.Ib(165,"code",19),r.lc(166,"\nimport { Injectable } from '@nestjs/common';\n\n@Injectable()\nexport class UsersService {\n  constructor() {\n    this.users = [\n      {\n        userId: 1,\n        username: 'john',\n        password: 'changeme',\n      },\n      {\n        userId: 2,\n        username: 'chris',\n        password: 'secret',\n      },\n      {\n        userId: 3,\n        username: 'maria',\n        password: 'guess',\n      },\n    ];\n  }\n\n  async findOne(username) {\n    return this.users.find(user => user.username === username);\n  }\n}"),r.Hb(),r.Hb(),r.Ib(167,"p"),r.lc(168,"In the "),r.Ib(169,"code"),r.lc(170,"UsersModule"),r.Hb(),r.lc(171,", the only change needed is to add the "),r.Ib(172,"code"),r.lc(173,"UsersService"),r.Hb(),r.lc(174," to the exports array of the "),r.Ib(175,"code"),r.lc(176,"@Module"),r.Hb(),r.lc(177," decorator so that it is visible outside this module (we'll soon use it in our "),r.Ib(178,"code"),r.lc(179,"AuthService"),r.Hb(),r.lc(180,")."),r.Hb(),r.Ib(181,"span",17),r.lc(182),r.Ub(183,"extension"),r.Gb(184,"app-tabs",null,20),r.Hb(),r.Ib(186,"pre"),r.Ib(187,"code",19),r.lc(188,"\nimport { Module } from '@nestjs/common';\nimport { UsersService } from './users.service';\n\n@Module({\n  providers: [UsersService],\n  exports: [UsersService],\n})\nexport class UsersModule {}"),r.Hb(),r.Hb(),r.Ib(189,"pre"),r.Ib(190,"code",19),r.lc(191,"\nimport { Module } from '@nestjs/common';\nimport { UsersService } from './users.service';\n\n@Module({\n  providers: [UsersService],\n  exports: [UsersService],\n})\nexport class UsersModule {}"),r.Hb(),r.Hb(),r.Ib(192,"p"),r.lc(193,"Our "),r.Ib(194,"code"),r.lc(195,"AuthService"),r.Hb(),r.lc(196," has the job of retrieving a user and verifying the password. We create a "),r.Ib(197,"code"),r.lc(198,"validateUser()"),r.Hb(),r.lc(199," method for this purpose. In the code below, we use a convenient ES6 spread operator to strip the password property from the user object before returning it. We'll be calling into the "),r.Ib(200,"code"),r.lc(201,"validateUser()"),r.Hb(),r.lc(202," method from our Passport local strategy in a moment."),r.Hb(),r.Ib(203,"span",17),r.lc(204),r.Ub(205,"extension"),r.Gb(206,"app-tabs",null,21),r.Hb(),r.Ib(208,"pre"),r.Ib(209,"code",19),r.lc(210,"\nimport { Injectable } from '@nestjs/common';\nimport { UsersService } from '../users/users.service';\n\n@Injectable()\nexport class AuthService {\n  constructor(private usersService: UsersService) {}\n\n  async validateUser(username: string, pass: string): Promise<any> {\n    const user = await this.usersService.findOne(username);\n    if (user && user.password === pass) {\n      const { password, ...result } = user;\n      return result;\n    }\n    return null;\n  }\n}"),r.Hb(),r.Hb(),r.Ib(211,"pre"),r.Ib(212,"code",19),r.lc(213,"\nimport { Injectable, Dependencies } from '@nestjs/common';\nimport { UsersService } from '../users/users.service';\n\n@Injectable()\n@Dependencies(UsersService)\nexport class AuthService {\n  constructor(usersService) {\n    this.usersService = usersService;\n  }\n\n  async validateUser(username, pass) {\n    const user = await this.usersService.findOne(username);\n    if (user && user.password === pass) {\n      const { password, ...result } = user;\n      return result;\n    }\n    return null;\n  }\n}"),r.Hb(),r.Hb(),r.Ib(214,"blockquote",22),r.Ib(215,"strong"),r.lc(216,"Warning"),r.Hb(),r.lc(217," Of course in a real application, you wouldn't store a password in plain text. You'd instead use a library like "),r.Ib(218,"a",23),r.lc(219,"bcrypt"),r.Hb(),r.lc(220,", with a salted one-way hash algorithm. With that approach, you'd only store hashed passwords, and then compare the stored password to a hashed version of the "),r.Ib(221,"strong"),r.lc(222,"incoming"),r.Hb(),r.lc(223," password, thus never storing or exposing user passwords in plain text. To keep our sample app simple, we violate that absolute mandate and use plain text. "),r.Ib(224,"strong"),r.lc(225,"Don't do this in your real app!"),r.Hb(),r.Hb(),r.Ib(226,"p"),r.lc(227,"Now, we update our "),r.Ib(228,"code"),r.lc(229,"AuthModule"),r.Hb(),r.lc(230," to import the "),r.Ib(231,"code"),r.lc(232,"UsersModule"),r.Hb(),r.lc(233,"."),r.Hb(),r.Ib(234,"span",17),r.lc(235),r.Ub(236,"extension"),r.Gb(237,"app-tabs",null,24),r.Hb(),r.Ib(239,"pre"),r.Ib(240,"code",19),r.lc(241,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { UsersModule } from '../users/users.module';\n\n@Module({\n  imports: [UsersModule],\n  providers: [AuthService],\n})\nexport class AuthModule {}"),r.Hb(),r.Hb(),r.Ib(242,"pre"),r.Ib(243,"code",19),r.lc(244,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { UsersModule } from '../users/users.module';\n\n@Module({\n  imports: [UsersModule],\n  providers: [AuthService],\n})\nexport class AuthModule {}"),r.Hb(),r.Hb(),r.Ib(245,"h4",25),r.Ib(246,"span"),r.lc(247,"Implementing Passport local"),r.Hb(),r.Hb(),r.Ib(248,"p"),r.lc(249,"Now we can implement our Passport "),r.Ib(250,"strong"),r.lc(251,"local authentication strategy"),r.Hb(),r.lc(252,". Create a file called "),r.Ib(253,"code"),r.lc(254,"local.strategy.ts"),r.Hb(),r.lc(255," in the "),r.Ib(256,"code"),r.lc(257,"auth"),r.Hb(),r.lc(258," folder, and add the following code:"),r.Hb(),r.Ib(259,"span",17),r.lc(260),r.Ub(261,"extension"),r.Gb(262,"app-tabs",null,26),r.Hb(),r.Ib(264,"pre"),r.Ib(265,"code",19),r.lc(266,"\nimport { Strategy } from 'passport-local';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { AuthService } from './auth.service';\n\n@Injectable()\nexport class LocalStrategy extends PassportStrategy(Strategy) {\n  constructor(private authService: AuthService) {\n    super();\n  }\n\n  async validate(username: string, password: string): Promise<any> {\n    const user = await this.authService.validateUser(username, password);\n    if (!user) {\n      throw new UnauthorizedException();\n    }\n    return user;\n  }\n}"),r.Hb(),r.Hb(),r.Ib(267,"pre"),r.Ib(268,"code",19),r.lc(269,"\nimport { Strategy } from 'passport-local';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { Injectable, UnauthorizedException, Dependencies } from '@nestjs/common';\nimport { AuthService } from './auth.service';\n\n@Injectable()\n@Dependencies(AuthService)\nexport class LocalStrategy extends PassportStrategy(Strategy) {\n  constructor(authService) {\n    this.authService = authService\n    super();\n  }\n\n  async validate(username, password) {\n    const user = await this.authService.validateUser(username, password);\n    if (!user) {\n      throw new UnauthorizedException();\n    }\n    return user;\n  }\n}"),r.Hb(),r.Hb(),r.Ib(270,"p"),r.lc(271,"We've followed the recipe described earlier for all Passport strategies. In our use case with passport-local, there are no configuration options, so our constructor simply calls "),r.Ib(272,"code"),r.lc(273,"super()"),r.Hb(),r.lc(274,", without an options object."),r.Hb(),r.Ib(275,"blockquote",27),r.Ib(276,"strong"),r.lc(277,"Hint"),r.Hb(),r.lc(278," We can pass an options object in the call to "),r.Ib(279,"code"),r.lc(280,"super()"),r.Hb(),r.lc(281," to customize the behavior of the passport strategy. In this example, the passport-local strategy by default expects properties called "),r.Ib(282,"code"),r.lc(283,"username"),r.Hb(),r.lc(284," and "),r.Ib(285,"code"),r.lc(286,"password"),r.Hb(),r.lc(287," in the request body. Pass an options object to specify different property names, for example: "),r.Ib(288,"code"),r.lc(289),r.Hb(),r.lc(290,". See the "),r.Ib(291,"a",28),r.lc(292,"Passport documentation"),r.Hb(),r.lc(293," for more information.\n"),r.Hb(),r.Ib(294,"p"),r.lc(295,"We've also implemented the "),r.Ib(296,"code"),r.lc(297,"validate()"),r.Hb(),r.lc(298," method. For each strategy, Passport will call the verify function (implemented with the "),r.Ib(299,"code"),r.lc(300,"validate()"),r.Hb(),r.lc(301," method in "),r.Ib(302,"code"),r.lc(303,"@nestjs/passport"),r.Hb(),r.lc(304,") using an appropriate strategy-specific set of parameters. For the local-strategy, Passport expects a "),r.Ib(305,"code"),r.lc(306,"validate()"),r.Hb(),r.lc(307," method with the following signature: "),r.Ib(308,"code"),r.lc(309,"validate(username: string, password:string): any"),r.Hb(),r.lc(310,"."),r.Hb(),r.Ib(311,"p"),r.lc(312,"Most of the validation work is done in our "),r.Ib(313,"code"),r.lc(314,"AuthService"),r.Hb(),r.lc(315," (with the help of our "),r.Ib(316,"code"),r.lc(317,"UsersService"),r.Hb(),r.lc(318,"), so this method is quite straightforward. The "),r.Ib(319,"code"),r.lc(320,"validate()"),r.Hb(),r.lc(321," method for "),r.Ib(322,"strong"),r.lc(323,"any"),r.Hb(),r.lc(324," Passport strategy will follow a similar pattern, varying only in the details of how credentials are represented. If a user is found and the credentials are valid, the user is returned so Passport can complete its tasks (e.g., creating the "),r.Ib(325,"code"),r.lc(326,"user"),r.Hb(),r.lc(327," property on the "),r.Ib(328,"code"),r.lc(329,"Request"),r.Hb(),r.lc(330," object), and the request handling pipeline can continue. If it's not found, we throw an exception and let our "),r.Ib(331,"a",29),r.lc(332,"exceptions layer"),r.Hb(),r.lc(333," handle it."),r.Hb(),r.Ib(334,"p"),r.lc(335,"Typically, the only significant difference in the "),r.Ib(336,"code"),r.lc(337,"validate()"),r.Hb(),r.lc(338," method for each strategy is "),r.Ib(339,"strong"),r.lc(340,"how"),r.Hb(),r.lc(341," you determine if a user exists and is valid. For example, in a JWT strategy, depending on requirements, we may evaluate whether the "),r.Ib(342,"code"),r.lc(343,"userId"),r.Hb(),r.lc(344," carried in the decoded token matches a record in our user database, or matches a list of revoked tokens. Hence, this pattern of sub-classing and implementing strategy-specific validation is consistent, elegant and extensible."),r.Hb(),r.Ib(345,"p"),r.lc(346,"We need to configure our "),r.Ib(347,"code"),r.lc(348,"AuthModule"),r.Hb(),r.lc(349," to use the Passport features we just defined. Update "),r.Ib(350,"code"),r.lc(351,"auth.module.ts"),r.Hb(),r.lc(352," to look like this:"),r.Hb(),r.Ib(353,"span",17),r.lc(354),r.Ub(355,"extension"),r.Gb(356,"app-tabs",null,30),r.Hb(),r.Ib(358,"pre"),r.Ib(359,"code",19),r.lc(360,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { UsersModule } from '../users/users.module';\nimport { PassportModule } from '@nestjs/passport';\nimport { LocalStrategy } from './local.strategy';\n\n@Module({\n  imports: [UsersModule, PassportModule],\n  providers: [AuthService, LocalStrategy],\n})\nexport class AuthModule {}"),r.Hb(),r.Hb(),r.Ib(361,"pre"),r.Ib(362,"code",19),r.lc(363,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { UsersModule } from '../users/users.module';\nimport { PassportModule } from '@nestjs/passport';\nimport { LocalStrategy } from './local.strategy';\n\n@Module({\n  imports: [UsersModule, PassportModule],\n  providers: [AuthService, LocalStrategy],\n})\nexport class AuthModule {}"),r.Hb(),r.Hb(),r.Ib(364,"h4",31),r.Ib(365,"span"),r.lc(366,"Built-in Passport Guards"),r.Hb(),r.Hb(),r.Ib(367,"p"),r.lc(368,"The "),r.Ib(369,"a",32),r.lc(370,"Guards"),r.Hb(),r.lc(371," chapter describes the primary function of Guards: to determine whether a request will be handled by the route handler or not. That remains true, and we'll use that standard capability soon. However, in the context of using the "),r.Ib(372,"code"),r.lc(373,"@nestjs/passport"),r.Hb(),r.lc(374," module, we will also introduce a slight new wrinkle that may at first be confusing, so let's discuss that now. Consider that your app can exist in two states, from an authentication perspective:"),r.Hb(),r.Ib(375,"ol"),r.Ib(376,"li"),r.lc(377,"the user/client is "),r.Ib(378,"strong"),r.lc(379,"not"),r.Hb(),r.lc(380," logged in (is not authenticated)"),r.Hb(),r.Ib(381,"li"),r.lc(382,"the user/client "),r.Ib(383,"strong"),r.lc(384,"is"),r.Hb(),r.lc(385," logged in (is authenticated)"),r.Hb(),r.Hb(),r.Ib(386,"p"),r.lc(387,"In the first case (user is not logged in), we need to perform two distinct functions:"),r.Hb(),r.Ib(388,"ul"),r.Ib(389,"li"),r.Ib(390,"p"),r.lc(391,"Restrict the routes an unauthenticated user can access (i.e., deny access to restricted routes). We'll use Guards in their familiar capacity to handle this function, by placing a Guard on the protected routes. As you may anticipate, we'll be checking for the presence of a valid JWT in this Guard, so we'll work on this Guard later, once we are successfully issuing JWTs."),r.Hb(),r.Hb(),r.Ib(392,"li"),r.Ib(393,"p"),r.lc(394,"Initiate the "),r.Ib(395,"strong"),r.lc(396,"authentication step"),r.Hb(),r.lc(397," itself when a previously unauthenticated user attempts to login. This is the step where we'll "),r.Ib(398,"strong"),r.lc(399,"issue"),r.Hb(),r.lc(400," a JWT to a valid user. Thinking about this for a moment, we know we'll need to "),r.Ib(401,"code"),r.lc(402,"POST"),r.Hb(),r.lc(403," username/password credentials to initiate authentication, so we'll set up a "),r.Ib(404,"code"),r.lc(405,"POST /auth/login"),r.Hb(),r.lc(406," route to handle that. This raises the question: how exactly do we invoke the passport-local strategy in that route?"),r.Hb(),r.Hb(),r.Hb(),r.Ib(407,"p"),r.lc(408,"The answer is straightforward: by using another, slightly different type of Guard. The "),r.Ib(409,"code"),r.lc(410,"@nestjs/passport"),r.Hb(),r.lc(411," module provides us with a built-in Guard that does this for us. This Guard invokes the Passport strategy and kicks off the steps described above (retrieving credentials, running the verify function, creating the "),r.Ib(412,"code"),r.lc(413,"user"),r.Hb(),r.lc(414," property, etc)."),r.Hb(),r.Ib(415,"p"),r.lc(416,"The second case enumerated above (logged in user) simply relies on the standard type of Guard we already discussed to enable access to protected routes for logged in users."),r.Hb(),r.Ib(417,"p"),r.Gb(418,"app-banner-courses"),r.Hb(),r.Ib(419,"h4",33),r.Ib(420,"span"),r.lc(421,"Login route"),r.Hb(),r.Hb(),r.Ib(422,"p"),r.lc(423,"With the strategy in place, we can now implement a bare-bones "),r.Ib(424,"code"),r.lc(425,"/auth/login"),r.Hb(),r.lc(426," route, and apply the built-in Guard to initiate the passport-local flow."),r.Hb(),r.Ib(427,"p"),r.lc(428,"Open the "),r.Ib(429,"code"),r.lc(430,"app.controller.ts"),r.Hb(),r.lc(431," file and replace its contents with the following:"),r.Hb(),r.Ib(432,"span",17),r.lc(433),r.Ub(434,"extension"),r.Gb(435,"app-tabs",null,34),r.Hb(),r.Ib(437,"pre"),r.Ib(438,"code",19),r.lc(439,"\nimport { Controller, Request, Post, UseGuards } from '@nestjs/common';\nimport { AuthGuard } from '@nestjs/passport';\n\n@Controller()\nexport class AppController {\n  @UseGuards(AuthGuard('local'))\n  @Post('auth/login')\n  async login(@Request() req) {\n    return req.user;\n  }\n}"),r.Hb(),r.Hb(),r.Ib(440,"pre"),r.Ib(441,"code",19),r.lc(442,"\nimport { Controller, Bind, Request, Post, UseGuards } from '@nestjs/common';\nimport { AuthGuard } from '@nestjs/passport';\n\n@Controller()\nexport class AppController {\n  @UseGuards(AuthGuard('local'))\n  @Post('auth/login')\n  @Bind(Req())\n  async login(req) {\n    return req.user;\n  }\n}"),r.Hb(),r.Hb(),r.Ib(443,"p"),r.lc(444,"With "),r.Ib(445,"code"),r.lc(446,"@UseGuards(AuthGuard('local'))"),r.Hb(),r.lc(447," we are using an "),r.Ib(448,"code"),r.lc(449,"AuthGuard"),r.Hb(),r.lc(450," that "),r.Ib(451,"code"),r.lc(452,"@nestjs/passport"),r.Hb(),r.Ib(453,"strong"),r.lc(454,"automatically provisioned"),r.Hb(),r.lc(455," for us when we extended the passport-local strategy. Let's break that down. Our Passport local strategy has a default name of "),r.Ib(456,"code"),r.lc(457,"'local'"),r.Hb(),r.lc(458,". We reference that name in the "),r.Ib(459,"code"),r.lc(460,"@UseGuards()"),r.Hb(),r.lc(461," decorator to associate it with code supplied by the "),r.Ib(462,"code"),r.lc(463,"passport-local"),r.Hb(),r.lc(464," package. This is used to disambiguate which strategy to invoke in case we have multiple Passport strategies in our app (each of which may provision a strategy-specific "),r.Ib(465,"code"),r.lc(466,"AuthGuard"),r.Hb(),r.lc(467,"). While we only have one such strategy so far, we'll shortly add a second, so this is needed for disambiguation."),r.Hb(),r.Ib(468,"p"),r.lc(469,"In order to test our route we'll have our "),r.Ib(470,"code"),r.lc(471,"/auth/login"),r.Hb(),r.lc(472," route simply return the user for now. This also lets us demonstrate another Passport feature: Passport automatically creates a "),r.Ib(473,"code"),r.lc(474,"user"),r.Hb(),r.lc(475," object, based on the value we return from the "),r.Ib(476,"code"),r.lc(477,"validate()"),r.Hb(),r.lc(478," method, and assigns it to the "),r.Ib(479,"code"),r.lc(480,"Request"),r.Hb(),r.lc(481," object as "),r.Ib(482,"code"),r.lc(483,"req.user"),r.Hb(),r.lc(484,". Later, we'll replace this with code to create and return a JWT instead."),r.Hb(),r.Ib(485,"p"),r.lc(486,"Since these are API routes, we'll test them using the commonly available "),r.Ib(487,"a",35),r.lc(488,"cURL"),r.Hb(),r.lc(489," library. You can test with any of the "),r.Ib(490,"code"),r.lc(491,"user"),r.Hb(),r.lc(492," objects hard-coded in the "),r.Ib(493,"code"),r.lc(494,"UsersService"),r.Hb(),r.lc(495,"."),r.Hb(),r.Ib(496,"pre"),r.Ib(497,"code",14),r.lc(498,'\n$ # POST to /auth/login\n$ curl -X POST http://localhost:3000/auth/login -d \'{"username": "john", "password": "changeme"}\' -H "Content-Type: application/json"\n$ # result -> {"userId":1,"username":"john"}'),r.Hb(),r.Hb(),r.Ib(499,"p"),r.lc(500,"While this works, passing the strategy name directly to the "),r.Ib(501,"code"),r.lc(502,"AuthGuard()"),r.Hb(),r.lc(503," introduces magic strings in the codebase. Instead, we recommend creating your own class, as shown below:"),r.Hb(),r.Ib(504,"span",17),r.lc(505),r.Ub(506,"extension"),r.Gb(507,"app-tabs",null,36),r.Hb(),r.Ib(509,"pre"),r.Ib(510,"code",19),r.lc(511,"\nimport { Injectable } from '@nestjs/common';\nimport { AuthGuard } from '@nestjs/passport';\n\n@Injectable()\nexport class LocalAuthGuard extends AuthGuard('local') {}"),r.Hb(),r.Hb(),r.Ib(512,"p"),r.lc(513,"Now, we can update the "),r.Ib(514,"code"),r.lc(515,"/auth/login"),r.Hb(),r.lc(516," route handler and use the "),r.Ib(517,"code"),r.lc(518,"LocalAuthGuard"),r.Hb(),r.lc(519," instead:"),r.Hb(),r.Ib(520,"pre"),r.Ib(521,"code",19),r.lc(522,"\n@UseGuards(LocalAuthGuard)\n@Post('auth/login')\nasync login(@Request() req) {\n  return req.user;\n}"),r.Hb(),r.Hb(),r.Ib(523,"h4",37),r.Ib(524,"span"),r.lc(525,"JWT functionality"),r.Hb(),r.Hb(),r.Ib(526,"p"),r.lc(527,"We're ready to move on to the JWT portion of our auth system. Let's review and refine our requirements:"),r.Hb(),r.Ib(528,"ul"),r.Ib(529,"li"),r.lc(530,"Allow users to authenticate with username/password, returning a JWT for use in subsequent calls to protected API endpoints. We're well on our way to meeting this requirement. To complete it, we'll need to write the code that issues a JWT."),r.Hb(),r.Ib(531,"li"),r.lc(532,"Create API routes which are protected based on the presence of a valid JWT as a bearer token"),r.Hb(),r.Hb(),r.Ib(533,"p"),r.lc(534,"We'll need to install a couple more packages to support our JWT requirements:"),r.Hb(),r.Ib(535,"pre"),r.Ib(536,"code",14),r.lc(537,"\n$ npm install --save @nestjs/jwt passport-jwt\n$ npm install --save-dev @types/passport-jwt"),r.Hb(),r.Hb(),r.Ib(538,"p"),r.lc(539,"The "),r.Ib(540,"code"),r.lc(541,"@nestjs/jwt"),r.Hb(),r.lc(542," package (see more "),r.Ib(543,"a",38),r.lc(544,"here"),r.Hb(),r.lc(545,") is a utility package that helps with JWT manipulation. The "),r.Ib(546,"code"),r.lc(547,"passport-jwt"),r.Hb(),r.lc(548," package is the Passport package that implements the JWT strategy and "),r.Ib(549,"code"),r.lc(550,"@types/passport-jwt"),r.Hb(),r.lc(551," provides the TypeScript type definitions."),r.Hb(),r.Ib(552,"p"),r.lc(553,"Let's take a closer look at how a "),r.Ib(554,"code"),r.lc(555,"POST /auth/login"),r.Hb(),r.lc(556," request is handled. We've decorated the route using the built-in "),r.Ib(557,"code"),r.lc(558,"AuthGuard"),r.Hb(),r.lc(559," provided by the passport-local strategy. This means that:"),r.Hb(),r.Ib(560,"ol"),r.Ib(561,"li"),r.lc(562,"The route handler "),r.Ib(563,"strong"),r.lc(564,"will only be invoked if the user has been validated"),r.Hb(),r.Hb(),r.Ib(565,"li"),r.lc(566,"The "),r.Ib(567,"code"),r.lc(568,"req"),r.Hb(),r.lc(569," parameter will contain a "),r.Ib(570,"code"),r.lc(571,"user"),r.Hb();r.lc(572," property (populated by Passport during the passport-local authentication flow)"),r.Hb(),r.Hb(),r.Ib(573,"p"),r.lc(574,"With this in mind, we can now finally generate a real JWT, and return it in this route. To keep our services cleanly modularized, we'll handle generating the JWT in the "),r.Ib(575,"code"),r.lc(576,"authService"),r.Hb(),r.lc(577,". Open the "),r.Ib(578,"code"),r.lc(579,"auth.service.ts"),r.Hb(),r.lc(580," file in the "),r.Ib(581,"code"),r.lc(582,"auth"),r.Hb(),r.lc(583," folder, and add the "),r.Ib(584,"code"),r.lc(585,"login()"),r.Hb(),r.lc(586," method, and import the "),r.Ib(587,"code"),r.lc(588,"JwtService"),r.Hb(),r.lc(589," as shown:"),r.Hb(),r.Ib(590,"span",17),r.lc(591),r.Ub(592,"extension"),r.Gb(593,"app-tabs",null,39),r.Hb(),r.Ib(595,"pre"),r.Ib(596,"code",19),r.lc(597,"\nimport { Injectable } from '@nestjs/common';\nimport { UsersService } from '../users/users.service';\nimport { JwtService } from '@nestjs/jwt';\n\n@Injectable()\nexport class AuthService {\n  constructor(\n    private usersService: UsersService,\n    private jwtService: JwtService\n  ) {}\n\n  async validateUser(username: string, pass: string): Promise<any> {\n    const user = await this.usersService.findOne(username);\n    if (user && user.password === pass) {\n      const { password, ...result } = user;\n      return result;\n    }\n    return null;\n  }\n\n  async login(user: any) {\n    const payload = { username: user.username, sub: user.userId };\n    return {\n      access_token: this.jwtService.sign(payload),\n    };\n  }\n}"),r.Hb(),r.Hb(),r.Ib(598,"pre"),r.Ib(599,"code",19),r.lc(600,"\nimport { Injectable, Dependencies } from '@nestjs/common';\nimport { UsersService } from '../users/users.service';\nimport { JwtService } from '@nestjs/jwt';\n\n@Dependencies(UsersService, JwtService)\n@Injectable()\nexport class AuthService {\n  constructor(usersService, jwtService)\n  ) {\n    this.usersService = usersService;\n    this.jwtService = jwtService;\n  }\n\n  async validateUser(username, pass) {\n    const user = await this.usersService.findOne(username);\n    if (user && user.password === pass) {\n      const { password, ...result } = user;\n      return result;\n    }\n    return null;\n  }\n\n  async login(user) {\n    const payload = { username: user.username, sub: user.userId };\n    return {\n      access_token: this.jwtService.sign(payload),\n    };\n  }\n}"),r.Hb(),r.Hb(),r.Ib(601,"p"),r.lc(602,"We're using the "),r.Ib(603,"code"),r.lc(604,"@nestjs/jwt"),r.Hb(),r.lc(605," library, which supplies a "),r.Ib(606,"code"),r.lc(607,"sign()"),r.Hb(),r.lc(608," function to generate our JWT from a subset of the "),r.Ib(609,"code"),r.lc(610,"user"),r.Hb(),r.lc(611," object properties, which we then return as a simple object with a single "),r.Ib(612,"code"),r.lc(613,"access_token"),r.Hb(),r.lc(614," property. Note: we choose a property name of "),r.Ib(615,"code"),r.lc(616,"sub"),r.Hb(),r.lc(617," to hold our "),r.Ib(618,"code"),r.lc(619,"userId"),r.Hb(),r.lc(620," value to be consistent with JWT standards. Don't forget to inject the JwtService provider into the "),r.Ib(621,"code"),r.lc(622,"AuthService"),r.Hb(),r.lc(623,"."),r.Hb(),r.Ib(624,"p"),r.lc(625,"We now need to update the "),r.Ib(626,"code"),r.lc(627,"AuthModule"),r.Hb(),r.lc(628," to import the new dependencies and configure the "),r.Ib(629,"code"),r.lc(630,"JwtModule"),r.Hb(),r.lc(631,"."),r.Hb(),r.Ib(632,"p"),r.lc(633,"First, create "),r.Ib(634,"code"),r.lc(635,"constants.ts"),r.Hb(),r.lc(636," in the "),r.Ib(637,"code"),r.lc(638,"auth"),r.Hb(),r.lc(639," folder, and add the following code:"),r.Hb(),r.Ib(640,"span",17),r.lc(641),r.Ub(642,"extension"),r.Gb(643,"app-tabs",null,40),r.Hb(),r.Ib(645,"pre"),r.Ib(646,"code",19),r.lc(647,"\nexport const jwtConstants = {\n  secret: 'secretKey',\n};"),r.Hb(),r.Hb(),r.Ib(648,"pre"),r.Ib(649,"code",19),r.lc(650,"\nexport const jwtConstants = {\n  secret: 'secretKey',\n};"),r.Hb(),r.Hb(),r.Ib(651,"p"),r.lc(652,"We'll use this to share our key between the JWT signing and verifying steps."),r.Hb(),r.Ib(653,"blockquote",22),r.Ib(654,"strong"),r.lc(655,"Warning"),r.Hb(),r.Ib(656,"strong"),r.lc(657,"Do not expose this key publicly"),r.Hb(),r.lc(658,". We have done so here to make it clear what the code is doing, but in a production system "),r.Ib(659,"strong"),r.lc(660,"you must protect this key"),r.Hb(),r.lc(661," using appropriate measures such as a secrets vault, environment variable, or configuration service.\n"),r.Hb(),r.Ib(662,"p"),r.lc(663,"Now, open "),r.Ib(664,"code"),r.lc(665,"auth.module.ts"),r.Hb(),r.lc(666," in the "),r.Ib(667,"code"),r.lc(668,"auth"),r.Hb(),r.lc(669," folder and update it to look like this:"),r.Hb(),r.Ib(670,"span",17),r.lc(671),r.Ub(672,"extension"),r.Gb(673,"app-tabs",null,41),r.Hb(),r.Ib(675,"pre"),r.Ib(676,"code",19),r.lc(677,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { LocalStrategy } from './local.strategy';\nimport { UsersModule } from '../users/users.module';\nimport { PassportModule } from '@nestjs/passport';\nimport { JwtModule } from '@nestjs/jwt';\nimport { jwtConstants } from './constants';\n\n@Module({\n  imports: [\n    UsersModule,\n    PassportModule,\n    JwtModule.register({\n      secret: jwtConstants.secret,\n      signOptions: { expiresIn: '60s' },\n    }),\n  ],\n  providers: [AuthService, LocalStrategy],\n  exports: [AuthService],\n})\nexport class AuthModule {}"),r.Hb(),r.Hb(),r.Ib(678,"pre"),r.Ib(679,"code",19),r.lc(680,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { LocalStrategy } from './local.strategy';\nimport { UsersModule } from '../users/users.module';\nimport { PassportModule } from '@nestjs/passport';\nimport { JwtModule } from '@nestjs/jwt';\nimport { jwtConstants } from './constants';\n\n@Module({\n  imports: [\n    UsersModule,\n    PassportModule,\n    JwtModule.register({\n      secret: jwtConstants.secret,\n      signOptions: { expiresIn: '60s' },\n    }),\n  ],\n  providers: [AuthService, LocalStrategy],\n  exports: [AuthService],\n})\nexport class AuthModule {}"),r.Hb(),r.Hb(),r.Ib(681,"p"),r.lc(682,"We configure the "),r.Ib(683,"code"),r.lc(684,"JwtModule"),r.Hb(),r.lc(685," using "),r.Ib(686,"code"),r.lc(687,"register()"),r.Hb(),r.lc(688,", passing in a configuration object. See "),r.Ib(689,"a",42),r.lc(690,"here"),r.Hb(),r.lc(691," for more on the Nest "),r.Ib(692,"code"),r.lc(693,"JwtModule"),r.Hb(),r.lc(694," and "),r.Ib(695,"a",43),r.lc(696,"here"),r.Hb(),r.lc(697," for more details on the available configuration options."),r.Hb(),r.Ib(698,"p"),r.lc(699,"Now we can update the "),r.Ib(700,"code"),r.lc(701,"/auth/login"),r.Hb(),r.lc(702," route to return a JWT."),r.Hb(),r.Ib(703,"span",17),r.lc(704),r.Ub(705,"extension"),r.Gb(706,"app-tabs",null,44),r.Hb(),r.Ib(708,"pre"),r.Ib(709,"code",19),r.lc(710,"\nimport { Controller, Request, Post, UseGuards } from '@nestjs/common';\nimport { LocalAuthGuard } from './auth/local-auth.guard';\nimport { AuthService } from './auth/auth.service';\n\n@Controller()\nexport class AppController {\n  constructor(private authService: AuthService) {}\n\n  @UseGuards(LocalAuthGuard)\n  @Post('auth/login')\n  async login(@Request() req) {\n    return this.authService.login(req.user);\n  }\n}"),r.Hb(),r.Hb(),r.Ib(711,"pre"),r.Ib(712,"code",19),r.lc(713,"\nimport { Controller, Bind, Request, Post, UseGuards } from '@nestjs/common';\nimport { LocalAuthGuard } from './auth/local-auth.guard';\nimport { AuthService } from './auth/auth.service';\n\n@Controller()\nexport class AppController {\n  constructor(private authService: AuthService) {}\n\n  @UseGuards(LocalAuthGuard)\n  @Post('auth/login')\n  @Bind(Req())\n  async login(req) {\n    return this.authService.login(req.user);\n  }\n}"),r.Hb(),r.Hb(),r.Ib(714,"p"),r.lc(715,"Let's go ahead and test our routes using cURL again. You can test with any of the "),r.Ib(716,"code"),r.lc(717,"user"),r.Hb(),r.lc(718," objects hard-coded in the "),r.Ib(719,"code"),r.lc(720,"UsersService"),r.Hb(),r.lc(721,"."),r.Hb(),r.Ib(722,"pre"),r.Ib(723,"code",14),r.lc(724,'\n$ # POST to /auth/login\n$ curl -X POST http://localhost:3000/auth/login -d \'{"username": "john", "password": "changeme"}\' -H "Content-Type: application/json"\n$ # result -> {"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."}\n$ # Note: above JWT truncated'),r.Hb(),r.Hb(),r.Ib(725,"h4",45),r.Ib(726,"span"),r.lc(727,"Implementing Passport JWT"),r.Hb(),r.Hb(),r.Ib(728,"p"),r.lc(729,"We can now address our final requirement: protecting endpoints by requiring a valid JWT be present on the request. Passport can help us here too. It provides the "),r.Ib(730,"a",46),r.lc(731,"passport-jwt"),r.Hb(),r.lc(732," strategy for securing RESTful endpoints with JSON Web Tokens. Start by creating a file called "),r.Ib(733,"code"),r.lc(734,"jwt.strategy.ts"),r.Hb(),r.lc(735," in the "),r.Ib(736,"code"),r.lc(737,"auth"),r.Hb(),r.lc(738," folder, and add the following code:"),r.Hb(),r.Ib(739,"span",17),r.lc(740),r.Ub(741,"extension"),r.Gb(742,"app-tabs",null,47),r.Hb(),r.Ib(744,"pre"),r.Ib(745,"code",19),r.lc(746,"\nimport { ExtractJwt, Strategy } from 'passport-jwt';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { Injectable } from '@nestjs/common';\nimport { jwtConstants } from './constants';\n\n@Injectable()\nexport class JwtStrategy extends PassportStrategy(Strategy) {\n  constructor() {\n    super({\n      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\n      ignoreExpiration: false,\n      secretOrKey: jwtConstants.secret,\n    });\n  }\n\n  async validate(payload: any) {\n    return { userId: payload.sub, username: payload.username };\n  }\n}"),r.Hb(),r.Hb(),r.Ib(747,"pre"),r.Ib(748,"code",19),r.lc(749,"\nimport { ExtractJwt, Strategy } from 'passport-jwt';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { Injectable } from '@nestjs/common';\nimport { jwtConstants } from './constants';\n\n@Injectable()\nexport class JwtStrategy extends PassportStrategy(Strategy) {\n  constructor() {\n    super({\n      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\n      ignoreExpiration: false,\n      secretOrKey: jwtConstants.secret,\n    });\n  }\n\n  async validate(payload) {\n    return { userId: payload.sub, username: payload.username };\n  }\n}"),r.Hb(),r.Hb(),r.Ib(750,"p"),r.lc(751,"With our "),r.Ib(752,"code"),r.lc(753,"JwtStrategy"),r.Hb(),r.lc(754,", we've followed the same recipe described earlier for all Passport strategies. This strategy requires some initialization, so we do that by passing in an options object in the "),r.Ib(755,"code"),r.lc(756,"super()"),r.Hb(),r.lc(757," call. You can read more about the available options "),r.Ib(758,"a",48),r.lc(759,"here"),r.Hb(),r.lc(760,". In our case, these options are:"),r.Hb(),r.Ib(761,"ul"),r.Ib(762,"li"),r.Ib(763,"code"),r.lc(764,"jwtFromRequest"),r.Hb(),r.lc(765,": supplies the method by which the JWT will be extracted from the "),r.Ib(766,"code"),r.lc(767,"Request"),r.Hb(),r.lc(768,". We will use the standard approach of supplying a bearer token in the Authorization header of our API requests. Other options are described "),r.Ib(769,"a",49),r.lc(770,"here"),r.Hb(),r.lc(771,"."),r.Hb(),r.Ib(772,"li"),r.Ib(773,"code"),r.lc(774,"ignoreExpiration"),r.Hb(),r.lc(775,": just to be explicit, we choose the default "),r.Ib(776,"code"),r.lc(777,"false"),r.Hb(),r.lc(778," setting, which delegates the responsibility of ensuring that a JWT has not expired to the Passport module. This means that if our route is supplied with an expired JWT, the request will be denied and a "),r.Ib(779,"code"),r.lc(780,"401 Unauthorized"),r.Hb(),r.lc(781," response sent. Passport conveniently handles this automatically for us."),r.Hb(),r.Ib(782,"li"),r.Ib(783,"code"),r.lc(784,"secretOrKey"),r.Hb(),r.lc(785,": we are using the expedient option of supplying a symmetric secret for signing the token. Other options, such as a PEM-encoded public key, may be more appropriate for production apps (see "),r.Ib(786,"a",49),r.lc(787,"here"),r.Hb(),r.lc(788," for more information). In any case, as cautioned earlier, "),r.Ib(789,"strong"),r.lc(790,"do not expose this secret publicly"),r.Hb(),r.lc(791,"."),r.Hb(),r.Hb(),r.Ib(792,"p"),r.lc(793,"The "),r.Ib(794,"code"),r.lc(795,"validate()"),r.Hb(),r.lc(796," method deserves some discussion. For the jwt-strategy, Passport first verifies the JWT's signature and decodes the JSON. It then invokes our "),r.Ib(797,"code"),r.lc(798,"validate()"),r.Hb(),r.lc(799," method passing the decoded JSON as its single parameter. Based on the way JWT signing works, "),r.Ib(800,"strong"),r.lc(801,"we're guaranteed that we're receiving a valid token"),r.Hb(),r.lc(802," that we have previously signed and issued to a valid user."),r.Hb(),r.Ib(803,"p"),r.lc(804,"As a result of all this, our response to the "),r.Ib(805,"code"),r.lc(806,"validate()"),r.Hb(),r.lc(807," callback is trivial: we simply return an object containing the "),r.Ib(808,"code"),r.lc(809,"userId"),r.Hb(),r.lc(810," and "),r.Ib(811,"code"),r.lc(812,"username"),r.Hb(),r.lc(813," properties. Recall again that Passport will build a "),r.Ib(814,"code"),r.lc(815,"user"),r.Hb(),r.lc(816," object based on the return value of our "),r.Ib(817,"code"),r.lc(818,"validate()"),r.Hb(),r.lc(819," method, and attach it as a property on the "),r.Ib(820,"code"),r.lc(821,"Request"),r.Hb(),r.lc(822," object."),r.Hb(),r.Ib(823,"p"),r.lc(824,"It's also worth pointing out that this approach leaves us room ('hooks' as it were) to inject other business logic into the process. For example, we could do a database lookup in our "),r.Ib(825,"code"),r.lc(826,"validate()"),r.Hb(),r.lc(827," method to extract more information about the user, resulting in a more enriched "),r.Ib(828,"code"),r.lc(829,"user"),r.Hb(),r.lc(830," object being available in our "),r.Ib(831,"code"),r.lc(832,"Request"),r.Hb(),r.lc(833,". This is also the place we may decide to do further token validation, such as looking up the "),r.Ib(834,"code"),r.lc(835,"userId"),r.Hb(),r.lc(836,' in a list of revoked tokens, enabling us to perform token revocation. The model we\'ve implemented here in our sample code is a fast, "stateless JWT" model, where each API call is immediately authorized based on the presence of a valid JWT, and a small bit of information about the requester (its '),r.Ib(837,"code"),r.lc(838,"userId"),r.Hb(),r.lc(839," and "),r.Ib(840,"code"),r.lc(841,"username"),r.Hb(),r.lc(842,") is available in our Request pipeline."),r.Hb(),r.Ib(843,"p"),r.lc(844,"Add the new "),r.Ib(845,"code"),r.lc(846,"JwtStrategy"),r.Hb(),r.lc(847," as a provider in the "),r.Ib(848,"code"),r.lc(849,"AuthModule"),r.Hb(),r.lc(850,":"),r.Hb(),r.Ib(851,"span",17),r.lc(852),r.Ub(853,"extension"),r.Gb(854,"app-tabs",null,50),r.Hb(),r.Ib(856,"pre"),r.Ib(857,"code",19),r.lc(858,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { LocalStrategy } from './local.strategy';\nimport { JwtStrategy } from './jwt.strategy';\nimport { UsersModule } from '../users/users.module';\nimport { PassportModule } from '@nestjs/passport';\nimport { JwtModule } from '@nestjs/jwt';\nimport { jwtConstants } from './constants';\n\n@Module({\n  imports: [\n    UsersModule,\n    PassportModule,\n    JwtModule.register({\n      secret: jwtConstants.secret,\n      signOptions: { expiresIn: '60s' },\n    }),\n  ],\n  providers: [AuthService, LocalStrategy, JwtStrategy],\n  exports: [AuthService],\n})\nexport class AuthModule {}"),r.Hb(),r.Hb(),r.Ib(859,"pre"),r.Ib(860,"code",19),r.lc(861,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { LocalStrategy } from './local.strategy';\nimport { JwtStrategy } from './jwt.strategy';\nimport { UsersModule } from '../users/users.module';\nimport { PassportModule } from '@nestjs/passport';\nimport { JwtModule } from '@nestjs/jwt';\nimport { jwtConstants } from './constants';\n\n@Module({\n  imports: [\n    UsersModule,\n    PassportModule,\n    JwtModule.register({\n      secret: jwtConstants.secret,\n      signOptions: { expiresIn: '60s' },\n    }),\n  ],\n  providers: [AuthService, LocalStrategy, JwtStrategy],\n  exports: [AuthService],\n})\nexport class AuthModule {}"),r.Hb(),r.Hb(),r.Ib(862,"p"),r.lc(863,"By importing the same secret used when we signed the JWT, we ensure that the "),r.Ib(864,"strong"),r.lc(865,"verify"),r.Hb(),r.lc(866," phase performed by Passport, and the "),r.Ib(867,"strong"),r.lc(868,"sign"),r.Hb(),r.lc(869," phase performed in our AuthService, use a common secret."),r.Hb(),r.Ib(870,"p"),r.lc(871,"Finally, we define the "),r.Ib(872,"code"),r.lc(873,"JwtAuthGuard"),r.Hb(),r.lc(874," class which extends the built-in "),r.Ib(875,"code"),r.lc(876,"AuthGuard"),r.Hb(),r.lc(877,":"),r.Hb(),r.Ib(878,"span",17),r.lc(879),r.Ub(880,"extension"),r.Gb(881,"app-tabs",null,51),r.Hb(),r.Ib(883,"pre"),r.Ib(884,"code",19),r.lc(885,"\nimport { Injectable } from '@nestjs/common';\nimport { AuthGuard } from '@nestjs/passport';\n\n@Injectable()\nexport class JwtAuthGuard extends AuthGuard('jwt') {}"),r.Hb(),r.Hb(),r.Ib(886,"h4",52),r.Ib(887,"span"),r.lc(888,"Implement protected route and JWT strategy guards"),r.Hb(),r.Hb(),r.Ib(889,"p"),r.lc(890,"We can now implement our protected route and its associated Guard."),r.Hb(),r.Ib(891,"p"),r.lc(892,"Open the "),r.Ib(893,"code"),r.lc(894,"app.controller.ts"),r.Hb(),r.lc(895," file and update it as shown below:"),r.Hb(),r.Ib(896,"span",17),r.lc(897),r.Ub(898,"extension"),r.Gb(899,"app-tabs",null,53),r.Hb(),r.Ib(901,"pre"),r.Ib(902,"code",19),r.lc(903,"\nimport { Controller, Get, Request, Post, UseGuards } from '@nestjs/common';\nimport { JwtAuthGuard } from './auth/jwt-auth.guard';\nimport { LocalAuthGuard } from './auth/local-auth.guard';\nimport { AuthService } from './auth/auth.service';\n\n@Controller()\nexport class AppController {\n  constructor(private authService: AuthService) {}\n\n  @UseGuards(LocalAuthGuard)\n  @Post('auth/login')\n  async login(@Request() req) {\n    return this.authService.login(req.user);\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Get('profile')\n  getProfile(@Request() req) {\n    return req.user;\n  }\n}"),r.Hb(),r.Hb(),r.Ib(904,"pre"),r.Ib(905,"code",19),r.lc(906,"\nimport { Controller, Bind, Get, Request, Post, UseGuards } from '@nestjs/common';\nimport { JwtAuthGuard } from './auth/jwt-auth.guard';\nimport { LocalAuthGuard } from './auth/local-auth.guard';\nimport { AuthService } from './auth/auth.service';\n\n@Controller()\nexport class AppController {\n  constructor(private authService: AuthService) {}\n\n  @UseGuards(LocalAuthGuard)\n  @Post('auth/login')\n  @Bind(Req())\n  async login(req) {\n    return this.authService.login(req.user);\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Get('profile')\n  @Bind(Req())\n  getProfile(req) {\n    return req.user;\n  }\n}"),r.Hb(),r.Hb(),r.Ib(907,"p"),r.lc(908,"Once again, we're applying the "),r.Ib(909,"code"),r.lc(910,"AuthGuard"),r.Hb(),r.lc(911," that the "),r.Ib(912,"code"),r.lc(913,"@nestjs/passport"),r.Hb(),r.lc(914," module has automatically provisioned for us when we configured the passport-jwt module. This Guard is referenced by its default name, "),r.Ib(915,"code"),r.lc(916,"jwt"),r.Hb(),r.lc(917,". When our "),r.Ib(918,"code"),r.lc(919,"GET /profile"),r.Hb(),r.lc(920," route is hit, the Guard will automatically invoke our passport-jwt custom configured logic, validating the JWT, and assigning the "),r.Ib(921,"code"),r.lc(922,"user"),r.Hb(),r.lc(923," property to the "),r.Ib(924,"code"),r.lc(925,"Request"),r.Hb(),r.lc(926," object."),r.Hb(),r.Ib(927,"p"),r.lc(928,"Ensure the app is running, and test the routes using "),r.Ib(929,"code"),r.lc(930,"cURL"),r.Hb(),r.lc(931,"."),r.Hb(),r.Ib(932,"pre"),r.Ib(933,"code",14),r.lc(934,'\n$ # GET /profile\n$ curl http://localhost:3000/profile\n$ # result -> {"statusCode":401,"error":"Unauthorized"}\n\n$ # POST /auth/login\n$ curl -X POST http://localhost:3000/auth/login -d \'{"username": "john", "password": "changeme"}\' -H "Content-Type: application/json"\n$ # result -> {"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm... }\n\n$ # GET /profile using access_token returned from previous step as bearer code\n$ curl http://localhost:3000/profile -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm..."\n$ # result -> {"userId":1,"username":"john"}'),r.Hb(),r.Hb(),r.Ib(935,"p"),r.lc(936,"Note that in the "),r.Ib(937,"code"),r.lc(938,"AuthModule"),r.Hb(),r.lc(939,", we configured the JWT to have an expiration of "),r.Ib(940,"code"),r.lc(941,"60 seconds"),r.Hb(),r.lc(942,". This is probably too short an expiration, and dealing with the details of token expiration and refresh is beyond the scope of this article. However, we chose that to demonstrate an important quality of JWTs and the passport-jwt strategy. If you wait 60 seconds after authenticating before attempting a "),r.Ib(943,"code"),r.lc(944,"GET /profile"),r.Hb(),r.lc(945," request, you'll receive a "),r.Ib(946,"code"),r.lc(947,"401 Unauthorized"),r.Hb(),r.lc(948," response. This is because Passport automatically checks the JWT for its expiration time, saving you the trouble of doing so in your application."),r.Hb(),r.Ib(949,"p"),r.lc(950,"We've now completed our JWT authentication implementation. JavaScript clients (such as Angular/React/Vue), and other JavaScript apps, can now authenticate and communicate securely with our API Server. You can find a complete version of the code in this chapter "),r.Ib(951,"a",10),r.lc(952,"here"),r.Hb(),r.lc(953,"."),r.Hb(),r.Ib(954,"p"),r.Gb(955,"app-banner-enterprise"),r.Hb(),r.Ib(956,"h4",54),r.Ib(957,"span"),r.lc(958,"Default strategy"),r.Hb(),r.Hb(),r.Ib(959,"p"),r.lc(960,"In our "),r.Ib(961,"code"),r.lc(962,"AppController"),r.Hb(),r.lc(963,", we pass the name of the strategy in the "),r.Ib(964,"code"),r.lc(965,"AuthGuard()"),r.Hb(),r.lc(966," function. We need to do this because we've introduced "),r.Ib(967,"strong"),r.lc(968,"two"),r.Hb(),r.lc(969," Passport strategies (passport-local and passport-jwt), both of which supply implementations of various Passport components. Passing the name disambiguates which implementation we're linking to. When multiple strategies are included in an application, we can declare a default strategy so that we no longer have to pass the name in the "),r.Ib(970,"code"),r.lc(971,"AuthGuard"),r.Hb(),r.lc(972," function if using that default strategy. Here's how to register a default strategy when importing the "),r.Ib(973,"code"),r.lc(974,"PassportModule"),r.Hb(),r.lc(975,". This code would go in the "),r.Ib(976,"code"),r.lc(977,"AuthModule"),r.Hb(),r.lc(978,":"),r.Hb(),r.Ib(979,"pre"),r.Ib(980,"code",19),r.lc(981,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { LocalStrategy } from './local.strategy';\nimport { UsersModule } from '../users/users.module';\nimport { PassportModule } from '@nestjs/passport';\nimport { JwtModule } from '@nestjs/jwt';\nimport { jwtConstants } from './constants';\nimport { JwtStrategy } from './jwt.strategy';\n\n@Module({\n  imports: [\n    PassportModule.register({ defaultStrategy: 'jwt' }),\n    JwtModule.register({\n      secret: jwtConstants.secret,\n      signOptions: { expiresIn: '60s' },\n    }),\n    UsersModule,\n  ],\n  providers: [AuthService, LocalStrategy, JwtStrategy],\n  exports: [AuthService],\n})\nexport class AuthModule {}"),r.Hb(),r.Hb(),r.Ib(982,"h4",55),r.Ib(983,"span"),r.lc(984,"Request-scoped strategies"),r.Hb(),r.Hb(),r.Ib(985,"p"),r.lc(986,"The passport API is based on registering strategies to the global instance of the library. Therefore strategies are not designed to have request-dependent options or to be dynamically instantiated per request (read more about the "),r.Ib(987,"a",56),r.lc(988,"request-scoped"),r.Hb(),r.lc(989,' providers). When you configure your strategy to be request-scoped, Nest will never instantiate it since it\'s not tied to any specific route. There is no physical way to determine which "request-scoped" strategies should be executed per request.'),r.Hb(),r.Ib(990,"p"),r.lc(991,"However, there are ways to dynamically resolve request-scoped providers within the strategy. For this, we leverage the "),r.Ib(992,"a",57),r.lc(993,"module reference"),r.Hb(),r.lc(994," feature."),r.Hb(),r.Ib(995,"p"),r.lc(996,"First, open the "),r.Ib(997,"code"),r.lc(998,"local.strategy.ts"),r.Hb(),r.lc(999," file and inject the "),r.Ib(1e3,"code"),r.lc(1001,"ModuleRef"),r.Hb(),r.lc(1002," in the normal way:"),r.Hb(),r.Ib(1003,"pre"),r.Ib(1004,"code",19),r.lc(1005,"\nconstructor(private moduleRef: ModuleRef) {\n  super({\n    passReqToCallback: true,\n  });\n}"),r.Hb(),r.Hb(),r.Ib(1006,"blockquote",27),r.Ib(1007,"strong"),r.lc(1008,"Hint"),r.Hb(),r.lc(1009," The "),r.Ib(1010,"code"),r.lc(1011,"ModuleRef"),r.Hb(),r.lc(1012," class is imported from the "),r.Ib(1013,"code"),r.lc(1014,"@nestjs/core"),r.Hb(),r.lc(1015," package.\n"),r.Hb(),r.Ib(1016,"p"),r.lc(1017,"Be sure to set the "),r.Ib(1018,"code"),r.lc(1019,"passReqToCallback"),r.Hb(),r.lc(1020," configuration property to "),r.Ib(1021,"code"),r.lc(1022,"true"),r.Hb(),r.lc(1023,", as shown above."),r.Hb(),r.Ib(1024,"p"),r.lc(1025,"In the next step, the request instance will be used to obtain the current context identifier, instead of generating a new one (read more about request context "),r.Ib(1026,"a",58),r.lc(1027,"here"),r.Hb(),r.lc(1028,")."),r.Hb(),r.Ib(1029,"p"),r.lc(1030,"Now, inside the "),r.Ib(1031,"code"),r.lc(1032,"validate()"),r.Hb(),r.lc(1033," method of the "),r.Ib(1034,"code"),r.lc(1035,"LocalStrategy"),r.Hb(),r.lc(1036," class, use the "),r.Ib(1037,"code"),r.lc(1038,"getByRequest()"),r.Hb(),r.lc(1039," method of the "),r.Ib(1040,"code"),r.lc(1041,"ContextIdFactory"),r.Hb(),r.lc(1042," class to create a context id based on the request object, and pass this to the "),r.Ib(1043,"code"),r.lc(1044,"resolve()"),r.Hb(),r.lc(1045," call:"),r.Hb(),r.Ib(1046,"pre"),r.Ib(1047,"code",19),r.lc(1048,'\nasync validate(\n  request: Request,\n  username: string,\n  password: string,\n) {\n  const contextId = ContextIdFactory.getByRequest(request);\n  // "AuthService" is a request-scoped provider\n  const authService = await this.moduleRef.resolve(AuthService, contextId);\n  ...\n}'),r.Hb(),r.Hb(),r.Ib(1049,"p"),r.lc(1050,"In the example above, the "),r.Ib(1051,"code"),r.lc(1052,"resolve()"),r.Hb(),r.lc(1053," method will asynchronously return the request-scoped instance of the "),r.Ib(1054,"code"),r.lc(1055,"AuthService"),r.Hb(),r.lc(1056," provider (we assumed that "),r.Ib(1057,"code"),r.lc(1058,"AuthService"),r.Hb(),r.lc(1059," is marked as a request-scoped provider)."),r.Hb(),r.Ib(1060,"h4",59),r.Ib(1061,"span"),r.lc(1062,"Extending guards"),r.Hb(),r.Hb(),r.Ib(1063,"p"),r.lc(1064,"In most cases, using a provided "),r.Ib(1065,"code"),r.lc(1066,"AuthGuard"),r.Hb(),r.lc(1067," class is sufficient. However, there might be use-cases when you would like to simply extend the default error handling or authentication logic. For this, you can extend the built-in class and override methods within a sub-class."),r.Hb(),r.Ib(1068,"pre"),r.Ib(1069,"code",19),r.lc(1070,"\nimport {\n  ExecutionContext,\n  Injectable,\n  UnauthorizedException,\n} from '@nestjs/common';\nimport { AuthGuard } from '@nestjs/passport';\n\n@Injectable()\nexport class JwtAuthGuard extends AuthGuard('jwt') {\n  canActivate(context: ExecutionContext) {\n    // Add your custom authentication logic here\n    // for example, call super.logIn(request) to establish a session.\n    return super.canActivate(context);\n  }\n\n  handleRequest(err, user, info) {\n    // You can throw an exception based on either \"info\" or \"err\" arguments\n    if (err || !user) {\n      throw err || new UnauthorizedException();\n    }\n    return user;\n  }\n}"),r.Hb(),r.Hb(),r.Ib(1071,"h4",60),r.Ib(1072,"span"),r.lc(1073,"Customize Passport"),r.Hb(),r.Hb(),r.Ib(1074,"p"),r.lc(1075,"Any standard Passport customization options can be passed the same way, using the "),r.Ib(1076,"code"),r.lc(1077,"register()"),r.Hb(),r.lc(1078," method. The available options depend on the strategy being implemented. For example:"),r.Hb(),r.Ib(1079,"pre"),r.Ib(1080,"code",19),r.lc(1081,"\nPassportModule.register({ session: true });"),r.Hb(),r.Hb(),r.Ib(1082,"p"),r.lc(1083,"You can also pass strategies an options object in their constructors to configure them.\nFor the local strategy you can pass e.g.:"),r.Hb(),r.Ib(1084,"pre"),r.Ib(1085,"code",19),r.lc(1086,"\nconstructor(private authService: AuthService) {\n  super({\n    usernameField: 'email',\n    passwordField: 'password',\n  });\n}"),r.Hb(),r.Hb(),r.Ib(1087,"p"),r.lc(1088,"Take a look at the official "),r.Ib(1089,"a",61),r.lc(1090,"Passport Website"),r.Hb(),r.lc(1091," for property names."),r.Hb(),r.Ib(1092,"h4",62),r.Ib(1093,"span"),r.lc(1094,"Named strategies"),r.Hb(),r.Hb(),r.Ib(1095,"p"),r.lc(1096,"When implementing a strategy, you can provide a name for it by passing a second argument to the "),r.Ib(1097,"code"),r.lc(1098,"PassportStrategy"),r.Hb(),r.lc(1099," function. If you don't do this, each strategy will have a default name (e.g., 'jwt' for jwt-strategy):"),r.Hb(),r.Ib(1100,"pre"),r.Ib(1101,"code",19),r.lc(1102,"\nexport class JwtStrategy extends PassportStrategy(Strategy, 'myjwt')"),r.Hb(),r.Hb(),r.Ib(1103,"p"),r.lc(1104,"Then, you refer to this via a decorator like "),r.Ib(1105,"code"),r.lc(1106,"@UseGuards(AuthGuard('myjwt'))"),r.Hb(),r.lc(1107,"."),r.Hb(),r.Ib(1108,"h4",63),r.Ib(1109,"span"),r.lc(1110,"GraphQL"),r.Hb(),r.Hb(),r.Ib(1111,"p"),r.lc(1112,"In order to use an AuthGuard with "),r.Ib(1113,"a",64),r.lc(1114,"GraphQL"),r.Hb(),r.lc(1115,", extend the built-in AuthGuard class and override the getRequest() method."),r.Hb(),r.Ib(1116,"pre"),r.Ib(1117,"code",19),r.lc(1118,"\n@Injectable()\nexport class GqlAuthGuard extends AuthGuard('jwt') {\n  getRequest(context: ExecutionContext) {\n    const ctx = GqlExecutionContext.create(context);\n    return ctx.getContext().req;\n  }\n}"),r.Hb(),r.Hb(),r.Ib(1119,"p"),r.lc(1120,"To use the above construct, be sure to pass the request ("),r.Ib(1121,"code"),r.lc(1122,"req"),r.Hb(),r.lc(1123,") object as part of the context value in the GraphQL Module settings:"),r.Hb(),r.Ib(1124,"pre"),r.Ib(1125,"code",19),r.lc(1126,"\nGraphQLModule.forRoot({\n  context: ({ req }) => ({ req }),\n});"),r.Hb(),r.Hb(),r.Ib(1127,"p"),r.lc(1128,"To get the current authenticated user in your graphql resolver, you can define a "),r.Ib(1129,"code"),r.lc(1130,"@CurrentUser()"),r.Hb(),r.lc(1131," decorator:"),r.Hb(),r.Ib(1132,"pre"),r.Ib(1133,"code",19),r.lc(1134,"\nimport { createParamDecorator, ExecutionContext } from '@nestjs/common';\nimport { GqlExecutionContext } from '@nestjs/graphql';\n\nexport const CurrentUser = createParamDecorator(\n  (data: unknown, context: ExecutionContext) => {\n    const ctx = GqlExecutionContext.create(context);\n    return ctx.getContext().req.user;\n  },\n);"),r.Hb(),r.Hb(),r.Ib(1135,"p"),r.lc(1136,"To use above decorator in your resolver, be sure to include it as a parameter of your query or mutation:"),r.Hb(),r.Ib(1137,"pre"),r.Ib(1138,"code",19),r.lc(1139,"\n@Query(returns => User)\n@UseGuards(GqlAuthGuard)\nwhoAmI(@CurrentUser() user: User) {\n  return this.usersService.findById(user.id);\n}"),r.Hb(),r.Hb();r.Hb()}if(2&e){const e=r.dc(160),t=r.dc(185),o=r.dc(207),n=r.dc(238),s=r.dc(263),c=r.dc(357),a=r.dc(436),l=r.dc(508),i=r.dc(594),b=r.dc(644),d=r.dc(674),p=r.dc(707),u=r.dc(743),h=r.dc(855),m=r.dc(882),I=r.dc(900);r.vb(157),r.nc(" ",r.Vb(158,74,"users/users.service",e.isJsActive),"\n"),r.vb(4),r.xb("hide",e.isJsActive),r.vb(3),r.xb("hide",!e.isJsActive),r.vb(18),r.nc(" ",r.Vb(183,77,"users/users.module",t.isJsActive),"\n"),r.vb(4),r.xb("hide",t.isJsActive),r.vb(3),r.xb("hide",!t.isJsActive),r.vb(15),r.nc(" ",r.Vb(205,80,"auth/auth.service",o.isJsActive),"\n"),r.vb(4),r.xb("hide",o.isJsActive),r.vb(3),r.xb("hide",!o.isJsActive),r.vb(24),r.nc(" ",r.Vb(236,83,"auth/auth.module",n.isJsActive),"\n"),r.vb(4),r.xb("hide",n.isJsActive),r.vb(3),r.xb("hide",!n.isJsActive),r.vb(18),r.nc(" ",r.Vb(261,86,"auth/local.strategy",s.isJsActive),"\n"),r.vb(4),r.xb("hide",s.isJsActive),r.vb(3),r.xb("hide",!s.isJsActive),r.vb(22),r.oc("super(","{"," usernameField: 'email' ","}",")"),r.vb(65),r.nc(" ",r.Vb(355,89,"auth/auth.module",c.isJsActive),"\n"),r.vb(4),r.xb("hide",c.isJsActive),r.vb(3),r.xb("hide",!c.isJsActive),r.vb(72),r.nc(" ",r.Vb(434,92,"app.controller",a.isJsActive),"\n"),r.vb(4),r.xb("hide",a.isJsActive),r.vb(3),r.xb("hide",!a.isJsActive),r.vb(65),r.nc(" ",r.Vb(506,95,"auth/local-auth.guard",l.isJsActive),"\n"),r.vb(86),r.nc(" ",r.Vb(592,98,"auth/auth.service",i.isJsActive),"\n"),r.vb(4),r.xb("hide",i.isJsActive),r.vb(3),r.xb("hide",!i.isJsActive),r.vb(43),r.nc(" ",r.Vb(642,101,"auth/constants",b.isJsActive),"\n"),r.vb(4),r.xb("hide",b.isJsActive),r.vb(3),r.xb("hide",!b.isJsActive),r.vb(23),r.nc(" ",r.Vb(672,104,"auth/auth.module",d.isJsActive),"\n"),r.vb(4),r.xb("hide",d.isJsActive),r.vb(3),r.xb("hide",!d.isJsActive),r.vb(26),r.nc(" ",r.Vb(705,107,"app.controller",p.isJsActive),"\n"),r.vb(4),r.xb("hide",p.isJsActive),r.vb(3),r.xb("hide",!p.isJsActive),r.vb(29),r.nc(" ",r.Vb(741,110,"auth/jwt.strategy",u.isJsActive),"\n"),r.vb(4),r.xb("hide",u.isJsActive),r.vb(3),r.xb("hide",!u.isJsActive),r.vb(105),r.nc(" ",r.Vb(853,113,"auth/auth.module",h.isJsActive),"\n"),r.vb(4),r.xb("hide",h.isJsActive),r.vb(3),r.xb("hide",!h.isJsActive),r.vb(20),r.nc(" ",r.Vb(880,116,"auth/jwt-auth.guard",m.isJsActive),"\n"),r.vb(18),r.nc(" ",r.Vb(898,119,"app.controller",I.isJsActive),"\n"),r.vb(4),r.xb("hide",I.isJsActive),r.vb(3),r.xb("hide",!I.isJsActive)}},directives:[l.a,i.a,b.a,d.a,s.f],pipes:[p.a],encapsulation:2,changeDetection:0}),e})();const h=r.Kb(u);let m=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return I(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-caching"]],features:[r.tb],decls:301,vars:8,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/caching.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","caching"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","in-memory-cache"],[1,"language-typescript"],[1,"warning"],["routerLink","/graphql/quick-start"],["href","https://docs.nestjs.com/interceptors#response-mapping"],["appAnchor","","id","global-cache"],["appAnchor","","id","customize-caching"],["appAnchor","","id","global-cache-overrides"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/techniques/caching#different-stores"],[1,"info"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/techniques/caching#customize-caching"],["appAnchor","","id","websockets-and-microservices"],[1,"filename"],["app9b22f26b861e0825ac1056f8e3422e848ebb8482",""],["appfc7b3108d069a4c260d0172b1cd03eb9cc6bffb1",""],["appAnchor","","id","different-stores"],["rel","nofollow","target","_blank","href","https://github.com/BryanDonovan/node-cache-manager"],["rel","nofollow","target","_blank","href","https://github.com/dabroek/node-cache-manager-redis-store"],["rel","nofollow","target","_blank","href","https://github.com/BryanDonovan/node-cache-manager#store-engines"],["appAnchor","","id","adjust-tracking"],["appAnchor","","id","async-configuration"]],template:function(e,t){if(1&e&&(r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"Caching"),r.Hb(),r.Ib(7,"p"),r.lc(8,"Caching is a great and simple "),r.Ib(9,"strong"),r.lc(10,"technique"),r.Hb(),r.lc(11," that helps improve your app's performance. It acts as a temporary data store providing high performance data access."),r.Hb(),r.Ib(12,"h4",6),r.Ib(13,"span"),r.lc(14,"Installation"),r.Hb(),r.Hb(),r.Ib(15,"p"),r.lc(16,"First install the required package:"),r.Hb(),r.Ib(17,"pre"),r.Ib(18,"code",7),r.lc(19,"\n$ npm install --save cache-manager"),r.Hb(),r.Hb(),r.Ib(20,"h4",8),r.Ib(21,"span"),r.lc(22,"In-memory cache"),r.Hb(),r.Hb(),r.Ib(23,"p"),r.lc(24,"Nest provides a unified API for various cache storage providers. The built-in one is an in-memory data store. However, you can easily switch to a more comprehensive solution, like Redis. In order to enable caching, first import the "),r.Ib(25,"code"),r.lc(26,"CacheModule"),r.Hb(),r.lc(27," and call its "),r.Ib(28,"code"),r.lc(29,"register()"),r.Hb(),r.lc(30," method."),r.Hb(),r.Ib(31,"pre"),r.Ib(32,"code",9),r.lc(33,"\nimport { CacheModule, Module } from '@nestjs/common';\nimport { AppController } from './app.controller';\n\n@Module({\n  imports: [CacheModule.register()],\n  controllers: [AppController],\n})\nexport class ApplicationModule {}"),r.Hb(),r.Hb(),r.Ib(34,"blockquote",10),r.Ib(35,"strong"),r.lc(36,"Warning"),r.Hb(),r.lc(37," In "),r.Ib(38,"a",11),r.lc(39,"GraphQL"),r.Hb(),r.lc(40," applications, interceptors are executed separately for each field resolver. Thus, "),r.Ib(41,"code"),r.lc(42,"CacheModule"),r.Hb(),r.lc(43," (which uses interceptors to cache responses) will not work properly.\n"),r.Hb(),r.Ib(44,"p"),r.lc(45,"Then just tie the "),r.Ib(46,"code"),r.lc(47,"CacheInterceptor"),r.Hb(),r.lc(48," where you want to cache data."),r.Hb(),r.Ib(49,"pre"),r.Ib(50,"code",9),r.lc(51,"\n@Controller()\n@UseInterceptors(CacheInterceptor)\nexport class AppController {\n  @Get()\n  findAll(): string[] {\n    return [];\n  }\n}"),r.Hb(),r.Hb(),r.Ib(52,"blockquote",10),r.Ib(53,"strong"),r.lc(54,"Warning"),r.Hb(),r.lc(55," Only "),r.Ib(56,"code"),r.lc(57,"GET"),r.Hb(),r.lc(58," endpoints are cached. Also, HTTP server routes that inject the native response object ("),r.Ib(59,"code"),r.lc(60,"@Res()"),r.Hb(),r.lc(61,") cannot use the Cache Interceptor. See\n"),r.Ib(62,"a",12),r.lc(63,"response mapping"),r.Hb(),r.lc(64," for more details.\n"),r.Hb(),r.Ib(65,"h4",13),r.Ib(66,"span"),r.lc(67,"Global cache"),r.Hb(),r.Hb(),r.Ib(68,"p"),r.lc(69,"To reduce the amount of required boilerplate, you can bind "),r.Ib(70,"code"),r.lc(71,"CacheInterceptor"),r.Hb(),r.lc(72," to all endpoints globally:"),r.Hb(),r.Ib(73,"pre"),r.Ib(74,"code",9),r.lc(75,"\nimport { CacheModule, Module, CacheInterceptor } from '@nestjs/common';\nimport { AppController } from './app.controller';\nimport { APP_INTERCEPTOR } from '@nestjs/core';\n\n@Module({\n  imports: [CacheModule.register()],\n  controllers: [AppController],\n  providers: [\n    {\n      provide: APP_INTERCEPTOR,\n      useClass: CacheInterceptor,\n    },\n  ],\n})\nexport class ApplicationModule {}"),r.Hb(),r.Hb(),r.Ib(76,"h4",14),r.Ib(77,"span"),r.lc(78,"Customize caching"),r.Hb(),r.Hb(),r.Ib(79,"p"),r.lc(80,"All cached data has its own expiration time (TTL). To customize default values, pass the options object to the "),r.Ib(81,"code"),r.lc(82,"register()"),r.Hb(),r.lc(83," method."),r.Hb(),r.Ib(84,"pre"),r.Ib(85,"code",9),r.lc(86,"\nCacheModule.register({\n  ttl: 5, // seconds\n  max: 10, // maximum number of items in cache\n});"),r.Hb(),r.Hb(),r.Ib(87,"h4",15),r.Ib(88,"span"),r.lc(89,"Global cache overrides"),r.Hb(),r.Hb(),r.Ib(90,"p"),r.lc(91,"While global cache is enabled, cache entries are stored under a "),r.Ib(92,"code"),r.lc(93,"CacheKey"),r.Hb(),r.lc(94," that is auto-generated based on the route path. You may override certain cache settings ("),r.Ib(95,"code"),r.lc(96,"@CacheKey()"),r.Hb(),r.lc(97," and "),r.Ib(98,"code"),r.lc(99,"@CacheTTL()"),r.Hb(),r.lc(100,") on a per-method basis, allowing customized caching strategies for individual controller methods. This may be most relevant while using "),r.Ib(101,"a",16),r.lc(102,"different cache stores."),r.Hb(),r.Hb(),r.Ib(103,"pre"),r.Ib(104,"code",9),r.lc(105,"\n@Controller()\nexport class AppController {\n  @CacheKey('custom_key')\n  @CacheTTL(20)\n  findAll(): string[] {\n    return [];\n  }\n}"),r.Hb(),r.Hb(),r.Ib(106,"blockquote",17),r.Ib(107,"strong"),r.lc(108,"Hint"),r.Hb(),r.lc(109," The "),r.Ib(110,"code"),r.lc(111,"@CacheKey()"),r.Hb(),r.lc(112," and "),r.Ib(113,"code"),r.lc(114,"@CacheTTL()"),r.Hb(),r.lc(115," decorators are imported from the "),r.Ib(116,"code"),r.lc(117,"@nestjs/common"),r.Hb(),r.lc(118," package.\n"),r.Hb(),r.Ib(119,"p"),r.lc(120,"The "),r.Ib(121,"code"),r.lc(122,"@CacheKey()"),r.Hb(),r.lc(123," decorator may be used with or without a corresponding "),r.Ib(124,"code"),r.lc(125,"@CacheTTL()"),r.Hb(),r.lc(126," decorator and vice versa. One may choose to override only the "),r.Ib(127,"code"),r.lc(128,"@CacheKey()"),r.Hb(),r.lc(129," or only the "),r.Ib(130,"code"),r.lc(131,"@CacheTTL()"),r.Hb(),r.lc(132,". Settings that are not overridden with a decorator will use the default values as registered globally (see "),r.Ib(133,"a",18),r.lc(134,"Customize caching"),r.Hb(),r.lc(135,")."),r.Hb(),r.Ib(136,"h4",19),r.Ib(137,"span"),r.lc(138,"WebSockets and Microservices"),r.Hb(),r.Hb(),r.Ib(139,"p"),r.lc(140,"You can also apply the "),r.Ib(141,"code"),r.lc(142,"CacheInterceptor"),r.Hb(),r.lc(143," to WebSocket subscribers as well as Microservice's patterns (regardless of the transport method that is being used)."),r.Hb(),r.Ib(144,"span",20),r.Gb(145,"app-tabs",null,21),r.Hb(),r.Ib(147,"pre"),r.Ib(148,"code",9),r.lc(149,"\n@CacheKey('events')\n@UseInterceptors(CacheInterceptor)\n@SubscribeMessage('events')\nhandleEvent(client: Client, data: string[]): Observable<string[]> {\n  return [];\n}"),r.Hb(),r.Hb(),r.Ib(150,"pre"),r.Ib(151,"code",9),r.lc(152,"\n@CacheKey('events')\n@UseInterceptors(CacheInterceptor)\n@SubscribeMessage('events')\nhandleEvent(client, data) {\n  return [];\n}"),r.Hb(),r.Hb(),r.Ib(153,"p"),r.lc(154,"However, the additional "),r.Ib(155,"code"),r.lc(156,"@CacheKey()"),r.Hb(),r.lc(157," decorator is required in order to specify a key used to subsequently store and retrieve cached data. Also, please note that you "),r.Ib(158,"strong"),r.lc(159,"shouldn't cache everything"),r.Hb(),r.lc(160,". Actions which perform some business operations rather than simply querying the data should never be cached."),r.Hb(),r.Ib(161,"p"),r.lc(162,"Additionally, you may specify a cache expiration time (TTL) by using the "),r.Ib(163,"code"),r.lc(164,"@CacheTTL()"),r.Hb(),r.lc(165," decorator, which will override the global default TTL value."),r.Hb(),r.Ib(166,"span",20),r.Gb(167,"app-tabs",null,22),r.Hb(),r.Ib(169,"pre"),r.Ib(170,"code",9),r.lc(171,"\n@CacheTTL(10)\n@UseInterceptors(CacheInterceptor)\n@SubscribeMessage('events')\nhandleEvent(client: Client, data: string[]): Observable<string[]> {\n  return [];\n}"),r.Hb(),r.Hb(),r.Ib(172,"pre"),r.Ib(173,"code",9),r.lc(174,"\n@CacheTTL(10)\n@UseInterceptors(CacheInterceptor)\n@SubscribeMessage('events')\nhandleEvent(client, data) {\n  return [];\n}"),r.Hb(),r.Hb(),r.Ib(175,"blockquote",17),r.Ib(176,"strong"),r.lc(177,"Hint"),r.Hb(),r.lc(178," The "),r.Ib(179,"code"),r.lc(180,"@CacheTTL()"),r.Hb(),r.lc(181," decorator may be used with or without a corresponding "),r.Ib(182,"code"),r.lc(183,"@CacheKey()"),r.Hb(),r.lc(184," decorator.\n"),r.Hb(),r.Ib(185,"h4",23),r.Ib(186,"span"),r.lc(187,"Different stores"),r.Hb(),r.Hb(),r.Ib(188,"p"),r.lc(189,"This service takes advantage of "),r.Ib(190,"a",24),r.lc(191,"cache-manager"),r.Hb(),r.lc(192," under the hood. The "),r.Ib(193,"code"),r.lc(194,"cache-manager"),r.Hb(),r.lc(195," package supports a wide-range of useful stores, for example, "),r.Ib(196,"a",25),r.lc(197,"Redis"),r.Hb(),r.lc(198," store. A full list of supported stores is available "),r.Ib(199,"a",26),r.lc(200,"here"),r.Hb(),r.lc(201,". To set up the Redis store, simply pass the package together with corresponding options to the "),r.Ib(202,"code"),r.lc(203,"register()"),r.Hb(),r.lc(204," method."),r.Hb(),r.Ib(205,"pre"),r.Ib(206,"code",9),r.lc(207,"\nimport * as redisStore from 'cache-manager-redis-store';\nimport { CacheModule, Module } from '@nestjs/common';\nimport { AppController } from './app.controller';\n\n@Module({\n  imports: [\n    CacheModule.register({\n      store: redisStore,\n      host: 'localhost',\n      port: 6379,\n    }),\n  ],\n  controllers: [AppController],\n})\nexport class ApplicationModule {}"),r.Hb(),r.Hb(),r.Ib(208,"h4",27),r.Ib(209,"span"),r.lc(210,"Adjust tracking"),r.Hb(),r.Hb(),r.Ib(211,"p"),r.lc(212,"By default, Nest uses the request URL (in an HTTP app) or cache key (in websockets and microservices apps, set through the "),r.Ib(213,"code"),r.lc(214,"@CacheKey()"),r.Hb(),r.lc(215," decorator) to associate cache records with your endpoints. Nevertheless, sometimes you might want to set up tracking based on different factors, for example, using HTTP headers (e.g. "),r.Ib(216,"code"),r.lc(217,"Authorization"),r.Hb(),r.lc(218," to properly identify "),r.Ib(219,"code"),r.lc(220,"profile"),r.Hb(),r.lc(221," endpoints)."),r.Hb(),r.Ib(222,"p"),r.lc(223,"In order to accomplish that, create a subclass of "),r.Ib(224,"code"),r.lc(225,"CacheInterceptor"),r.Hb(),r.lc(226," and override the "),r.Ib(227,"code"),r.lc(228,"trackBy()"),r.Hb(),r.lc(229," method."),r.Hb(),r.Ib(230,"pre"),r.Ib(231,"code",9),r.lc(232,"\n@Injectable()\nclass HttpCacheInterceptor extends CacheInterceptor {\n  trackBy(context: ExecutionContext): string | undefined {\n    return 'key';\n  }\n}"),r.Hb(),r.Hb(),r.Ib(233,"h4",28),r.Ib(234,"span"),r.lc(235,"Async configuration"),r.Hb(),r.Hb(),r.Ib(236,"p"),r.lc(237,"You may want to asynchronously pass in module options instead of passing them statically at compile time. In this case, use the "),r.Ib(238,"code"),r.lc(239,"registerAsync()"),r.Hb(),r.lc(240," method, which provides several ways to deal with async configuration."),r.Hb(),r.Ib(241,"p"),r.lc(242,"One approach is to use a factory function:"),r.Hb(),r.Ib(243,"pre"),r.Ib(244,"code",9),r.lc(245,"\nCacheModule.registerAsync({\n  useFactory: () => ({\n    ttl: 5,\n  }),\n});"),r.Hb(),r.Hb(),r.Ib(246,"p"),r.lc(247,"Our factory behaves like all other asynchronous module factories (it can be "),r.Ib(248,"code"),r.lc(249,"async"),r.Hb(),r.lc(250," and is able to inject dependencies through "),r.Ib(251,"code"),r.lc(252,"inject"),r.Hb(),r.lc(253,")."),r.Hb(),r.Ib(254,"pre"),r.Ib(255,"code",9),r.lc(256,"\nCacheModule.registerAsync({\n  imports: [ConfigModule],\n  useFactory: async (configService: ConfigService) => ({\n    ttl: configService.getString('CACHE_TTL'),\n  }),\n  inject: [ConfigService],\n});"),r.Hb(),r.Hb(),r.Ib(257,"p"),r.lc(258,"Alternatively, you can use the "),r.Ib(259,"code"),r.lc(260,"useClass"),r.Hb(),r.lc(261," method:"),r.Hb(),r.Ib(262,"pre"),r.Ib(263,"code",9),r.lc(264,"\nCacheModule.registerAsync({\n  useClass: CacheConfigService,\n});"),r.Hb(),r.Hb(),r.Ib(265,"p"),r.lc(266,"The above construction will instantiate "),r.Ib(267,"code"),r.lc(268,"CacheConfigService"),r.Hb(),r.lc(269," inside "),r.Ib(270,"code"),r.lc(271,"CacheModule"),r.Hb(),r.lc(272," and will use it to get the options object. The "),r.Ib(273,"code"),r.lc(274,"CacheConfigService"),r.Hb(),r.lc(275," has to implement the "),r.Ib(276,"code"),r.lc(277,"CacheOptionsFactory"),r.Hb(),r.lc(278," interface in order to provide the configuration options:"),r.Hb(),r.Ib(279,"pre"),r.Ib(280,"code",9),r.lc(281,"\n@Injectable()\nclass CacheConfigService implements CacheOptionsFactory {\n  createCacheOptions(): CacheModuleOptions {\n    return {\n      ttl: 5,\n    };\n  }\n}"),r.Hb(),r.Hb(),r.Ib(282,"p"),r.lc(283,"If you wish to use an existing configuration provider imported from a different module, use the "),r.Ib(284,"code"),r.lc(285,"useExisting"),r.Hb(),r.lc(286," syntax:"),r.Hb(),r.Ib(287,"pre"),r.Ib(288,"code",9),r.lc(289,"\nCacheModule.registerAsync({\n  imports: [ConfigModule],\n  useExisting: ConfigService,\n});"),r.Hb(),r.Hb(),r.Ib(290,"p"),r.lc(291,"This works the same as "),r.Ib(292,"code"),r.lc(293,"useClass"),r.Hb(),r.lc(294," with one critical difference - "),r.Ib(295,"code"),r.lc(296,"CacheModule"),r.Hb(),r.lc(297," will lookup imported modules to reuse any already-created "),r.Ib(298,"code"),r.lc(299,"ConfigService"),r.Hb(),r.lc(300,", instead of instantiating its own."),r.Hb(),r.Hb()),2&e){const e=r.dc(146),t=r.dc(168);r.vb(147),r.xb("hide",e.isJsActive),r.vb(3),r.xb("hide",!e.isJsActive),r.vb(19),r.xb("hide",t.isJsActive),r.vb(3),r.xb("hide",!t.isJsActive)}},directives:[l.a,s.f,i.a],encapsulation:2,changeDetection:0}),e})();const I=r.Kb(m);let H=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return f(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-compression"]],features:[r.tb],decls:66,vars:0,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/compression.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","compression"],["appAnchor","","id","use-with-express-default"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/compression"],[1,"language-bash"],[1,"language-typescript"],["appAnchor","","id","use-with-fastify"],["rel","nofollow","target","_blank","href","https://github.com/fastify/fastify-compress"]],template:function(e,t){1&e&&(r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"Compression"),r.Hb(),r.Ib(7,"p"),r.lc(8,"Compression can greatly decrease the size of the response body, thereby increasing the speed of a web app."),r.Hb(),r.Ib(9,"p"),r.lc(10,"For "),r.Ib(11,"strong"),r.lc(12,"high-traffic"),r.Hb(),r.lc(13," websites in production, it is strongly recommended to offload compression from the application server - typically in a reverse proxy (e.g., Nginx). In that case, you should not use compression middleware."),r.Hb(),r.Ib(14,"h4",6),r.Ib(15,"span"),r.lc(16,"Use with Express (default)"),r.Hb(),r.Hb(),r.Ib(17,"p"),r.lc(18,"Use the "),r.Ib(19,"a",7),r.lc(20,"compression"),r.Hb(),r.lc(21," middleware package to enable gzip compression."),r.Hb(),r.Ib(22,"p"),r.lc(23,"First install the required package:"),r.Hb(),r.Ib(24,"pre"),r.Ib(25,"code",8),r.lc(26,"\n$ npm i --save compression"),r.Hb(),r.Hb(),r.Ib(27,"p"),r.lc(28,"Once the installation is complete, apply the compression middleware as global middleware."),r.Hb(),r.Ib(29,"pre"),r.Ib(30,"code",9),r.lc(31,"\nimport * as compression from 'compression';\n// somewhere in your initialization file\napp.use(compression());"),r.Hb(),r.Hb(),r.Ib(32,"h4",10),r.Ib(33,"span"),r.lc(34,"Use with Fastify"),r.Hb(),r.Hb(),r.Ib(35,"p"),r.lc(36,"If using the "),r.Ib(37,"code"),r.lc(38,"FastifyAdapter"),r.Hb(),r.lc(39,", you'll want to use "),r.Ib(40,"a",11),r.lc(41,"fastify-compress"),r.Hb(),r.lc(42,":"),r.Hb(),r.Ib(43,"pre"),r.Ib(44,"code",8),r.lc(45,"\n$ npm i --save fastify-compress"),r.Hb(),r.Hb(),r.Ib(46,"p"),r.lc(47,"Once the installation is complete, apply the fastify-compress middleware as global middleware."),r.Hb(),r.Ib(48,"pre"),r.Ib(49,"code",9),r.lc(50,"\nimport * as compression from 'fastify-compress';\n// somewhere in your initialization file\napp.register(compression);"),r.Hb(),r.Hb(),r.Ib(51,"p"),r.lc(52,"By default, fastify-compress will use Brotli compression (on Node >= 11.7.0) when browsers indicate support for the encoding. While Brotli is quite efficient in terms of compression ratio, it's also quite slow. Due to this, you may want to tell fastify-compress to only use deflate and gzip to compress responses; you'll end up with larger responses but they'll be delivered much more quickly."),r.Hb(),r.Ib(53,"p"),r.lc(54,"To specify encodings, provide a second argument to "),r.Ib(55,"code"),r.lc(56,"app.register"),r.Hb(),r.lc(57,":"),r.Hb(),r.Ib(58,"pre"),r.Ib(59,"code",9),r.lc(60,"\napp.register(compression, { encodings: ['gzip', 'deflate'] });"),r.Hb(),r.Hb(),r.Ib(61,"p"),r.lc(62,"The above tells "),r.Ib(63,"code"),r.lc(64,"fastify-compress"),r.Hb(),r.lc(65," to only use gzip and deflate encodings, preferring gzip if the client supports both."),r.Hb(),r.Hb())},directives:[l.a],encapsulation:2,changeDetection:0}),e})();const f=r.Kb(H);var g=o("rOQQ");let y=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return v(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-configuration"]],features:[r.tb],decls:727,vars:42,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/configuration.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","configuration"],["rel","nofollow","target","_blank","href","https://12factor.net/config"],["appAnchor","","id","installation"],[1,"language-bash"],[1,"info"],["rel","nofollow","target","_blank","href","https://github.com/motdotla/dotenv"],["appAnchor","","id","getting-started"],[1,"filename"],["appc70a5cfe9d63fb6d713b71780b9ea5509b7bd1c9",""],[1,"language-typescript"],[1,"language-json"],["appAnchor","","id","custom-env-file-path"],["appAnchor","","id","disable-env-variables-loading"],["appAnchor","","id","use-module-globally"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/modules#global-modules"],["appAnchor","","id","custom-configuration-files"],["href","techniques/configuration#getting-started"],["appb5bc5964b3fe7e5f62ba371d3cf174aba6fc4ea5",""],["appAnchor","","id","using-the-configservice"],["appedd862ae1bb9f5802626d40eed30eb4d97665d0e",""],["href","techniques/configuration#custom-configuration-files"],[1,"warning"],["appAnchor","","id","configuration-namespaces"],["app65cf188fbab78d2b831d820d9544addd7ca2fb2e",""],["appAnchor","","id","partial-registration"],["appAnchor","","id","schema-validation"],["rel","nofollow","target","_blank","href","https://github.com/hapijs/joi"],["rel","nofollow","target","_blank","href","https://hapi.dev/family/joi/?v=17.0.2#install"],["rel","nofollow","target","_blank","href","https://github.com/hapijs/joi/issues/2266#issuecomment-571667769"],["app373451cffcef7c1a5f0332bde1b192e597a3c779",""],["rel","nofollow","target","_blank","href","https://hapi.dev/family/joi/?v=17.0.2#example"],["rel","nofollow","target","_blank","href","https://hapi.dev/family/joi/api/?v=17.0.2#anyvalidvalues---aliases-equal"],["appd13d0cb4f94427fcd3917b04ebf36a5df788e7e5",""],["appAnchor","","id","custom-getter-functions"],["app033eed4da7bdb2462bc9dec36fba9f83db980db9",""],["app60275d20f740ddedc5579d5428082ca4a1cfcf5e",""],["appAnchor","","id","expandable-variables"],["rel","nofollow","target","_blank","href","https://github.com/motdotla/dotenv-expand"],["appf944c74ffc0a01de0eb9f860e31b4f98d94a1943",""],["appAnchor","","id","using-in-the-maints"]],template:function(e,t){if(1&e){r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"Configuration"),r.Hb(),r.Ib(7,"p"),r.lc(8,"Applications often run in different "),r.Ib(9,"strong"),r.lc(10,"environments"),r.Hb(),r.lc(11,". Depending on the environment, different configuration settings should be used. For example, usually the local environment relies on specific database credentials, valid only for the local DB instance. The production environment would use a separate set of DB credentials. Since configuration variables change, best practice is to "),r.Ib(12,"a",6),r.lc(13,"store configuration variables"),r.Hb(),r.lc(14," in the environment."),r.Hb(),r.Ib(15,"p"),r.lc(16,"Externally defined environment variables are visible inside Node.js through the "),r.Ib(17,"code"),r.lc(18,"process.env"),r.Hb(),r.lc(19," global. We could try to solve the problem of multiple environments by setting the environment variables separately in each environment. This can quickly get unwieldy, especially in the development and testing environments where these values need to be easily mocked and/or changed."),r.Hb(),r.Ib(20,"p"),r.lc(21,"In Node.js applications, it's common to use "),r.Ib(22,"code"),r.lc(23,".env"),r.Hb(),r.lc(24," files, holding key-value pairs where each key represents a particular value, to represent each environment. Running an app in different environments is then just a matter of swapping in the correct "),r.Ib(25,"code"),r.lc(26,".env"),r.Hb(),r.lc(27," file."),r.Hb(),r.Ib(28,"p"),r.lc(29,"A good approach for using this technique in Nest is to create a "),r.Ib(30,"code"),r.lc(31,"ConfigModule"),r.Hb(),r.lc(32," that exposes a "),r.Ib(33,"code"),r.lc(34,"ConfigService"),r.Hb(),r.lc(35," which loads the appropriate "),r.Ib(36,"code"),r.lc(37,".env"),r.Hb(),r.lc(38," file. While you may choose to write such a module yourself, for convenience Nest provides the "),r.Ib(39,"code"),r.lc(40,"@nestjs/config"),r.Hb(),r.lc(41," package out-of-the box. We'll cover this package in the current chapter."),r.Hb(),r.Ib(42,"h4",7),r.Ib(43,"span"),r.lc(44,"Installation"),r.Hb(),r.Hb(),r.Ib(45,"p"),r.lc(46,"To begin using it, we first install the required dependency."),r.Hb(),r.Ib(47,"pre"),r.Ib(48,"code",8),r.lc(49,"\n$ npm i --save @nestjs/config"),r.Hb(),r.Hb(),r.Ib(50,"blockquote",9),r.Ib(51,"strong"),r.lc(52,"Hint"),r.Hb(),r.lc(53," The "),r.Ib(54,"code"),r.lc(55,"@nestjs/config"),r.Hb(),r.lc(56," package internally uses "),r.Ib(57,"a",10),r.lc(58,"dotenv"),r.Hb(),r.lc(59,".\n"),r.Hb(),r.Ib(60,"h4",11),r.Ib(61,"span"),r.lc(62,"Getting started"),r.Hb(),r.Hb(),r.Ib(63,"p"),r.lc(64,"Once the installation process is complete, we can import the "),r.Ib(65,"code"),r.lc(66,"ConfigModule"),r.Hb(),r.lc(67,". Typically, we'll import it into the root "),r.Ib(68,"code"),r.lc(69,"AppModule"),r.Hb(),r.lc(70," and control its behavior using the "),r.Ib(71,"code"),r.lc(72,".forRoot()"),r.Hb(),r.lc(73," static method. During this step, environment variable key/value pairs are parsed and resolved. Later, we'll see several options for accessing the "),r.Ib(74,"code"),r.lc(75,"ConfigService"),r.Hb(),r.lc(76," class of the "),r.Ib(77,"code"),r.lc(78,"ConfigModule"),r.Hb(),r.lc(79," in our other feature modules."),r.Hb(),r.Ib(80,"span",12),r.lc(81),r.Ub(82,"extension"),r.Gb(83,"app-tabs",null,13),r.Hb(),r.Ib(85,"pre"),r.Ib(86,"code",14),r.lc(87,"\nimport { Module } from '@nestjs/common';\nimport { ConfigModule } from '@nestjs/config';\n\n@Module({\n  imports: [ConfigModule.forRoot()],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(88,"p"),r.lc(89,"The above code will load and parse a "),r.Ib(90,"code"),r.lc(91,".env"),r.Hb(),r.lc(92," file from the default location (the project root directory), merge key/value pairs from the "),r.Ib(93,"code"),r.lc(94,".env"),r.Hb(),r.lc(95," file with environment variables assigned to "),r.Ib(96,"code"),r.lc(97,"process.env"),r.Hb(),r.lc(98,", and store the result in a private structure that you can access through the "),r.Ib(99,"code"),r.lc(100,"ConfigService"),r.Hb(),r.lc(101,". The "),r.Ib(102,"code"),r.lc(103,"forRoot()"),r.Hb(),r.lc(104," method registers the "),r.Ib(105,"code"),r.lc(106,"ConfigService"),r.Hb(),r.lc(107," provider, which provides a "),r.Ib(108,"code"),r.lc(109,"get()"),r.Hb(),r.lc(110," method for reading these parsed/merged configuration variables. Since "),r.Ib(111,"code"),r.lc(112,"@nestjs/config"),r.Hb(),r.lc(113," relies on "),r.Ib(114,"a",10),r.lc(115,"dotenv"),r.Hb(),r.lc(116,", it uses that package's rules for resolving conflicts in environment variable names. When a key exists both in the runtime environment as an environment variable (e.g., via OS shell exports like "),r.Ib(117,"code"),r.lc(118,"export DATABASE_USER=test"),r.Hb(),r.lc(119,") and in a "),r.Ib(120,"code"),r.lc(121,".env"),r.Hb(),r.lc(122," file, the runtime environment variable takes precedence."),r.Hb(),r.Ib(123,"p"),r.lc(124,"A sample "),r.Ib(125,"code"),r.lc(126,".env"),r.Hb(),r.lc(127," file looks something like this:"),r.Hb(),r.Ib(128,"pre"),r.Ib(129,"code",15),r.lc(130,"\nDATABASE_USER=test\nDATABASE_PASSWORD=test"),r.Hb(),r.Hb(),r.Ib(131,"h4",16),r.Ib(132,"span"),r.lc(133,"Custom env file path"),r.Hb(),r.Hb(),r.Ib(134,"p"),r.lc(135,"By default, the package looks for a "),r.Ib(136,"code"),r.lc(137,".env"),r.Hb(),r.lc(138," file in the root directory of the application. To specify another path for the "),r.Ib(139,"code"),r.lc(140,".env"),r.Hb(),r.lc(141," file, set the "),r.Ib(142,"code"),r.lc(143,"envFilePath"),r.Hb(),r.lc(144," property of an (optional) options object you pass to "),r.Ib(145,"code"),r.lc(146,"forRoot()"),r.Hb(),r.lc(147,", as follows:"),r.Hb(),r.Ib(148,"pre"),r.Ib(149,"code",14),r.lc(150,"\nConfigModule.forRoot({\n  envFilePath: '.development.env',\n});"),r.Hb(),r.Hb(),r.Ib(151,"p"),r.lc(152,"You can also specify multiple paths for "),r.Ib(153,"code"),r.lc(154,".env"),r.Hb(),r.lc(155," files like this:"),r.Hb(),r.Ib(156,"pre"),r.Ib(157,"code",14),r.lc(158,"\nConfigModule.forRoot({\n  envFilePath: ['.env.development.local', '.env.development'],\n});"),r.Hb(),r.Hb(),r.Ib(159,"p"),r.lc(160,"If a variable is found in multiple files, the first one takes precedence."),r.Hb(),r.Ib(161,"h4",17),r.Ib(162,"span"),r.lc(163,"Disable env variables loading"),r.Hb(),r.Hb(),r.Ib(164,"p"),r.lc(165,"If you don't want to load the "),r.Ib(166,"code"),r.lc(167,".env"),r.Hb(),r.lc(168," file, but instead would like to simply access environment variables from the runtime environment (as with OS shell exports like "),r.Ib(169,"code"),r.lc(170,"export DATABASE_USER=test"),r.Hb(),r.lc(171,"), set the options object's "),r.Ib(172,"code"),r.lc(173,"ignoreEnvFile"),r.Hb(),r.lc(174," property to "),r.Ib(175,"code"),r.lc(176,"true"),r.Hb(),r.lc(177,", as follows:"),r.Hb(),r.Ib(178,"pre"),r.Ib(179,"code",14),r.lc(180,"\nConfigModule.forRoot({\n  ignoreEnvFile: true,\n});"),r.Hb(),r.Hb(),r.Ib(181,"h4",18),r.Ib(182,"span"),r.lc(183,"Use module globally"),r.Hb(),r.Hb(),r.Ib(184,"p"),r.lc(185,"When you want to use "),r.Ib(186,"code"),r.lc(187,"ConfigModule"),r.Hb(),r.lc(188," in other modules, you'll need to import it (as is standard with any Nest module). Alternatively, declare it as a "),r.Ib(189,"a",19),r.lc(190,"global module"),r.Hb(),r.lc(191," by setting the options object's "),r.Ib(192,"code"),r.lc(193,"isGlobal"),r.Hb(),r.lc(194," property to "),r.Ib(195,"code"),r.lc(196,"true"),r.Hb(),r.lc(197,", as shown below. In that case, you will not need to import "),r.Ib(198,"code"),r.lc(199,"ConfigModule"),r.Hb(),r.lc(200," in other modules once it's been loaded in the root module (e.g., "),r.Ib(201,"code"),r.lc(202,"AppModule"),r.Hb(),r.lc(203,")."),r.Hb(),r.Ib(204,"pre"),r.Ib(205,"code",14),r.lc(206,"\nConfigModule.forRoot({\n  isGlobal: true,\n});"),r.Hb(),r.Hb(),r.Ib(207,"h4",20),r.Ib(208,"span"),r.lc(209,"Custom configuration files"),r.Hb(),r.Hb(),r.Ib(210,"p"),r.lc(211,"For more complex projects, you may utilize custom configuration files to return nested configuration objects. This allows you to group related configuration settings by function (e.g., database-related settings), and to store related settings in individual files to help manage them independently."),r.Hb(),r.Ib(212,"p"),r.lc(213,"A custom configuration file exports a factory function that returns a configuration object. The configuration object can be any arbitrarily nested plain JavaScript object. The "),r.Ib(214,"code"),r.lc(215,"process.env"),r.Hb(),r.lc(216," object will contain the fully resolved environment variable key/value pairs (with "),r.Ib(217,"code"),r.lc(218,".env"),r.Hb(),r.lc(219," file and externally defined variables resolved and merged as described "),r.Ib(220,"a",21),r.lc(221,"above"),r.Hb(),r.lc(222,"). Since you control the returned configuration object, you can add any required logic to cast values to an appropriate type, set default values, etc. For example:"),r.Hb(),r.Ib(223,"span",12),r.lc(224),r.Ub(225,"extension"),r.Gb(226,"app-tabs",null,22),r.Hb(),r.Ib(228,"pre"),r.Ib(229,"code",14),r.lc(230,"\nexport default () => ({\n  port: parseInt(process.env.PORT, 10) || 3000,\n  database: {\n    host: process.env.DATABASE_HOST,\n    port: parseInt(process.env.DATABASE_PORT, 10) || 5432\n  }\n});"),r.Hb(),r.Hb(),r.Ib(231,"p"),r.lc(232,"We load this file using the "),r.Ib(233,"code"),r.lc(234,"load"),r.Hb(),r.lc(235," property of the options object we pass to the "),r.Ib(236,"code"),r.lc(237,"ConfigModule.forRoot()"),r.Hb(),r.lc(238," method:"),r.Hb(),r.Ib(239,"pre"),r.Ib(240,"code",14),r.lc(241,"\nimport configuration from './config/configuration';\n\n@Module({\n  imports: [\n    ConfigModule.forRoot({\n      load: [configuration],\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(242,"blockquote",9),r.Ib(243,"strong"),r.lc(244,"Notice"),r.Hb(),r.lc(245," The value assigned to the "),r.Ib(246,"code"),r.lc(247,"load"),r.Hb(),r.lc(248," property is an array, allowing you to load multiple configuration files (e.g. "),r.Ib(249,"code"),r.lc(250,"load: [databaseConfig, authConfig]"),r.Hb(),r.lc(251,")\n"),r.Hb(),r.Ib(252,"p"),r.Gb(253,"app-banner-enterprise"),r.Hb(),r.Ib(254,"h4",23),r.Ib(255,"span"),r.lc(256,"Using the "),r.Ib(257,"code"),r.lc(258,"ConfigService"),r.Hb(),r.Hb(),r.Hb(),r.Ib(259,"p"),r.lc(260,"To access configuration values from our "),r.Ib(261,"code"),r.lc(262,"ConfigService"),r.Hb(),r.lc(263,", we first need to inject "),r.Ib(264,"code"),r.lc(265,"ConfigService"),r.Hb(),r.lc(266,". As with any provider, we need to import its containing module - the "),r.Ib(267,"code"),r.lc(268,"ConfigModule"),r.Hb(),r.lc(269," - into the module that will use it (unless you set the "),r.Ib(270,"code"),r.lc(271,"isGlobal"),r.Hb(),r.lc(272," property in the options object passed to the "),r.Ib(273,"code"),r.lc(274,"ConfigModule.forRoot()"),r.Hb(),r.lc(275," method to "),r.Ib(276,"code"),r.lc(277,"true"),r.Hb(),r.lc(278,"). Import it into a feature module as shown below."),r.Hb(),r.Ib(279,"span",12),r.lc(280),r.Ub(281,"extension"),r.Gb(282,"app-tabs",null,24),r.Hb(),r.Ib(284,"pre"),r.Ib(285,"code",14),r.lc(286,"\n@Module({\n  imports: [ConfigModule],\n  // ...\n})"),r.Hb(),r.Hb(),r.Ib(287,"p"),r.lc(288,"Then we can inject it using standard constructor injection:"),r.Hb(),r.Ib(289,"pre"),r.Ib(290,"code",14),r.lc(291,"\nconstructor(private configService: ConfigService) {}"),r.Hb(),r.Hb(),r.Ib(292,"p"),r.lc(293,"And use it in our class:"),r.Hb(),r.Ib(294,"pre"),r.Ib(295,"code",14),r.lc(296,"\n// get an environment variable\nconst dbUser = this.configService.get<string>('DATABASE_USER');\n\n// get a custom configuration value\nconst dbHost = this.configService.get<string>('database.host');"),r.Hb(),r.Hb(),r.Ib(297,"p"),r.lc(298,"As shown above, use the "),r.Ib(299,"code"),r.lc(300,"configService.get()"),r.Hb(),r.lc(301," method to get a simple environment variable by passing the variable name. You can do TypeScript type hinting by passing the type, as shown above (e.g., "),r.Ib(302,"code"),r.lc(303,"get<string>(...)"),r.Hb(),r.lc(304,"). The "),r.Ib(305,"code"),r.lc(306,"get()"),r.Hb(),r.lc(307," method can also traverse a nested custom configuration object (created via a "),r.Ib(308,"a",25),r.lc(309,"Custom configuration file"),r.Hb(),r.lc(310,"), as shown in the second example above."),r.Hb(),r.Ib(311,"p"),r.lc(312,"You can also get the whole nested custom configuration object using an interface as the type hint:"),r.Hb(),r.Ib(313,"pre"),r.Ib(314,"code",14),r.lc(315,"\ninterface DatabaseConfig {\n  host: string;\n  port: number;\n}\n\nconst dbConfig = this.configService.get<DatabaseConfig>('database');\n\n// you can now use `dbConfig.port` and `dbConfig.host`\nconst port = dbConfig.port;"),r.Hb(),r.Hb(),r.Ib(316,"p"),r.lc(317,"The "),r.Ib(318,"code"),r.lc(319,"get()"),r.Hb(),r.lc(320," method also takes an optional second argument defining a default value, which will be returned when the key doesn't exist, as shown below:"),r.Hb(),r.Ib(321,"pre"),r.Ib(322,"code",14),r.lc(323,"\n// use \"localhost\" when \"database.host\" is not defined\nconst dbHost = this.configService.get<string>('database.host', 'localhost');"),r.Hb(),r.Hb(),r.Ib(324,"p"),r.Ib(325,"code"),r.lc(326,"ConfigService"),r.Hb(),r.lc(327," has an optional generic (type argument) to help prevent accessing a config property that does not exist. Use it as shown below:"),r.Hb(),r.Ib(328,"pre"),r.Ib(329,"code",14),r.lc(330,"\ninterface EnvironmentVariables {\n  PORT: number;\n  TIMEOUT: string;\n}\n\n// somewhere in the code\nconstructor(private configService: ConfigService<EnvironmentVariables>) {\n  // this is valid\n  const port = this.configService.get<number>('PORT');\n\n  // this is invalid as URL is not a property on the EnvironmentVariables interface\n  const url = this.configService.get<string>('URL');\n}"),r.Hb(),r.Hb(),r.Ib(331,"blockquote",26),r.Ib(332,"strong"),r.lc(333,"Notice"),r.Hb(),r.lc(334," If you have nested properties in your config, like in the "),r.Ib(335,"code"),r.lc(336,"database.host"),r.Hb(),r.lc(337," example above, the interface must have a matching "),r.Ib(338,"code"),r.lc(339,"'database.host': string;"),r.Hb(),r.lc(340," property. Otherwise a TypeScript error will be thrown.\n"),r.Hb(),r.Ib(341,"h4",27),r.Ib(342,"span"),r.lc(343,"Configuration namespaces"),r.Hb(),r.Hb(),r.Ib(344,"p"),r.lc(345,"The "),r.Ib(346,"code"),r.lc(347,"ConfigModule"),r.Hb(),r.lc(348," allows you to define and load multiple custom configuration files, as shown in "),r.Ib(349,"a",25),r.lc(350,"Custom configuration files"),r.Hb(),r.lc(351,' above. You can manage complex configuration object hierarchies with nested configuration objects as shown in that section. Alternatively, you can return a "namespaced" configuration object with the '),r.Ib(352,"code"),r.lc(353,"registerAs()"),r.Hb(),r.lc(354," function as follows:"),r.Hb(),r.Ib(355,"span",12),r.lc(356),r.Ub(357,"extension"),r.Gb(358,"app-tabs",null,28),r.Hb(),r.Ib(360,"pre"),r.Ib(361,"code",14),r.lc(362,"\nexport default registerAs('database', () => ({\n  host: process.env.DATABASE_HOST,\n  port: process.env.DATABASE_PORT || 5432\n}));"),r.Hb(),r.Hb(),r.Ib(363,"p"),r.lc(364,"As with custom configuration files, inside your "),r.Ib(365,"code"),r.lc(366,"registerAs()"),r.Hb(),r.lc(367," factory function, the "),r.Ib(368,"code"),r.lc(369,"process.env"),r.Hb(),r.lc(370," object will contain the fully resolved environment variable key/value pairs (with "),r.Ib(371,"code"),r.lc(372,".env"),r.Hb(),r.lc(373," file and externally defined variables resolved and merged as described "),r.Ib(374,"a",21),r.lc(375,"above"),r.Hb(),r.lc(376,")."),r.Hb(),r.Ib(377,"blockquote",9),r.Ib(378,"strong"),r.lc(379,"Hint"),r.Hb(),r.lc(380," The "),r.Ib(381,"code"),r.lc(382,"registerAs"),r.Hb(),r.lc(383," function is exported from the "),r.Ib(384,"code"),r.lc(385,"@nestjs/config"),r.Hb(),r.lc(386," package.\n"),r.Hb(),r.Ib(387,"p"),r.lc(388,"Load a namespaced configuration with the "),r.Ib(389,"code"),r.lc(390,"load"),r.Hb(),r.lc(391," property of the "),r.Ib(392,"code"),r.lc(393,"forRoot()"),r.Hb(),r.lc(394," method's options object, in the same way you load a custom configuration file:"),r.Hb(),r.Ib(395,"pre"),r.Ib(396,"code",14),r.lc(397,"\nimport databaseConfig from './config/database.config';\n\n@Module({\n  imports: [\n    ConfigModule.forRoot({\n      load: [databaseConfig],\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(398,"p"),r.lc(399,"Now, to get the "),r.Ib(400,"code"),r.lc(401,"host"),r.Hb(),r.lc(402," value from the "),r.Ib(403,"code"),r.lc(404,"database"),r.Hb(),r.lc(405," namespace, use dot notation. Use "),r.Ib(406,"code"),r.lc(407,"'database'"),r.Hb(),r.lc(408," as the prefix to the property name, corresponding to the name of the namespace (passed as the first argument to the "),r.Ib(409,"code"),r.lc(410,"registerAs()"),r.Hb(),r.lc(411," function):"),r.Hb(),r.Ib(412,"pre"),r.Ib(413,"code",14),r.lc(414,"\nconst dbHost = this.configService.get<string>('database.host');"),r.Hb(),r.Hb(),r.Ib(415,"p"),r.lc(416,"A reasonable alternative is to inject the "),r.Ib(417,"code"),r.lc(418,"database"),r.Hb(),r.lc(419," namespace directly. This allows us to benefit from strong typing:"),r.Hb(),r.Ib(420,"pre"),r.Ib(421,"code",14),r.lc(422,"\nconstructor(\n  @Inject(databaseConfig.KEY)\n  private dbConfig: ConfigType<typeof databaseConfig>,\n) {}"),r.Hb(),r.Hb(),r.Ib(423,"blockquote",9),r.Ib(424,"strong"),r.lc(425,"Hint"),r.Hb(),r.lc(426," The "),r.Ib(427,"code"),r.lc(428,"ConfigType"),r.Hb(),r.lc(429," is exported from the "),r.Ib(430,"code"),r.lc(431,"@nestjs/config"),r.Hb(),r.lc(432," package.\n"),r.Hb(),r.Ib(433,"h4",29),r.Ib(434,"span"),r.lc(435,"Partial registration"),r.Hb(),r.Hb(),r.Ib(436,"p"),r.lc(437,"Thus far, we've processed configuration files in our root module (e.g., "),r.Ib(438,"code"),r.lc(439,"AppModule"),r.Hb(),r.lc(440,"), with the "),r.Ib(441,"code"),r.lc(442,"forRoot()"),r.Hb(),r.lc(443," method. Perhaps you have a more complex project structure, with feature-specific configuration files located in multiple different directories. Rather than load all these files in the root module, the "),r.Ib(444,"code"),r.lc(445,"@nestjs/config"),r.Hb(),r.lc(446," package provides a feature called "),r.Ib(447,"strong"),r.lc(448,"partial registration"),r.Hb(),r.lc(449,", which references only the configuration files associated with each feature module. Use the "),r.Ib(450,"code"),r.lc(451,"forFeature()"),r.Hb(),r.lc(452," static method within a feature module to perform this partial registration, as follows:"),r.Hb(),r.Ib(453,"pre"),r.Ib(454,"code",14),r.lc(455,"\nimport databaseConfig from './config/database.config';\n\n@Module({\n  imports: [ConfigModule.forFeature(databaseConfig)],\n})\nexport class DatabaseModule {}"),r.Hb(),r.Hb(),r.Ib(456,"blockquote",9),r.Ib(457,"strong"),r.lc(458,"Warning"),r.Hb(),r.lc(459," In some circumstances, you may need to access properties loaded via partial registration using the "),r.Ib(460,"code"),r.lc(461,"onModuleInit()"),r.Hb(),r.lc(462," hook, rather than in a constructor. This is because the "),r.Ib(463,"code"),r.lc(464,"forFeature()"),r.Hb(),r.lc(465," method is run during module initialization, and the order of module initialization is indeterminate. If you access values loaded this way by another module, in a constructor, the module that the configuration depends upon may not yet have initialized. The "),r.Ib(466,"code"),r.lc(467,"onModuleInit()"),r.Hb(),r.lc(468," method runs only after all modules it depends upon have been initialized, so this technique is safe.\n"),r.Hb(),r.Ib(469,"h4",30),r.Ib(470,"span"),r.lc(471,"Schema validation"),r.Hb(),r.Hb(),r.Ib(472,"p"),r.lc(473,"It is standard practice to throw an exception during application startup if required environment variables haven't been provided or if they don't meet certain validation rules. The "),r.Ib(474,"code"),r.lc(475,"@nestjs/config"),r.Hb(),r.lc(476," package enables use of the "),r.Ib(477,"a",31),r.lc(478,"Joi"),r.Hb(),r.lc(479," npm package to support this type of validation. With Joi, you define an object schema and validate JavaScript objects against it."),r.Hb(),r.Ib(480,"p"),r.lc(481,"Install Joi (and its types, for "),r.Ib(482,"strong"),r.lc(483,"TypeScript"),r.Hb(),r.lc(484," users):"),r.Hb(),r.Ib(485,"pre"),r.Ib(486,"code",8),r.lc(487,"\n$ npm install --save @hapi/joi\n$ npm install --save-dev @types/hapi__joi"),r.Hb(),r.Hb(),r.Ib(488,"blockquote",26),r.Ib(489,"strong"),r.lc(490,"Notice"),r.Hb(),r.lc(491," The latest version of "),r.Ib(492,"code"),r.lc(493,"@hapi/joi"),r.Hb(),r.lc(494," requires you to be running Node v12 or later. For older versions of node, please install "),r.Ib(495,"code"),r.lc(496,"v16.1.8"),r.Hb(),r.lc(497,". This is mainly after the release of "),r.Ib(498,"code"),r.lc(499,"v17.0.2"),r.Hb(),r.lc(500," which causes errors during build time. For more information, please refer to "),r.Ib(501,"a",32),r.lc(502,"their documentation"),r.Hb(),r.lc(503," & this "),r.Ib(504,"a",33),r.lc(505,"github issue"),r.Hb(),r.lc(506,".\n"),r.Hb(),r.Ib(507,"p"),r.lc(508,"Now we can define a Joi validation schema and pass it via the "),r.Ib(509,"code"),r.lc(510,"validationSchema"),r.Hb(),r.lc(511," property of the "),r.Ib(512,"code"),r.lc(513,"forRoot()"),r.Hb(),r.lc(514," method's options object, as shown below:"),r.Hb(),r.Ib(515,"span",12),r.lc(516),r.Ub(517,"extension"),r.Gb(518,"app-tabs",null,34),r.Hb(),r.Ib(520,"pre"),r.Ib(521,"code",14),r.lc(522,"\nimport * as Joi from '@hapi/joi';\n\n@Module({\n  imports: [\n    ConfigModule.forRoot({\n      validationSchema: Joi.object({\n        NODE_ENV: Joi.string()\n          .valid('development', 'production', 'test', 'provision')\n          .default('development'),\n        PORT: Joi.number().default(3000),\n      }),\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(523,"p"),r.lc(524,"By default, all schema keys are considered optional. Here, we set default values for "),r.Ib(525,"code"),r.lc(526,"NODE_ENV"),r.Hb(),r.lc(527," and "),r.Ib(528,"code"),r.lc(529,"PORT"),r.Hb(),r.lc(530," which will be used if we don't provide these variables in the environment ("),r.Ib(531,"code"),r.lc(532,".env"),r.Hb(),r.lc(533," file or process environment). Alternatively, we can use the "),r.Ib(534,"code"),r.lc(535,"required()"),r.Hb(),r.lc(536," validation method to require that a value must be defined in the environment ("),r.Ib(537,"code"),r.lc(538,".env"),r.Hb(),r.lc(539," file or process environment). In this case, the validation step will throw an exception if we don't provide the variable in the environment. See "),r.Ib(540,"a",35),r.lc(541,"Joi validation methods"),r.Hb(),r.lc(542," for more on how to construct validation schemas."),r.Hb(),r.Ib(543,"p"),r.lc(544,"By default, unknown environment variables (environment variables whose keys are not present in the schema) are allowed and do not trigger a validation exception. By default, all validation errors are reported. You can alter these behaviors by passing an options object via the "),r.Ib(545,"code"),r.lc(546,"validationOptions"),r.Hb(),r.lc(547," key of the "),r.Ib(548,"code"),r.lc(549,"forRoot()"),r.Hb(),r.lc(550," options object. This options object can contain any of the standard validation options properties provided by "),r.Ib(551,"a",36),r.lc(552,"Joi validation options"),r.Hb(),r.lc(553,". For example, to reverse the two settings above, pass options like this:"),r.Hb(),r.Ib(554,"span",12),r.lc(555),r.Ub(556,"extension"),r.Gb(557,"app-tabs",null,37),r.Hb(),r.Ib(559,"pre"),r.Ib(560,"code",14),r.lc(561,"\nimport * as Joi from '@hapi/joi';\n\n@Module({\n  imports: [\n    ConfigModule.forRoot({\n      validationSchema: Joi.object({\n        NODE_ENV: Joi.string()\n          .valid('development', 'production', 'test', 'provision')\n          .default('development'),\n        PORT: Joi.number().default(3000),\n      }),\n      validationOptions: {\n        allowUnknown: false,\n        abortEarly: true,\n      },\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(562,"p"),r.lc(563,"The "),r.Ib(564,"code"),r.lc(565,"@nestjs/config"),r.Hb(),r.lc(566," package uses default settings of:"),r.Hb(),r.Ib(567,"ul"),r.Ib(568,"li"),r.Ib(569,"code"),r.lc(570,"allowUnknown");r.Hb(),r.lc(571,": controls whether or not to allow unknown keys in the environment variables. Default is "),r.Ib(572,"code"),r.lc(573,"true"),r.Hb(),r.Hb(),r.Ib(574,"li"),r.Ib(575,"code"),r.lc(576,"abortEarly"),r.Hb(),r.lc(577,": if true, stops validation on the first error; if false, returns all errors. Defaults to "),r.Ib(578,"code"),r.lc(579,"false"),r.Hb(),r.lc(580,"."),r.Hb(),r.Hb(),r.Ib(581,"p"),r.lc(582,"Note that once you decide to pass a "),r.Ib(583,"code"),r.lc(584,"validationOptions"),r.Hb(),r.lc(585," object, any settings you do not explicitly pass will default to "),r.Ib(586,"code"),r.lc(587,"Joi"),r.Hb(),r.lc(588," standard defaults (not the "),r.Ib(589,"code"),r.lc(590,"@nestjs/config"),r.Hb(),r.lc(591," defaults). For example, if you leave "),r.Ib(592,"code"),r.lc(593,"allowUnknowns"),r.Hb(),r.lc(594," unspecified in your custom "),r.Ib(595,"code"),r.lc(596,"validationOptions"),r.Hb(),r.lc(597," object, it will have the "),r.Ib(598,"code"),r.lc(599,"Joi"),r.Hb(),r.lc(600," default value of "),r.Ib(601,"code"),r.lc(602,"false"),r.Hb(),r.lc(603,". Hence, it is probably safest to specify "),r.Ib(604,"strong"),r.lc(605,"both"),r.Hb(),r.lc(606," of these settings in your custom object."),r.Hb(),r.Ib(607,"p"),r.Gb(608,"app-banner-shop"),r.Hb(),r.Ib(609,"h4",38),r.Ib(610,"span"),r.lc(611,"Custom getter functions"),r.Hb(),r.Hb(),r.Ib(612,"p"),r.Ib(613,"code"),r.lc(614,"ConfigService"),r.Hb(),r.lc(615," defines a generic "),r.Ib(616,"code"),r.lc(617,"get()"),r.Hb(),r.lc(618," method to retrieve a configuration value by key. We may also add "),r.Ib(619,"code"),r.lc(620,"getter"),r.Hb(),r.lc(621," functions to enable a little more natural coding style:"),r.Hb(),r.Ib(622,"span",12),r.Gb(623,"app-tabs",null,39),r.Hb(),r.Ib(625,"pre"),r.Ib(626,"code",14),r.lc(627,"\n@Injectable()\nexport class ApiConfigService {\n  constructor(private configService: ConfigService) {}\n\n  get isAuthEnabled(): boolean {\n    return this.configService.get('AUTH_ENABLED') === 'true';\n  }\n}"),r.Hb(),r.Hb(),r.Ib(628,"pre"),r.Ib(629,"code",14),r.lc(630,"\n@Dependencies(ConfigService)\n@Injectable()\nexport class ApiConfigService {\n  constructor(configService) {\n    this.configService = configService;\n  }\n\n  get isAuthEnabled() {\n    return this.configService.get('AUTH_ENABLED') === 'true';\n  }\n}"),r.Hb(),r.Hb(),r.Ib(631,"p"),r.lc(632,"Now we can use the getter function as follows:"),r.Hb(),r.Ib(633,"span",12),r.lc(634),r.Ub(635,"extension"),r.Gb(636,"app-tabs",null,40),r.Hb(),r.Ib(638,"pre"),r.Ib(639,"code",14),r.lc(640,"\n@Injectable()\nexport class AppService {\n  constructor(apiConfigService: ApiConfigService) {\n    if (apiConfigService.isAuthEnabled) {\n      // Authentication is enabled\n    }\n  }\n}"),r.Hb(),r.Hb(),r.Ib(641,"pre"),r.Ib(642,"code",14),r.lc(643,"\n@Dependencies(ApiConfigService)\n@Injectable()\nexport class AppService {\n  constructor(apiConfigService) {\n    if (apiConfigService.isAuthEnabled) {\n      // Authentication is enabled\n    }\n  }\n}"),r.Hb(),r.Hb(),r.Ib(644,"h4",41),r.Ib(645,"span"),r.lc(646,"Expandable variables"),r.Hb(),r.Hb(),r.Ib(647,"p"),r.lc(648,"The "),r.Ib(649,"code"),r.lc(650,"@nestjs/config"),r.Hb(),r.lc(651," package supports environment variable expansion. With this technique, you can create nested environment variables, where one variable is referred to within the definition of another. For example:"),r.Hb(),r.Ib(652,"pre"),r.Ib(653,"code",15),r.lc(654,"\nAPP_URL=mywebsite.com\nSUPPORT_EMAIL=support@${APP_URL}"),r.Hb(),r.Hb(),r.Ib(655,"p"),r.lc(656,"With this construction, the variable "),r.Ib(657,"code"),r.lc(658,"SUPPORT_EMAIL"),r.Hb(),r.lc(659," resolves to "),r.Ib(660,"code"),r.lc(661,"'support@mywebsite.com'"),r.Hb(),r.lc(662,". Note the use of the "),r.Ib(663,"code"),r.lc(664),r.Hb(),r.lc(665," syntax to trigger resolving the value of the variable "),r.Ib(666,"code"),r.lc(667,"APP_URL"),r.Hb(),r.lc(668," inside the definition of "),r.Ib(669,"code"),r.lc(670,"SUPPORT_EMAIL"),r.Hb(),r.lc(671,"."),r.Hb(),r.Ib(672,"blockquote",9),r.Ib(673,"strong"),r.lc(674,"Hint"),r.Hb(),r.lc(675," For this feature, "),r.Ib(676,"code"),r.lc(677,"@nestjs/config"),r.Hb(),r.lc(678," package internally uses "),r.Ib(679,"a",42),r.lc(680,"dotenv-expand"),r.Hb(),r.lc(681,".\n"),r.Hb(),r.Ib(682,"p"),r.lc(683,"Enable environment variable expansion using the "),r.Ib(684,"code"),r.lc(685,"expandVariables"),r.Hb(),r.lc(686," property in the options object passed to the "),r.Ib(687,"code"),r.lc(688,"forRoot()"),r.Hb(),r.lc(689," method of the "),r.Ib(690,"code"),r.lc(691,"ConfigModule"),r.Hb(),r.lc(692,", as shown below:"),r.Hb(),r.Ib(693,"span",12),r.lc(694),r.Ub(695,"extension"),r.Gb(696,"app-tabs",null,43),r.Hb(),r.Ib(698,"pre"),r.Ib(699,"code",14),r.lc(700,"\n@Module({\n  imports: [\n    ConfigModule.forRoot({\n      // ...\n      expandVariables: true,\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(701,"h4",44),r.Ib(702,"span"),r.lc(703,"Using in the "),r.Ib(704,"code"),r.lc(705,"main.ts"),r.Hb(),r.Hb(),r.Hb(),r.Ib(706,"p"),r.lc(707,"While our config is a stored in a service, it can still be used in the "),r.Ib(708,"code"),r.lc(709,"main.ts"),r.Hb(),r.lc(710," file. This way, you can use it to store variables such as the application port or the CORS host."),r.Hb(),r.Ib(711,"p"),r.lc(712,"To access it, you must use the "),r.Ib(713,"code"),r.lc(714,"app.get()"),r.Hb(),r.lc(715," method, followed by the service reference:"),r.Hb(),r.Ib(716,"pre"),r.Ib(717,"code",14),r.lc(718,"\nconst configService = app.get(ConfigService);"),r.Hb(),r.Hb(),r.Ib(719,"p"),r.lc(720,"You can then use it as usual, by calling the "),r.Ib(721,"code"),r.lc(722,"get"),r.Hb(),r.lc(723," method with the configuration key:"),r.Hb(),r.Ib(724,"pre"),r.Ib(725,"code",14),r.lc(726,"\nconst port = configService.get('PORT');"),r.Hb(),r.Hb(),r.Hb()}if(2&e){const e=r.dc(84),t=r.dc(227),o=r.dc(283),n=r.dc(359),s=r.dc(519),c=r.dc(558),a=r.dc(624),l=r.dc(637),i=r.dc(697);r.vb(81),r.nc(" ",r.Vb(82,18,"app.module",e.isJsActive),"\n"),r.vb(143),r.nc(" ",r.Vb(225,21,"config/configuration",t.isJsActive),"\n"),r.vb(56),r.nc(" ",r.Vb(281,24,"feature.module",o.isJsActive),"\n"),r.vb(76),r.nc(" ",r.Vb(357,27,"config/database.config",n.isJsActive),"\n"),r.vb(160),r.nc(" ",r.Vb(517,30,"app.module",s.isJsActive),"\n"),r.vb(39),r.nc(" ",r.Vb(556,33,"app.module",c.isJsActive),"\n"),r.vb(70),r.xb("hide",a.isJsActive),r.vb(3),r.xb("hide",!a.isJsActive),r.vb(6),r.nc(" ",r.Vb(635,36,"app.service",l.isJsActive),"\n"),r.vb(4),r.xb("hide",l.isJsActive),r.vb(3),r.xb("hide",!l.isJsActive),r.vb(23),r.oc("$","{","...","}",""),r.vb(30),r.nc(" ",r.Vb(695,39,"app.module",i.isJsActive),"\n")}},directives:[l.a,i.a,d.a,g.a],pipes:[p.a],encapsulation:2,changeDetection:0}),e})();const v=r.Kb(y);let w=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return j(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-file-upload"]],features:[r.tb],decls:329,vars:16,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/file-upload.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","file-upload"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/multer"],[1,"warning"],["appAnchor","","id","basic-example"],[1,"filename"],["appd5ea24df895e305c7e7f4b10d58d8bc6eec946d2",""],[1,"language-typescript"],[1,"info"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/multer#multeropts"],["appAnchor","","id","array-of-files"],["appb1b15bea256ab33ee447ad10a7bbb5d4323d69de",""],["appAnchor","","id","multiple-files"],["app74032bdc4502a3040b23ee5322a217c2be7772de",""],["appAnchor","","id","any-files"],["app237e3636577c916e43dc2b56f34932aec509973d",""],["appAnchor","","id","default-options"],["appAnchor","","id","async-configuration"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/fundamentals/custom-providers#factory-providers-usefactory"]],template:function(e,t){if(1&e&&(r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"File upload"),r.Hb(),r.Ib(7,"p"),r.lc(8,"To handle file uploading, Nest provides a built-in module based on the "),r.Ib(9,"a",6),r.lc(10,"multer"),r.Hb(),r.lc(11," middleware package for Express. Multer handles data posted in the "),r.Ib(12,"code"),r.lc(13,"multipart/form-data"),r.Hb(),r.lc(14," format, which is primarily used for uploading files via an HTTP "),r.Ib(15,"code"),r.lc(16,"POST"),r.Hb(),r.lc(17," request. This module is fully configurable and you can adjust its behavior to your application requirements."),r.Hb(),r.Ib(18,"blockquote",7),r.Ib(19,"strong"),r.lc(20,"Warning"),r.Hb(),r.lc(21," Multer cannot process data which is not in the supported multipart format ("),r.Ib(22,"code"),r.lc(23,"multipart/form-data"),r.Hb(),r.lc(24,"). Also, note that this package is not compatible with the "),r.Ib(25,"code"),r.lc(26,"FastifyAdapter"),r.Hb(),r.lc(27,".\n"),r.Hb(),r.Ib(28,"h4",8),r.Ib(29,"span"),r.lc(30,"Basic example"),r.Hb(),r.Hb(),r.Ib(31,"p"),r.lc(32,"To upload a single file, simply tie the "),r.Ib(33,"code"),r.lc(34,"FileInterceptor()"),r.Hb(),r.lc(35," interceptor to the route handler and extract "),r.Ib(36,"code"),r.lc(37,"file"),r.Hb(),r.lc(38," from the "),r.Ib(39,"code"),r.lc(40,"request"),r.Hb(),r.lc(41," using the "),r.Ib(42,"code"),r.lc(43,"@UploadedFile()"),r.Hb(),r.lc(44," decorator."),r.Hb(),r.Ib(45,"span",9),r.Gb(46,"app-tabs",null,10),r.Hb(),r.Ib(48,"pre"),r.Ib(49,"code",11),r.lc(50,"\n@Post('upload')\n@UseInterceptors(FileInterceptor('file'))\nuploadFile(@UploadedFile() file) {\n  console.log(file);\n}"),r.Hb(),r.Hb(),r.Ib(51,"pre"),r.Ib(52,"code",11),r.lc(53,"\n@Post('upload')\n@UseInterceptors(FileInterceptor('file'))\n@Bind(UploadedFile())\nuploadFile(file) {\n  console.log(file);\n}"),r.Hb(),r.Hb(),r.Ib(54,"blockquote",12),r.Ib(55,"strong"),r.lc(56,"Hint"),r.Hb(),r.lc(57," The "),r.Ib(58,"code"),r.lc(59,"FileInterceptor()"),r.Hb(),r.lc(60," decorator is exported from the "),r.Ib(61,"code"),r.lc(62,"@nestjs/platform-express"),r.Hb(),r.lc(63," package. The "),r.Ib(64,"code"),r.lc(65,"@UploadedFile()"),r.Hb(),r.lc(66," decorator is exported from "),r.Ib(67,"code"),r.lc(68,"@nestjs/common"),r.Hb(),r.lc(69,".\n"),r.Hb(),r.Ib(70,"p"),r.lc(71,"The "),r.Ib(72,"code"),r.lc(73,"FileInterceptor()"),r.Hb(),r.lc(74," decorator takes two arguments:"),r.Hb(),r.Ib(75,"ul"),r.Ib(76,"li"),r.Ib(77,"code"),r.lc(78,"fieldName"),r.Hb(),r.lc(79,": string that supplies the name of the field from the HTML form that holds a file"),r.Hb(),r.Ib(80,"li"),r.Ib(81,"code"),r.lc(82,"options"),r.Hb(),r.lc(83,": optional object of type "),r.Ib(84,"code"),r.lc(85,"MulterOptions"),r.Hb(),r.lc(86,". This is the same object used by the multer constructor (more details "),r.Ib(87,"a",13),r.lc(88,"here"),r.Hb(),r.lc(89,")."),r.Hb(),r.Hb(),r.Ib(90,"h4",14),r.Ib(91,"span"),r.lc(92,"Array of files"),r.Hb(),r.Hb(),r.Ib(93,"p"),r.lc(94,"To upload an array of files (identified with a single field name), use the "),r.Ib(95,"code"),r.lc(96,"FilesInterceptor()"),r.Hb(),r.lc(97," decorator (note the plural "),r.Ib(98,"strong"),r.lc(99,"Files"),r.Hb(),r.lc(100," in the decorator name). This decorator takes three arguments:"),r.Hb(),r.Ib(101,"ul"),r.Ib(102,"li"),r.Ib(103,"code"),r.lc(104,"fieldName"),r.Hb(),r.lc(105,": as described above"),r.Hb(),r.Ib(106,"li"),r.Ib(107,"code"),r.lc(108,"maxCount"),r.Hb(),r.lc(109,": optional number defining the maximum number of files to accept"),r.Hb(),r.Ib(110,"li"),r.Ib(111,"code"),r.lc(112,"options"),r.Hb(),r.lc(113,": optional "),r.Ib(114,"code"),r.lc(115,"MulterOptions"),r.Hb(),r.lc(116," object, as described above"),r.Hb(),r.Hb(),r.Ib(117,"p"),r.lc(118,"When using "),r.Ib(119,"code"),r.lc(120,"FilesInterceptor()"),r.Hb(),r.lc(121,", extract files from the "),r.Ib(122,"code"),r.lc(123,"request"),r.Hb(),r.lc(124," with the "),r.Ib(125,"code"),r.lc(126,"@UploadedFiles()"),r.Hb(),r.lc(127," decorator."),r.Hb(),r.Ib(128,"span",9),r.Gb(129,"app-tabs",null,15),r.Hb(),r.Ib(131,"pre"),r.Ib(132,"code",11),r.lc(133,"\n@Post('upload')\n@UseInterceptors(FilesInterceptor('files'))\nuploadFile(@UploadedFiles() files) {\n  console.log(files);\n}"),r.Hb(),r.Hb(),r.Ib(134,"pre"),r.Ib(135,"code",11),r.lc(136,"\n@Post('upload')\n@UseInterceptors(FilesInterceptor('files'))\n@Bind(UploadedFiles())\nuploadFile(files) {\n  console.log(files);\n}"),r.Hb(),r.Hb(),r.Ib(137,"blockquote",12),r.Ib(138,"strong"),r.lc(139,"Hint"),r.Hb(),r.lc(140," The "),r.Ib(141,"code"),r.lc(142,"FilesInterceptor()"),r.Hb(),r.lc(143," decorator is exported from the "),r.Ib(144,"code"),r.lc(145,"@nestjs/platform-express"),r.Hb(),r.lc(146," package. The "),r.Ib(147,"code"),r.lc(148,"@UploadedFiles()"),r.Hb(),r.lc(149," decorator is exported from "),r.Ib(150,"code"),r.lc(151,"@nestjs/common"),r.Hb(),r.lc(152,".\n"),r.Hb(),r.Ib(153,"h4",16),r.Ib(154,"span"),r.lc(155,"Multiple files"),r.Hb(),r.Hb(),r.Ib(156,"p"),r.lc(157,"To upload multiple fields (all with different field name keys), use the "),r.Ib(158,"code"),r.lc(159,"FileFieldsInterceptor()"),r.Hb(),r.lc(160," decorator. This decorator takes two arguments:"),r.Hb(),r.Ib(161,"ul"),r.Ib(162,"li"),r.Ib(163,"code"),r.lc(164,"uploadedFields"),r.Hb(),r.lc(165,": an array of objects, where each object specifies a required "),r.Ib(166,"code"),r.lc(167,"name"),r.Hb(),r.lc(168," property with a string value specifying a field name, as described above, and an optional "),r.Ib(169,"code"),r.lc(170,"maxCount"),r.Hb(),r.lc(171," property, as described above"),r.Hb(),r.Ib(172,"li"),r.Ib(173,"code"),r.lc(174,"options"),r.Hb(),r.lc(175,": optional "),r.Ib(176,"code"),r.lc(177,"MulterOptions"),r.Hb(),r.lc(178," object, as described above"),r.Hb(),r.Hb(),r.Ib(179,"p"),r.lc(180,"When using "),r.Ib(181,"code"),r.lc(182,"FileFieldsInterceptor()"),r.Hb(),r.lc(183,", extract files from the "),r.Ib(184,"code"),r.lc(185,"request"),r.Hb(),r.lc(186," with the "),r.Ib(187,"code"),r.lc(188,"@UploadedFiles()"),r.Hb(),r.lc(189," decorator."),r.Hb(),r.Ib(190,"span",9),r.Gb(191,"app-tabs",null,17),r.Hb(),r.Ib(193,"pre"),r.Ib(194,"code",11),r.lc(195,"\n@Post('upload')\n@UseInterceptors(FileFieldsInterceptor([\n  { name: 'avatar', maxCount: 1 },\n  { name: 'background', maxCount: 1 },\n]))\nuploadFile(@UploadedFiles() files) {\n  console.log(files);\n}"),r.Hb(),r.Hb(),r.Ib(196,"pre"),r.Ib(197,"code",11),r.lc(198,"\n@Post('upload')\n@Bind(UploadedFiles())\n@UseInterceptors(FileFieldsInterceptor([\n  { name: 'avatar', maxCount: 1 },\n  { name: 'background', maxCount: 1 },\n]))\nuploadFile(files) {\n  console.log(files);\n}"),r.Hb(),r.Hb(),r.Ib(199,"h4",18),r.Ib(200,"span"),r.lc(201,"Any files"),r.Hb(),r.Hb(),r.Ib(202,"p"),r.lc(203,"To upload all fields with arbitrary field name keys, use the "),r.Ib(204,"code"),r.lc(205,"AnyFilesInterceptor()"),r.Hb(),r.lc(206," decorator. This decorator can accept an optional "),r.Ib(207,"code"),r.lc(208,"options"),r.Hb(),r.lc(209," object as described above."),r.Hb(),r.Ib(210,"p"),r.lc(211,"When using "),r.Ib(212,"code"),r.lc(213,"AnyFilesInterceptor()"),r.Hb(),r.lc(214,", extract files from the "),r.Ib(215,"code"),r.lc(216,"request"),r.Hb(),r.lc(217," with the "),r.Ib(218,"code"),r.lc(219,"@UploadedFiles()"),r.Hb(),r.lc(220," decorator."),r.Hb(),r.Ib(221,"span",9),r.Gb(222,"app-tabs",null,19),r.Hb(),r.Ib(224,"pre"),r.Ib(225,"code",11),r.lc(226,"\n@Post('upload')\n@UseInterceptors(AnyFilesInterceptor())\nuploadFile(@UploadedFiles() files) {\n  console.log(files);\n}"),r.Hb(),r.Hb(),r.Ib(227,"pre"),r.Ib(228,"code",11),r.lc(229,"\n@Post('upload')\n@Bind(UploadedFiles())\n@UseInterceptors(AnyFilesInterceptor())\nuploadFile(files) {\n  console.log(files);\n}"),r.Hb(),r.Hb(),r.Ib(230,"h4",20),r.Ib(231,"span"),r.lc(232,"Default options"),r.Hb(),r.Hb(),r.Ib(233,"p"),r.lc(234,"You can specify multer options in the file interceptors as described above. To set default options, you can call the static "),r.Ib(235,"code"),r.lc(236,"register()"),r.Hb(),r.lc(237," method when you import the "),r.Ib(238,"code"),r.lc(239,"MulterModule"),r.Hb(),r.lc(240,", passing in supported options. You can use all options listed "),r.Ib(241,"a",13),r.lc(242,"here"),r.Hb(),r.lc(243,"."),r.Hb(),r.Ib(244,"pre"),r.Ib(245,"code",11),r.lc(246,"\nMulterModule.register({\n  dest: '/upload',\n});"),r.Hb(),r.Hb(),r.Ib(247,"blockquote",12),r.Ib(248,"strong"),r.lc(249,"Hint"),r.Hb(),r.lc(250," The "),r.Ib(251,"code"),r.lc(252,"MulterModule"),r.Hb(),r.lc(253," class is exported from the "),r.Ib(254,"code"),r.lc(255,"@nestjs/platform-express"),r.Hb(),r.lc(256," package.\n"),r.Hb(),r.Ib(257,"h4",21),r.Ib(258,"span"),r.lc(259,"Async configuration"),r.Hb(),r.Hb(),r.Ib(260,"p"),r.lc(261,"When you need to set "),r.Ib(262,"code"),r.lc(263,"MulterModule"),r.Hb(),r.lc(264," options asynchronously instead of statically, use the "),r.Ib(265,"code"),r.lc(266,"registerAsync()"),r.Hb(),r.lc(267," method. As with most dynamic modules, Nest provides several techniques to deal with async configuration."),r.Hb(),r.Ib(268,"p"),r.lc(269,"One technique is to use a factory function:"),r.Hb(),r.Ib(270,"pre"),r.Ib(271,"code",11),r.lc(272,"\nMulterModule.registerAsync({\n  useFactory: () => ({\n    dest: '/upload',\n  }),\n});"),r.Hb(),r.Hb(),r.Ib(273,"p"),r.lc(274,"Like other "),r.Ib(275,"a",22),r.lc(276,"factory providers"),r.Hb(),r.lc(277,", our factory function can be "),r.Ib(278,"code"),r.lc(279,"async"),r.Hb(),r.lc(280," and can inject dependencies through "),r.Ib(281,"code"),r.lc(282,"inject"),r.Hb(),r.lc(283,"."),r.Hb(),r.Ib(284,"pre"),r.Ib(285,"code",11),r.lc(286,"\nMulterModule.registerAsync({\n  imports: [ConfigModule],\n  useFactory: async (configService: ConfigService) => ({\n    dest: configService.getString('MULTER_DEST'),\n  }),\n  inject: [ConfigService],\n});"),r.Hb(),r.Hb(),r.Ib(287,"p"),r.lc(288,"Alternatively, you can configure the "),r.Ib(289,"code"),r.lc(290,"MulterModule"),r.Hb(),r.lc(291," using a class instead of a factory, as shown below:"),r.Hb(),r.Ib(292,"pre"),r.Ib(293,"code",11),r.lc(294,"\nMulterModule.registerAsync({\n  useClass: MulterConfigService,\n});"),r.Hb(),r.Hb(),r.Ib(295,"p"),r.lc(296,"The construction above instantiates "),r.Ib(297,"code"),r.lc(298,"MulterConfigService"),r.Hb(),r.lc(299," inside "),r.Ib(300,"code"),r.lc(301,"MulterModule"),r.Hb(),r.lc(302,", using it to create the required options object. Note that in this example, the "),r.Ib(303,"code"),r.lc(304,"MulterConfigService"),r.Hb(),r.lc(305," has to implement the "),r.Ib(306,"code"),r.lc(307,"MulterOptionsFactory"),r.Hb(),r.lc(308," interface, as shown below. The "),r.Ib(309,"code"),r.lc(310,"MulterModule"),r.Hb(),r.lc(311," will call the "),r.Ib(312,"code"),r.lc(313,"createMulterOptions()"),r.Hb(),r.lc(314," method on the instantiated object of the supplied class."),r.Hb(),r.Ib(315,"pre"),r.Ib(316,"code",11),r.lc(317,"\n@Injectable()\nclass MulterConfigService implements MulterOptionsFactory {\n  createMulterOptions(): MulterModuleOptions {\n    return {\n      dest: '/upload',\n    };\n  }\n}"),r.Hb(),r.Hb(),r.Ib(318,"p"),r.lc(319,"If you want to reuse an existing options provider instead of creating a private copy inside the "),r.Ib(320,"code"),r.lc(321,"MulterModule"),r.Hb(),r.lc(322,", use the "),r.Ib(323,"code"),r.lc(324,"useExisting"),r.Hb(),r.lc(325," syntax."),r.Hb(),r.Ib(326,"pre"),r.Ib(327,"code",11),r.lc(328,"\nMulterModule.registerAsync({\n  imports: [ConfigModule],\n  useExisting: ConfigService,\n});"),r.Hb(),r.Hb(),r.Hb()),2&e){const e=r.dc(47),t=r.dc(130),o=r.dc(192),n=r.dc(223);r.vb(48),r.xb("hide",e.isJsActive),r.vb(3),r.xb("hide",!e.isJsActive),r.vb(80),r.xb("hide",t.isJsActive),r.vb(3),r.xb("hide",!t.isJsActive),r.vb(59),r.xb("hide",o.isJsActive),r.vb(3),r.xb("hide",!o.isJsActive),r.vb(28),r.xb("hide",n.isJsActive),r.vb(3),r.xb("hide",!n.isJsActive)}},directives:[l.a,i.a],encapsulation:2,changeDetection:0}),e})();const j=r.Kb(w);let A=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return x(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-http-module"]],features:[r.tb],decls:159,vars:4,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/http-module.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","http-module"],["rel","nofollow","target","_blank","href","https://github.com/axios/axios"],[1,"language-typescript"],[1,"info"],[1,"filename"],["app1b2e79703ef87e7ccfe88bab0b188359c3fee879",""],["appAnchor","","id","configuration"],["rel","nofollow","target","_blank","href","https://github.com/axios/axios#request-config"],["appAnchor","","id","async-configuration"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/fundamentals/custom-providers#factory-providers-usefactory"]],template:function(e,t){if(1&e&&(r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"HTTP module"),r.Hb(),r.Ib(7,"p"),r.Ib(8,"a",6),r.lc(9,"Axios"),r.Hb(),r.lc(10," is richly featured HTTP client package that is widely used. Nest wraps Axios and exposes it via the built-in "),r.Ib(11,"code"),r.lc(12,"HttpModule"),r.Hb(),r.lc(13,". The "),r.Ib(14,"code"),r.lc(15,"HttpModule"),r.Hb(),r.lc(16," exports the "),r.Ib(17,"code"),r.lc(18,"HttpService"),r.Hb(),r.lc(19," class, which exposes Axios-based methods to perform HTTP requests. The library also transforms the resulting HTTP responses into "),r.Ib(20,"code"),r.lc(21,"Observables"),r.Hb(),r.lc(22,"."),r.Hb(),r.Ib(23,"p"),r.lc(24,"To use the "),r.Ib(25,"code"),r.lc(26,"HttpService"),r.Hb(),r.lc(27,", first import "),r.Ib(28,"code"),r.lc(29,"HttpModule"),r.Hb(),r.lc(30,"."),r.Hb(),r.Ib(31,"pre"),r.Ib(32,"code",7),r.lc(33,"\n@Module({\n  imports: [HttpModule],\n  providers: [CatsService],\n})\nexport class CatsModule {}"),r.Hb(),r.Hb(),r.Ib(34,"p"),r.lc(35,"Next, inject "),r.Ib(36,"code"),r.lc(37,"HttpService"),r.Hb(),r.lc(38," using normal constructor injection."),r.Hb(),r.Ib(39,"blockquote",8),r.Ib(40,"strong"),r.lc(41,"Hint"),r.Hb(),r.Ib(42,"code"),r.lc(43,"HttpModule"),r.Hb(),r.lc(44," and "),r.Ib(45,"code"),r.lc(46,"HttpService"),r.Hb(),r.lc(47," are imported from "),r.Ib(48,"code"),r.lc(49,"@nestjs/common"),r.Hb(),r.lc(50," package.\n"),r.Hb(),r.Ib(51,"span",9),r.Gb(52,"app-tabs",null,10),r.Hb(),r.Ib(54,"pre"),r.Ib(55,"code",7),r.lc(56,"\n@Injectable()\nexport class CatsService {\n  constructor(private httpService: HttpService) {}\n\n  findAll(): Observable<AxiosResponse<Cat[]>> {\n    return this.httpService.get('http://localhost:3000/cats');\n  }\n}"),r.Hb(),r.Hb(),r.Ib(57,"pre"),r.Ib(58,"code",7),r.lc(59,"\n@Injectable()\n@Dependencies(HttpService)\nexport class CatsService {\n  constructor(httpService) {\n    this.httpService = httpService;\n  }\n\n  findAll() {\n    return this.httpService.get('http://localhost:3000/cats');\n  }\n}"),r.Hb(),r.Hb(),r.Ib(60,"p"),r.lc(61,"All "),r.Ib(62,"code"),r.lc(63,"HttpService"),r.Hb(),r.lc(64," methods return an "),r.Ib(65,"code"),r.lc(66,"AxiosResponse"),r.Hb(),r.lc(67," wrapped in an "),r.Ib(68,"code"),r.lc(69,"Observable"),r.Hb(),r.lc(70," object."),r.Hb(),r.Ib(71,"h4",11),r.Ib(72,"span"),r.lc(73,"Configuration"),r.Hb(),r.Hb(),r.Ib(74,"p"),r.Ib(75,"a",6),r.lc(76,"Axios"),r.Hb(),r.lc(77," can be configured with a variety of options to customize the behavior of the "),r.Ib(78,"code"),r.lc(79,"HttpService"),r.Hb(),r.lc(80,". Read more about them "),r.Ib(81,"a",12),r.lc(82,"here"),r.Hb(),r.lc(83,". To configure the underlying Axios instance, pass an optional options object to the "),r.Ib(84,"code"),r.lc(85,"register()"),r.Hb(),r.lc(86," method of "),r.Ib(87,"code"),r.lc(88,"HttpModule"),r.Hb(),r.lc(89," when importing it. This options object will be passed directly to the underlying Axios constructor."),r.Hb(),r.Ib(90,"pre"),r.Ib(91,"code",7),r.lc(92,"\n@Module({\n  imports: [\n    HttpModule.register({\n      timeout: 5000,\n      maxRedirects: 5,\n    }),\n  ],\n  providers: [CatsService],\n})\nexport class CatsModule {}"),r.Hb(),r.Hb(),r.Ib(93,"h4",13),r.Ib(94,"span"),r.lc(95,"Async configuration"),r.Hb(),r.Hb(),r.Ib(96,"p"),r.lc(97,"When you need to pass module options asynchronously instead of statically, use the "),r.Ib(98,"code"),r.lc(99,"registerAsync()"),r.Hb(),r.lc(100," method. As with most dynamic modules, Nest provides several techniques to deal with async configuration."),r.Hb(),r.Ib(101,"p"),r.lc(102,"One technique is to use a factory function:"),r.Hb(),r.Ib(103,"pre"),r.Ib(104,"code",7),r.lc(105,"\nHttpModule.registerAsync({\n  useFactory: () => ({\n    timeout: 5000,\n    maxRedirects: 5,\n  }),\n});"),r.Hb(),r.Hb(),r.Ib(106,"p"),r.lc(107,"Like other factory providers, our factory function can be "),r.Ib(108,"a",14),r.lc(109,"async"),r.Hb(),r.lc(110," and can inject dependencies through "),r.Ib(111,"code"),r.lc(112,"inject"),r.Hb(),r.lc(113,"."),r.Hb(),r.Ib(114,"pre"),r.Ib(115,"code",7),r.lc(116,"\nHttpModule.registerAsync({\n  imports: [ConfigModule],\n  useFactory: async (configService: ConfigService) => ({\n    timeout: configService.getString('HTTP_TIMEOUT'),\n    maxRedirects: configService.getString('HTTP_MAX_REDIRECTS'),\n  }),\n  inject: [ConfigService],\n});"),r.Hb(),r.Hb(),r.Ib(117,"p"),r.lc(118,"Alternatively, you can configure the "),r.Ib(119,"code"),r.lc(120,"HttpModule"),r.Hb(),r.lc(121," using a class instead of a factory, as shown below."),r.Hb(),r.Ib(122,"pre"),r.Ib(123,"code",7),r.lc(124,"\nHttpModule.registerAsync({\n  useClass: HttpConfigService,\n});"),r.Hb(),r.Hb(),r.Ib(125,"p"),r.lc(126,"The construction above instantiates "),r.Ib(127,"code"),r.lc(128,"HttpConfigService"),r.Hb(),r.lc(129," inside "),r.Ib(130,"code"),r.lc(131,"HttpModule"),r.Hb(),r.lc(132,", using it to create an options object. Note that in this example, the "),r.Ib(133,"code"),r.lc(134,"HttpConfigService"),r.Hb(),r.lc(135," has to implement "),r.Ib(136,"code"),r.lc(137,"HttpModuleOptionsFactory"),r.Hb(),r.lc(138," interface as shown below. The "),r.Ib(139,"code"),r.lc(140,"HttpModule"),r.Hb(),r.lc(141," will call the "),r.Ib(142,"code"),r.lc(143,"createHttpOptions()"),r.Hb(),r.lc(144," method on the instantiated object of the supplied class."),r.Hb(),r.Ib(145,"pre"),r.Ib(146,"code",7),r.lc(147,"\n@Injectable()\nclass HttpConfigService implements HttpModuleOptionsFactory {\n  createHttpOptions(): HttpModuleOptions {\n    return {\n      timeout: 5000,\n      maxRedirects: 5,\n    };\n  }\n}"),r.Hb(),r.Hb(),r.Ib(148,"p"),r.lc(149,"If you want to reuse an existing options provider instead of creating a private copy inside the "),r.Ib(150,"code"),r.lc(151,"HttpModule"),r.Hb(),r.lc(152,", use the "),r.Ib(153,"code"),r.lc(154,"useExisting"),r.Hb(),r.lc(155," syntax."),r.Hb(),r.Ib(156,"pre"),r.Ib(157,"code",7),r.lc(158,"\nHttpModule.registerAsync({\n  imports: [ConfigModule],\n  useExisting: ConfigService,\n});"),r.Hb(),r.Hb(),r.Hb()),2&e){const e=r.dc(53);r.vb(54),r.xb("hide",e.isJsActive),r.vb(3),r.xb("hide",!e.isJsActive)}},directives:[i.a,l.a],encapsulation:2,changeDetection:0}),e})();const x=r.Kb(A);let k=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return M(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-logger"]],features:[r.tb],decls:338,vars:0,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/logger.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","logger"],["rel","nofollow","target","_blank","href","https://github.com/winstonjs/winston"],["appAnchor","","id","basic-customization"],[1,"language-typescript"],["appAnchor","","id","custom-implementation"],["href","techniques/logger#dependency-injection"],["appAnchor","","id","extend-built-in-logger"],["href","techniques/logger#using-the-logger-for-application-logging"],["href","techniques/logger#custom-logger-implementation"],["appAnchor","","id","dependency-injection"],["appAnchor","","id","using-the-logger-for-application-logging"],[1,"language-bash"],["start","2"],["routerLink","/fundamentals/injection-scopes"],["appAnchor","","id","use-external-logger"]],template:function(e,t){1&e&&(r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"Logger"),r.Hb(),r.Ib(7,"p"),r.lc(8,"Nest comes with a built-in text-based logger which is used during application bootstrapping and several other circumstances such as displaying caught exceptions (i.e., system logging). This functionality is provided via the "),r.Ib(9,"code"),r.lc(10,"Logger"),r.Hb(),r.lc(11," class in the "),r.Ib(12,"code"),r.lc(13,"@nestjs/common"),r.Hb(),r.lc(14," package. You can fully control the behavior of the logging system, including any of the following:"),r.Hb(),r.Ib(15,"ul"),r.Ib(16,"li"),r.lc(17,"disable logging entirely"),r.Hb(),r.Ib(18,"li"),r.lc(19,"specify the log level of detail (e.g., display errors, warnings, debug information, etc.)"),r.Hb(),r.Ib(20,"li"),r.lc(21,"completely override the default logger"),r.Hb(),r.Ib(22,"li"),r.lc(23,"customize the default logger by extending it"),r.Hb(),r.Ib(24,"li"),r.lc(25,"make use of dependency injection to simplify composing and testing your application"),r.Hb(),r.Hb(),r.Ib(26,"p"),r.lc(27,"You can also make use of the built-in logger, or create your own custom implementation, to log your own application-level events and messages."),r.Hb(),r.Ib(28,"p"),r.lc(29,"For more advanced logging functionality, you can make use of any Node.js logging package, such as "),r.Ib(30,"a",6),r.lc(31,"Winston"),r.Hb(),r.lc(32,", to implement a completely custom, production grade logging system."),r.Hb(),r.Ib(33,"h4",7),r.Ib(34,"span"),r.lc(35,"Basic customization"),r.Hb(),r.Hb(),r.Ib(36,"p"),r.lc(37,"To disable logging, set the "),r.Ib(38,"code"),r.lc(39,"logger"),r.Hb(),r.lc(40," property to "),r.Ib(41,"code"),r.lc(42,"false"),r.Hb(),r.lc(43," in the (optional) Nest application options object passed as the second argument to the "),r.Ib(44,"code"),r.lc(45,"NestFactory.create()"),r.Hb(),r.lc(46," method."),r.Hb(),r.Ib(47,"pre"),r.Ib(48,"code",8),r.lc(49,"\nconst app = await NestFactory.create(ApplicationModule, {\n  logger: false,\n});\nawait app.listen(3000);"),r.Hb(),r.Hb(),r.Ib(50,"p"),r.lc(51,"To enable specific logging levels, set the "),r.Ib(52,"code"),r.lc(53,"logger"),r.Hb(),r.lc(54," property to an array of strings specifying the log levels to display, as follows:"),r.Hb(),r.Ib(55,"pre"),r.Ib(56,"code",8),r.lc(57,"\nconst app = await NestFactory.create(ApplicationModule, {\n  logger: ['error', 'warn'],\n});\nawait app.listen(3000);"),r.Hb(),r.Hb(),r.Ib(58,"p"),r.lc(59,"Values in the array can be any combination of "),r.Ib(60,"code"),r.lc(61,"'log'"),r.Hb(),r.lc(62,", "),r.Ib(63,"code"),r.lc(64,"'error'"),r.Hb(),r.lc(65,", "),r.Ib(66,"code"),r.lc(67,"'warn'"),r.Hb(),r.lc(68,", "),r.Ib(69,"code"),r.lc(70,"'debug'"),r.Hb(),r.lc(71,", and "),r.Ib(72,"code"),r.lc(73,"'verbose'"),r.Hb(),r.lc(74,"."),r.Hb(),r.Ib(75,"h4",9),r.Ib(76,"span"),r.lc(77,"Custom implementation"),r.Hb(),r.Hb(),r.Ib(78,"p"),r.lc(79,"You can provide a custom logger implementation to be used by Nest for system logging by setting the value of the "),r.Ib(80,"code"),r.lc(81,"logger"),r.Hb(),r.lc(82," property to an object that fulfills the "),r.Ib(83,"code"),r.lc(84,"LoggerService"),r.Hb(),r.lc(85," interface. For example, you can tell Nest to use the built-in global JavaScript "),r.Ib(86,"code"),r.lc(87,"console"),r.Hb(),r.lc(88," object (which implements the "),r.Ib(89,"code"),r.lc(90,"LoggerService"),r.Hb(),r.lc(91," interface), as follows:"),r.Hb(),r.Ib(92,"pre"),r.Ib(93,"code",8),r.lc(94,"\nconst app = await NestFactory.create(ApplicationModule, {\n  logger: console,\n});\nawait app.listen(3000);"),r.Hb(),r.Hb(),r.Ib(95,"p"),r.lc(96,"Implementing your own custom logger is straightforward. Simply implement each of the methods of the "),r.Ib(97,"code"),r.lc(98,"LoggerService"),r.Hb(),r.lc(99," interface as shown below."),r.Hb(),r.Ib(100,"pre"),r.Ib(101,"code",8),r.lc(102,"\nimport { LoggerService } from '@nestjs/common';\n\nexport class MyLogger implements LoggerService {\n  log(message: string) {\n    /* your implementation */\n  }\n  error(message: string, trace: string) {\n    /* your implementation */\n  }\n  warn(message: string) {\n    /* your implementation */\n  }\n  debug(message: string) {\n    /* your implementation */\n  }\n  verbose(message: string) {\n    /* your implementation */\n  }\n}"),r.Hb(),r.Hb(),r.Ib(103,"p"),r.lc(104,"You can then supply an instance of "),r.Ib(105,"code"),r.lc(106,"MyLogger"),r.Hb(),r.lc(107," via the "),r.Ib(108,"code"),r.lc(109,"logger"),r.Hb(),r.lc(110," property of the Nest application options object."),r.Hb(),r.Ib(111,"pre"),r.Ib(112,"code",8),r.lc(113,"\nconst app = await NestFactory.create(ApplicationModule, {\n  logger: new MyLogger(),\n});\nawait app.listen(3000);"),r.Hb(),r.Hb(),r.Ib(114,"p"),r.lc(115,"This technique, while simple, doesn't utilize dependency injection for the "),r.Ib(116,"code"),r.lc(117,"MyLogger"),r.Hb(),r.lc(118," class. This can pose some challenges, particularly for testing, and limit the reusability of "),r.Ib(119,"code"),r.lc(120,"MyLogger"),r.Hb(),r.lc(121,". For a better solution, see the "),r.Ib(122,"a",10),r.lc(123,"Dependency Injection"),r.Hb(),r.lc(124," section below."),r.Hb(),r.Ib(125,"h4",11),r.Ib(126,"span"),r.lc(127,"Extend built-in logger"),r.Hb(),r.Hb(),r.Ib(128,"p"),r.lc(129,"Rather than writing a logger from scratch, you may be able to meet your needs by extending the built-in "),r.Ib(130,"code"),r.lc(131,"Logger"),r.Hb(),r.lc(132," class and overriding selected behavior of the default implementation."),r.Hb(),r.Ib(133,"pre"),r.Ib(134,"code",8),r.lc(135,"\nimport { Logger } from '@nestjs/common';\n\nexport class MyLogger extends Logger {\n  error(message: string, trace: string) {\n    // add your tailored logic here\n    super.error(message, trace);\n  }\n}"),r.Hb(),r.Hb(),r.Ib(136,"p"),r.lc(137,"You can use such an extended logger in your feature modules as described in the "),r.Ib(138,"a",12),r.lc(139,"Using the logger for application logging"),r.Hb(),r.lc(140," section below."),r.Hb(),r.Ib(141,"p"),r.lc(142,"You can tell Nest to use your extended logger for system logging by passing an instance of it via the "),r.Ib(143,"code"),r.lc(144,"logger"),r.Hb(),r.lc(145," property of the application options object (as shown in the "),r.Ib(146,"a",13),r.lc(147,"Custom implementation"),r.Hb(),r.lc(148," section above), or by using the technique shown in the "),r.Ib(149,"a",10),r.lc(150,"Dependency Injection"),r.Hb(),r.lc(151," section below. If you do so, you should take care to call "),r.Ib(152,"code"),r.lc(153,"super"),r.Hb(),r.lc(154,", as shown in the sample code above, to delegate the specific log method call to the parent (built-in) class so that Nest can rely on the built-in features it expects."),r.Hb(),r.Ib(155,"p"),r.Gb(156,"app-banner-courses"),r.Hb(),r.Ib(157,"h4",14),r.Ib(158,"span"),r.lc(159,"Dependency injection"),r.Hb(),r.Hb(),r.Ib(160,"p"),r.lc(161,"For more advanced logging functionality, you'll want to take advantage of dependency injection. For example, you may want to inject a "),r.Ib(162,"code"),r.lc(163,"ConfigService"),r.Hb(),r.lc(164," into your logger to customize it, and in turn inject your custom logger into other controllers and/or providers. To enable dependency injection for your custom logger, create a class that implements "),r.Ib(165,"code"),r.lc(166,"LoggerService"),r.Hb(),r.lc(167," and register that class as a provider in some module. For example, you can"),r.Hb(),r.Ib(168,"ol"),r.Ib(169,"li"),r.lc(170,"Define a "),r.Ib(171,"code"),r.lc(172,"MyLogger"),r.Hb(),r.lc(173," class that either extends the built-in "),r.Ib(174,"code"),r.lc(175,"Logger"),r.Hb(),r.lc(176," or completely overrides it, as shown in previous sections."),r.Hb(),r.Ib(177,"li"),r.lc(178,"Create a "),r.Ib(179,"code"),r.lc(180,"LoggerModule"),r.Hb(),r.lc(181," as shown below, and provide "),r.Ib(182,"code"),r.lc(183,"MyLogger"),r.Hb(),r.lc(184," from that module."),r.Hb(),r.Hb(),r.Ib(185,"pre"),r.Ib(186,"code",8),r.lc(187,"\nimport { Module } from '@nestjs/common';\nimport { MyLogger } from './my-logger.service';\n\n@Module({\n  providers: [MyLogger],\n  exports: [MyLogger],\n})\nexport class LoggerModule {}"),r.Hb(),r.Hb(),r.Ib(188,"p"),r.lc(189,"With this construct, you are now providing your custom logger for use by any other module. Because your "),r.Ib(190,"code"),r.lc(191,"MyLogger"),r.Hb(),r.lc(192," class is part of a module, it can use dependency injection (for example, to inject a "),r.Ib(193,"code"),r.lc(194,"ConfigService"),r.Hb(),r.lc(195,"). There's one more technique needed to provide this custom logger for use by Nest for system logging (e.g., for bootstrapping and error handling)."),r.Hb(),r.Ib(196,"p"),r.lc(197,"Because application instantiation ("),r.Ib(198,"code"),r.lc(199,"NestFactory.create()"),r.Hb(),r.lc(200,") happens outside the context of any module, it doesn't participate in the normal Dependency Injection phase of initialization. So we must ensure that at least one application module imports the "),r.Ib(201,"code"),r.lc(202,"LoggerModule"),r.Hb(),r.lc(203," to trigger Nest to instantiate a singleton instance of our "),r.Ib(204,"code"),r.lc(205,"MyLogger"),r.Hb(),r.lc(206," class. We can then instruct Nest to use the same singleton instance of "),r.Ib(207,"code"),r.lc(208,"MyLogger"),r.Hb(),r.lc(209," with the following construction:"),r.Hb(),r.Ib(210,"pre"),r.Ib(211,"code",8),r.lc(212,"\nconst app = await NestFactory.create(ApplicationModule, {\n  logger: false,\n});\napp.useLogger(app.get(MyLogger));\nawait app.listen(3000);"),r.Hb(),r.Hb(),r.Ib(213,"p"),r.lc(214,"Here we use the "),r.Ib(215,"code"),r.lc(216,"get()"),r.Hb(),r.lc(217," method on the "),r.Ib(218,"code"),r.lc(219,"NestApplication"),r.Hb(),r.lc(220," instance to retrieve the singleton instance of the "),r.Ib(221,"code"),r.lc(222,"MyLogger"),r.Hb(),r.lc(223,' object. This technique is essentially a way to "inject" an instance of a logger for use by Nest. The '),r.Ib(224,"code"),r.lc(225,"app.get()"),r.Hb(),r.lc(226," call retrieves the singleton instance of "),r.Ib(227,"code"),r.lc(228,"MyLogger"),r.Hb(),r.lc(229,", and depends on that instance being first injected in another module, as described above."),r.Hb(),r.Ib(230,"p"),r.lc(231,"You can also inject this "),r.Ib(232,"code"),r.lc(233,"MyLogger"),r.Hb(),r.lc(234," provider in your feature classes, thus ensuring consistent logging behavior across both Nest system logging and application logging. See "),r.Ib(235,"a",12),r.lc(236,"Using the logger for application logging"),r.Hb(),r.lc(237," below for more information."),r.Hb(),r.Ib(238,"p"),r.lc(239,"The only downside of this solution is that your first initialization messages won't be handled by your logger instance, though, it shouldn't really matter at this point."),r.Hb(),r.Ib(240,"h4",15),r.Ib(241,"span"),r.lc(242,"Using the logger for application logging"),r.Hb(),r.Hb(),r.Ib(243,"p"),r.lc(244,"We can combine several of the techniques above to provide consistent behavior and formatting across both Nest system logging and our own application event/message logging. In this section, we'll achieve this with the following steps:"),r.Hb(),r.Ib(245,"ol"),r.Ib(246,"li"),r.lc(247,"We extend the built-in logger and customize the "),r.Ib(248,"code"),r.lc(249,"context"),r.Hb(),r.lc(250," portion of the log message (e.g., the phrase "),r.Ib(251,"code"),r.lc(252,"NestFactory"),r.Hb(),r.lc(253," in square brackets in the log line shown below)."),r.Hb(),r.Hb(),r.Ib(254,"pre"),r.Ib(255,"code",16),r.lc(256,"\n[Nest] 19096   - 12/08/2019, 7:12:59 AM   [NestFactory] Starting Nest application..."),r.Hb(),r.Hb(),r.Ib(257,"ol",17),r.Ib(258,"li"),r.lc(259,"We inject a "),r.Ib(260,"a",18),r.lc(261,"transient"),r.Hb(),r.lc(262," instance of the "),r.Ib(263,"code"),r.lc(264,"Logger"),r.Hb(),r.lc(265," into our feature modules so that each one has its own custom context."),r.Hb(),r.Ib(266,"li"),r.lc(267,"We supply this extended logger for Nest to use for system logging."),r.Hb(),r.Hb(),r.Ib(268,"p"),r.lc(269,"To start, extend the built-in logger with code like the following. We supply the "),r.Ib(270,"code"),r.lc(271,"scope"),r.Hb(),r.lc(272," option as configuration metadata for the "),r.Ib(273,"code"),r.lc(274,"Logger"),r.Hb(),r.lc(275," class, specifying a "),r.Ib(276,"a",18),r.lc(277,"transient"),r.Hb(),r.lc(278," scope, to ensure that we'll have a unique instance of the "),r.Ib(279,"code"),r.lc(280,"Logger"),r.Hb(),r.lc(281," in each feature module. In this example, we do not extend the individual "),r.Ib(282,"code"),r.lc(283,"Logger"),r.Hb(),r.lc(284," methods (like "),r.Ib(285,"code"),r.lc(286,"log()"),r.Hb(),r.lc(287,", "),r.Ib(288,"code"),r.lc(289,"warn()"),r.Hb(),r.lc(290,", etc.), though you may choose to do so."),r.Hb(),r.Ib(291,"pre"),r.Ib(292,"code",8),r.lc(293,"\nimport { Injectable, Scope, Logger } from '@nestjs/common';\n\n@Injectable({ scope: Scope.TRANSIENT })\nexport class MyLogger extends Logger {}"),r.Hb(),r.Hb(),r.Ib(294,"p"),r.lc(295,"Next, create a "),r.Ib(296,"code"),r.lc(297,"LoggerModule"),r.Hb(),r.lc(298," with a construction like this:"),r.Hb(),r.Ib(299,"pre"),r.Ib(300,"code",8),r.lc(301,"\nimport { Module } from '@nestjs/common';\nimport { MyLogger } from './my-logger.service';\n\n@Module({\n  providers: [MyLogger],\n  exports: [MyLogger],\n})\nexport class LoggerModule {}"),r.Hb(),r.Hb(),r.Ib(302,"p"),r.lc(303,"Next, import the "),r.Ib(304,"code"),r.lc(305,"LoggerModule"),r.Hb(),r.lc(306," into your feature module. Then set the logger context, and start using the context-aware custom logger, like this:"),r.Hb(),r.Ib(307,"pre"),r.Ib(308,"code",8),r.lc(309,"\nimport { Injectable } from '@nestjs/common';\nimport { MyLogger } from './my-logger.service';\n\n@Injectable()\nexport class CatsService {\n  private readonly cats: Cat[] = [];\n\n  constructor(private myLogger: MyLogger) {\n    this.myLogger.setContext('CatsService');\n  }\n\n  findAll(): Cat[] {\n    this.myLogger.warn('About to return cats!');\n    return this.cats;\n  }\n}"),r.Hb(),r.Hb(),r.Ib(310,"p"),r.lc(311,"Finally, instruct Nest to use an instance of the custom logger in your "),r.Ib(312,"code"),r.lc(313,"main.ts"),r.Hb(),r.lc(314," file as shown below. Of course in this example, we haven't actually customized the logger behavior (by extending the "),r.Ib(315,"code"),r.lc(316,"Logger"),r.Hb(),r.lc(317," methods like "),r.Ib(318,"code"),r.lc(319,"log()"),r.Hb(),r.lc(320,", "),r.Ib(321,"code"),r.lc(322,"warn()"),r.Hb(),r.lc(323,", etc.), so this step isn't actually needed. But it "),r.Ib(324,"strong"),r.lc(325,"would"),r.Hb(),r.lc(326," be needed if you added custom logic to those methods and wanted Nest to use the same implementation."),r.Hb(),r.Ib(327,"pre"),r.Ib(328,"code",8),r.lc(329,"\nconst app = await NestFactory.create(ApplicationModule, {\n  logger: false,\n});\napp.useLogger(new MyLogger());\nawait app.listen(3000);"),r.Hb(),r.Hb(),r.Ib(330,"h4",19),r.Ib(331,"span"),r.lc(332,"Use external logger"),r.Hb(),r.Hb(),r.Ib(333,"p"),r.lc(334,"Production applications often have specific logging requirements, including advanced filtering, formatting and centralized logging. Nest's built-in logger is used for monitoring Nest system behavior, and can also be useful for basic formatted text logging in your feature modules while in development, but production applications often take advantage of dedicated logging modules like "),r.Ib(335,"a",6),r.lc(336,"Winston"),r.Hb(),r.lc(337,". As with any standard Node.js application, you can take full advantage of such modules in Nest."),r.Hb(),r.Hb())},directives:[l.a,b.a,s.f],encapsulation:2,changeDetection:0}),e})();const M=r.Kb(k);let S=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return T(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-mongo"]],features:[r.tb],decls:484,vars:28,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/mongo.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","mongo"],["rel","nofollow","target","_blank","href","https://www.mongodb.com/"],["rel","nofollow","target","_blank","href","https://github.com/typeorm/typeorm"],["routerLink","/techniques/database"],["rel","nofollow","target","_blank","href","http://mongoosejs.com"],[1,"language-bash"],[1,"filename"],["app303b97a23b4cd986b0963be37430ed18fa4ebae9",""],[1,"language-typescript"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/connections.html"],["appAnchor","","id","model-injection"],["rel","nofollow","target","_blank","href","http://mongoosejs.com/docs/guide.html"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/models.html"],["app38173fd4b1538df4802d8893b9503a2a7a0eeb42",""],[1,"info"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/guide.html#options"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/schematypes.html"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/schematypes.html#schematype-options"],["appa7d6b38bf46edb0711c734f419bf1f768e2fedcf",""],["app3acf01983dbee9b2093ecbe16bf3f278963baa1e",""],["appAnchor","","id","connection"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/api.html#Connection"],["appAnchor","","id","multiple-databases"],["app22a8338bb35e418026bb431b73a73ad506d8ecb9",""],[1,"warning"],["appAnchor","","id","hooks-middleware"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/middleware.html"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/fundamentals/custom-providers#factory-providers-usefactory"],["appAnchor","","id","plugins"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/plugins.html"],["app23a00afb162e11bd89eb3a0d9898115b979142ba",""],["appAnchor","","id","testing"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/fundamentals/custom-providers#di-fundamentals"],["routerLink","/fundamentals/custom-providers"],["appAnchor","","id","async-configuration"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/06-mongoose"]],template:function(e,t){if(1&e&&(r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"Mongo"),r.Hb(),r.Ib(7,"p"),r.lc(8,"Nest supports two methods for integrating with the "),r.Ib(9,"a",6),r.lc(10,"MongoDB"),r.Hb(),r.lc(11," database. You can either use the built-in "),r.Ib(12,"a",7),r.lc(13,"TypeORM"),r.Hb(),r.lc(14," module described "),r.Ib(15,"a",8),r.lc(16,"here"),r.Hb(),r.lc(17,", which has a connector for MongoDB, or use "),r.Ib(18,"a",9),r.lc(19,"Mongoose"),r.Hb(),r.lc(20,", the most popular MongoDB object modeling tool. In this chapter we'll describe the latter, using the dedicated "),r.Ib(21,"code"),r.lc(22,"@nestjs/mongoose"),r.Hb(),r.lc(23," package."),r.Hb(),r.Ib(24,"p"),r.lc(25,"Start by installing the required dependencies:"),r.Hb(),r.Ib(26,"pre"),r.Ib(27,"code",10),r.lc(28,"\n$ npm install --save @nestjs/mongoose mongoose\n$ npm install --save-dev @types/mongoose"),r.Hb(),r.Hb(),r.Ib(29,"p"),r.lc(30,"Once the installation process is complete, we can import the "),r.Ib(31,"code"),r.lc(32,"MongooseModule"),r.Hb(),r.lc(33," into the root "),r.Ib(34,"code"),r.lc(35,"AppModule"),r.Hb(),r.lc(36,"."),r.Hb(),r.Ib(37,"span",11),r.lc(38),r.Ub(39,"extension"),r.Gb(40,"app-tabs",null,12),r.Hb(),r.Ib(42,"pre"),r.Ib(43,"code",13),r.lc(44,"\nimport { Module } from '@nestjs/common';\nimport { MongooseModule } from '@nestjs/mongoose';\n\n@Module({\n  imports: [MongooseModule.forRoot('mongodb://localhost/nest')],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(45,"p"),r.lc(46,"The "),r.Ib(47,"code"),r.lc(48,"forRoot()"),r.Hb(),r.lc(49," method accepts the same configuration object as "),r.Ib(50,"code"),r.lc(51,"mongoose.connect()"),r.Hb(),r.lc(52," from the Mongoose package, as described "),r.Ib(53,"a",14),r.lc(54,"here"),r.Hb(),r.lc(55,"."),r.Hb(),r.Ib(56,"h4",15),r.Ib(57,"span"),r.lc(58,"Model injection"),r.Hb(),r.Hb(),r.Ib(59,"p"),r.lc(60,"With Mongoose, everything is derived from a "),r.Ib(61,"a",16),r.lc(62,"Schema"),r.Hb(),r.lc(63,". Each schema maps to a MongoDB collection and defines the shape of the documents within that collection. Schemas are used to define "),r.Ib(64,"a",17),r.lc(65,"Models"),r.Hb(),r.lc(66,". Models are responsible for creating and reading documents from the underlying MongoDB database."),r.Hb(),r.Ib(67,"p"),r.lc(68,"Schemas can be created with NestJS decorators, or with Mongoose itself manually. Using decorators to create schemas greatly reduces boilerplate and improves overall code readability."),r.Hb(),r.Ib(69,"p"),r.lc(70,"Let's define the "),r.Ib(71,"code"),r.lc(72,"CatSchema"),r.Hb(),r.lc(73,":"),r.Hb(),r.Ib(74,"span",11),r.lc(75),r.Ub(76,"extension"),r.Gb(77,"app-tabs",null,18),r.Hb(),r.Ib(79,"pre"),r.Ib(80,"code",13),r.lc(81,"\nimport { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';\nimport { Document } from 'mongoose';\n\n@Schema()\nexport class Cat extends Document {\n  @Prop()\n  name: string;\n\n  @Prop()\n  age: number;\n\n  @Prop()\n  breed: string;\n}\n\nexport const CatSchema = SchemaFactory.createForClass(Cat);"),r.Hb(),r.Hb(),r.Ib(82,"blockquote",19),r.Ib(83,"strong"),r.lc(84,"Hint"),r.Hb(),r.lc(85," Note you can also generate a raw schema definition using the "),r.Ib(86,"code"),r.lc(87,"DefinitionsFactory"),r.Hb(),r.lc(88," class (from the "),r.Ib(89,"code"),r.lc(90,"nestjs/mongoose"),r.Hb(),r.lc(91,"). This allows you to manually modify the schema definition generated based on the metadata you provided. This is useful for certain edge-cases where it may be hard to represent everything with decorators.\n"),r.Hb(),r.Ib(92,"p"),r.lc(93,"The "),r.Ib(94,"code"),r.lc(95,"@Schema()"),r.Hb(),r.lc(96," decorator marks a class as a schema definition. It maps our "),r.Ib(97,"code"),r.lc(98,"Cat"),r.Hb(),r.lc(99," class to a MongoDB collection of the same name, but with an additional \u201cs\u201d at the end - so the final mongo collection name will be "),r.Ib(100,"code"),r.lc(101,"cats"),r.Hb(),r.lc(102,". This decorator accepts a single optional argument which is a schema options object. Think of it as the object you would normally pass as a second argument of the "),r.Ib(103,"code"),r.lc(104,"mongoose.Schema"),r.Hb(),r.lc(105," class' constructor (e.g., "),r.Ib(106,"code"),r.lc(107,"new mongoose.Schema(_, options)"),r.Hb(),r.lc(108,")). To learn more about available schema options, see "),r.Ib(109,"a",20),r.lc(110,"this"),r.Hb(),r.lc(111," chapter."),r.Hb(),r.Ib(112,"p"),r.lc(113,"The "),r.Ib(114,"code"),r.lc(115,"@Prop()"),r.Hb(),r.lc(116," decorator defines a property in the document. For example, in the schema definition above, we defined three properties: "),r.Ib(117,"code"),r.lc(118,"name"),r.Hb(),r.lc(119,", "),r.Ib(120,"code"),r.lc(121,"age"),r.Hb(),r.lc(122,", and "),r.Ib(123,"code"),r.lc(124,"breed"),r.Hb(),r.lc(125,". The "),r.Ib(126,"a",21),r.lc(127,"schema types"),r.Hb(),r.lc(128," for these properties are automatically inferred thanks to TypeScript metadata (and reflection) capabilities. However, in more complex scenarios in which types cannot be implicitly reflected (for example, arrays or nested object structures), types must be indicated explicitly, as follows:"),r.Hb(),r.Ib(129,"pre"),r.Ib(130,"code",13),r.lc(131,"\n@Prop([String])\ntags: string[];"),r.Hb(),r.Hb(),r.Ib(132,"p"),r.lc(133,"Alternatively, the "),r.Ib(134,"code"),r.lc(135,"@Prop()"),r.Hb(),r.lc(136," decorator accepts an options object argument ("),r.Ib(137,"a",22),r.lc(138,"read more"),r.Hb(),r.lc(139," about the available options). With this, you can indicate whether a property is required or not, specify a default value, or mark it as immutable. For example:"),r.Hb(),r.Ib(140,"pre"),r.Ib(141,"code",13),r.lc(142,"\n@Prop({ required: true })\nname: string;"),r.Hb(),r.Hb(),r.Ib(143,"p"),r.lc(144,"Finally, the "),r.Ib(145,"strong"),r.lc(146,"raw"),r.Hb(),r.lc(147," schema definition can also be passed to the decorator. This is useful when, for example, a property represents a nested object which is not defined as a class. For this, use the "),r.Ib(148,"code"),r.lc(149,"raw()"),r.Hb(),r.lc(150," function from the "),r.Ib(151,"code"),r.lc(152,"@nestjs/mongoose"),r.Hb(),r.lc(153," package, as follows:"),r.Hb(),r.Ib(154,"pre"),r.Ib(155,"code",13),r.lc(156,"\n@Prop(raw({\n  firstName: { type: String },\n  lastName: { type: String }\n}))\ndetails: Record<string, any>;"),r.Hb(),r.Hb(),r.Ib(157,"p"),r.lc(158,"Alternatively, if you prefer "),r.Ib(159,"strong"),r.lc(160,"not using decorators"),r.Hb(),r.lc(161,", you can define a schema manually. For example:"),r.Hb(),r.Ib(162,"pre"),r.Ib(163,"code",13),r.lc(164,"\nexport const CatSchema = new mongoose.Schema({\n  name: String,\n  age: Number,\n  breed: String,\n});"),r.Hb(),r.Hb(),r.Ib(165,"p"),r.lc(166,"The "),r.Ib(167,"code"),r.lc(168,"cat.schema"),r.Hb(),r.lc(169," file resides in a folder in the "),r.Ib(170,"code"),r.lc(171,"cats"),r.Hb(),r.lc(172," directory, where we also define the "),r.Ib(173,"code"),r.lc(174,"CatsModule"),r.Hb(),r.lc(175,". While you can store schema files wherever you prefer, we recommend storing them them near their related "),r.Ib(176,"strong"),r.lc(177,"domain"),r.Hb(),r.lc(178," objects, in the appropriate module directory."),r.Hb(),r.Ib(179,"p"),r.lc(180,"Let's look at the "),r.Ib(181,"code"),r.lc(182,"CatsModule"),r.Hb(),r.lc(183,":"),r.Hb(),r.Ib(184,"span",11),r.lc(185),r.Ub(186,"extension"),r.Gb(187,"app-tabs",null,23),r.Hb(),r.Ib(189,"pre"),r.Ib(190,"code",13),r.lc(191,"\nimport { Module } from '@nestjs/common';\nimport { MongooseModule } from '@nestjs/mongoose';\nimport { CatsController } from './cats.controller';\nimport { CatsService } from './cats.service';\nimport { Cat, CatSchema } from './schemas/cat.schema';\n\n@Module({\n  imports: [MongooseModule.forFeature([{ name: Cat.name, schema: CatSchema }])],\n  controllers: [CatsController],\n  providers: [CatsService],\n})\nexport class CatsModule {}"),r.Hb(),r.Hb(),r.Ib(192,"p"),r.lc(193,"The "),r.Ib(194,"code"),r.lc(195,"MongooseModule"),r.Hb(),r.lc(196," provides the "),r.Ib(197,"code"),r.lc(198,"forFeature()"),r.Hb(),r.lc(199," method to configure the module, including defining which models should be registered in the current scope. If you also want to use the models in another module, add MongooseModule to the "),r.Ib(200,"code"),r.lc(201,"exports"),r.Hb(),r.lc(202," section of "),r.Ib(203,"code"),r.lc(204,"CatsModule"),r.Hb(),r.lc(205," and import "),r.Ib(206,"code"),r.lc(207,"CatsModule"),r.Hb(),r.lc(208," in the other module."),r.Hb(),r.Ib(209,"p"),r.lc(210,"Once you've registered the schema, you can inject a "),r.Ib(211,"code"),r.lc(212,"Cat"),r.Hb(),r.lc(213," model into the "),r.Ib(214,"code"),r.lc(215,"CatsService"),r.Hb(),r.lc(216," using the "),r.Ib(217,"code"),r.lc(218,"@InjectModel()"),r.Hb(),r.lc(219," decorator:"),r.Hb(),r.Ib(220,"span",11),r.lc(221),r.Ub(222,"extension"),r.Gb(223,"app-tabs",null,24),r.Hb(),r.Ib(225,"pre"),r.Ib(226,"code",13),r.lc(227,"\nimport { Model } from 'mongoose';\nimport { Injectable } from '@nestjs/common';\nimport { InjectModel } from '@nestjs/mongoose';\nimport { Cat } from './schemas/cat.schema';\nimport { CreateCatDto } from './dto/create-cat.dto';\n\n@Injectable()\nexport class CatsService {\n  constructor(@InjectModel(Cat.name) private catModel: Model<Cat>) {}\n\n  async create(createCatDto: CreateCatDto): Promise<Cat> {\n    const createdCat = new this.catModel(createCatDto);\n    return createdCat.save();\n  }\n\n  async findAll(): Promise<Cat[]> {\n    return this.catModel.find().exec();\n  }\n}"),r.Hb(),r.Hb(),r.Ib(228,"pre"),r.Ib(229,"code",13),r.lc(230,"\nimport { Model } from 'mongoose';\nimport { Injectable, Dependencies } from '@nestjs/common';\nimport { getModelToken } from '@nestjs/mongoose';\nimport { Cat } from './schemas/cat.schema';\n\n@Injectable()\n@Dependencies(getModelToken(Cat.name))\nexport class CatsService {\n  constructor(catModel) {\n    this.catModel = catModel;\n  }\n\n  async create(createCatDto) {\n    const createdCat = new this.catModel(createCatDto);\n    return createdCat.save();\n  }\n\n  async findAll() {\n    return this.catModel.find().exec();\n  }\n}"),r.Hb(),r.Hb(),r.Ib(231,"h4",25),r.Ib(232,"span"),r.lc(233,"Connection"),r.Hb(),r.Hb(),r.Ib(234,"p"),r.lc(235,"At times you may need to access the native "),r.Ib(236,"a",26),r.lc(237,"Mongoose Connection"),r.Hb(),r.lc(238," object. For example, you may want to make native API calls on the connection object. You can inject the Mongoose Connection by using the "),r.Ib(239,"code"),r.lc(240,"@InjectConnection()"),r.Hb(),r.lc(241," decorator as follows:"),r.Hb(),r.Ib(242,"pre"),r.Ib(243,"code",13),r.lc(244,"\nimport { Injectable } from '@nestjs/common';\nimport { InjectConnection } from '@nestjs/mongoose';\nimport { Connection } from 'mongoose';\n\n@Injectable()\nexport class CatsService {\n  constructor(@InjectConnection() private connection: Connection) {}\n}"),r.Hb(),r.Hb(),r.Ib(245,"h4",27),r.Ib(246,"span"),r.lc(247,"Multiple databases"),r.Hb(),r.Hb(),r.Ib(248,"p"),r.lc(249,"Some projects require multiple database connections. This can also be achieved with this module. To work with multiple connections, first create the connections. In this case, connection naming becomes "),r.Ib(250,"strong"),r.lc(251,"mandatory"),r.Hb(),r.lc(252,"."),r.Hb(),r.Ib(253,"span",11),r.lc(254),r.Ub(255,"extension"),r.Gb(256,"app-tabs",null,28),r.Hb(),r.Ib(258,"pre"),r.Ib(259,"code",13),r.lc(260,"\nimport { Module } from '@nestjs/common';\nimport { MongooseModule } from '@nestjs/mongoose';\n\n@Module({\n  imports: [\n    MongooseModule.forRoot('mongodb://localhost/test', {\n      connectionName: 'cats',\n    }),\n    MongooseModule.forRoot('mongodb://localhost/users', {\n      connectionName: 'users',\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(261,"blockquote",29),r.Ib(262,"strong"),r.lc(263,"Notice"),r.Hb(),r.lc(264," Please note that you shouldn't have multiple connections without a name, or with the same name, otherwise they will get overridden.\n"),r.Hb(),r.Ib(265,"p"),r.lc(266,"With this setup, you have to tell the "),r.Ib(267,"code"),r.lc(268,"MongooseModule.forFeature()"),r.Hb(),r.lc(269," function which connection should be used."),r.Hb(),r.Ib(270,"pre"),r.Ib(271,"code",13),r.lc(272,"\n@Module({\n  imports: [\n    MongooseModule.forFeature([{ name: Cat.name, schema: CatSchema }], 'cats'),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(273,"p"),r.lc(274,"You can also inject the "),r.Ib(275,"code"),r.lc(276,"Connection"),r.Hb(),r.lc(277," for a given connection:"),r.Hb(),r.Ib(278,"pre"),r.Ib(279,"code",13),r.lc(280,"\nimport { Injectable } from '@nestjs/common';\nimport { InjectConnection } from '@nestjs/mongoose';\nimport { Connection } from 'mongoose';\n\n@Injectable()\nexport class CatsService {\n  constructor(@InjectConnection('cats') private connection: Connection) {}\n}"),r.Hb(),r.Hb(),r.Ib(281,"h4",30),r.Ib(282,"span"),r.lc(283,"Hooks (middleware)"),r.Hb(),r.Hb(),r.Ib(284,"p"),r.lc(285,"Middleware (also called pre and post hooks) are functions which are passed control during execution of asynchronous functions. Middleware is specified on the schema level and is useful for writing plugins ("),r.Ib(286,"a",31),r.lc(287,"source"),r.Hb(),r.lc(288,"). Calling "),r.Ib(289,"code"),r.lc(290,"pre()"),r.Hb(),r.lc(291," or "),r.Ib(292,"code"),r.lc(293,"post()"),r.Hb(),r.lc(294," after compiling a model does not work in Mongoose. To register a hook "),r.Ib(295,"strong"),r.lc(296,"before"),r.Hb(),r.lc(297," model registration, use the "),r.Ib(298,"code"),r.lc(299,"forFeatureAsync()"),r.Hb(),r.lc(300," method of the "),r.Ib(301,"code"),r.lc(302,"MongooseModule"),r.Hb(),r.lc(303," along with a factory provider (i.e., "),r.Ib(304,"code"),r.lc(305,"useFactory"),r.Hb(),r.lc(306,"). With this technique, you can access a schema object, then use the "),r.Ib(307,"code"),r.lc(308,"pre()"),r.Hb(),r.lc(309," or "),r.Ib(310,"code"),r.lc(311,"post()"),r.Hb(),r.lc(312," method to register a hook on that schema. See example below:"),r.Hb(),r.Ib(313,"pre"),r.Ib(314,"code",13),r.lc(315,"\n@Module({\n  imports: [\n    MongooseModule.forFeatureAsync([\n      {\n        name: Cat.name,\n        useFactory: () => {\n          const schema = CatsSchema;\n          schema.pre('save', () => console.log('Hello from pre save'));\n          return schema;\n        },\n      },\n    ]),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(316,"p"),r.lc(317,"Like other "),r.Ib(318,"a",32),r.lc(319,"factory providers"),r.Hb(),r.lc(320,", our factory function can be "),r.Ib(321,"code"),r.lc(322,"async"),r.Hb(),r.lc(323," and can inject dependencies through "),r.Ib(324,"code"),r.lc(325,"inject"),r.Hb(),r.lc(326,"."),r.Hb(),r.Ib(327,"pre"),r.Ib(328,"code",13),r.lc(329,"\n@Module({\n  imports: [\n    MongooseModule.forFeatureAsync([\n      {\n        name: Cat.name,\n        imports: [ConfigModule],\n        useFactory: (configService: ConfigService) => {\n          const schema = CatsSchema;\n          schema.pre('save', () =>\n            console.log(\n              `${configService.get<string>('APP_NAME')}: Hello from pre save`,\n            ),\n          );\n          return schema;\n        },\n        inject: [ConfigService],\n      },\n    ]),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(330,"h4",33),r.Ib(331,"span"),r.lc(332,"Plugins"),r.Hb(),r.Hb(),r.Ib(333,"p"),r.lc(334,"To register a "),r.Ib(335,"a",34),r.lc(336,"plugin"),r.Hb(),r.lc(337," for a given schema, use the "),r.Ib(338,"code"),r.lc(339,"forFeatureAsync()"),r.Hb(),r.lc(340," method."),r.Hb(),r.Ib(341,"pre"),r.Ib(342,"code",13),r.lc(343,"\n@Module({\n  imports: [\n    MongooseModule.forFeatureAsync([\n      {\n        name: Cat.name,\n        useFactory: () => {\n          const schema = CatsSchema;\n          schema.plugin(require('mongoose-autopopulate'));\n          return schema;\n        },\n      },\n    ]),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(344,"p"),r.lc(345,"To register a plugin for all schemas at once, call the "),r.Ib(346,"code"),r.lc(347,".plugin()"),r.Hb(),r.lc(348," method of the "),r.Ib(349,"code"),r.lc(350,"Connection"),r.Hb(),r.lc(351," object. You should access the connection before models are created; to do this, use the "),r.Ib(352,"code"),r.lc(353,"connectionFactory"),r.Hb(),r.lc(354,":"),r.Hb(),r.Ib(355,"span",11),r.lc(356),r.Ub(357,"extension"),r.Gb(358,"app-tabs",null,35),r.Hb(),r.Ib(360,"pre"),r.Ib(361,"code",13),r.lc(362,"\nimport { Module } from '@nestjs/common';\nimport { MongooseModule } from '@nestjs/mongoose';\n\n@Module({\n  imports: [\n    MongooseModule.forRoot('mongodb://localhost/test', {\n      connectionFactory: (connection) => {\n        connection.plugin(require('mongoose-autopopulate'));\n        return connection;\n      }\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(363,"h4",36),r.Ib(364,"span"),r.lc(365,"Testing"),r.Hb(),r.Hb(),r.Ib(366,"p"),r.lc(367,"When unit testing an application, we usually want to avoid any database connection, making our test suites simpler to set up and faster to execute. But our classes might depend on models that are pulled from the connection instance. How do we resolve these classes? The solution is to create mock models."),r.Hb(),r.Ib(368,"p"),r.lc(369,"To make this easier, the "),r.Ib(370,"code"),r.lc(371,"@nestjs/mongoose"),r.Hb(),r.lc(372," package exposes a "),r.Ib(373,"code"),r.lc(374,"getModelToken()"),r.Hb(),r.lc(375," function that returns a prepared "),r.Ib(376,"a",37),r.lc(377,"injection token"),r.Hb(),r.lc(378," based on a token name. Using this token, you can easily provide a mock implementation using any of the standard "),r.Ib(379,"a",38),r.lc(380,"custom provider"),r.Hb(),r.lc(381," techniques, including "),r.Ib(382,"code"),r.lc(383,"useClass"),r.Hb(),r.lc(384,", "),r.Ib(385,"code"),r.lc(386,"useValue"),r.Hb(),r.lc(387,", and "),r.Ib(388,"code"),r.lc(389,"useFactory"),r.Hb(),r.lc(390,". For example:"),r.Hb(),r.Ib(391,"pre"),r.Ib(392,"code",13),r.lc(393,"\n@Module({\n  providers: [\n    CatsService,\n    {\n      provide: getModelToken(Cat.name),\n      useValue: catModel,\n    },\n  ],\n})\nexport class CatsModule {}"),r.Hb(),r.Hb(),r.Ib(394,"p"),r.lc(395,"In this example, a hardcoded "),r.Ib(396,"code"),r.lc(397,"catModel"),r.Hb(),r.lc(398," (object instance) will be provided whenever any consumer injects a "),r.Ib(399,"code"),r.lc(400,"Model<Cat>"),r.Hb(),r.lc(401," using an "),r.Ib(402,"code"),r.lc(403,"@InjectModel()"),r.Hb(),r.lc(404," decorator."),r.Hb(),r.Ib(405,"p"),r.Gb(406,"app-banner-courses"),r.Hb(),r.Ib(407,"h4",39),r.Ib(408,"span"),r.lc(409,"Async configuration"),r.Hb(),r.Hb(),r.Ib(410,"p"),r.lc(411,"When you need to pass module options asynchronously instead of statically, use the "),r.Ib(412,"code"),r.lc(413,"forRootAsync()"),r.Hb(),r.lc(414," method. As with most dynamic modules, Nest provides several techniques to deal with async configuration."),r.Hb(),r.Ib(415,"p"),r.lc(416,"One technique is to use a factory function:"),r.Hb(),r.Ib(417,"pre"),r.Ib(418,"code",13),r.lc(419,"\nMongooseModule.forRootAsync({\n  useFactory: () => ({\n    uri: 'mongodb://localhost/nest',\n  }),\n});"),r.Hb(),r.Hb(),r.Ib(420,"p"),r.lc(421,"Like other "),r.Ib(422,"a",32),r.lc(423,"factory providers"),r.Hb(),r.lc(424,", our factory function can be "),r.Ib(425,"code"),r.lc(426,"async"),r.Hb(),r.lc(427," and can inject dependencies through "),r.Ib(428,"code"),r.lc(429,"inject"),r.Hb(),r.lc(430,"."),r.Hb(),r.Ib(431,"pre"),r.Ib(432,"code",13),r.lc(433,"\nMongooseModule.forRootAsync({\n  imports: [ConfigModule],\n  useFactory: async (configService: ConfigService) => ({\n    uri: configService.get<string>('MONGODB_URI'),\n  }),\n  inject: [ConfigService],\n});"),r.Hb(),r.Hb(),r.Ib(434,"p"),r.lc(435,"Alternatively, you can configure the "),r.Ib(436,"code"),r.lc(437,"MongooseModule"),r.Hb(),r.lc(438," using a class instead of a factory, as shown below:"),r.Hb(),r.Ib(439,"pre"),r.Ib(440,"code",13),r.lc(441,"\nMongooseModule.forRootAsync({\n  useClass: MongooseConfigService,\n});"),r.Hb(),r.Hb(),r.Ib(442,"p"),r.lc(443,"The construction above instantiates "),r.Ib(444,"code"),r.lc(445,"MongooseConfigService"),r.Hb(),r.lc(446," inside "),r.Ib(447,"code"),r.lc(448,"MongooseModule"),r.Hb(),r.lc(449,", using it to create the required options object. Note that in this example, the "),r.Ib(450,"code"),r.lc(451,"MongooseConfigService"),r.Hb(),r.lc(452," has to implement the "),r.Ib(453,"code"),r.lc(454,"MongooseOptionsFactory"),r.Hb(),r.lc(455," interface, as shown below. The "),r.Ib(456,"code"),r.lc(457,"MongooseModule"),r.Hb(),r.lc(458," will call the "),r.Ib(459,"code"),r.lc(460,"createMongooseOptions()"),r.Hb(),r.lc(461," method on the instantiated object of the supplied class."),r.Hb(),r.Ib(462,"pre"),r.Ib(463,"code",13),r.lc(464,"\n@Injectable()\nclass MongooseConfigService implements MongooseOptionsFactory {\n  createMongooseOptions(): MongooseModuleOptions {\n    return {\n      uri: 'mongodb://localhost/nest',\n    };\n  }\n}"),r.Hb(),r.Hb(),r.Ib(465,"p"),r.lc(466,"If you want to reuse an existing options provider instead of creating a private copy inside the "),r.Ib(467,"code"),r.lc(468,"MongooseModule"),r.Hb(),r.lc(469,", use the "),r.Ib(470,"code"),r.lc(471,"useExisting"),r.Hb(),r.lc(472," syntax."),r.Hb(),r.Ib(473,"pre"),r.Ib(474,"code",13),r.lc(475,"\nMongooseModule.forRootAsync({\n  imports: [ConfigModule],\n  useExisting: ConfigService,\n});"),r.Hb(),r.Hb(),r.Ib(476,"h4",40),r.Ib(477,"span"),r.lc(478,"Example"),r.Hb(),r.Hb(),r.Ib(479,"p"),r.lc(480,"A working example is available "),r.Ib(481,"a",41),r.lc(482,"here"),r.Hb(),r.lc(483,"."),r.Hb(),r.Hb()),2&e){const e=r.dc(41),t=r.dc(78),o=r.dc(188),n=r.dc(224),s=r.dc(257),c=r.dc(359);r.vb(38),r.nc(" ",r.Vb(39,10,"app.module",e.isJsActive),"\n"),r.vb(37),r.nc(" ",r.Vb(76,13,"schemas/cat.schema",t.isJsActive),"\n"),r.vb(110),r.nc(" ",r.Vb(186,16,"cats.module",o.isJsActive),"\n"),r.vb(36),r.nc(" ",r.Vb(222,19,"cats.service",n.isJsActive),"\n"),r.vb(4),r.xb("hide",n.isJsActive),r.vb(3),r.xb("hide",!n.isJsActive),r.vb(26),r.nc(" ",r.Vb(255,22,"app.module",s.isJsActive),"\n"),r.vb(102),r.nc(" ",r.Vb(357,25,"app.module",c.isJsActive),"\n")}},directives:[s.f,i.a,l.a,b.a],pipes:[p.a],encapsulation:2,changeDetection:0}),e})();const T=r.Kb(S);let C=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return q(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-mvc"]],features:[r.tb],decls:215,vars:29,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/mvc.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","model-view-controller"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/express"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest-cli"],[1,"language-bash"],["rel","nofollow","target","_blank","href","http://expressjs.com/en/guide/using-template-engines.html"],["rel","nofollow","target","_blank","href","https://github.com/pillarjs/hbs#readme"],[1,"filename"],["app5d16f7cafdbd589cff9eddbddae8e036e0de488b",""],[1,"language-typescript"],["appAnchor","","id","template-rendering"],[1,"language-html"],["appba425d37507f8d6ed37e1dc4bf34e73eeea5c4d4",""],["appAnchor","","id","dynamic-template-rendering"],[1,"info"],["rel","nofollow","target","_blank","href","http://expressjs.com/en/api.html"],["app7a04c65b84443f22ea4bc9b050df757de46860e0",""],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/15-mvc"],["appAnchor","","id","fastify"],["routerLink","/techniques/performance"],["rel","nofollow","target","_blank","href","https://github.com/fastify/fastify"],["app09e2b4268965c27bf39af8c609ee109a067c9803",""],["app98bf741549d92ee0f09d766b30498f730ea4d0dc",""],["appAnchor","","id","example-1"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/17-mvc-fastify"]],template:function(e,t){if(1&e&&(r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"Model-View-Controller"),r.Hb(),r.Ib(7,"p"),r.lc(8,"Nest, by default, makes use of the "),r.Ib(9,"a",6),r.lc(10,"Express"),r.Hb(),r.lc(11," library under the hood. Hence, every technique for using the MVC (Model-View-Controller) pattern in Express applies to Nest as well."),r.Hb(),r.Ib(12,"p"),r.lc(13,"First, let's scaffold a simple Nest application using the "),r.Ib(14,"a",7),r.lc(15,"CLI"),r.Hb(),r.lc(16," tool:"),r.Hb(),r.Ib(17,"pre"),r.Ib(18,"code",8),r.lc(19,"\n$ npm i -g @nestjs/cli\n$ nest new project"),r.Hb(),r.Hb(),r.Ib(20,"p"),r.lc(21,"In order to create an MVC app, we also need a "),r.Ib(22,"a",9),r.lc(23,"template engine"),r.Hb(),r.lc(24," to render our HTML views:"),r.Hb(),r.Ib(25,"pre"),r.Ib(26,"code",8),r.lc(27,"\n$ npm install --save hbs"),r.Hb(),r.Hb(),r.Ib(28,"p"),r.lc(29,"We've used the "),r.Ib(30,"code"),r.lc(31,"hbs"),r.Hb(),r.lc(32," ("),r.Ib(33,"a",10),r.lc(34,"Handlebars"),r.Hb(),r.lc(35,") engine, though you can use whatever fits your requirements. Once the installation process is complete, we need to configure the express instance using the following code:"),r.Hb(),r.Ib(36,"span",11),r.lc(37),r.Ub(38,"extension"),r.Gb(39,"app-tabs",null,12),r.Hb(),r.Ib(41,"pre"),r.Ib(42,"code",13),r.lc(43,"\nimport { NestFactory } from '@nestjs/core';\nimport { NestExpressApplication } from '@nestjs/platform-express';\nimport { join } from 'path';\nimport { AppModule } from './app.module';\n\nasync function bootstrap() {\n  const app = await NestFactory.create<NestExpressApplication>(\n    AppModule,\n  );\n\n  app.useStaticAssets(join(__dirname, '..', 'public'));\n  app.setBaseViewsDir(join(__dirname, '..', 'views'));\n  app.setViewEngine('hbs');\n\n  await app.listen(3000);\n}\nbootstrap();"),r.Hb(),r.Hb(),r.Ib(44,"pre"),r.Ib(45,"code",13),r.lc(46,"\nimport { NestFactory } from '@nestjs/core';\nimport { join } from 'path';\nimport { AppModule } from './app.module';\n\nasync function bootstrap() {\n  const app = await NestFactory.create(\n    AppModule,\n  );\n\n  app.useStaticAssets(join(__dirname, '..', 'public'));\n  app.setBaseViewsDir(join(__dirname, '..', 'views'));\n  app.setViewEngine('hbs');\n\n  await app.listen(3000);\n}\nbootstrap();"),r.Hb(),r.Hb(),r.Ib(47,"p"),r.lc(48,"We told "),r.Ib(49,"a",6),r.lc(50,"Express"),r.Hb(),r.lc(51," that the "),r.Ib(52,"code"),r.lc(53,"public"),r.Hb(),r.lc(54," directory will be used for storing static assets, "),r.Ib(55,"code"),r.lc(56,"views"),r.Hb(),r.lc(57," will contain templates, and the "),r.Ib(58,"code"),r.lc(59,"hbs"),r.Hb(),r.lc(60," template engine should be used to render HTML output."),r.Hb(),r.Ib(61,"h4",14),r.Ib(62,"span"),r.lc(63,"Template rendering"),r.Hb(),r.Hb(),r.Ib(64,"p"),r.lc(65,"Now, let's create a "),r.Ib(66,"code"),r.lc(67,"views"),r.Hb(),r.lc(68," directory and "),r.Ib(69,"code"),r.lc(70,"index.hbs"),r.Hb(),r.lc(71," template inside it. In the template, we'll print a "),r.Ib(72,"code"),r.lc(73,"message"),r.Hb(),r.lc(74," passed from the controller:"),r.Hb(),r.Ib(75,"pre"),r.Ib(76,"code",15),r.lc(77),r.Hb(),r.Hb(),r.Ib(78,"p"),r.lc(79,"Next, open the "),r.Ib(80,"code"),r.lc(81,"app.controller"),r.Hb(),r.lc(82," file and replace the "),r.Ib(83,"code"),r.lc(84,"root()"),r.Hb(),r.lc(85," method with the following code:"),r.Hb(),r.Ib(86,"span",11),r.lc(87),r.Ub(88,"extension"),r.Gb(89,"app-tabs",null,16),r.Hb(),r.Ib(91,"pre"),r.Ib(92,"code",13),r.lc(93,"\nimport { Get, Controller, Render } from '@nestjs/common';\n\n@Controller()\nexport class AppController {\n  @Get()\n  @Render('index')\n  root() {\n    return { message: 'Hello world!' };\n  }\n}"),r.Hb(),r.Hb(),r.Ib(94,"p"),r.lc(95,"In this code, we are specifying the template to use in the "),r.Ib(96,"code"),r.lc(97,"@Render()"),r.Hb(),r.lc(98," decorator, and the return value of the route handler method is passed to the template for rendering. Notice that the return value is an object with a property "),r.Ib(99,"code"),r.lc(100,"message"),r.Hb(),r.lc(101,", matching the "),r.Ib(102,"code"),r.lc(103,"message"),r.Hb(),r.lc(104," placeholder we created in the template."),r.Hb(),r.Ib(105,"p"),r.lc(106,"While the application is running, open your browser and navigate to "),r.Ib(107,"code"),r.lc(108,"http://localhost:3000"),r.Hb(),r.lc(109,". You should see the "),r.Ib(110,"code"),r.lc(111,"Hello world!"),r.Hb(),r.lc(112," message."),r.Hb(),r.Ib(113,"h4",17),r.Ib(114,"span"),r.lc(115,"Dynamic template rendering"),r.Hb(),r.Hb(),r.Ib(116,"p"),r.lc(117,"If the application logic must dynamically decide which template to render, then we should use the "),r.Ib(118,"code"),r.lc(119,"@Res()"),r.Hb(),r.lc(120," decorator, and supply the view name in our route handler, rather than in the "),r.Ib(121,"code"),r.lc(122,"@Render()"),r.Hb(),r.lc(123," decorator:"),r.Hb(),r.Ib(124,"blockquote",18),r.Ib(125,"strong"),r.lc(126,"Hint"),r.Hb(),r.lc(127," When Nest detects the "),r.Ib(128,"code"),r.lc(129,"@Res()"),r.Hb(),r.lc(130," decorator, it injects the library-specific "),r.Ib(131,"code"),r.lc(132,"response"),r.Hb(),r.lc(133," object. We can use this object to dynamically render the template. Learn more about the "),r.Ib(134,"code"),r.lc(135,"response"),r.Hb(),r.lc(136," object API "),r.Ib(137,"a",19),r.lc(138,"here"),r.Hb(),r.lc(139,".\n"),r.Hb(),r.Ib(140,"span",11),r.lc(141),r.Ub(142,"extension"),r.Gb(143,"app-tabs",null,20),r.Hb(),r.Ib(145,"pre"),r.Ib(146,"code",13),r.lc(147,"\nimport { Get, Controller, Res, Render } from '@nestjs/common';\nimport { Response } from 'express';\nimport { AppService } from './app.service';\n\n@Controller()\nexport class AppController {\n  constructor(private appService: AppService) {}\n\n  @Get()\n  root(@Res() res: Response) {\n    return res.render(\n      this.appService.getViewName(),\n      { message: 'Hello world!' },\n    );\n  }\n}"),r.Hb(),r.Hb(),r.Ib(148,"h4",21),r.Ib(149,"span"),r.lc(150,"Example"),r.Hb(),r.Hb(),r.Ib(151,"p"),r.lc(152,"A working example is available "),r.Ib(153,"a",22),r.lc(154,"here"),r.Hb(),r.lc(155,"."),r.Hb(),r.Ib(156,"h4",23),r.Ib(157,"span"),r.lc(158,"Fastify"),r.Hb(),r.Hb(),r.Ib(159,"p"),r.lc(160,"As mentioned in this "),r.Ib(161,"a",24),r.lc(162,"chapter"),r.Hb(),r.lc(163,", we are able to use any compatible HTTP provider together with Nest. One such library is "),r.Ib(164,"a",25),r.lc(165,"Fastify"),r.Hb(),r.lc(166,". In order to create an MVC application with Fastify, we have to install the following packages:"),r.Hb(),r.Ib(167,"pre"),r.Ib(168,"code",8),r.lc(169,"\n$ npm i --save fastify point-of-view handlebars"),r.Hb(),r.Hb(),r.Ib(170,"p"),r.lc(171,"The next steps cover almost the same process used with Express, with minor differences specific to the platform. Once the installation process is complete, open the "),r.Ib(172,"code"),r.lc(173,"main.ts"),r.Hb(),r.lc(174," file and update its contents:"),r.Hb(),r.Ib(175,"span",11),r.lc(176),r.Ub(177,"extension"),r.Gb(178,"app-tabs",null,26),r.Hb(),r.Ib(180,"pre"),r.Ib(181,"code",13),r.lc(182,"\nimport { NestFactory } from '@nestjs/core';\nimport { NestFastifyApplication, FastifyAdapter } from '@nestjs/platform-fastify';\nimport { AppModule } from './app.module';\nimport { join } from 'path';\n\nasync function bootstrap() {\n  const app = await NestFactory.create<NestFastifyApplication>(\n    AppModule,\n    new FastifyAdapter(),\n  );\n  app.useStaticAssets({\n    root: join(__dirname, '..', 'public'),\n    prefix: '/public/',\n  });\n  app.setViewEngine({\n    engine: {\n      handlebars: require('handlebars'),\n    },\n    templates: join(__dirname, '..', 'views'),\n  });\n  await app.listen(3000);\n}\nbootstrap();"),r.Hb(),r.Hb(),r.Ib(183,"pre"),r.Ib(184,"code",13),r.lc(185,"\nimport { NestFactory } from '@nestjs/core';\nimport { FastifyAdapter } from '@nestjs/platform-fastify';\nimport { AppModule } from './app.module';\nimport { join } from 'path';\n\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule, new FastifyAdapter());\n  app.useStaticAssets({\n    root: join(__dirname, '..', 'public'),\n    prefix: '/public/',\n  });\n  app.setViewEngine({\n    engine: {\n      handlebars: require('handlebars'),\n    },\n    templates: join(__dirname, '..', 'views'),\n  });\n  await app.listen(3000);\n}\nbootstrap();"),r.Hb(),r.Hb(),r.Ib(186,"p"),r.lc(187,"The Fastify API is slightly different but the end result of those methods calls remains the same. One difference to notice with Fastify is that the template name passed into the "),r.Ib(188,"code"),r.lc(189,"@Render()"),r.Hb(),r.lc(190," decorator must include a file extension."),r.Hb(),r.Ib(191,"span",11),r.lc(192),r.Ub(193,"extension"),r.Gb(194,"app-tabs",null,27),r.Hb(),r.Ib(196,"pre"),r.Ib(197,"code",13),r.lc(198,"\nimport { Get, Controller, Render } from '@nestjs/common';\n\n@Controller()\nexport class AppController {\n  @Get()\n  @Render('index.hbs')\n  root() {\n    return { message: 'Hello world!' };\n  }\n}"),r.Hb(),r.Hb(),r.Ib(199,"p"),r.lc(200,"While the application is running, open your browser and navigate to "),r.Ib(201,"code"),r.lc(202,"http://localhost:3000"),r.Hb(),r.lc(203,". You should see the "),r.Ib(204,"code"),r.lc(205,"Hello world!"),r.Hb(),r.lc(206," message."),r.Hb(),r.Ib(207,"h4",28),r.Ib(208,"span"),r.lc(209,"Example"),r.Hb(),r.Hb(),r.Ib(210,"p"),r.lc(211,"A working example is available "),r.Ib(212,"a",29),r.lc(213,"here"),r.Hb(),r.lc(214,"."),r.Hb(),r.Hb()),2&e){const e=r.dc(40),t=r.dc(90),o=r.dc(144),n=r.dc(179),s=r.dc(195);r.vb(37),r.nc(" ",r.Vb(38,14,"main",e.isJsActive),"\n"),r.vb(4),r.xb("hide",e.isJsActive),r.vb(3),r.xb("hide",!e.isJsActive),r.vb(33),r.nc('\n<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset="utf-8" />\n    <title>App</title>\n  </head>\n  <body>\n    ',"{{ message }}","\n  </body>\n</html>"),r.vb(10),r.nc(" ",r.Vb(88,17,"app.controller",t.isJsActive),"\n"),r.vb(54),r.nc(" ",r.Vb(142,20,"app.controller",o.isJsActive),"\n"),r.vb(35),r.nc(" ",r.Vb(177,23,"main",n.isJsActive),"\n"),r.vb(4),r.xb("hide",n.isJsActive),r.vb(3),r.xb("hide",!n.isJsActive),r.vb(9),r.nc(" ",r.Vb(193,26,"app.controller",s.isJsActive),"\n")}},directives:[i.a,l.a,s.f],pipes:[p.a],encapsulation:2,changeDetection:0}),e})();const q=r.Kb(C);let U=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return R(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-performance"]],features:[r.tb],decls:105,vars:0,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/performance.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","performance-fastify"],["rel","nofollow","target","_blank","href","https://expressjs.com/"],["rel","nofollow","target","_blank","href","https://github.com/fastify/fastify"],[1,"info"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","adapter"],[1,"language-typescript"],["rel","nofollow","target","_blank","href","https://www.fastify.io/docs/latest/Getting-Started/#your-first-server"],["appAnchor","","id","platform-specific-packages"],["appAnchor","","id","redirect-response"],["appAnchor","","id","fastify-options"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/10-fastify"]],template:function(e,t){1&e&&(r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"Performance (Fastify)"),r.Hb(),r.Ib(7,"p"),r.lc(8,"By default, Nest makes use of the "),r.Ib(9,"a",6),r.lc(10,"Express"),r.Hb(),r.lc(11," framework. As mentioned earlier, Nest also provides compatibility with other libraries such as, for example, "),r.Ib(12,"a",7),r.lc(13,"Fastify"),r.Hb(),r.lc(14,". Nest achieves this framework independence by implementing a framework adapter whose primary function is to proxy middleware and handlers to appropriate library-specific implementations."),r.Hb(),r.Ib(15,"blockquote",8),r.Ib(16,"strong"),r.lc(17,"Hint"),r.Hb(),r.lc(18," Note that in order for a framework adapter to be implemented, the target library has to provide similar request/response pipeline processing as found in Express.\n"),r.Hb(),r.Ib(19,"p"),r.Ib(20,"a",7),r.lc(21,"Fastify"),r.Hb(),r.lc(22," provides a good alternative framework for Nest because it solves design issues in a similar manner to Express. However, fastify is much "),r.Ib(23,"strong"),r.lc(24,"faster"),r.Hb(),r.lc(25," than Express, achieving almost two times better benchmarks results. A fair question is why does Nest use Express as the default HTTP provider? The reason is that Express is widely-used, well-known, and has an enormous set of compatible middleware, which is available to Nest users out-of-the-box."),r.Hb(),r.Ib(26,"p"),r.lc(27,"But since Nest provides framework-independence, you can easily migrate between them. Fastify can be a better choice when you place high value on very fast performance. To utilize Fastify, simply choose the built-in "),r.Ib(28,"code"),r.lc(29,"FastifyAdapter"),r.Hb(),r.lc(30," as shown in this chapter."),r.Hb(),r.Ib(31,"h4",9),r.Ib(32,"span"),r.lc(33,"Installation"),r.Hb(),r.Hb(),r.Ib(34,"p"),r.lc(35,"First, we need to install the required package:"),r.Hb(),r.Ib(36,"pre"),r.Ib(37,"code",10),r.lc(38,"\n$ npm i --save @nestjs/platform-fastify"),r.Hb(),r.Hb(),r.Ib(39,"h4",11),r.Ib(40,"span"),r.lc(41,"Adapter"),r.Hb(),r.Hb(),r.Ib(42,"p"),r.lc(43,"Once the Fastify platform is installed, we can use the "),r.Ib(44,"code"),r.lc(45,"FastifyAdapter"),r.Hb(),r.lc(46,"."),r.Hb(),r.Ib(47,"pre"),r.Ib(48,"code",12),r.lc(49,"\nimport { NestFactory } from '@nestjs/core';\nimport {\n  FastifyAdapter,\n  NestFastifyApplication,\n} from '@nestjs/platform-fastify';\nimport { AppModule } from './app.module';\n\nasync function bootstrap() {\n  const app = await NestFactory.create<NestFastifyApplication>(\n    AppModule,\n    new FastifyAdapter()\n  );\n  await app.listen(3000);\n}\nbootstrap();"),r.Hb(),r.Hb(),r.Ib(50,"p"),r.lc(51,"By default, Fastify listens only on the "),r.Ib(52,"code"),r.lc(53,"localhost 127.0.0.1"),r.Hb(),r.lc(54," interface ("),r.Ib(55,"a",13),r.lc(56,"read more"),r.Hb(),r.lc(57,"). If you want to accept connections on other hosts, you should specify "),r.Ib(58,"code"),r.lc(59,"'0.0.0.0'"),r.Hb(),r.lc(60," in the "),r.Ib(61,"code"),r.lc(62,"listen()"),r.Hb(),r.lc(63," call:"),r.Hb(),r.Ib(64,"pre"),r.Ib(65,"code",12),r.lc(66,"\nasync function bootstrap() {\n  const app = await NestFactory.create<NestFastifyApplication>(\n    AppModule,\n    new FastifyAdapter()\n  );\n  await app.listen(3000, '0.0.0.0');\n}"),r.Hb(),r.Hb(),r.Ib(67,"h4",14),r.Ib(68,"span"),r.lc(69,"Platform specific packages"),r.Hb(),r.Hb(),r.Ib(70,"p"),r.lc(71,"Keep in mind that when you use the "),r.Ib(72,"code"),r.lc(73,"FastifyAdapter"),r.Hb(),r.lc(74,", Nest uses Fastify as the "),r.Ib(75,"strong"),r.lc(76,"HTTP provider"),r.Hb(),r.lc(77,". This means that each recipe that relies on Express may no longer work. You should, instead, use Fastify equivalent packages."),r.Hb(),r.Ib(78,"h4",15),r.Ib(79,"span"),r.lc(80,"Redirect response"),r.Hb(),r.Hb(),r.Ib(81,"p"),r.lc(82,"Fastify handles redirect responses slightly differently than Express. To do a proper redirect with Fastify, return both the status code and the URL, as follows:"),r.Hb(),r.Ib(83,"pre"),r.Ib(84,"code",12),r.lc(85,"\n@Get()\nindex(@Res() res) {\n  res.status(302).redirect('/login');\n}"),r.Hb(),r.Hb(),r.Ib(86,"h4",16),r.Ib(87,"span"),r.lc(88,"Fastify options"),r.Hb(),r.Hb(),r.Ib(89,"p"),r.lc(90,"You can pass options into the Fastify constructor through the "),r.Ib(91,"code"),r.lc(92,"FastifyAdapter"),r.Hb(),r.lc(93," constructor. For example:"),r.Hb(),r.Ib(94,"pre"),r.Ib(95,"code",12),r.lc(96,"\nnew FastifyAdapter({ logger: true });"),r.Hb(),r.Hb(),r.Ib(97,"h4",17),r.Ib(98,"span"),r.lc(99,"Example"),r.Hb(),r.Hb(),r.Ib(100,"p"),r.lc(101,"A working example is available "),r.Ib(102,"a",18),r.lc(103,"here"),r.Hb(),r.lc(104,"."),r.Hb(),r.Hb())},directives:[l.a],encapsulation:2,changeDetection:0}),e})();const R=r.Kb(U);let O=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return P(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-queues"]],features:[r.tb],decls:788,vars:4,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/queues.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","queues"],["rel","nofollow","target","_blank","href","https://github.com/OptimalBits/bull"],["rel","nofollow","target","_blank","href","https://redis.io/"],["href","techniques/queues#producers"],["href","techniques/queues#consumers"],["href","techniques/queues#event-listeners"],["rel","nofollow","target","_blank","href","https://github.com/OptimalBits/bull/blob/master/REFERENCE.md"],["appAnchor","","id","installation"],[1,"language-bash"],[1,"filename"],["appe9df5908e929d99326bbbe2501a6465001487066",""],[1,"language-typescript"],["rel","nofollow","target","_blank","href","https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#queue"],["rel","nofollow","target","_blank","href","https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#queueadd"],[1,"info"],["appAnchor","","id","producers"],["routerLink","/providers"],["appAnchor","","id","named-jobs"],[1,"Warning"],["appAnchor","","id","job-options"],["appAnchor","","id","consumers"],["rel","nofollow","target","_blank","href","https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#job"],["appAnchor","","id","event-listeners"],["rel","nofollow","target","_blank","href","https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#events"],["appAnchor","","id","queue-management"],["appAnchor","","id","async-configuration"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/fundamentals/async-providers"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/26-queues"]],template:function(e,t){if(1&e){r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"Queues"),r.Hb(),r.Ib(7,"p"),r.lc(8,"Queues are a powerful design pattern that help you deal with common application scaling and performance challenges. Some examples of problems that Queues can help you solve are:"),r.Hb(),r.Ib(9,"ul"),r.Ib(10,"li"),r.lc(11,"Smooth out processing peaks. For example, if users can initiate resource-intensive tasks at arbitrary times, you can add these tasks to a queue instead of performing them synchronously. Then you can have worker processes pull tasks from the queue in a controlled manner. You can easily add new Queue consumers to scale up the back-end task handling as the application scales up."),r.Hb(),r.Ib(12,"li"),r.lc(13,"Break up monolithic tasks that may otherwise block the Node.js event loop. For example, if a user request requires CPU intensive work like audio transcoding, you can delegate this task to other processes, freeing up user-facing processes to remain responsive."),r.Hb(),r.Ib(14,"li"),r.lc(15,"Provide a reliable communication channel across various services. For example, you can queue tasks (jobs) in one process or service, and consume them in another. You can be notified (by listening for status events) upon completion, error or other state changes in the job life cycle from any process or service. When Queue producers or consumers fail, their state is preserved and task handling can restart automatically when nodes are restarted."),r.Hb(),r.Hb(),r.Ib(16,"p"),r.lc(17,"Nest provides the "),r.Ib(18,"code"),r.lc(19,"@nestjs/bull"),r.Hb(),r.lc(20," package as an abstraction/wrapper on top of "),r.Ib(21,"a",6),r.lc(22,"Bull"),r.Hb(),r.lc(23,", a popular, well supported, high performance Node.js based Queue system implementation. The package makes it easy to integrate Bull Queues in a Nest-friendly way to your application."),r.Hb(),r.Ib(24,"p"),r.lc(25,"Bull uses "),r.Ib(26,"a",7),r.lc(27,"Redis"),r.Hb(),r.lc(28," to persist job data, so you'll need to have Redis installed on your system. Because it is Redis-backed, your Queue architecture can be completely distributed and platform-independent. For example, you can have some Queue "),r.Ib(29,"a",8),r.lc(30,"producers"),r.Hb(),r.lc(31," and "),r.Ib(32,"a",9),r.lc(33,"consumers"),r.Hb(),r.lc(34," and "),r.Ib(35,"a",10),r.lc(36,"listeners"),r.Hb(),r.lc(37," running in Nest on one (or several) nodes, and other producers, consumers and listeners running on other Node.js platforms on other network nodes."),r.Hb(),r.Ib(38,"p"),r.lc(39,"This chapter covers the "),r.Ib(40,"code"),r.lc(41,"@nestjs/bull"),r.Hb(),r.lc(42," package. We also recommend reading the "),r.Ib(43,"a",11),r.lc(44,"Bull documentation"),r.Hb(),r.lc(45," for more background and specific implementation details."),r.Hb(),r.Ib(46,"h4",12),r.Ib(47,"span"),r.lc(48,"Installation"),r.Hb(),r.Hb(),r.Ib(49,"p"),r.lc(50,"To begin using it, we first install the required dependencies."),r.Hb(),r.Ib(51,"pre"),r.Ib(52,"code",13),r.lc(53,"\n$ npm install --save @nestjs/bull bull\n$ npm install --save-dev @types/bull"),r.Hb(),r.Hb(),r.Ib(54,"p"),r.lc(55,"Once the installation process is complete, we can import the "),r.Ib(56,"code"),r.lc(57,"BullModule"),r.Hb(),r.lc(58," into the root "),r.Ib(59,"code"),r.lc(60,"AppModule"),r.Hb(),r.lc(61,"."),r.Hb(),r.Ib(62,"span",14),r.lc(63),r.Ub(64,"extension"),r.Gb(65,"app-tabs",null,15),r.Hb(),r.Ib(67,"pre"),r.Ib(68,"code",16),r.lc(69,"\nimport { Module } from '@nestjs/common';\nimport { BullModule } from '@nestjs/bull';\n\n@Module({\n  imports: [\n    BullModule.registerQueue({\n      name: 'audio',\n      redis: {\n        host: 'localhost',\n        port: 6379,\n      },\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(70,"p"),r.lc(71,"The "),r.Ib(72,"code"),r.lc(73,"registerQueue()"),r.Hb(),r.lc(74," method is used to instantiate and/or register queues. Queues are shared across modules and processes that connect to the same underlying Redis database with the same credentials. Each queue is unique by its name property (see below). When sharing queues (across modules/processes), the first "),r.Ib(75,"code"),r.lc(76,"registerQueue()"),r.Hb(),r.lc(77," method to run both "),r.Ib(78,"strong"),r.lc(79,"instantiates"),r.Hb(),r.lc(80," the queue and "),r.Ib(81,"strong"),r.lc(82,"registers"),r.Hb(),r.lc(83," it for that module. Other modules (in the same or separate processes) simply "),r.Ib(84,"strong"),r.lc(85,"register"),r.Hb(),r.lc(86," the queue. Queue registration creates an "),r.Ib(87,"strong"),r.lc(88,"injection token"),r.Hb(),r.lc(89," that can be used to access the queue in a given Nest module."),r.Hb(),r.Ib(90,"p"),r.lc(91,"For each queue, pass a configuration object containing the following properties:"),r.Hb(),r.Ib(92,"ul"),r.Ib(93,"li"),r.Ib(94,"code"),r.lc(95,"name: string"),r.Hb(),r.lc(96," - A queue name, which will be used as both an injection token (for injecting the queue into controllers/providers), and as an argument to decorators to associate consumer classes and listeners with queues. Required."),r.Hb(),r.Ib(97,"li"),r.Ib(98,"code"),r.lc(99,"limiter: RateLimiter"),r.Hb(),r.lc(100," - Options to control the rate at which the queue's jobs are processed. See "),r.Ib(101,"a",17),r.lc(102,"RateLimiter"),r.Hb(),r.lc(103," for more information. Optional."),r.Hb(),r.Ib(104,"li"),r.Ib(105,"code"),r.lc(106,"redis: RedisOpts"),r.Hb(),r.lc(107," - Options to configure the Redis connection. See "),r.Ib(108,"a",17),r.lc(109,"RedisOpts"),r.Hb(),r.lc(110," for more information. Optional."),r.Hb(),r.Ib(111,"li"),r.Ib(112,"code"),r.lc(113,"prefix: string"),r.Hb(),r.lc(114," - Prefix for all queue keys. Optional."),r.Hb(),r.Ib(115,"li"),r.Ib(116,"code"),r.lc(117,"defaultJobOptions: JobOpts"),r.Hb(),r.lc(118," - Options to control the default settings for new jobs. See "),r.Ib(119,"a",18),r.lc(120,"JobOpts"),r.Hb(),r.lc(121," for more information. Optional."),r.Hb(),r.Ib(122,"li"),r.Ib(123,"code"),r.lc(124,"settings: AdvancedSettings"),r.Hb(),r.lc(125," - Advanced Queue configuration settings. These should usually not be changed. See "),r.Ib(126,"a",17),r.lc(127,"AdvancedSettings"),r.Hb(),r.lc(128," for more information. Optional."),r.Hb(),r.Hb(),r.Ib(129,"p"),r.lc(130,"As noted, the "),r.Ib(131,"code"),r.lc(132,"name"),r.Hb(),r.lc(133," property is required. The rest of the options are optional, providing detailed control over queue behavior. These are passed directly to the Bull "),r.Ib(134,"code"),r.lc(135,"Queue"),r.Hb(),r.lc(136," constructor. Read more about these options "),r.Ib(137,"a",17),r.lc(138,"here"),r.Hb(),r.lc(139,". When registering a queue in a second or subsequent module, it is best practice to omit all options but the "),r.Ib(140,"code"),r.lc(141,"name"),r.Hb(),r.lc(142," property from the configuration object. These options should be specified only in the module that "),r.Ib(143,"strong"),r.lc(144,"instantiates"),r.Hb(),r.lc(145," the queue."),r.Hb(),r.Ib(146,"blockquote",19),r.Ib(147,"strong"),r.lc(148,"Hint"),r.Hb(),r.lc(149," Create multiple queues by passing multiple comma-separated configuration objects to the "),r.Ib(150,"code"),r.lc(151,"registerQueue()"),r.Hb(),r.lc(152," method.\n"),r.Hb(),r.Ib(153,"p"),r.lc(154,"Since jobs are persisted in Redis, each time a specific named queue is instantiated (e.g., when an app is started/restarted), it attempts to process any old jobs that may exist from a previous unfinished session."),r.Hb(),r.Ib(155,"p"),r.lc(156,"Each queue can have one or many producers, consumers, and listeners. Consumers retrieve jobs from the queue in a specific order: FIFO (the default), LIFO, or according to priorities. Controlling queue processing order is discussed "),r.Ib(157,"a",9),r.lc(158,"here"),r.Hb(),r.lc(159,"."),r.Hb(),r.Ib(160,"p"),r.Gb(161,"app-banner-enterprise"),r.Hb(),r.Ib(162,"h4",20),r.Ib(163,"span"),r.lc(164,"Producers"),r.Hb(),r.Hb(),r.Ib(165,"p"),r.lc(166,"Job producers add jobs to queues. Producers are typically application services (Nest "),r.Ib(167,"a",21),r.lc(168,"providers"),r.Hb(),r.lc(169,"). To add jobs to a queue, first inject the queue into the service as follows:"),r.Hb(),r.Ib(170,"pre"),r.Ib(171,"code",16),r.lc(172,"\nimport { Injectable } from '@nestjs/common';\nimport { Queue } from 'bull';\nimport { InjectQueue } from '@nestjs/bull';\n\n@Injectable()\nexport class AudioService {\n  constructor(@InjectQueue('audio') private audioQueue: Queue) {}\n}"),r.Hb(),r.Hb(),r.Ib(173,"blockquote",19),r.Ib(174,"strong"),r.lc(175,"Hint"),r.Hb(),r.lc(176," The "),r.Ib(177,"code"),r.lc(178,"@InjectQueue()"),r.Hb(),r.lc(179," decorator identifies the queue by its name, as provided in the "),r.Ib(180,"code"),r.lc(181,"registerQueue()"),r.Hb(),r.lc(182," method call (e.g., "),r.Ib(183,"code"),r.lc(184,"'audio'"),r.Hb(),r.lc(185,").\n"),r.Hb(),r.Ib(186,"p"),r.lc(187,"Now, add a job by calling the queue's "),r.Ib(188,"code"),r.lc(189,"add()"),r.Hb(),r.lc(190," method, passing a user-defined job object. Jobs are represented as serializable JavaScript objects (since that is how they are stored in the Redis database). The shape of the job you pass is arbitrary; use it to represent the semantics of your job object."),r.Hb(),r.Ib(191,"pre"),r.Ib(192,"code",16),r.lc(193,"\nconst job = await this.audioQueue.add({\n  foo: 'bar',\n});"),r.Hb(),r.Hb(),r.Ib(194,"h4",22),r.Ib(195,"span"),r.lc(196,"Named jobs"),r.Hb(),r.Hb(),r.Ib(197,"p"),r.lc(198,"Jobs may have unique names. This allows you to create specialized "),r.Ib(199,"a",9),r.lc(200,"consumers"),r.Hb(),r.lc(201," that will only process jobs with a given name."),r.Hb(),r.Ib(202,"pre"),r.Ib(203,"code",16),r.lc(204,"\nconst job = await this.audioQueue.add('transcode', {\n  foo: 'bar',\n});"),r.Hb(),r.Hb(),r.Ib(205,"blockquote",23),r.Ib(206,"strong"),r.lc(207,"Warning"),r.Hb(),r.lc(208," When using named jobs, you must create processors for each unique name added to a queue, or the queue will complain that you are missing a processor for the given job. See "),r.Ib(209,"a",9),r.lc(210,"here"),r.Hb(),r.lc(211," for more information on consuming named jobs.\n"),r.Hb(),r.Ib(212,"h4",24),r.Ib(213,"span"),r.lc(214,"Job options"),r.Hb(),r.Hb(),r.Ib(215,"p"),r.lc(216,"Jobs can have additional options associated with them. Pass an options object after the "),r.Ib(217,"code"),r.lc(218,"job"),r.Hb(),r.lc(219," argument in the "),r.Ib(220,"code"),r.lc(221,"Queue.add()"),r.Hb(),r.lc(222," method. Job options properties are:"),r.Hb(),r.Ib(223,"ul"),r.Ib(224,"li"),r.Ib(225,"code"),r.lc(226,"priority"),r.Hb(),r.lc(227,": "),r.Ib(228,"code"),r.lc(229,"number"),r.Hb(),r.lc(230," - Optional priority value. Ranges from 1 (highest priority) to MAX_INT (lowest priority). Note that using priorities has a slight impact on performance, so use them with caution."),r.Hb(),r.Ib(231,"li"),r.Ib(232,"code"),r.lc(233,"delay"),r.Hb(),r.lc(234,": "),r.Ib(235,"code"),r.lc(236,"number"),r.Hb(),r.lc(237," - An amount of time (milliseconds) to wait until this job can be processed. Note that for accurate delays, both server and clients should have their clocks synchronized."),r.Hb(),r.Ib(238,"li"),r.Ib(239,"code"),r.lc(240,"attempts"),r.Hb(),r.lc(241,": "),r.Ib(242,"code"),r.lc(243,"number"),r.Hb(),r.lc(244," - The total number of attempts to try the job until it completes."),r.Hb(),r.Ib(245,"li"),r.Ib(246,"code"),r.lc(247,"repeat"),r.Hb(),r.lc(248,": "),r.Ib(249,"code"),r.lc(250,"RepeatOpts"),r.Hb(),r.lc(251," - Repeat job according to a cron specification. See "),r.Ib(252,"a",18),r.lc(253,"RepeatOpts"),r.Hb(),r.lc(254,"."),r.Hb(),r.Ib(255,"li"),r.Ib(256,"code"),r.lc(257,"backoff"),r.Hb(),r.lc(258,": "),r.Ib(259,"code"),r.lc(260,"number | BackoffOpts"),r.Hb(),r.lc(261," - Backoff setting for automatic retries if the job fails. See "),r.Ib(262,"a",18),r.lc(263,"BackoffOpts"),r.Hb(),r.lc(264,"."),r.Hb(),r.Ib(265,"li"),r.Ib(266,"code"),r.lc(267,"lifo"),r.Hb(),r.lc(268,": "),r.Ib(269,"code"),r.lc(270,"boolean"),r.Hb(),r.lc(271," - If true, adds the job to the right end of the queue instead of the left (default false)."),r.Hb(),r.Ib(272,"li"),r.Ib(273,"code"),r.lc(274,"timeout"),r.Hb(),r.lc(275,": "),r.Ib(276,"code"),r.lc(277,"number"),r.Hb(),r.lc(278," - The number of milliseconds after which the job should fail with a timeout error."),r.Hb(),r.Ib(279,"li"),r.Ib(280,"code"),r.lc(281,"jobId"),r.Hb(),r.lc(282,": "),r.Ib(283,"code"),r.lc(284,"number"),r.Hb(),r.lc(285," | "),r.Ib(286,"code"),r.lc(287,"string"),r.Hb(),r.lc(288," - Override the job ID - by default, the job ID is a unique\ninteger, but you can use this setting to override it. If you use this option, it is up to you to ensure the jobId is unique. If you attempt to add a job with an id that already exists, it will not be added."),r.Hb(),r.Ib(289,"li"),r.Ib(290,"code"),r.lc(291,"removeOnComplete"),r.Hb(),r.lc(292,": "),r.Ib(293,"code"),r.lc(294,"boolean | number"),r.Hb(),r.lc(295," - If true, removes the job when it successfully completes. A number specifies the amount of jobs to keep. Default behavior is to keep the job in the completed set."),r.Hb(),r.Ib(296,"li"),r.Ib(297,"code"),r.lc(298,"removeOnFail"),r.Hb(),r.lc(299,": "),r.Ib(300,"code"),r.lc(301,"boolean | number"),r.Hb(),r.lc(302," - If true, removes the job when it fails after all attempts. A number specifies the amount of jobs to keep. Default behavior is to keep the job in the failed set."),r.Hb(),r.Ib(303,"li"),r.Ib(304,"code"),r.lc(305,"stackTraceLimit"),r.Hb(),r.lc(306,": "),r.Ib(307,"code"),r.lc(308,"number"),r.Hb(),r.lc(309," - Limits the amount of stack trace lines that will be recorded in the stacktrace."),r.Hb(),r.Hb(),r.Ib(310,"p"),r.lc(311,"Here are a few examples of customizing jobs with job options."),r.Hb(),r.Ib(312,"p"),r.lc(313,"To delay the start of a job, use the "),r.Ib(314,"code"),r.lc(315,"delay"),r.Hb(),r.lc(316," configuration property."),r.Hb(),r.Ib(317,"pre"),r.Ib(318,"code",16),r.lc(319,"\nconst job = await this.audioQueue.add(\n  {\n    foo: 'bar',\n  },\n  { delay: 3000 }, // 3 seconds delayed\n);"),r.Hb(),r.Hb(),r.Ib(320,"p"),r.lc(321,"To add a job to the right end of the queue (process the job as "),r.Ib(322,"strong"),r.lc(323,"LIFO"),r.Hb(),r.lc(324," (Last In First Out)), set the "),r.Ib(325,"code"),r.lc(326,"lifo"),r.Hb(),r.lc(327," property of the configuration object to "),r.Ib(328,"code"),r.lc(329,"true"),r.Hb(),r.lc(330,"."),r.Hb(),r.Ib(331,"pre"),r.Ib(332,"code",16),r.lc(333,"\nconst job = await this.audioQueue.add(\n  {\n    foo: 'bar',\n  },\n  { lifo: true },\n);"),r.Hb(),r.Hb(),r.Ib(334,"p"),r.lc(335,"To prioritize a job, use the "),r.Ib(336,"code"),r.lc(337,"priority"),r.Hb(),r.lc(338," property."),r.Hb(),r.Ib(339,"pre"),r.Ib(340,"code",16),r.lc(341,"\nconst job = await this.audioQueue.add(\n  {\n    foo: 'bar',\n  },\n  { priority: 2 },\n);"),r.Hb(),r.Hb(),r.Ib(342,"h4",25),r.Ib(343,"span"),r.lc(344,"Consumers"),r.Hb(),r.Hb(),r.Ib(345,"p"),r.lc(346,"A consumer is a "),r.Ib(347,"strong"),r.lc(348,"class"),r.Hb(),r.lc(349," defining methods that either process jobs added into the queue, or listen for events on the queue, or both. Declare a consumer class using the "),r.Ib(350,"code"),r.lc(351,"@Processor()"),r.Hb(),r.lc(352," decorator as follows:"),r.Hb(),r.Ib(353,"pre"),r.Ib(354,"code",16),r.lc(355,"\nimport { Processor } from '@nestjs/bull';\n\n@Processor('audio')\nexport class AudioConsumer {}"),r.Hb(),r.Hb(),r.Ib(356,"p"),r.lc(357,"Where the decorator's string argument (e.g., "),r.Ib(358,"code"),r.lc(359,"'audio'"),r.Hb(),r.lc(360,") is the name of the queue to be associated with the class methods."),r.Hb(),r.Ib(361,"p"),r.lc(362,"Within a consumer class, declare job handlers by decorating handler methods with the "),r.Ib(363,"code"),r.lc(364,"@Process()"),r.Hb(),r.lc(365," decorator."),r.Hb(),r.Ib(366,"pre"),r.Ib(367,"code",16),r.lc(368,"\nimport { Processor, Process } from '@nestjs/bull';\nimport { Job } from 'bull';\n\n@Processor('audio')\nexport class AudioConsumer {\n  @Process()\n  async transcode(job: Job<unknown>) {\n    let progress = 0;\n    for (i = 0; i < 100; i++) {\n      await doSomething(job.data);\n      progress += 10;\n      job.progress(progress);\n    }\n    return {};\n  }\n}"),r.Hb(),r.Hb(),r.Ib(369,"p"),r.lc(370,"The decorated method (e.g., "),r.Ib(371,"code"),r.lc(372,"transcode()"),r.Hb(),r.lc(373,") is called whenever the worker is idle and there are jobs to process in the queue. This handler method receives the "),r.Ib(374,"code"),r.lc(375,"job"),r.Hb(),r.lc(376," object as its only argument. The value returned by the handler method is stored in the job object and can be accessed later on, for example in a listener for the completed event."),r.Hb(),r.Ib(377,"p"),r.Ib(378,"code"),r.lc(379,"Job"),r.Hb(),r.lc(380," objects have multiple methods that allow you to interact with their state. For example, the above code uses the "),r.Ib(381,"code"),r.lc(382,"progress()"),r.Hb(),r.lc(383," method to update the job's progress. See "),r.Ib(384,"a",26),r.lc(385,"here"),r.Hb(),r.lc(386," for the complete "),r.Ib(387,"code"),r.lc(388,"Job"),r.Hb(),r.lc(389," object API reference."),r.Hb(),r.Ib(390,"p"),r.lc(391,"You can designate that a job handler method will handle "),r.Ib(392,"strong"),r.lc(393,"only"),r.Hb(),r.lc(394," jobs of a certain type (jobs with a specific "),r.Ib(395,"code"),r.lc(396,"name"),r.Hb(),r.lc(397,") by passing that "),r.Ib(398,"code"),r.lc(399,"name"),r.Hb(),r.lc(400," to the "),r.Ib(401,"code"),r.lc(402,"@Process()"),r.Hb(),r.lc(403," decorator as shown below. You can have multiple "),r.Ib(404,"code"),r.lc(405,"@Process()"),r.Hb(),r.lc(406," handlers in a given consumer class, corresponding to each job type ("),r.Ib(407,"code"),r.lc(408,"name"),r.Hb(),r.lc(409,"). When you use named jobs, be sure to have a handler corresponding to each name."),r.Hb(),r.Ib(410,"pre"),r.Ib(411,"code",16),r.lc(412,"\n@Process('transcode')\nasync transcode(job: Job<unknown>) { ... }"),r.Hb(),r.Hb(),r.Ib(413,"h4",27),r.Ib(414,"span"),r.lc(415,"Event listeners"),r.Hb(),r.Hb(),r.Ib(416,"p"),r.lc(417,"Bull generates a set of useful events when queue and/or job state changes occur. Nest provides a set of decorators that allow subscribing to a core set of standard events. These are exported from the "),r.Ib(418,"code"),r.lc(419,"@nestjs/bull"),r.Hb(),r.lc(420," package."),r.Hb(),r.Ib(421,"p"),r.lc(422,"Event listeners must be declared within a "),r.Ib(423,"a",9),r.lc(424,"consumer"),r.Hb(),r.lc(425," class (i.e., within a class decorated with the "),r.Ib(426,"code"),r.lc(427,"@Processor()"),r.Hb(),r.lc(428," decorator). To listen for an event, use one of the decorators in the table below to declare a handler for the event. For example, to listen to the event emitted when a job enters the active state in the "),r.Ib(429,"code"),r.lc(430,"audio"),r.Hb(),r.lc(431," queue, use the following construct:"),r.Hb(),r.Ib(432,"pre"),r.Ib(433,"code",16),r.lc(434,"\nimport { Processor, Process } from '@nestjs/bull';\nimport { Job } from 'bull';\n\n@Processor('audio')\nexport class AudioConsumer {\n\n  @OnQueueActive()\n  onActive(job: Job) {\n    console.log(\n      `Processing job ${job.id} of type ${job.name} with data ${job.data}...`,\n    );\n  }\n  ..."),r.Hb(),r.Hb(),r.Ib(435,"p"),r.lc(436,"Since Bull operates in a distributed (multi-node) environment, it defines the concept of event locality. This concept recognizes that events may be triggered either entirely within a single process, or on shared queues from different processes. A "),r.Ib(437,"strong"),r.lc(438,"local"),r.Hb(),r.lc(439," event is one that is produced when an action or state change is triggered on a queue in the local process. In other words, when your event producers and consumers are local to a single process, all events happening on queues are local."),r.Hb(),r.Ib(440,"p"),r.lc(441,"When a queue is shared across multiple processes, we encounter the possibility of "),r.Ib(442,"strong"),r.lc(443,"global"),r.Hb(),r.lc(444," events. For a listener in one process to receive an event notification triggered by another process, it must register for a global event."),r.Hb(),r.Ib(445,"p"),r.lc(446,"Event handlers are invoked whenever their corresponding event is emitted. The handler is called with the signature shown in the table below, providing access to information relevant to the event. We discuss one key difference between local and global event handler signatures below."),r.Hb(),r.Ib(447,"table"),r.Ib(448,"tr"),r.Ib(449,"th"),r.lc(450,"Local event listeners"),r.Hb(),r.Ib(451,"th"),r.lc(452,"Global event listeners"),r.Hb(),r.Ib(453,"th"),r.lc(454,"Handler method signature / When fired"),r.Hb(),r.Hb(),r.Ib(455,"tr"),r.Ib(456,"td"),r.Ib(457,"code"),r.lc(458,"@OnQueueError()"),r.Hb(),r.Hb(),r.Ib(459,"td"),r.Ib(460,"code"),r.lc(461,"@OnGlobalQueueError()"),r.Hb(),r.Hb(),r.Ib(462,"td"),r.Ib(463,"code"),r.lc(464,"handler(error: Error)"),r.Hb(),r.lc(465," - An error occurred. "),r.Ib(466,"code"),r.lc(467,"error"),r.Hb(),r.lc(468," contains the triggering error."),r.Hb(),r.Hb(),r.Ib(469,"tr"),r.Ib(470,"td"),r.Ib(471,"code"),r.lc(472,"@OnQueueWaiting()"),r.Hb(),r.Hb(),r.Ib(473,"td"),r.Ib(474,"code"),r.lc(475,"@OnGlobalQueueWaiting()"),r.Hb(),r.Hb(),r.Ib(476,"td"),r.Ib(477,"code"),r.lc(478,"handler(jobId: number | string)"),r.Hb(),r.lc(479," - A Job is waiting to be processed as soon as a worker is idling. "),r.Ib(480,"code"),r.lc(481,"jobId"),r.Hb(),r.lc(482," contains the id for the job that has entered this state."),r.Hb(),r.Hb(),r.Ib(483,"tr"),r.Ib(484,"td"),r.Ib(485,"code"),r.lc(486,"@OnQueueActive()"),r.Hb(),r.Hb(),r.Ib(487,"td"),r.Ib(488,"code"),r.lc(489,"@OnGlobalQueueActive()"),r.Hb(),r.Hb(),r.Ib(490,"td"),r.Ib(491,"code"),r.lc(492,"handler(job: Job)"),r.Hb(),r.lc(493," - Job "),r.Ib(494,"code"),r.lc(495,"job"),r.Hb(),r.lc(496,"has started. "),r.Hb(),r.Hb(),r.Ib(497,"tr"),r.Ib(498,"td"),r.Ib(499,"code"),r.lc(500,"@OnQueueStalled()"),r.Hb(),r.Hb(),r.Ib(501,"td"),r.Ib(502,"code"),r.lc(503,"@OnGlobalQueueStalled()"),r.Hb(),r.Hb(),r.Ib(504,"td"),r.Ib(505,"code"),r.lc(506,"handler(job: Job)"),r.Hb(),r.lc(507," - Job "),r.Ib(508,"code"),r.lc(509,"job"),r.Hb(),r.lc(510," has been marked as stalled. This is useful for debugging job workers that crash or pause the event loop."),r.Hb(),r.Hb(),r.Ib(511,"tr"),r.Ib(512,"td"),r.Ib(513,"code"),r.lc(514,"@OnQueueProgress()"),r.Hb(),r.Hb(),r.Ib(515,"td"),r.Ib(516,"code"),r.lc(517,"@OnGlobalQueueProgress()"),r.Hb(),r.Hb(),r.Ib(518,"td"),r.Ib(519,"code"),r.lc(520,"handler(job: Job, progress: number)"),r.Hb(),r.lc(521," - Job "),r.Ib(522,"code"),r.lc(523,"job"),r.Hb(),r.lc(524,"'s progress was updated to value "),r.Ib(525,"code"),r.lc(526,"progress"),r.Hb(),r.lc(527,"."),r.Hb(),r.Hb(),r.Ib(528,"tr"),r.Ib(529,"td"),r.Ib(530,"code"),r.lc(531,"@OnQueueCompleted()"),r.Hb(),r.Hb(),r.Ib(532,"td"),r.Ib(533,"code"),r.lc(534,"@OnGlobalQueueCompleted()"),r.Hb(),r.Hb(),r.Ib(535,"td"),r.Ib(536,"code"),r.lc(537,"handler(job: Job, result: any)"),r.Hb(),r.lc(538," Job "),r.Ib(539,"code"),r.lc(540,"job"),r.Hb(),r.lc(541," successfully completed with a result "),r.Ib(542,"code"),r.lc(543,"result"),r.Hb(),r.lc(544,"."),r.Hb(),r.Hb(),r.Ib(545,"tr"),r.Ib(546,"td"),r.Ib(547,"code"),r.lc(548,"@OnQueueFailed()"),r.Hb(),r.Hb(),r.Ib(549,"td"),r.Ib(550,"code"),r.lc(551,"@OnGlobalQueueFailed()");r.Hb(),r.Hb(),r.Ib(552,"td"),r.Ib(553,"code"),r.lc(554,"handler(job: Job, err: Error)"),r.Hb(),r.lc(555," Job "),r.Ib(556,"code"),r.lc(557,"job"),r.Hb(),r.lc(558," failed with reason "),r.Ib(559,"code"),r.lc(560,"err"),r.Hb(),r.lc(561,"."),r.Hb(),r.Hb(),r.Ib(562,"tr"),r.Ib(563,"td"),r.Ib(564,"code"),r.lc(565,"@OnQueuePaused()"),r.Hb(),r.Hb(),r.Ib(566,"td"),r.Ib(567,"code"),r.lc(568,"@OnGlobalQueuePaused()"),r.Hb(),r.Hb(),r.Ib(569,"td"),r.Ib(570,"code"),r.lc(571,"handler()"),r.Hb(),r.lc(572," The queue has been paused."),r.Hb(),r.Hb(),r.Ib(573,"tr"),r.Ib(574,"td"),r.Ib(575,"code"),r.lc(576,"@OnQueueResumed()"),r.Hb(),r.Hb(),r.Ib(577,"td"),r.Ib(578,"code"),r.lc(579,"@OnGlobalQueueResumed()"),r.Hb(),r.Hb(),r.Ib(580,"td"),r.Ib(581,"code"),r.lc(582,"handler(job: Job)"),r.Hb(),r.lc(583," The queue has been resumed."),r.Hb(),r.Hb(),r.Ib(584,"tr"),r.Ib(585,"td"),r.Ib(586,"code"),r.lc(587,"@OnQueueCleaned()"),r.Hb(),r.Hb(),r.Ib(588,"td"),r.Ib(589,"code"),r.lc(590,"@OnGlobalQueueCleaned()"),r.Hb(),r.Hb(),r.Ib(591,"td"),r.Ib(592,"code"),r.lc(593,"handler(jobs: Job[], type: string)"),r.Hb(),r.lc(594," Old jobs have been cleaned from the queue. "),r.Ib(595,"code"),r.lc(596,"jobs"),r.Hb(),r.lc(597," is an array of cleaned jobs, and "),r.Ib(598,"code"),r.lc(599,"type"),r.Hb(),r.lc(600," is the type of jobs cleaned."),r.Hb(),r.Hb(),r.Ib(601,"tr"),r.Ib(602,"td"),r.Ib(603,"code"),r.lc(604,"@OnQueueDrained()"),r.Hb(),r.Hb(),r.Ib(605,"td"),r.Ib(606,"code"),r.lc(607,"@OnGlobalQueueDrained()"),r.Hb(),r.Hb(),r.Ib(608,"td"),r.Ib(609,"code"),r.lc(610,"handler()"),r.Hb(),r.lc(611," Emitted whenever the queue has processed all the waiting jobs (even if there can be some delayed jobs not yet processed)."),r.Hb(),r.Hb(),r.Ib(612,"tr"),r.Ib(613,"td"),r.Ib(614,"code"),r.lc(615,"@OnQueueRemoved()"),r.Hb(),r.Hb(),r.Ib(616,"td"),r.Ib(617,"code"),r.lc(618,"@OnGlobalQueueRemoved()"),r.Hb(),r.Hb(),r.Ib(619,"td"),r.Ib(620,"code"),r.lc(621,"handler(job: Job)"),r.Hb(),r.lc(622," Job "),r.Ib(623,"code"),r.lc(624,"job"),r.Hb(),r.lc(625," was successfully removed."),r.Hb(),r.Hb(),r.Hb(),r.Ib(626,"p"),r.lc(627,"When listening for global events, the method signatures can be slightly different from their local counterpart. Specifically, any method signature that receives "),r.Ib(628,"code"),r.lc(629,"job"),r.Hb(),r.lc(630," objects in the local version, instead receives a "),r.Ib(631,"code"),r.lc(632,"jobId"),r.Hb(),r.lc(633," ("),r.Ib(634,"code"),r.lc(635,"number"),r.Hb(),r.lc(636,") in the global version. To get a reference to the actual "),r.Ib(637,"code"),r.lc(638,"job"),r.Hb(),r.lc(639," object in such a case, use the "),r.Ib(640,"code"),r.lc(641,"Queue#getJob"),r.Hb(),r.lc(642," method. This call should be awaited, and therefore the handler should be declared "),r.Ib(643,"code"),r.lc(644,"async"),r.Hb(),r.lc(645,". For example:"),r.Hb(),r.Ib(646,"pre"),r.Ib(647,"code",16),r.lc(648,"\n@OnGlobalQueueCompleted()\nasync onGlobalCompleted(jobId: number, result: any) {\n  const job = await this.immediateQueue.getJob(jobId);\n  console.log('(Global) on completed: job ', job.id, ' -> result: ', result);\n}"),r.Hb(),r.Hb(),r.Ib(649,"blockquote",19),r.Ib(650,"strong"),r.lc(651,"Hint"),r.Hb(),r.lc(652," To access the "),r.Ib(653,"code"),r.lc(654,"Queue"),r.Hb(),r.lc(655," object (to make a "),r.Ib(656,"code"),r.lc(657,"getJob()"),r.Hb(),r.lc(658," call), you must of course inject it. Also, the Queue must be registered in the module where you are injecting it.\n"),r.Hb(),r.Ib(659,"p"),r.lc(660,"In addition to the specific event listener decorators, you can also use the generic "),r.Ib(661,"code"),r.lc(662,"@OnQueueEvent()"),r.Hb(),r.lc(663," decorator in combination with either "),r.Ib(664,"code"),r.lc(665,"BullQueueEvents"),r.Hb(),r.lc(666," or "),r.Ib(667,"code"),r.lc(668,"BullQueueGlobalEvents"),r.Hb(),r.lc(669," enums. Read more about events "),r.Ib(670,"a",28),r.lc(671,"here"),r.Hb(),r.lc(672,"."),r.Hb(),r.Ib(673,"h4",29),r.Ib(674,"span"),r.lc(675,"Queue management"),r.Hb(),r.Hb(),r.Ib(676,"p"),r.lc(677,"Queue's have an API that allows you to perform management functions like pausing and resuming, retrieving the count of jobs in various states, and several more. You can find the full queue API "),r.Ib(678,"a",17),r.lc(679,"here"),r.Hb(),r.lc(680,". Invoke any of these methods directly on the "),r.Ib(681,"code"),r.lc(682,"Queue"),r.Hb(),r.lc(683," object, as shown below with the pause/resume examples."),r.Hb(),r.Ib(684,"p"),r.lc(685,"Pause a queue with the "),r.Ib(686,"code"),r.lc(687,"pause()"),r.Hb(),r.lc(688," method call. A paused queue will not process new jobs until resumed, but current jobs being processed will continue until they are finalized."),r.Hb(),r.Ib(689,"pre"),r.Ib(690,"code",16),r.lc(691,"\nawait audioQueue.pause();"),r.Hb(),r.Hb(),r.Ib(692,"p"),r.lc(693,"To resume a paused queue, use the "),r.Ib(694,"code"),r.lc(695,"resume()"),r.Hb(),r.lc(696," method, as follows:"),r.Hb(),r.Ib(697,"pre"),r.Ib(698,"code",16),r.lc(699,"\nawait audioQueue.resume();"),r.Hb(),r.Hb(),r.Ib(700,"h4",30),r.Ib(701,"span"),r.lc(702,"Async configuration"),r.Hb(),r.Hb(),r.Ib(703,"p"),r.lc(704,"You may want to pass your queue options asynchronously instead of statically. In this case, use the "),r.Ib(705,"code"),r.lc(706,"registerQueueAsync()"),r.Hb(),r.lc(707," method, which provides several ways to deal with async configuration."),r.Hb(),r.Ib(708,"p"),r.lc(709,"One approach is to use a factory function:"),r.Hb(),r.Ib(710,"pre"),r.Ib(711,"code",16),r.lc(712,"\nBullModule.registerQueueAsync({\n  name: 'audio',\n  useFactory: () => ({\n    redis: {\n      host: 'localhost',\n      port: 6379,\n    },\n  }),\n});"),r.Hb(),r.Hb(),r.Ib(713,"p"),r.lc(714,"Our factory behaves like any other "),r.Ib(715,"a",31),r.lc(716,"asynchronous provider"),r.Hb(),r.lc(717," (e.g., it can be "),r.Ib(718,"code"),r.lc(719,"async"),r.Hb(),r.lc(720," and it's able to inject dependencies through "),r.Ib(721,"code"),r.lc(722,"inject"),r.Hb(),r.lc(723,")."),r.Hb(),r.Ib(724,"pre"),r.Ib(725,"code",16),r.lc(726,"\nBullModule.registerQueueAsync({\n  name: 'audio',\n  imports: [ConfigModule],\n  useFactory: async (configService: ConfigService) => ({\n    redis: {\n      host: configService.get('QUEUE_HOST'),\n      port: +configService.get('QUEUE_PORT'),\n    },\n  }),\n  inject: [ConfigService],\n});"),r.Hb(),r.Hb(),r.Ib(727,"p"),r.lc(728,"Alternatively, you can use the "),r.Ib(729,"code"),r.lc(730,"useClass"),r.Hb(),r.lc(731," syntax:"),r.Hb(),r.Ib(732,"pre"),r.Ib(733,"code",16),r.lc(734,"\nBullModule.registerQueueAsync({\n  name: 'audio',\n  useClass: BullConfigService,\n});"),r.Hb(),r.Hb(),r.Ib(735,"p"),r.lc(736,"The construction above will instantiate "),r.Ib(737,"code"),r.lc(738,"BullConfigService"),r.Hb(),r.lc(739," inside "),r.Ib(740,"code"),r.lc(741,"BullModule"),r.Hb(),r.lc(742," and use it to provide an options object by calling "),r.Ib(743,"code"),r.lc(744,"createBullOptions()"),r.Hb(),r.lc(745,". Note that this means that the "),r.Ib(746,"code"),r.lc(747,"BullConfigService"),r.Hb(),r.lc(748," has to implement the "),r.Ib(749,"code"),r.lc(750,"BullOptionsFactory"),r.Hb(),r.lc(751," interface, as shown below:"),r.Hb(),r.Ib(752,"pre"),r.Ib(753,"code",16),r.lc(754,"\n@Injectable()\nclass BullConfigService implements BullOptionsFactory {\n  createBullOptions(): BullModuleOptions {\n    return {\n      redis: {\n        host: 'localhost',\n        port: 6379,\n      },\n    };\n  }\n}"),r.Hb(),r.Hb(),r.Ib(755,"p"),r.lc(756,"In order to prevent the creation of "),r.Ib(757,"code"),r.lc(758,"BullConfigService"),r.Hb(),r.lc(759," inside "),r.Ib(760,"code"),r.lc(761,"BullModule"),r.Hb(),r.lc(762," and use a provider imported from a different module, you can use the "),r.Ib(763,"code"),r.lc(764,"useExisting"),r.Hb(),r.lc(765," syntax."),r.Hb(),r.Ib(766,"pre"),r.Ib(767,"code",16),r.lc(768,"\nBullModule.registerQueueAsync({\n  name: 'audio',\n  imports: [ConfigModule],\n  useExisting: ConfigService,\n});"),r.Hb(),r.Hb(),r.Ib(769,"p"),r.lc(770,"This construction works the same as "),r.Ib(771,"code"),r.lc(772,"useClass"),r.Hb(),r.lc(773," with one critical difference - "),r.Ib(774,"code"),r.lc(775,"BullModule"),r.Hb(),r.lc(776," will lookup imported modules to reuse an existing "),r.Ib(777,"code"),r.lc(778,"ConfigService"),r.Hb(),r.lc(779," instead of instantiating a new one."),r.Hb(),r.Ib(780,"h4",32),r.Ib(781,"span"),r.lc(782,"Example"),r.Hb(),r.Hb(),r.Ib(783,"p"),r.lc(784,"A working example is available "),r.Ib(785,"a",33),r.lc(786,"here"),r.Hb(),r.lc(787,"."),r.Hb(),r.Hb()}if(2&e){const e=r.dc(66);r.vb(63),r.nc(" ",r.Vb(64,1,"app.module",e.isJsActive),"\n")}},directives:[l.a,i.a,d.a,s.f],pipes:[p.a],encapsulation:2,changeDetection:0}),e})();const P=r.Kb(O);let E=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return J(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-securit"]],features:[r.tb],decls:193,vars:0,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/security.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","security"],["appAnchor","","id","helmet"],["rel","nofollow","target","_blank","href","https://github.com/helmetjs/helmet"],["rel","nofollow","target","_blank","href","https://github.com/helmetjs/helmet#how-it-works"],["rel","nofollow","target","_blank","href","https://expressjs.com/"],[1,"language-bash"],[1,"language-typescript"],["rel","nofollow","target","_blank","href","https://github.com/fastify/fastify-helmet"],["rel","nofollow","target","_blank","href","https://www.fastify.io/docs/latest/Plugins/"],[1,"info"],["appAnchor","","id","cors"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/cors"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/cors#configuration-options"],["appAnchor","","id","csrf"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/csurf"],[1,"warning"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/csurf#csurf"],["appAnchor","","id","rate-limiting"],["rel","nofollow","target","_blank","href","https://github.com/nfriedly/express-rate-limit"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/first-steps#platform"],["rel","nofollow","target","_blank","href","https://expressjs.com/en/guide/behind-proxies.html"],["rel","nofollow","target","_blank","href","https://github.com/fastify/fastify-rate-limit"]],template:function(e,t){1&e&&(r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"Security"),r.Hb(),r.Ib(7,"p"),r.lc(8,"In this chapter we cover various techniques that help you to increase the security of your applications."),r.Hb(),r.Ib(9,"h4",6),r.Ib(10,"span"),r.lc(11,"Helmet"),r.Hb(),r.Hb(),r.Ib(12,"p"),r.Ib(13,"a",7),r.lc(14,"Helmet"),r.Hb(),r.lc(15," can help protect your app from some well-known web vulnerabilities by setting HTTP headers appropriately. Generally, Helmet is just a collection of 14 smaller middleware functions that set security-related HTTP headers (read "),r.Ib(16,"a",8),r.lc(17,"more"),r.Hb(),r.lc(18,")."),r.Hb(),r.Ib(19,"p"),r.lc(20,"Start by installing the required package. If you are using "),r.Ib(21,"a",9),r.lc(22,"Express"),r.Hb(),r.lc(23," (default in Nest):"),r.Hb(),r.Ib(24,"pre"),r.Ib(25,"code",10),r.lc(26,"\n$ npm i --save helmet"),r.Hb(),r.Hb(),r.Ib(27,"p"),r.lc(28,"Once the installation is complete, apply it as a global middleware."),r.Hb(),r.Ib(29,"pre"),r.Ib(30,"code",11),r.lc(31,"\nimport * as helmet from 'helmet';\n// somewhere in your initialization file\napp.use(helmet());"),r.Hb(),r.Hb(),r.Ib(32,"p"),r.lc(33,"If you are using the "),r.Ib(34,"code"),r.lc(35,"FastifyAdapter"),r.Hb(),r.lc(36,", you'll need "),r.Ib(37,"a",12),r.lc(38,"fastify-helmet"),r.Hb(),r.lc(39," instead:"),r.Hb(),r.Ib(40,"pre"),r.Ib(41,"code",10),r.lc(42,"\n$ npm i --save fastify-helmet"),r.Hb(),r.Hb(),r.Ib(43,"p"),r.Ib(44,"a",12),r.lc(45,"fastify-helmet"),r.Hb(),r.lc(46," should not be used as a middleware, but as a "),r.Ib(47,"a",13),r.lc(48,"Fastify plugin"),r.Hb(),r.lc(49,", i.e., by using "),r.Ib(50,"code"),r.lc(51,"app.register()"),r.Hb(),r.lc(52,":"),r.Hb(),r.Ib(53,"pre"),r.Ib(54,"code",11),r.lc(55,"\nimport * as helmet from 'fastify-helmet';\n// somewhere in your initialization file\napp.register(helmet);\n// or the following, but note that it's not type safe\n// app.getHttpAdapter().register(helmet);"),r.Hb(),r.Hb(),r.Ib(56,"blockquote",14),r.Ib(57,"strong"),r.lc(58,"Hint"),r.Hb(),r.lc(59," Note that applying "),r.Ib(60,"code"),r.lc(61,"helmet"),r.Hb(),r.lc(62," as global or registering it must come before other calls to "),r.Ib(63,"code"),r.lc(64,"app.use()"),r.Hb(),r.lc(65," or setup functions that may call "),r.Ib(66,"code"),r.lc(67,"app.use()"),r.Hb(),r.lc(68,"). This is due to the way the underlying platform (i.e., Express or Fastify) works, where the order that middleware/routes are defined matters. If you use middleware like "),r.Ib(69,"code"),r.lc(70,"helmet"),r.Hb(),r.lc(71," or "),r.Ib(72,"code"),r.lc(73,"cors"),r.Hb(),r.lc(74," after you define a route, then that middleware will not apply to that route, it will only apply to middleware defined after the route.\n"),r.Hb(),r.Ib(75,"h4",15),r.Ib(76,"span"),r.lc(77,"CORS"),r.Hb(),r.Hb(),r.Ib(78,"p"),r.lc(79,"Cross-origin resource sharing (CORS) is a mechanism that allows resources to be requested from another domain. Under the hood, Nest makes use of the Express "),r.Ib(80,"a",16),r.lc(81,"cors"),r.Hb(),r.lc(82," package. This package provides various options that you can customize based on your requirements. To enable CORS, call the "),r.Ib(83,"code"),r.lc(84,"enableCors()"),r.Hb(),r.lc(85," method on the Nest application object."),r.Hb(),r.Ib(86,"pre"),r.Ib(87,"code",11),r.lc(88,"\nconst app = await NestFactory.create(AppModule);\napp.enableCors();\nawait app.listen(3000);"),r.Hb(),r.Hb(),r.Ib(89,"p"),r.lc(90,"The "),r.Ib(91,"code"),r.lc(92,"enableCors()"),r.Hb(),r.lc(93," method takes an optional configuration object argument. The available properties of this object are described in the official "),r.Ib(94,"a",17),r.lc(95,"CORS"),r.Hb(),r.lc(96," documentation."),r.Hb(),r.Ib(97,"p"),r.lc(98,"Alternatively, enable CORS via the "),r.Ib(99,"code"),r.lc(100,"create()"),r.Hb(),r.lc(101," method's options object. Set the "),r.Ib(102,"code"),r.lc(103,"cors"),r.Hb(),r.lc(104," property to "),r.Ib(105,"code"),r.lc(106,"true"),r.Hb(),r.lc(107," to enable CORS with default settings. Alternatively, pass a "),r.Ib(108,"a",17),r.lc(109,"CORS configuration object"),r.Hb(),r.lc(110," as the "),r.Ib(111,"code"),r.lc(112,"cors"),r.Hb(),r.lc(113," property value to customize its behavior."),r.Hb(),r.Ib(114,"pre"),r.Ib(115,"code",11),r.lc(116,"\nconst app = await NestFactory.create(AppModule, { cors: true });\nawait app.listen(3000);"),r.Hb(),r.Hb(),r.Ib(117,"h4",18),r.Ib(118,"span"),r.lc(119,"CSRF"),r.Hb(),r.Hb(),r.Ib(120,"p"),r.lc(121,"Cross-site request forgery (also known as CSRF or XSRF) is a type of malicious exploit of a website where "),r.Ib(122,"strong"),r.lc(123,"unauthorized"),r.Hb(),r.lc(124," commands are transmitted from a user that the web application trusts. To mitigate this kind of attack you can use the "),r.Ib(125,"a",19),r.lc(126,"csurf"),r.Hb(),r.lc(127," package."),r.Hb(),r.Ib(128,"p"),r.lc(129,"Start by installing the required package:"),r.Hb(),r.Ib(130,"pre"),r.Ib(131,"code",10),r.lc(132,"\n$ npm i --save csurf"),r.Hb(),r.Hb(),r.Ib(133,"blockquote",20),r.Ib(134,"strong"),r.lc(135,"Warning"),r.Hb(),r.lc(136," As explained on the "),r.Ib(137,"a",21),r.lc(138,"csurf middleware page"),r.Hb(),r.lc(139,", the csurf module requires either session middleware or a cookie-parser to be initialized first. Please see that documentation for further instructions.\n"),r.Hb(),r.Ib(140,"p"),r.lc(141,"Once the installation is complete, apply the csurf middleware as global middleware."),r.Hb(),r.Ib(142,"pre"),r.Ib(143,"code",11),r.lc(144,"\nimport * as csurf from 'csurf';\n// somewhere in your initialization file\napp.use(csurf());"),r.Hb(),r.Hb(),r.Ib(145,"h4",22),r.Ib(146,"span"),r.lc(147,"Rate limiting"),r.Hb(),r.Hb(),r.Ib(148,"p"),r.lc(149,"A common technique to protect applications from brute-force attacks is "),r.Ib(150,"strong"),r.lc(151,"rate-limiting"),r.Hb(),r.lc(152,". Many Express packages exist to provide a rate-limiting feature. A popular one is "),r.Ib(153,"a",23),r.lc(154,"express-rate-limit"),r.Hb(),r.lc(155,"."),r.Hb(),r.Ib(156,"p"),r.lc(157,"Start by installing the required package:"),r.Hb(),r.Ib(158,"pre"),r.Ib(159,"code",10),r.lc(160,"\n$ npm i --save express-rate-limit"),r.Hb(),r.Hb(),r.Ib(161,"p"),r.lc(162,"Once the installation is complete, apply the rate-limiter as global middleware."),r.Hb(),r.Ib(163,"pre"),r.Ib(164,"code",11),r.lc(165,"\nimport * as rateLimit from 'express-rate-limit';\n// somewhere in your initialization file\napp.use(\n  rateLimit({\n    windowMs: 15 * 60 * 1000, // 15 minutes\n    max: 100, // limit each IP to 100 requests per windowMs\n  }),\n);"),r.Hb(),r.Hb(),r.Ib(166,"p"),r.lc(167,"When there is a load balancer or reverse proxy between the server and the internet, Express may need to be configured to trust the headers set by the proxy in order to get the correct IP for the end user. To do so, first use the "),r.Ib(168,"code"),r.lc(169,"NestExpressApplication"),r.Hb(),r.lc(170," platform "),r.Ib(171,"a",24),r.lc(172,"interface"),r.Hb(),r.lc(173," when creating your "),r.Ib(174,"code"),r.lc(175,"app"),r.Hb(),r.lc(176," instance, then enable the "),r.Ib(177,"a",25),r.lc(178,"trust proxy"),r.Hb(),r.lc(179," setting:"),r.Hb(),r.Ib(180,"pre"),r.Ib(181,"code",11),r.lc(182,"\nconst app = await NestFactory.create<NestExpressApplication>(AppModule);\n// see https://expressjs.com/en/guide/behind-proxies.html\napp.set('trust proxy', 1);"),r.Hb(),r.Hb(),r.Ib(183,"blockquote",14),r.Ib(184,"strong"),r.lc(185,"Hint"),r.Hb(),r.lc(186," If you use the "),r.Ib(187,"code"),r.lc(188,"FastifyAdapter"),r.Hb(),r.lc(189,", consider using "),r.Ib(190,"a",26),r.lc(191,"fastify-rate-limit"),r.Hb(),r.lc(192," instead.\n"),r.Hb(),r.Hb())},directives:[l.a],encapsulation:2,changeDetection:0}),e})();const J=r.Kb(E);let F=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return N(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-serialization"]],features:[r.tb],decls:163,vars:2,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/serialization.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","serialization"],["appAnchor","","id","overview"],["rel","nofollow","target","_blank","href","https://github.com/typestack/class-transformer"],["appAnchor","","id","exclude-properties"],[1,"language-typescript"],[1,""],[1,"info"],[1,"language-json"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/interceptors#binding-interceptors"],["appAnchor","","id","expose-properties"],["appAnchor","","id","transform"],["appAnchor","","id","pass-options"],["appAnchor","","id","websockets-and-microservices"],["appAnchor","","id","learn-more"]],template:function(e,t){1&e&&(r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"Serialization"),r.Hb(),r.Ib(7,"p"),r.lc(8,"Serialization is a process that happens before objects are returned in a network response. This is an appropriate place to provide rules for transforming and sanitizing the data to be returned to the client. For example, sensitive data like passwords should always be excluded from the response. Or, certain properties might require additional transformation, such as sending only a subset of properties of an entity. Performing these transformations manually can be tedious and error prone, and can leave you uncertain that all cases have been covered."),r.Hb(),r.Ib(9,"h4",6),r.Ib(10,"span"),r.lc(11,"Overview"),r.Hb(),r.Hb(),r.Ib(12,"p"),r.lc(13,"Nest provides a built-in capability to help ensure that these operations can be performed in a straightforward way. The "),r.Ib(14,"code"),r.lc(15,"ClassSerializerInterceptor"),r.Hb(),r.lc(16," interceptor uses the powerful "),r.Ib(17,"a",7),r.lc(18,"class-transformer"),r.Hb(),r.lc(19," package to provide a declarative and extensible way of transforming objects. The basic operation it performs is to take the value returned by a method handler and apply the "),r.Ib(20,"code"),r.lc(21,"classToPlain()"),r.Hb(),r.lc(22," function from "),r.Ib(23,"a",7),r.lc(24,"class-transformer"),r.Hb(),r.lc(25,". In doing so, it can apply rules expressed by "),r.Ib(26,"code"),r.lc(27,"class-transformer"),r.Hb(),r.lc(28," decorators on an entity/DTO class, as described below."),r.Hb(),r.Ib(29,"h4",8),r.Ib(30,"span"),r.lc(31,"Exclude properties"),r.Hb(),r.Hb(),r.Ib(32,"p"),r.lc(33,"Let's assume that we want to automatically exclude a "),r.Ib(34,"code"),r.lc(35,"password"),r.Hb(),r.lc(36," property from a user entity. We annotate the entity as follows:"),r.Hb(),r.Ib(37,"pre"),r.Ib(38,"code",9),r.lc(39,"\nimport { Exclude } from 'class-transformer';\n\nexport class UserEntity {\n  id: number;\n  firstName: string;\n  lastName: string;\n\n  @Exclude()\n  password: string;\n\n  constructor(partial: Partial<UserEntity>) {\n    Object.assign(this, partial);\n  }\n}"),r.Hb(),r.Hb(),r.Ib(40,"p"),r.lc(41,"Now consider a controller with a method handler that returns an instance of this class."),r.Hb(),r.Ib(42,"pre"),r.Ib(43,"code",9),r.lc(44,"\n@UseInterceptors(ClassSerializerInterceptor)\n@Get()\nfindOne(): UserEntity {\n  return new UserEntity({\n    id: 1,\n    firstName: 'Kamil',\n    lastName: 'Mysliwiec',\n    password: 'password',\n  });\n}"),r.Hb(),r.Hb(),r.Ib(45,"blockquote",10),r.Ib(46,"strong"),r.lc(47,"Warning"),r.Hb(),r.lc(48," Note that we must return an instance of the class. If you return a plain JavaScript object, for example, "),r.Ib(49,"code"),r.lc(50),r.Hb(),r.lc(51,", the object won't be properly serialized.\n"),r.Hb(),r.Ib(52,"blockquote",11),r.Ib(53,"strong"),r.lc(54,"Hint"),r.Hb(),r.lc(55," The "),r.Ib(56,"code"),r.lc(57,"ClassSerializerInterceptor"),r.Hb(),r.lc(58," is imported from "),r.Ib(59,"code"),r.lc(60,"@nestjs/common"),r.Hb(),r.lc(61,".\n"),r.Hb(),r.Ib(62,"p"),r.lc(63,"When this endpoint is requested, the client receives the following response:"),r.Hb(),r.Ib(64,"pre"),r.Ib(65,"code",12),r.lc(66,'\n{\n  "id": 1,\n  "firstName": "Kamil",\n  "lastName": "Mysliwiec"\n}'),r.Hb(),r.Hb(),r.Ib(67,"p"),r.lc(68,"Note that the interceptor can be applied application-wide (as covered "),r.Ib(69,"a",13),r.lc(70,"here"),r.Hb(),r.lc(71,"). The combination of the interceptor and the entity class declaration ensures that "),r.Ib(72,"strong"),r.lc(73,"any"),r.Hb(),r.lc(74," method that returns a "),r.Ib(75,"code"),r.lc(76,"UserEntity"),r.Hb(),r.lc(77," will be sure to remove the "),r.Ib(78,"code"),r.lc(79,"password"),r.Hb(),r.lc(80," property. This gives you a measure of centralized enforcement of this business rule."),r.Hb(),r.Ib(81,"h4",14),r.Ib(82,"span"),r.lc(83,"Expose properties"),r.Hb(),r.Hb(),r.Ib(84,"p"),r.lc(85,"You can use the "),r.Ib(86,"code"),r.lc(87,"@Expose()"),r.Hb(),r.lc(88," decorator to provide alias names for properties, or to execute a function to calculate a property value (analogous to "),r.Ib(89,"strong"),r.lc(90,"getter"),r.Hb(),r.lc(91," functions), as shown below."),r.Hb(),r.Ib(92,"pre"),r.Ib(93,"code",9),r.lc(94,"\n@Expose()\nget fullName(): string {\n  return `${this.firstName} ${this.lastName}`;\n}"),r.Hb(),r.Hb(),r.Ib(95,"h4",15),r.Ib(96,"span"),r.lc(97,"Transform"),r.Hb(),r.Hb(),r.Ib(98,"p"),r.lc(99,"You can perform additional data transformation using the "),r.Ib(100,"code"),r.lc(101,"@Transform()"),r.Hb(),r.lc(102," decorator. For example, the following construct returns the name property of the "),r.Ib(103,"code"),r.lc(104,"RoleEntity"),r.Hb(),r.lc(105," instead of returning the whole object."),r.Hb(),r.Ib(106,"pre"),r.Ib(107,"code",9),r.lc(108,"\n@Transform(role => role.name)\nrole: RoleEntity;"),r.Hb(),r.Hb(),r.Ib(109,"h4",16),r.Ib(110,"span"),r.lc(111,"Pass options"),r.Hb(),r.Hb(),r.Ib(112,"p"),r.lc(113,"You may want to modify the default behavior of the transformation functions. To override default settings, pass them in an "),r.Ib(114,"code"),r.lc(115,"options"),r.Hb(),r.lc(116," object with the "),r.Ib(117,"code"),r.lc(118,"@SerializeOptions()"),r.Hb(),r.lc(119," decorator."),r.Hb(),r.Ib(120,"pre"),r.Ib(121,"code",9),r.lc(122,"\n@SerializeOptions({\n  excludePrefixes: ['_'],\n})\n@Get()\nfindOne(): UserEntity {\n  return new UserEntity();\n}"),r.Hb(),r.Hb(),r.Ib(123,"blockquote",11),r.Ib(124,"strong"),r.lc(125,"Hint"),r.Hb(),r.lc(126," The "),r.Ib(127,"code"),r.lc(128,"@SerializeOptions()"),r.Hb(),r.lc(129," decorator is imported from "),r.Ib(130,"code"),r.lc(131,"@nestjs/common"),r.Hb(),r.lc(132,".\n"),r.Hb(),r.Ib(133,"p"),r.lc(134,"Options passed via "),r.Ib(135,"code"),r.lc(136,"@SerializeOptions()"),r.Hb(),r.lc(137," are passed as the second argument of the underlying "),r.Ib(138,"code"),r.lc(139,"classToPlain()"),r.Hb(),r.lc(140," function. In this example, we are automatically excluding all properties that begin with the "),r.Ib(141,"code"),r.lc(142,"_"),r.Hb(),r.lc(143," prefix."),r.Hb(),r.Ib(144,"h4",17),r.Ib(145,"span"),r.lc(146,"WebSockets and Microservices"),r.Hb(),r.Hb(),r.Ib(147,"p"),r.lc(148,"While this chapter shows examples using HTTP style applications (e.g., Express or Fastify), the "),r.Ib(149,"code"),r.lc(150,"ClassSerializerInterceptor"),r.Hb(),r.lc(151," works the same for WebSockets and Microservices, regardless of the transport method that is used."),r.Hb(),r.Ib(152,"h4",18),r.Ib(153,"span"),r.lc(154,"Learn more"),r.Hb(),r.Hb(),r.Ib(155,"p"),r.lc(156,"Read more about available decorators and options as provided by the "),r.Ib(157,"code"),r.lc(158,"class-transformer"),r.Hb(),r.lc(159," package "),r.Ib(160,"a",7),r.lc(161,"here"),r.Hb(),r.lc(162,"."),r.Hb(),r.Hb()),2&e&&(r.vb(50),r.oc("","{"," user: new UserEntity() ","}",""))},directives:[l.a],encapsulation:2,changeDetection:0}),e})();const N=r.Kb(F);let G=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return z(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-sql"]],features:[r.tb],decls:1477,vars:104,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/sql.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","database"],["rel","nofollow","target","_blank","href","https://expressjs.com/en/guide/database-integration.html"],["rel","nofollow","target","_blank","href","https://sequelize.org/"],["href","/techniques/database#sequelize-integration"],["rel","nofollow","target","_blank","href","http://knexjs.org/"],["rel","nofollow","target","_blank","href","https://dev.to/nestjs/build-a-nestjs-module-for-knex-js-or-other-resource-based-libraries-in-5-minutes-12an"],["rel","nofollow","target","_blank","href","https://github.com/typeorm/typeorm"],["rel","nofollow","target","_blank","href","https://www.github.com/prisma/prisma"],["routerLink","/recipes/prisma"],["routerLink","/techniques/mongodb"],["id","typeorm-integration"],["rel","nofollow","target","_blank","href","https://www.mysql.com/"],[1,"language-bash"],[1,"filename"],["app92e84d9ce0d170ef1e36565668a02892596ac387",""],[1,"language-typescript"],["rel","nofollow","target","_blank","href","https://typeorm.io/#/connection-options"],[1,"info"],[1,"language-json"],["appffe6ffe38bb6ee230a79ae8b5d160ed615046922",""],["rel","nofollow","target","_blank","href","https://webpack.js.org/"],[1,"warning"],["app9175cca464d0507e89b7aa25745644d37f71f6c5",""],["appAnchor","","id","repository-pattern"],["appe9888e9cd9e79b5e3135a7470197fc508d1ebd37",""],["rel","nofollow","target","_blank","href","https://typeorm.io/#/entities"],["app09f36eb34fc35f1f5c739a34cbd832ebc90494b7",""],["app7799335c4444a4eacaa06d1b4ff5ea3f2012dc7c",""],["app6628b26a7f81122d5fdc4f2c2f6de5ecb70c9b0e",""],["appe75ad5335b042cc806ae3cca39d4289dbeec8055",""],["appc899605a8064b106a165c643b1c4baac4abd387e",""],["id","relations"],["app48f1e9f9acebd877b1b4c835c8cebef68f42bfa8",""],["rel","nofollow","target","_blank","href","https://typeorm.io/#/relations"],["appAnchor","","id","auto-load-entities"],["appda450817e39adf127be99f58afe54056b8333824",""],["appAnchor","","id","separating-entity-definition"],["rel","nofollow","target","_blank","href","https://typeorm.io/#/separating-entity-definition"],[1,"warning","error"],["appAnchor","","id","transactions"],["rel","nofollow","target","_blank","href","https://en.wikipedia.org/wiki/Database_transaction"],["rel","nofollow","target","_blank","href","https://typeorm.io/#/transactions"],["rel","nofollow","target","_blank","href","https://typeorm.io/#/transactions/creating-and-using-transactions"],["appAnchor","","id","subscribers"],["rel","nofollow","target","_blank","href","https://typeorm.io/#/listeners-and-subscribers/what-is-a-subscriber"],[1,"error"],["routerLink","/fundamentals/injection-scopes"],["appAnchor","","id","migrations"],["rel","nofollow","target","_blank","href","https://typeorm.io/#/migrations"],["rel","nofollow","target","_blank","href","https://typeorm.io/#/migrations/creating-a-new-migration"],["appAnchor","","id","multiple-databases"],["appAnchor","","id","testing"],["routerLink","/fundamentals/custom-providers"],["appAnchor","","id","custom-repository"],["rel","nofollow","target","_blank","href","http://typeorm.io/#/custom-repository"],["appAnchor","","id","async-configuration"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/fundamentals/async-providers"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/05-sql-typeorm"],["id","sequelize-integration"],["rel","nofollow","target","_blank","href","https://github.com/RobinBuschmann/sequelize-typescript"],["appc147b3a9aaf8c66091f1d17815791b0997084ae0",""],["rel","nofollow","target","_blank","href","https://sequelize.org/v5/manual/getting-started.html#setting-up-a-connection"],["app0d83e7b14a63165ce88f59838e9217181bd2d365",""],["appAnchor","","id","models"],["appbad67e74de8f5d00f45588d1e08e456d00b4ffa2",""],["rel","nofollow","target","_blank","href","https://github.com/RobinBuschmann/sequelize-typescript#column"],["app3443e8559fffa1b3942813dcc77db493f685edcc",""],["app1324bda36e6c5697cada5d73d657ee7d1b0bde1e",""],["appe3122ee53cebb9b3ed617d12e9c97a4a1981ddf7",""],["appc0044a1b8d1e4989ba2104830a088945b53375e0",""],["app4d150ebe954b0652aee3c4c3787f8eeafafc4744",""],["id","relations-1"],["appc5af97eb07ee3f98c69abb12006f082c76af9bc6",""],["rel","nofollow","target","_blank","href","https://github.com/RobinBuschmann/sequelize-typescript#model-association"],["appAnchor","","id","auto-load-models"],["app08f43568649f930dbdf21588a6b1bb73c7888b70",""],["appAnchor","","id","transactions-1"],["rel","nofollow","target","_blank","href","https://sequelize.org/v5/manual/transactions.html"],["appAnchor","","id","migrations-1"],["rel","nofollow","target","_blank","href","https://sequelize.org/v5/manual/migrations.html"],["rel","nofollow","target","_blank","href","https://sequelize.org/v5/manual/migrations.html#the-cli"],["appAnchor","","id","multiple-databases-1"],["appAnchor","","id","testing-1"],["appAnchor","","id","async-configuration-1"],["appAnchor","","id","example-1"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/07-sequelize"]],template:function(e,t){if(1&e){r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"Database"),r.Hb(),r.Ib(7,"p"),r.lc(8,"Nest is database agnostic, allowing you to easily integrate with any SQL or NoSQL database. You have a number of options available to you, depending on your preferences. At the most general level, connecting Nest to a database is simply a matter of loading an appropriate Node.js driver for the database, just as you would with "),r.Ib(9,"a",6),r.lc(10,"Express"),r.Hb(),r.lc(11," or Fastify."),r.Hb(),r.Ib(12,"p"),r.lc(13,"You can also directly use any general purpose Node.js database integration "),r.Ib(14,"strong"),r.lc(15,"library"),r.Hb(),r.lc(16," or ORM, such as "),r.Ib(17,"a",7),r.lc(18,"Sequelize"),r.Hb(),r.lc(19," (navigate to the "),r.Ib(20,"a",8),r.lc(21,"Sequelize integration"),r.Hb(),r.lc(22," section), "),r.Ib(23,"a",9),r.lc(24,"Knex.js"),r.Hb(),r.lc(25," ("),r.Ib(26,"a",10),r.lc(27,"tutorial"),r.Hb(),r.lc(28,") "),r.Ib(29,"a",11),r.lc(30,"TypeORM"),r.Hb(),r.lc(31,", and "),r.Ib(32,"a",12),r.lc(33,"Prisma"),r.Hb(),r.lc(34," ("),r.Ib(35,"a",13),r.lc(36,"recipe"),r.Hb(),r.lc(37,") , to operate at a higher level of abstraction."),r.Hb(),r.Ib(38,"p"),r.lc(39,"For convenience, Nest provides tight integration with TypeORM and Sequelize out-of-the-box with the "),r.Ib(40,"code"),r.lc(41,"@nestjs/typeorm"),r.Hb(),r.lc(42," and "),r.Ib(43,"code"),r.lc(44,"@nestjs/sequelize"),r.Hb(),r.lc(45," packages respectively, which we'll cover in the current chapter, and Mongoose with "),r.Ib(46,"code"),r.lc(47,"@nestjs/mongoose"),r.Hb(),r.lc(48,", which is covered in "),r.Ib(49,"a",14),r.lc(50,"this chapter"),r.Hb(),r.lc(51,". These integrations provide additional NestJS-specific features, such as model/repository injection, testability, and asynchronous configuration to make accessing your chosen database even easier."),r.Hb(),r.Ib(52,"h3",15),r.lc(53,"TypeORM Integration"),r.Hb(),r.Ib(54,"p"),r.lc(55,"For integrating with SQL and NoSQL databases, Nest provides the "),r.Ib(56,"code"),r.lc(57,"@nestjs/typeorm"),r.Hb(),r.lc(58," package. Nest uses "),r.Ib(59,"a",11),r.lc(60,"TypeORM"),r.Hb(),r.lc(61," because it's the most mature Object Relational Mapper (ORM) available for TypeScript. Since it's written in TypeScript, it integrates well with the Nest framework."),r.Hb(),r.Ib(62,"p"),r.lc(63,"To begin using it, we first install the required dependencies. In this chapter, we'll demonstrate using the popular "),r.Ib(64,"a",16),r.lc(65,"MySQL"),r.Hb(),r.lc(66," Relational DBMS, but TypeORM provides support for many relational databases, such as PostgreSQL, Oracle, Microsoft SQL Server, SQLite, and even NoSQL databases like MongoDB. The procedure we walk through in this chapter will be the same for any database supported by TypeORM. You'll simply need to install the associated client API libraries for your selected database."),r.Hb(),r.Ib(67,"pre"),r.Ib(68,"code",17),r.lc(69,"\n$ npm install --save @nestjs/typeorm typeorm mysql"),r.Hb(),r.Hb(),r.Ib(70,"p"),r.lc(71,"Once the installation process is complete, we can import the "),r.Ib(72,"code"),r.lc(73,"TypeOrmModule"),r.Hb(),r.lc(74," into the root "),r.Ib(75,"code"),r.lc(76,"AppModule"),r.Hb(),r.lc(77,"."),r.Hb(),r.Ib(78,"span",18),r.lc(79),r.Ub(80,"extension"),r.Gb(81,"app-tabs",null,19),r.Hb(),r.Ib(83,"pre"),r.Ib(84,"code",20),r.lc(85,"\nimport { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\n\n@Module({\n  imports: [\n    TypeOrmModule.forRoot({\n      type: 'mysql',\n      host: 'localhost',\n      port: 3306,\n      username: 'root',\n      password: 'root',\n      database: 'test',\n      entities: [],\n      synchronize: true,\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(86,"p"),r.lc(87,"The "),r.Ib(88,"code"),r.lc(89,"forRoot()"),r.Hb(),r.lc(90," method supports all the configuration properties exposed by the "),r.Ib(91,"code"),r.lc(92,"createConnection()"),r.Hb(),r.lc(93," function from the "),r.Ib(94,"a",21),r.lc(95,"TypeORM"),r.Hb(),r.lc(96," package. In addition, there are several extra configuration properties described below."),r.Hb(),r.Ib(97,"table"),r.Ib(98,"tr"),r.Ib(99,"td"),r.Ib(100,"code"),r.lc(101,"retryAttempts"),r.Hb(),r.Hb(),r.Ib(102,"td"),r.lc(103,"Number of attempts to connect to the database (default: "),r.Ib(104,"code"),r.lc(105,"10"),r.Hb(),r.lc(106,")"),r.Hb(),r.Hb(),r.Ib(107,"tr"),r.Ib(108,"td"),r.Ib(109,"code"),r.lc(110,"retryDelay"),r.Hb(),r.Hb(),r.Ib(111,"td"),r.lc(112,"Delay between connection retry attempts (ms) (default: "),r.Ib(113,"code"),r.lc(114,"3000"),r.Hb(),r.lc(115,")"),r.Hb(),r.Hb(),r.Ib(116,"tr"),r.Ib(117,"td"),r.Ib(118,"code"),r.lc(119,"autoLoadEntities"),r.Hb(),r.Hb(),r.Ib(120,"td"),r.lc(121,"If "),r.Ib(122,"code"),r.lc(123,"true"),r.Hb(),r.lc(124,", entities will be loaded automatically (default: "),r.Ib(125,"code"),r.lc(126,"false"),r.Hb(),r.lc(127,")"),r.Hb(),r.Hb(),r.Ib(128,"tr"),r.Ib(129,"td"),r.Ib(130,"code"),r.lc(131,"keepConnectionAlive"),r.Hb(),r.Hb(),r.Ib(132,"td"),r.lc(133,"If "),r.Ib(134,"code"),r.lc(135,"true"),r.Hb(),r.lc(136,", connection will not be closed on application shutdown (default: "),r.Ib(137,"code"),r.lc(138,"false"),r.Hb(),r.lc(139,")"),r.Hb(),r.Hb(),r.Hb(),r.Ib(140,"blockquote",22),r.Ib(141,"strong"),r.lc(142,"Hint"),r.Hb(),r.lc(143," Learn more about the connection options "),r.Ib(144,"a",21),r.lc(145,"here"),r.Hb(),r.lc(146,".\n"),r.Hb(),r.Ib(147,"p"),r.lc(148,"Alternatively, rather than passing a configuration object to "),r.Ib(149,"code"),r.lc(150,"forRoot()"),r.Hb(),r.lc(151,", we can create an "),r.Ib(152,"code"),r.lc(153,"ormconfig.json"),r.Hb(),r.lc(154," file in the project root directory."),r.Hb(),r.Ib(155,"pre"),r.Ib(156,"code",23),r.lc(157,'\n{\n  "type": "mysql",\n  "host": "localhost",\n  "port": 3306,\n  "username": "root",\n  "password": "root",\n  "database": "test",\n  "entities": ["dist/**/*.entity{.ts,.js}"],\n  "synchronize": true\n}'),r.Hb(),r.Hb(),r.Ib(158,"p"),r.lc(159,"Then, we can call "),r.Ib(160,"code"),r.lc(161,"forRoot()"),r.Hb(),r.lc(162," without any options:"),r.Hb(),r.Ib(163,"span",18),r.lc(164),r.Ub(165,"extension"),r.Gb(166,"app-tabs",null,24),r.Hb(),r.Ib(168,"pre"),r.Ib(169,"code",20),r.lc(170,"\nimport { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\n\n@Module({\n  imports: [TypeOrmModule.forRoot()],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(171,"blockquote",22),r.Ib(172,"strong"),r.lc(173,"Warning"),r.Hb(),r.lc(174," Static glob paths (e.g., "),r.Ib(175,"code"),r.lc(176),r.Hb(),r.lc(177,") won't work properly with "),r.Ib(178,"a",25),r.lc(179,"webpack"),r.Hb(),r.lc(180,".\n"),r.Hb(),r.Ib(181,"blockquote",26),r.Ib(182,"strong"),r.lc(183,"Warning"),r.Hb(),r.lc(184," Note that the "),r.Ib(185,"code"),r.lc(186,"ormconfig.json"),r.Hb(),r.lc(187," file is loaded by the "),r.Ib(188,"code"),r.lc(189,"typeorm"),r.Hb(),r.lc(190," library. Thus, any of the extra properties described above (which are supported internally by way of the "),r.Ib(191,"code"),r.lc(192,"forRoot()"),r.Hb(),r.lc(193," method - for example, "),r.Ib(194,"code"),r.lc(195,"autoLoadEntities"),r.Hb(),r.lc(196," and "),r.Ib(197,"code"),r.lc(198,"retryDelay"),r.Hb(),r.lc(199,") won't be applied.\n"),r.Hb(),r.Ib(200,"p"),r.lc(201,"Once this is done, the TypeORM "),r.Ib(202,"code"),r.lc(203,"Connection"),r.Hb(),r.lc(204," and "),r.Ib(205,"code"),r.lc(206,"EntityManager"),r.Hb(),r.lc(207," objects will be available to inject across the entire project (without needing to import any modules), for example:"),r.Hb(),r.Ib(208,"span",18),r.lc(209),r.Ub(210,"extension"),r.Gb(211,"app-tabs",null,27),r.Hb(),r.Ib(213,"pre"),r.Ib(214,"code",20),r.lc(215,"\nimport { Connection } from 'typeorm';\n\n@Module({\n  imports: [TypeOrmModule.forRoot(), UsersModule],\n})\nexport class AppModule {\n  constructor(private connection: Connection) {}\n}"),r.Hb(),r.Hb(),r.Ib(216,"pre"),r.Ib(217,"code",20),r.lc(218,"\nimport { Connection } from 'typeorm';\n\n@Dependencies(Connection)\n@Module({\n  imports: [TypeOrmModule.forRoot(), UsersModule],\n})\nexport class AppModule {\n  constructor(connection) {\n    this.connection = connection;\n  }\n}"),r.Hb(),r.Hb(),r.Ib(219,"h4",28),r.Ib(220,"span"),r.lc(221,"Repository pattern"),r.Hb(),r.Hb(),r.Ib(222,"p"),r.Ib(223,"a",11),r.lc(224,"TypeORM"),r.Hb(),r.lc(225," supports the "),r.Ib(226,"strong"),r.lc(227,"repository design pattern"),r.Hb(),r.lc(228,", so each entity has its own repository. These repositories can be obtained from the database connection."),r.Hb(),r.Ib(229,"p"),r.lc(230,"To continue the example, we need at least one entity. Let's define the "),r.Ib(231,"code"),r.lc(232,"User"),r.Hb(),r.lc(233," entity."),r.Hb(),r.Ib(234,"span",18),r.lc(235),r.Ub(236,"extension"),r.Gb(237,"app-tabs",null,29),r.Hb(),r.Ib(239,"pre"),r.Ib(240,"code",20),r.lc(241,"\nimport { Entity, Column, PrimaryGeneratedColumn } from 'typeorm';\n\n@Entity()\nexport class User {\n  @PrimaryGeneratedColumn()\n  id: number;\n\n  @Column()\n  firstName: string;\n\n  @Column()\n  lastName: string;\n\n  @Column({ default: true })\n  isActive: boolean;\n}"),r.Hb(),r.Hb(),r.Ib(242,"blockquote",22),r.Ib(243,"strong"),r.lc(244,"Hint"),r.Hb(),r.lc(245," Learn more about entities\xa0in the "),r.Ib(246,"a",30),r.lc(247,"TypeORM documentation"),r.Hb(),r.lc(248,".\n"),r.Hb(),r.Ib(249,"p"),r.lc(250,"The "),r.Ib(251,"code"),r.lc(252,"User"),r.Hb(),r.lc(253," entity file sits in the "),r.Ib(254,"code"),r.lc(255,"users"),r.Hb(),r.lc(256," directory. This directory contains all files related to the "),r.Ib(257,"code"),r.lc(258,"UsersModule"),r.Hb(),r.lc(259,". You can decide where to keep your model files, however, we recommend creating them near their "),r.Ib(260,"strong"),r.lc(261,"domain"),r.Hb(),r.lc(262,", in the corresponding module directory."),r.Hb(),r.Ib(263,"p"),r.lc(264,"To begin using the "),r.Ib(265,"code"),r.lc(266,"User"),r.Hb(),r.lc(267," entity, we need to let TypeORM know about it by inserting it into the "),r.Ib(268,"code"),r.lc(269,"entities"),r.Hb(),r.lc(270," array in the module "),r.Ib(271,"code"),r.lc(272,"forRoot()"),r.Hb(),r.lc(273," method options (unless you use a static glob path):"),r.Hb(),r.Ib(274,"span",18),r.lc(275),r.Ub(276,"extension"),r.Gb(277,"app-tabs",null,31),r.Hb(),r.Ib(279,"pre"),r.Ib(280,"code",20),r.lc(281,"\nimport { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { User } from './users/user.entity';\n\n@Module({\n  imports: [\n    TypeOrmModule.forRoot({\n      type: 'mysql',\n      host: 'localhost',\n      port: 3306,\n      username: 'root',\n      password: 'root',\n      database: 'test',\n      entities: [User],\n      synchronize: true,\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(282,"p"),r.lc(283,"Next, let's look at the "),r.Ib(284,"code"),r.lc(285,"UsersModule"),r.Hb(),r.lc(286,":"),r.Hb(),r.Ib(287,"span",18),r.lc(288),r.Ub(289,"extension"),r.Gb(290,"app-tabs",null,32),r.Hb(),r.Ib(292,"pre"),r.Ib(293,"code",20),r.lc(294,"\nimport { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { UsersService } from './users.service';\nimport { UsersController } from './users.controller';\nimport { User } from './user.entity';\n\n@Module({\n  imports: [TypeOrmModule.forFeature([User])],\n  providers: [UsersService],\n  controllers: [UsersController],\n})\nexport class UsersModule {}"),r.Hb(),r.Hb(),r.Ib(295,"p"),r.lc(296,"This module uses the "),r.Ib(297,"code"),r.lc(298,"forFeature()"),r.Hb(),r.lc(299," method to define which repositories are registered in the current scope. With that in place, we can inject the "),r.Ib(300,"code"),r.lc(301,"UsersRepository"),r.Hb(),r.lc(302," into the "),r.Ib(303,"code"),r.lc(304,"UsersService"),r.Hb(),r.lc(305," using the "),r.Ib(306,"code"),r.lc(307,"@InjectRepository()"),r.Hb(),r.lc(308," decorator:"),r.Hb(),r.Ib(309,"span",18),r.lc(310),r.Ub(311,"extension"),r.Gb(312,"app-tabs",null,33),r.Hb(),r.Ib(314,"pre"),r.Ib(315,"code",20),r.lc(316,"\nimport { Injectable } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { User } from './user.entity';\n\n@Injectable()\nexport class UsersService {\n  constructor(\n    @InjectRepository(User)\n    private usersRepository: Repository<User>,\n  ) {}\n\n  findAll(): Promise<User[]> {\n    return this.usersRepository.find();\n  }\n\n  findOne(id: string): Promise<User> {\n    return this.usersRepository.findOne(id);\n  }\n\n  async remove(id: string): Promise<void> {\n    await this.usersRepository.delete(id);\n  }\n}"),r.Hb(),r.Hb(),r.Ib(317,"pre"),r.Ib(318,"code",20),r.lc(319,"\nimport { Injectable, Dependencies } from '@nestjs/common';\nimport { getRepositoryToken } from '@nestjs/typeorm';\nimport { User } from './user.entity';\n\n@Injectable()\n@Dependencies(getRepositoryToken(User))\nexport class UsersService {\n  constructor(usersRepository) {\n    this.usersRepository = usersRepository;\n  }\n\n  findAll() {\n    return this.usersRepository.find();\n  }\n\n  findOne(id) {\n    return this.usersRepository.findOne(id);\n  }\n\n  async remove(id) {\n    await this.usersRepository.delete(id);\n  }\n}"),r.Hb(),r.Hb(),r.Ib(320,"blockquote",26),r.Ib(321,"strong"),r.lc(322,"Notice"),r.Hb(),r.lc(323," Don't forget to import the "),r.Ib(324,"code"),r.lc(325,"UsersModule"),r.Hb(),r.lc(326," into the root "),r.Ib(327,"code"),r.lc(328,"AppModule"),r.Hb(),r.lc(329,".\n"),r.Hb(),r.Ib(330,"p"),r.lc(331,"If you want to use the repository outside of the module which imports "),r.Ib(332,"code"),r.lc(333,"TypeOrmModule.forFeature"),r.Hb(),r.lc(334,", you'll need to re-export the providers generated by it.\nYou can do this by exporting the whole module, like this:"),r.Hb(),r.Ib(335,"span",18),r.lc(336),r.Ub(337,"extension"),r.Gb(338,"app-tabs",null,34),r.Hb(),r.Ib(340,"pre"),r.Ib(341,"code",20),r.lc(342,"\nimport { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { User } from './user.entity';\n\n@Module({\n  imports: [TypeOrmModule.forFeature([User])],\n  exports: [TypeOrmModule]\n})\nexport class UsersModule {}"),r.Hb(),r.Hb(),r.Ib(343,"p"),r.lc(344,"Now if we import "),r.Ib(345,"code"),r.lc(346,"UsersModule"),r.Hb(),r.lc(347," in "),r.Ib(348,"code"),r.lc(349,"UserHttpModule"),r.Hb(),r.lc(350,", we can use "),r.Ib(351,"code"),r.lc(352,"@InjectRepository(User)"),r.Hb(),r.lc(353," in the providers of the latter module."),r.Hb(),r.Ib(354,"span",18),r.lc(355),r.Ub(356,"extension"),r.Gb(357,"app-tabs",null,35),r.Hb(),r.Ib(359,"pre"),r.Ib(360,"code",20),r.lc(361,"\nimport { Module } from '@nestjs/common';\nimport { UsersModule } from './user.module';\nimport { UsersService } from './users.service';\nimport { UsersController } from './users.controller';\n\n@Module({\n  imports: [UsersModule],\n  providers: [UsersService],\n  controllers: [UsersController]\n})\nexport class UserHttpModule {}"),r.Hb(),r.Hb(),r.Ib(362,"h3",36),r.lc(363,"Relations"),r.Hb(),r.Ib(364,"p"),r.lc(365,"Relations are associations established between two or more tables. Relations are based on common fields from each table, often involving primary and foreign keys."),r.Hb(),r.Ib(366,"p"),r.lc(367,"There are three types of relations:"),r.Hb(),r.Ib(368,"table"),r.Ib(369,"tr"),r.Ib(370,"td"),r.Ib(371,"code"),r.lc(372,"One-to-one"),r.Hb(),r.Hb(),r.Ib(373,"td"),r.lc(374,"Every row in the primary table has one and only one associated row in the foreign table. Use the "),r.Ib(375,"code"),r.lc(376,"@OneToOne()"),r.Hb(),r.lc(377," decorator to define this type of relation."),r.Hb(),r.Hb(),r.Ib(378,"tr"),r.Ib(379,"td"),r.Ib(380,"code"),r.lc(381,"One-to-many / Many-to-one"),r.Hb(),r.Hb(),r.Ib(382,"td"),r.lc(383,"Every row in the primary table has one or more related rows in the foreign table. Use the "),r.Ib(384,"code"),r.lc(385,"@OneToMany()"),r.Hb(),r.lc(386," and "),r.Ib(387,"code"),r.lc(388,"@ManyToOne()"),r.Hb(),r.lc(389," decorators to define this type of relation."),r.Hb(),r.Hb(),r.Ib(390,"tr"),r.Ib(391,"td"),r.Ib(392,"code"),r.lc(393,"Many-to-many"),r.Hb(),r.Hb(),r.Ib(394,"td"),r.lc(395,"Every row in the primary table has many related rows in the foreign table, and every record in the foreign table has many related rows in the primary table. Use the "),r.Ib(396,"code"),r.lc(397,"@ManyToMany()"),r.Hb(),r.lc(398," decorator to define this type of relation."),r.Hb(),r.Hb(),r.Hb(),r.Ib(399,"p"),r.lc(400,"To define relations in entities, use the corresponding "),r.Ib(401,"strong"),r.lc(402,"decorators"),r.Hb(),r.lc(403,". For example, to define that each "),r.Ib(404,"code"),r.lc(405,"User"),r.Hb(),r.lc(406," can have multiple photos, use the "),r.Ib(407,"code"),r.lc(408,"@OneToMany()"),r.Hb(),r.lc(409," decorator."),r.Hb(),r.Ib(410,"span",18),r.lc(411),r.Ub(412,"extension"),r.Gb(413,"app-tabs",null,37),r.Hb(),r.Ib(415,"pre"),r.Ib(416,"code",20),r.lc(417,"\nimport { Entity, Column, PrimaryGeneratedColumn, OneToMany } from 'typeorm';\nimport { Photo } from '../photos/photo.entity';\n\n@Entity()\nexport class User {\n  @PrimaryGeneratedColumn()\n  id: number;\n\n  @Column()\n  firstName: string;\n\n  @Column()\n  lastName: string;\n\n  @Column({ default: true })\n  isActive: boolean;\n\n  @OneToMany(type => Photo, photo => photo.user)\n  photos: Photo[];\n}"),r.Hb(),r.Hb(),r.Ib(418,"blockquote",22),r.Ib(419,"strong"),r.lc(420,"Hint"),r.Hb(),r.lc(421," To learn more about relations in TypeORM, visit the "),r.Ib(422,"a",38),r.lc(423,"TypeORM documentation"),r.Hb(),r.lc(424,".\n"),r.Hb(),r.Ib(425,"h4",39),r.Ib(426,"span"),r.lc(427,"Auto-load entities"),r.Hb(),r.Hb(),r.Ib(428,"p"),r.lc(429,"Manually adding entities to the "),r.Ib(430,"code"),r.lc(431,"entities"),r.Hb(),r.lc(432," array of the connection options can be tedious. In addition, referencing entities from the root module breaks application domain boundaries and causes leaking implementation details to other parts of the application. To solve this issue, static glob paths can be used (e.g., "),r.Ib(433,"code"),r.lc(434),r.Hb(),r.lc(435,")."),r.Hb(),r.Ib(436,"p"),r.lc(437,"Note, however, that glob paths are not supported by webpack, so if you are building your application within a monorepo, you won't be able to use them. To address this issue, an alternative solution is provided. To automatically load entities, set the "),r.Ib(438,"code"),r.lc(439,"autoLoadEntities"),r.Hb(),r.lc(440," property of the configuration object (passed into the "),r.Ib(441,"code"),r.lc(442,"forRoot()"),r.Hb(),r.lc(443," method) to "),r.Ib(444,"code"),r.lc(445,"true"),r.Hb(),r.lc(446,", as shown below:"),r.Hb(),r.Ib(447,"span",18),r.lc(448),r.Ub(449,"extension"),r.Gb(450,"app-tabs",null,40),r.Hb(),r.Ib(452,"pre"),r.Ib(453,"code",20),r.lc(454,"\nimport { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\n\n@Module({\n  imports: [\n    TypeOrmModule.forRoot({\n      ...\n      autoLoadEntities: true,\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(455,"p"),r.lc(456,"With that option specified, every entity registered through the "),r.Ib(457,"code"),r.lc(458,"forFeature()"),r.Hb(),r.lc(459," method will be automatically added to the "),r.Ib(460,"code"),r.lc(461,"entities"),r.Hb(),r.lc(462," array of the configuration object."),r.Hb(),r.Ib(463,"blockquote",26),r.Ib(464,"strong"),r.lc(465,"Warning"),r.Hb(),r.lc(466," Note that entities that aren't registered through the "),r.Ib(467,"code"),r.lc(468,"forFeature()"),r.Hb(),r.lc(469," method, but are only referenced from the entity (via a relationship), won't be included by way of the "),r.Ib(470,"code"),r.lc(471,"autoLoadEntities"),r.Hb(),r.lc(472," setting.\n"),r.Hb(),r.Ib(473,"h4",41),r.Ib(474,"span"),r.lc(475,"Separating entity definition"),r.Hb(),r.Hb(),r.Ib(476,"p"),r.lc(477,"You can define an entity and its columns right in the model, using decorators. But some people prefer to define entities and their columns inside separate files using the "),r.Ib(478,"a",42),r.lc(479,'"entity schemas"'),r.Hb(),r.lc(480,"."),r.Hb(),r.Ib(481,"pre"),r.Ib(482,"code",20),r.lc(483,"\nimport { EntitySchema } from 'typeorm';\nimport { User } from './user.entity';\n\nexport const UserSchema = new EntitySchema<User>({\n  name: 'User',\n  target: User,\n  columns: {\n    id: {\n      type: Number,\n      primary: true,\n      generated: true,\n    },\n    firstName: {\n      type: String,\n    },\n    lastName: {\n      type: String,\n    },\n    isActive: {\n      type: Boolean,\n      default: true,\n    },\n  },\n  relations: {\n    photos: {\n      type: 'one-to-many',\n      target: 'Photo', // the name of the PhotoSchema\n    },\n  },\n});"),r.Hb(),r.Hb(),r.Ib(484,"blockquote",43),r.Ib(485,"strong"),r.lc(486,"Warning"),r.Hb(),r.lc(487," If you provide the "),r.Ib(488,"code"),r.lc(489,"target"),r.Hb(),r.lc(490," option, the "),r.Ib(491,"code"),r.lc(492,"name"),r.Hb(),r.lc(493," option value has to be the same as the name of the target class.\nIf you do not provide the "),r.Ib(494,"code"),r.lc(495,"target"),r.Hb(),r.lc(496," you can use any name.\n"),r.Hb(),r.Ib(497,"p"),r.lc(498,"Nest allows you to use an "),r.Ib(499,"code"),r.lc(500,"EntitySchema"),r.Hb(),r.lc(501," instance wherever an "),r.Ib(502,"code"),r.lc(503,"Entity"),r.Hb(),r.lc(504," is expected, for example:"),r.Hb(),r.Ib(505,"pre"),r.Ib(506,"code",20),r.lc(507,"\nimport { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { UserSchema } from './user.schema';\nimport { UsersController } from './users.controller';\nimport { UsersService } from './users.service';\n\n@Module({\n  imports: [TypeOrmModule.forFeature([UserSchema])],\n  providers: [UsersService],\n  controllers: [UsersController],\n})\nexport class UsersModule {}"),r.Hb(),r.Hb(),r.Ib(508,"h4",44),r.Ib(509,"span"),r.lc(510,"Transactions"),r.Hb(),r.Hb(),r.Ib(511,"p"),r.lc(512,"A database transaction symbolizes a unit of work performed within a database management system against a database, and treated in a coherent and reliable way independent of other transactions. A transaction generally represents any change in a database ("),r.Ib(513,"a",45),r.lc(514,"learn more"),r.Hb(),r.lc(515,")."),r.Hb(),r.Ib(516,"p"),r.lc(517,"There are many different strategies to handle "),r.Ib(518,"a",46),r.lc(519,"TypeORM transactions"),r.Hb(),r.lc(520,". We recommend using the "),r.Ib(521,"code"),r.lc(522,"QueryRunner"),r.Hb(),r.lc(523," class because it gives full control over the transaction."),r.Hb(),r.Ib(524,"p"),r.lc(525,"First, we need to inject the "),r.Ib(526,"code"),r.lc(527,"Connection"),r.Hb(),r.lc(528," object into a class in the normal way:"),r.Hb(),r.Ib(529,"pre"),r.Ib(530,"code",20),r.lc(531,"\n@Injectable()\nexport class UsersService {\n  constructor(private connection: Connection) {}\n}"),r.Hb(),r.Hb(),r.Ib(532,"blockquote",22),r.Ib(533,"strong"),r.lc(534,"Hint"),r.Hb(),r.lc(535," The "),r.Ib(536,"code"),r.lc(537,"Connection"),r.Hb(),r.lc(538," class is imported from the "),r.Ib(539,"code"),r.lc(540,"typeorm"),r.Hb(),r.lc(541," package.\n"),r.Hb(),r.Ib(542,"p"),r.lc(543,"Now, we can use this object to create a transaction."),r.Hb(),r.Ib(544,"pre"),r.Ib(545,"code",20),r.lc(546,"\nasync createMany(users: User[]) {\n  const queryRunner = this.connection.createQueryRunner();\n\n  await queryRunner.connect();\n  await queryRunner.startTransaction();\n  try {\n    await queryRunner.manager.save(users[0]);\n    await queryRunner.manager.save(users[1]);\n\n    await queryRunner.commitTransaction();\n  } catch (err) {\n    // since we have errors lets rollback the changes we made\n    await queryRunner.rollbackTransaction();\n  } finally {\n    // you need to release a queryRunner which was manually instantiated\n    await queryRunner.release();\n  }\n}"),r.Hb(),r.Hb(),r.Ib(547,"blockquote",22),r.Ib(548,"strong"),r.lc(549,"Hint"),r.Hb(),r.lc(550," Note that the "),r.Ib(551,"code"),r.lc(552,"connection"),r.Hb(),r.lc(553," is used only to create the "),r.Ib(554,"code"),r.lc(555,"QueryRunner"),r.Hb(),r.lc(556,". However, to test this class would require mocking the entire "),r.Ib(557,"code"),r.lc(558,"Connection"),r.Hb(),r.lc(559," object (which exposes several methods). Thus, we recommend using a helper factory class (e.g., "),r.Ib(560,"code"),r.lc(561,"QueryRunnerFactory"),r.Hb(),r.lc(562,") and defining an interface with a limited set of methods required to maintain transactions. This technique makes mocking these methods pretty straightforward.\n"),r.Hb(),r.Ib(563,"p"),r.lc(564,"Alternatively, you can use the callback-style approach with the "),r.Ib(565,"code"),r.lc(566,"transaction"),r.Hb(),r.lc(567," method of the "),r.Ib(568,"code"),r.lc(569,"Connection"),r.Hb(),r.lc(570," object ("),r.Ib(571,"a",47),r.lc(572,"read more");r.Hb(),r.lc(573,")."),r.Hb(),r.Ib(574,"pre"),r.Ib(575,"code",20),r.lc(576,"\nasync createMany(users: User[]) {\n  await this.connection.transaction(async manager => {\n    await manager.save(users[0]);\n    await manager.save(users[1]);\n  });\n}"),r.Hb(),r.Hb(),r.Ib(577,"p"),r.lc(578,"Using decorators to control the transaction ("),r.Ib(579,"code"),r.lc(580,"@Transaction()"),r.Hb(),r.lc(581," and "),r.Ib(582,"code"),r.lc(583,"@TransactionManager()"),r.Hb(),r.lc(584,") is not recommended."),r.Hb(),r.Ib(585,"p"),r.Gb(586,"app-banner-shop"),r.Hb(),r.Ib(587,"h4",48),r.Ib(588,"span"),r.lc(589,"Subscribers"),r.Hb(),r.Hb(),r.Ib(590,"p"),r.lc(591,"With TypeORM "),r.Ib(592,"a",49),r.lc(593,"subscribers"),r.Hb(),r.lc(594,", you can listen to specific entity events."),r.Hb(),r.Ib(595,"pre"),r.Ib(596,"code",20),r.lc(597,"\nimport {\n  Connection,\n  EntitySubscriberInterface,\n  EventSubscriber,\n  InsertEvent,\n} from 'typeorm';\nimport { User } from './user.entity';\n\n@EventSubscriber()\nexport class UserSubscriber implements EntitySubscriberInterface<User> {\n  constructor(connection: Connection) {\n    connection.subscribers.push(this);\n  }\n\n  listenTo() {\n    return User;\n  }\n\n  beforeInsert(event: InsertEvent<User>) {\n    console.log(`BEFORE USER INSERTED: `, event.entity);\n  }\n}"),r.Hb(),r.Hb(),r.Ib(598,"blockquote",50),r.Ib(599,"strong"),r.lc(600,"Warning"),r.Hb(),r.lc(601," Event subscribers can not be "),r.Ib(602,"a",51),r.lc(603,"request-scoped"),r.Hb(),r.lc(604,".\n"),r.Hb(),r.Ib(605,"p"),r.lc(606,"Now, add the "),r.Ib(607,"code"),r.lc(608,"UserSubscriber"),r.Hb(),r.lc(609," class to the "),r.Ib(610,"code"),r.lc(611,"providers"),r.Hb(),r.lc(612," array:"),r.Hb(),r.Ib(613,"pre"),r.Ib(614,"code",20),r.lc(615,"\nimport { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { User } from './user.entity';\nimport { UsersController } from './users.controller';\nimport { UsersService } from './users.service';\nimport { UserSubscriber } from './user.subscriber';\n\n@Module({\n  imports: [TypeOrmModule.forFeature([User])],\n  providers: [UsersService, UserSubscriber],\n  controllers: [UsersController],\n})\nexport class UsersModule {}"),r.Hb(),r.Hb(),r.Ib(616,"blockquote",22),r.Ib(617,"strong"),r.lc(618,"Hint"),r.Hb(),r.lc(619," Learn more about entity subscribers "),r.Ib(620,"a",49),r.lc(621,"here"),r.Hb(),r.lc(622,".\n"),r.Hb(),r.Ib(623,"h4",52),r.Ib(624,"span"),r.lc(625,"Migrations"),r.Hb(),r.Hb(),r.Ib(626,"p"),r.Ib(627,"a",53),r.lc(628,"Migrations"),r.Hb(),r.lc(629," provide a way to incrementally update the database schema to keep it in sync with the application's data model while preserving existing data in the database. To generate, run, and revert migrations, TypeORM provides a dedicated "),r.Ib(630,"a",54),r.lc(631,"CLI"),r.Hb(),r.lc(632,"."),r.Hb(),r.Ib(633,"p"),r.lc(634,"Migration classes are separate from the Nest application source code. Their lifecycle is maintained by the TypeORM CLI. Therefore, you are not able to leverage dependency injection and other Nest specific features with migrations. To learn more about migrations, follow the guide in the "),r.Ib(635,"a",54),r.lc(636,"TypeORM documentation"),r.Hb(),r.lc(637,"."),r.Hb(),r.Ib(638,"h4",55),r.Ib(639,"span"),r.lc(640,"Multiple databases"),r.Hb(),r.Hb(),r.Ib(641,"p"),r.lc(642,"Some projects require multiple database connections. This can also be achieved with this module. To work with multiple connections, first create the connections. In this case, connection naming becomes "),r.Ib(643,"strong"),r.lc(644,"mandatory"),r.Hb(),r.lc(645,"."),r.Hb(),r.Ib(646,"p"),r.lc(647,"Suppose you have an "),r.Ib(648,"code"),r.lc(649,"Album"),r.Hb(),r.lc(650," entity stored in its own database."),r.Hb(),r.Ib(651,"pre"),r.Ib(652,"code",20),r.lc(653,"\nconst defaultOptions = {\n  type: 'postgres',\n  port: 5432,\n  username: 'user',\n  password: 'password',\n  database: 'db',\n  synchronize: true,\n};\n\n@Module({\n  imports: [\n    TypeOrmModule.forRoot({\n      ...defaultOptions,\n      host: 'user_db_host',\n      entities: [User],\n    }),\n    TypeOrmModule.forRoot({\n      ...defaultOptions,\n      name: 'albumsConnection',\n      host: 'album_db_host',\n      entities: [Album],\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(654,"blockquote",26),r.Ib(655,"strong"),r.lc(656,"Notice"),r.Hb(),r.lc(657," If you don't set the "),r.Ib(658,"code"),r.lc(659,"name"),r.Hb(),r.lc(660," for a connection, its name is set to "),r.Ib(661,"code"),r.lc(662,"default"),r.Hb(),r.lc(663,". Please note that you shouldn't have multiple connections without a name, or with the same name, otherwise they will get overridden.\n"),r.Hb(),r.Ib(664,"p"),r.lc(665,"At this point, you have "),r.Ib(666,"code"),r.lc(667,"User"),r.Hb(),r.lc(668," and "),r.Ib(669,"code"),r.lc(670,"Album"),r.Hb(),r.lc(671," entities registered with their own connection. With this setup, you have to tell the "),r.Ib(672,"code"),r.lc(673,"TypeOrmModule.forFeature()"),r.Hb(),r.lc(674," method and the "),r.Ib(675,"code"),r.lc(676,"@InjectRepository()"),r.Hb(),r.lc(677," decorator which connection should be used. If you do not pass any connection name, the "),r.Ib(678,"code"),r.lc(679,"default"),r.Hb(),r.lc(680," connection is used."),r.Hb(),r.Ib(681,"pre"),r.Ib(682,"code",20),r.lc(683,"\n@Module({\n  imports: [\n    TypeOrmModule.forFeature([User]),\n    TypeOrmModule.forFeature([Album], 'albumsConnection'),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(684,"p"),r.lc(685,"You can also inject the "),r.Ib(686,"code"),r.lc(687,"Connection"),r.Hb(),r.lc(688," or "),r.Ib(689,"code"),r.lc(690,"EntityManager"),r.Hb(),r.lc(691," for a given connection:"),r.Hb(),r.Ib(692,"pre"),r.Ib(693,"code",20),r.lc(694,"\n@Injectable()\nexport class AlbumsService {\n  constructor(\n    @InjectConnection('albumsConnection')\n    private connection: Connection,\n    @InjectEntityManager('albumsConnection')\n    private entityManager: EntityManager,\n  ) {}\n}"),r.Hb(),r.Hb(),r.Ib(695,"h4",56),r.Ib(696,"span"),r.lc(697,"Testing"),r.Hb(),r.Hb(),r.Ib(698,"p"),r.lc(699,"When it comes to unit testing an application, we usually want to avoid making a database connection, keeping our test suites independent and their execution process as fast as possible. But our classes might depend on repositories that are pulled from the connection instance. How do we handle that? The solution is to create mock repositories. In order to achieve that, we set up "),r.Ib(700,"a",57),r.lc(701,"custom providers"),r.Hb(),r.lc(702,". Each registered repository is automatically represented by an "),r.Ib(703,"code"),r.lc(704,"<EntityName>Repository"),r.Hb(),r.lc(705," token, where "),r.Ib(706,"code"),r.lc(707,"EntityName"),r.Hb(),r.lc(708," is the name of your entity class."),r.Hb(),r.Ib(709,"p"),r.lc(710,"The "),r.Ib(711,"code"),r.lc(712,"@nestjs/typeorm"),r.Hb(),r.lc(713," package exposes the "),r.Ib(714,"code"),r.lc(715,"getRepositoryToken()"),r.Hb(),r.lc(716," function which returns a prepared token based on a given entity."),r.Hb(),r.Ib(717,"pre"),r.Ib(718,"code",20),r.lc(719,"\n@Module({\n  providers: [\n    UsersService,\n    {\n      provide: getRepositoryToken(User),\n      useValue: mockRepository,\n    },\n  ],\n})\nexport class UsersModule {}"),r.Hb(),r.Hb(),r.Ib(720,"p"),r.lc(721,"Now a substitute "),r.Ib(722,"code"),r.lc(723,"mockRepository"),r.Hb(),r.lc(724," will be used as the "),r.Ib(725,"code"),r.lc(726,"UsersRepository"),r.Hb(),r.lc(727,". Whenever any class asks for "),r.Ib(728,"code"),r.lc(729,"UsersRepository"),r.Hb(),r.lc(730," using an "),r.Ib(731,"code"),r.lc(732,"@InjectRepository()"),r.Hb(),r.lc(733," decorator, Nest will use the registered "),r.Ib(734,"code"),r.lc(735,"mockRepository"),r.Hb(),r.lc(736," object."),r.Hb(),r.Ib(737,"h4",58),r.Ib(738,"span"),r.lc(739,"Custom repository"),r.Hb(),r.Hb(),r.Ib(740,"p"),r.lc(741,"TypeORM provides a feature called "),r.Ib(742,"strong"),r.lc(743,"custom repositories"),r.Hb(),r.lc(744,". Custom repositories allow you to extend a base repository class, and enrich it with several special methods. To learn more about this feature, visit "),r.Ib(745,"a",59),r.lc(746,"this page"),r.Hb(),r.lc(747,"."),r.Hb(),r.Ib(748,"p"),r.lc(749,"In order to create your custom repository, use the "),r.Ib(750,"code"),r.lc(751,"@EntityRepository()"),r.Hb(),r.lc(752," decorator and extend the "),r.Ib(753,"code"),r.lc(754,"Repository"),r.Hb(),r.lc(755," class."),r.Hb(),r.Ib(756,"pre"),r.Ib(757,"code",20),r.lc(758,"\n@EntityRepository(Author)\nexport class AuthorRepository extends Repository<Author> {}"),r.Hb(),r.Hb(),r.Ib(759,"blockquote",22),r.Ib(760,"strong"),r.lc(761,"Hint"),r.Hb(),r.lc(762," Both "),r.Ib(763,"code"),r.lc(764,"@EntityRepository()"),r.Hb(),r.lc(765," and "),r.Ib(766,"code"),r.lc(767,"Repository"),r.Hb(),r.lc(768," are imported from the "),r.Ib(769,"code"),r.lc(770,"typeorm"),r.Hb(),r.lc(771," package.\n"),r.Hb(),r.Ib(772,"p"),r.lc(773,"Once the class is created, the next step is to delegate instantiation responsibility to Nest. For this, we have to pass the"),r.Ib(774,"code"),r.lc(775,"AuthorRepository"),r.Hb(),r.lc(776," class to the "),r.Ib(777,"code"),r.lc(778,"TypeOrm.forFeature()"),r.Hb(),r.lc(779," method."),r.Hb(),r.Ib(780,"pre"),r.Ib(781,"code",20),r.lc(782,"\n@Module({\n  imports: [TypeOrmModule.forFeature([AuthorRepository])],\n  controller: [AuthorController],\n  providers: [AuthorService],\n})\nexport class AuthorModule {}"),r.Hb(),r.Hb(),r.Ib(783,"p"),r.lc(784,"Afterward, simply inject the repository using the following construction:"),r.Hb(),r.Ib(785,"pre"),r.Ib(786,"code",20),r.lc(787,"\n@Injectable()\nexport class AuthorService {\n  constructor(private authorRepository: AuthorRepository) {}\n}"),r.Hb(),r.Hb(),r.Ib(788,"h4",60),r.Ib(789,"span"),r.lc(790,"Async configuration"),r.Hb(),r.Hb(),r.Ib(791,"p"),r.lc(792,"You may want to pass your repository module options asynchronously instead of statically. In this case, use the "),r.Ib(793,"code"),r.lc(794,"forRootAsync()"),r.Hb(),r.lc(795," method, which provides several ways to deal with async configuration."),r.Hb(),r.Ib(796,"p"),r.lc(797,"One approach is to use a factory function:"),r.Hb(),r.Ib(798,"pre"),r.Ib(799,"code",20),r.lc(800,"\nTypeOrmModule.forRootAsync({\n  useFactory: () => ({\n    type: 'mysql',\n    host: 'localhost',\n    port: 3306,\n    username: 'root',\n    password: 'root',\n    database: 'test',\n    entities: [__dirname + '/**/*.entity{.ts,.js}'],\n    synchronize: true,\n  }),\n});"),r.Hb(),r.Hb(),r.Ib(801,"p"),r.lc(802,"Our factory behaves like any other "),r.Ib(803,"a",61),r.lc(804,"asynchronous provider"),r.Hb(),r.lc(805," (e.g., it can be "),r.Ib(806,"code"),r.lc(807,"async"),r.Hb(),r.lc(808," and it's able to inject dependencies through "),r.Ib(809,"code"),r.lc(810,"inject"),r.Hb(),r.lc(811,")."),r.Hb(),r.Ib(812,"pre"),r.Ib(813,"code",20),r.lc(814,"\nTypeOrmModule.forRootAsync({\n  imports: [ConfigModule],\n  useFactory: (configService: ConfigService) => ({\n    type: 'mysql',\n    host: configService.get('HOST'),\n    port: +configService.get<number>('PORT'),\n    username: configService.get('USERNAME'),\n    password: configService.get('PASSWORD'),\n    database: configService.get('DATABASE'),\n    entities: [__dirname + '/**/*.entity{.ts,.js}'],\n    synchronize: true,\n  }),\n  inject: [ConfigService],\n});"),r.Hb(),r.Hb(),r.Ib(815,"p"),r.lc(816,"Alternatively, you can use the "),r.Ib(817,"code"),r.lc(818,"useClass"),r.Hb(),r.lc(819," syntax:"),r.Hb(),r.Ib(820,"pre"),r.Ib(821,"code",20),r.lc(822,"\nTypeOrmModule.forRootAsync({\n  useClass: TypeOrmConfigService,\n});"),r.Hb(),r.Hb(),r.Ib(823,"p"),r.lc(824,"The construction above will instantiate "),r.Ib(825,"code"),r.lc(826,"TypeOrmConfigService"),r.Hb(),r.lc(827," inside "),r.Ib(828,"code"),r.lc(829,"TypeOrmModule"),r.Hb(),r.lc(830," and use it to provide an options object by calling "),r.Ib(831,"code"),r.lc(832,"createTypeOrmOptions()"),r.Hb(),r.lc(833,". Note that this means that the "),r.Ib(834,"code"),r.lc(835,"TypeOrmConfigService"),r.Hb(),r.lc(836," has to implement the "),r.Ib(837,"code"),r.lc(838,"TypeOrmOptionsFactory"),r.Hb(),r.lc(839," interface, as shown below:"),r.Hb(),r.Ib(840,"pre"),r.Ib(841,"code",20),r.lc(842,"\n@Injectable()\nclass TypeOrmConfigService implements TypeOrmOptionsFactory {\n  createTypeOrmOptions(): TypeOrmModuleOptions {\n    return {\n      type: 'mysql',\n      host: 'localhost',\n      port: 3306,\n      username: 'root',\n      password: 'root',\n      database: 'test',\n      entities: [__dirname + '/**/*.entity{.ts,.js}'],\n      synchronize: true,\n    };\n  }\n}"),r.Hb(),r.Hb(),r.Ib(843,"p"),r.lc(844,"In order to prevent the creation of "),r.Ib(845,"code"),r.lc(846,"TypeOrmConfigService"),r.Hb(),r.lc(847," inside "),r.Ib(848,"code"),r.lc(849,"TypeOrmModule"),r.Hb(),r.lc(850," and use a provider imported from a different module, you can use the "),r.Ib(851,"code"),r.lc(852,"useExisting"),r.Hb(),r.lc(853," syntax."),r.Hb(),r.Ib(854,"pre"),r.Ib(855,"code",20),r.lc(856,"\nTypeOrmModule.forRootAsync({\n  imports: [ConfigModule],\n  useExisting: ConfigService,\n});"),r.Hb(),r.Hb(),r.Ib(857,"p"),r.lc(858,"This construction works the same as "),r.Ib(859,"code"),r.lc(860,"useClass"),r.Hb(),r.lc(861," with one critical difference - "),r.Ib(862,"code"),r.lc(863,"TypeOrmModule"),r.Hb(),r.lc(864," will lookup imported modules to reuse an existing "),r.Ib(865,"code"),r.lc(866,"ConfigService"),r.Hb(),r.lc(867," instead of instantiating a new one."),r.Hb(),r.Ib(868,"h4",62),r.Ib(869,"span"),r.lc(870,"Example"),r.Hb(),r.Hb(),r.Ib(871,"p"),r.lc(872,"A working example is available "),r.Ib(873,"a",63),r.lc(874,"here"),r.Hb(),r.lc(875,"."),r.Hb(),r.Ib(876,"p"),r.Gb(877,"app-banner-enterprise"),r.Hb(),r.Ib(878,"h3",64),r.lc(879,"Sequelize Integration"),r.Hb(),r.Ib(880,"p"),r.lc(881,"An alternative to using TypeORM is to use the "),r.Ib(882,"a",7),r.lc(883,"Sequelize"),r.Hb(),r.lc(884," ORM with the "),r.Ib(885,"code"),r.lc(886,"@nestjs/sequelize"),r.Hb(),r.lc(887," package. In addition, we leverage the "),r.Ib(888,"a",65),r.lc(889,"sequelize-typescript"),r.Hb(),r.lc(890," package which provides a set of additional decorators to declaratively define entities."),r.Hb(),r.Ib(891,"p"),r.lc(892,"To begin using it, we first install the required dependencies. In this chapter, we'll demonstrate using the popular "),r.Ib(893,"a",16),r.lc(894,"MySQL"),r.Hb(),r.lc(895," Relational DBMS, but Sequelize provides support for many relational databases, such as PostgreSQL, MySQL, Microsoft SQL Server, SQLite, and MariaDB. The procedure we walk through in this chapter will be the same for any database supported by Sequelize. You'll simply need to install the associated client API libraries for your selected database."),r.Hb(),r.Ib(896,"pre"),r.Ib(897,"code",17),r.lc(898,"\n$ npm install --save @nestjs/sequelize sequelize sequelize-typescript mysql2\n$ npm install --save-dev @types/sequelize"),r.Hb(),r.Hb(),r.Ib(899,"p"),r.lc(900,"Once the installation process is complete, we can import the "),r.Ib(901,"code"),r.lc(902,"SequelizeModule"),r.Hb(),r.lc(903," into the root "),r.Ib(904,"code"),r.lc(905,"AppModule"),r.Hb(),r.lc(906,"."),r.Hb(),r.Ib(907,"span",18),r.lc(908),r.Ub(909,"extension"),r.Gb(910,"app-tabs",null,66),r.Hb(),r.Ib(912,"pre"),r.Ib(913,"code",20),r.lc(914,"\nimport { Module } from '@nestjs/common';\nimport { SequelizeModule } from '@nestjs/sequelize';\n\n@Module({\n  imports: [\n    SequelizeModule.forRoot({\n      dialect: 'mysql',\n      host: 'localhost',\n      port: 3306,\n      username: 'root',\n      password: 'root',\n      database: 'test',\n      models: [],\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(915,"p"),r.lc(916,"The "),r.Ib(917,"code"),r.lc(918,"forRoot()"),r.Hb(),r.lc(919," method supports all the configuration properties exposed by the Sequelize constructor ("),r.Ib(920,"a",67),r.lc(921,"read more"),r.Hb(),r.lc(922,"). In addition, there are several extra configuration properties described below."),r.Hb(),r.Ib(923,"table"),r.Ib(924,"tr"),r.Ib(925,"td"),r.Ib(926,"code"),r.lc(927,"retryAttempts"),r.Hb(),r.Hb(),r.Ib(928,"td"),r.lc(929,"Number of attempts to connect to the database (default: "),r.Ib(930,"code"),r.lc(931,"10"),r.Hb(),r.lc(932,")"),r.Hb(),r.Hb(),r.Ib(933,"tr"),r.Ib(934,"td"),r.Ib(935,"code"),r.lc(936,"retryDelay"),r.Hb(),r.Hb(),r.Ib(937,"td"),r.lc(938,"Delay between connection retry attempts (ms) (default: "),r.Ib(939,"code"),r.lc(940,"3000"),r.Hb(),r.lc(941,")"),r.Hb(),r.Hb(),r.Ib(942,"tr"),r.Ib(943,"td"),r.Ib(944,"code"),r.lc(945,"autoLoadModels"),r.Hb(),r.Hb(),r.Ib(946,"td"),r.lc(947,"If "),r.Ib(948,"code"),r.lc(949,"true"),r.Hb(),r.lc(950,", models will be loaded automatically (default: "),r.Ib(951,"code"),r.lc(952,"false"),r.Hb(),r.lc(953,")"),r.Hb(),r.Hb(),r.Ib(954,"tr"),r.Ib(955,"td"),r.Ib(956,"code"),r.lc(957,"keepConnectionAlive"),r.Hb(),r.Hb(),r.Ib(958,"td"),r.lc(959,"If "),r.Ib(960,"code"),r.lc(961,"true"),r.Hb(),r.lc(962,", connection will not be closed on the application shutdown (default: "),r.Ib(963,"code"),r.lc(964,"false"),r.Hb(),r.lc(965,")"),r.Hb(),r.Hb(),r.Ib(966,"tr"),r.Ib(967,"td"),r.Ib(968,"code"),r.lc(969,"synchronize"),r.Hb(),r.Hb(),r.Ib(970,"td"),r.lc(971,"If "),r.Ib(972,"code"),r.lc(973,"true"),r.Hb(),r.lc(974,", automatically loaded models will be synchronized (default: "),r.Ib(975,"code"),r.lc(976,"false"),r.Hb(),r.lc(977,")"),r.Hb(),r.Hb(),r.Hb(),r.Ib(978,"p"),r.lc(979,"Once this is done, the "),r.Ib(980,"code"),r.lc(981,"Sequelize"),r.Hb(),r.lc(982," object will be available to inject across the entire project (without needing to import any modules), for example:"),r.Hb(),r.Ib(983,"span",18),r.lc(984),r.Ub(985,"extension"),r.Gb(986,"app-tabs",null,68),r.Hb(),r.Ib(988,"pre"),r.Ib(989,"code",20),r.lc(990,"\nimport { Injectable } from '@nestjs/common';\nimport { Sequelize } from 'sequelize-typescript';\n\n@Injectable()\nexport class AppService {\n  constructor(private sequelize: Sequelize) {}\n}"),r.Hb(),r.Hb(),r.Ib(991,"pre"),r.Ib(992,"code",20),r.lc(993,"\nimport { Injectable } from '@nestjs/common';\nimport { Sequelize } from 'sequelize-typescript';\n\n@Dependencies(Sequelize)\n@Injectable()\nexport class AppService {\n  constructor(sequelize) {\n    this.sequelize = sequelize;\n  }\n}"),r.Hb(),r.Hb(),r.Ib(994,"h4",69),r.Ib(995,"span"),r.lc(996,"Models"),r.Hb(),r.Hb(),r.Ib(997,"p"),r.lc(998,"Sequelize implements the Active Record pattern. With this pattern, you use model classes directly to interact with the database. To continue the example, we need at least one model. Let's define the "),r.Ib(999,"code"),r.lc(1e3,"User"),r.Hb(),r.lc(1001," model."),r.Hb(),r.Ib(1002,"span",18),r.lc(1003),r.Ub(1004,"extension"),r.Gb(1005,"app-tabs",null,70),r.Hb(),r.Ib(1007,"pre"),r.Ib(1008,"code",20),r.lc(1009,"\nimport { Column, Model, Table } from 'sequelize-typescript';\n\n@Table\nexport class User extends Model<User> {\n  @Column\n  firstName: string;\n\n  @Column\n  lastName: string;\n\n  @Column({ defaultValue: true })\n  isActive: boolean;\n}"),r.Hb(),r.Hb(),r.Ib(1010,"blockquote",22),r.Ib(1011,"strong"),r.lc(1012,"Hint"),r.Hb(),r.lc(1013," Learn more about the available decorators "),r.Ib(1014,"a",71),r.lc(1015,"here"),r.Hb(),r.lc(1016,".\n"),r.Hb(),r.Ib(1017,"p"),r.lc(1018,"The "),r.Ib(1019,"code"),r.lc(1020,"User"),r.Hb(),r.lc(1021," model file sits in the "),r.Ib(1022,"code"),r.lc(1023,"users"),r.Hb(),r.lc(1024," directory. This directory contains all files related to the "),r.Ib(1025,"code"),r.lc(1026,"UsersModule"),r.Hb(),r.lc(1027,". You can decide where to keep your model files, however, we recommend creating them near their "),r.Ib(1028,"strong"),r.lc(1029,"domain"),r.Hb(),r.lc(1030,", in the corresponding module directory."),r.Hb(),r.Ib(1031,"p"),r.lc(1032,"To begin using the "),r.Ib(1033,"code"),r.lc(1034,"User"),r.Hb(),r.lc(1035," model, we need to let Sequelize know about it by inserting it into the "),r.Ib(1036,"code"),r.lc(1037,"models"),r.Hb(),r.lc(1038," array in the module "),r.Ib(1039,"code"),r.lc(1040,"forRoot()"),r.Hb(),r.lc(1041," method options:"),r.Hb(),r.Ib(1042,"span",18),r.lc(1043),r.Ub(1044,"extension"),r.Gb(1045,"app-tabs",null,72),r.Hb(),r.Ib(1047,"pre"),r.Ib(1048,"code",20),r.lc(1049,"\nimport { Module } from '@nestjs/common';\nimport { SequelizeModule } from '@nestjs/sequelize';\nimport { User } from './users/user.model';\n\n@Module({\n  imports: [\n    SequelizeModule.forRoot({\n      dialect: 'mysql',\n      host: 'localhost',\n      port: 3306,\n      username: 'root',\n      password: 'root',\n      database: 'test',\n      models: [User],\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(1050,"p"),r.lc(1051,"Next, let's look at the "),r.Ib(1052,"code"),r.lc(1053,"UsersModule"),r.Hb(),r.lc(1054,":"),r.Hb(),r.Ib(1055,"span",18),r.lc(1056),r.Ub(1057,"extension"),r.Gb(1058,"app-tabs",null,73),r.Hb(),r.Ib(1060,"pre"),r.Ib(1061,"code",20),r.lc(1062,"\nimport { Module } from '@nestjs/common';\nimport { SequelizeModule } from '@nestjs/sequelize';\nimport { User } from './user.model';\nimport { UsersController } from './users.controller';\nimport { UsersService } from './users.service';\n\n@Module({\n  imports: [SequelizeModule.forFeature([User])],\n  providers: [UsersService],\n  controllers: [UsersController],\n})\nexport class UsersModule {}"),r.Hb(),r.Hb(),r.Ib(1063,"p"),r.lc(1064,"This module uses the "),r.Ib(1065,"code"),r.lc(1066,"forFeature()"),r.Hb(),r.lc(1067," method to define which models are registered in the current scope. With that in place, we can inject the "),r.Ib(1068,"code"),r.lc(1069,"UserModel"),r.Hb(),r.lc(1070," into the "),r.Ib(1071,"code"),r.lc(1072,"UsersService"),r.Hb(),r.lc(1073," using the "),r.Ib(1074,"code"),r.lc(1075,"@InjectModel()"),r.Hb(),r.lc(1076," decorator:"),r.Hb(),r.Ib(1077,"span",18),r.lc(1078),r.Ub(1079,"extension"),r.Gb(1080,"app-tabs",null,74),r.Hb(),r.Ib(1082,"pre"),r.Ib(1083,"code",20),r.lc(1084,"\nimport { Injectable } from '@nestjs/common';\nimport { InjectModel } from '@nestjs/sequelize';\nimport { User } from './user.model';\n\n@Injectable()\nexport class UsersService {\n  constructor(\n    @InjectModel(User)\n    private userModel: typeof User,\n  ) {}\n\n  async findAll(): Promise<User[]> {\n    return this.userModel.findAll();\n  }\n\n  findOne(id: string): Promise<User> {\n    return this.userModel.findOne({\n      where: {\n        id,\n      },\n    });\n  }\n\n  async remove(id: string): Promise<void> {\n    const user = await this.findOne(id);\n    await user.destroy();\n  }\n}"),r.Hb(),r.Hb(),r.Ib(1085,"pre"),r.Ib(1086,"code",20),r.lc(1087,"\nimport { Injectable, Dependencies } from '@nestjs/common';\nimport { getModelToken } from '@nestjs/sequelize';\nimport { User } from './user.model';\n\n@Injectable()\n@Dependencies(getModelToken(User))\nexport class UsersService {\n  constructor(usersRepository) {\n    this.usersRepository = usersRepository;\n  }\n\n  async findAll() {\n    return this.userModel.findAll();\n  }\n\n  findOne(id) {\n    return this.userModel.findOne({\n      where: {\n        id,\n      },\n    });\n  }\n\n  async remove(id) {\n    const user = await this.findOne(id);\n    await user.destroy();\n  }\n}"),r.Hb(),r.Hb(),r.Ib(1088,"blockquote",26),r.Ib(1089,"strong"),r.lc(1090,"Notice"),r.Hb(),r.lc(1091," Don't forget to import the "),r.Ib(1092,"code"),r.lc(1093,"UsersModule"),r.Hb(),r.lc(1094," into the root "),r.Ib(1095,"code"),r.lc(1096,"AppModule"),r.Hb(),r.lc(1097,".\n"),r.Hb(),r.Ib(1098,"p"),r.lc(1099,"If you want to use the repository outside of the module which imports "),r.Ib(1100,"code"),r.lc(1101,"SequelizeModule.forFeature"),r.Hb(),r.lc(1102,", you'll need to re-export the providers generated by it.\nYou can do this by exporting the whole module, like this:"),r.Hb(),r.Ib(1103,"span",18),r.lc(1104),r.Ub(1105,"extension"),r.Gb(1106,"app-tabs",null,75),r.Hb(),r.Ib(1108,"pre"),r.Ib(1109,"code",20),r.lc(1110,"\nimport { Module } from '@nestjs/common';\nimport { SequelizeModule } from '@nestjs/sequelize';\nimport { User } from './user.entity';\n\n@Module({\n  imports: [SequelizeModule.forFeature([User])],\n  exports: [SequelizeModule]\n})\nexport class UsersModule {}"),r.Hb(),r.Hb(),r.Ib(1111,"p"),r.lc(1112,"Now if we import "),r.Ib(1113,"code"),r.lc(1114,"UsersModule"),r.Hb(),r.lc(1115," in "),r.Ib(1116,"code"),r.lc(1117,"UserHttpModule"),r.Hb(),r.lc(1118,", we can use "),r.Ib(1119,"code"),r.lc(1120,"@InjectModel(User)"),r.Hb(),r.lc(1121," in the providers of the latter module."),r.Hb(),r.Ib(1122,"span",18),r.lc(1123),r.Ub(1124,"extension"),r.Gb(1125,"app-tabs",null,76),r.Hb(),r.Ib(1127,"pre"),r.Ib(1128,"code",20),r.lc(1129,"\nimport { Module } from '@nestjs/common';\nimport { UsersModule } from './user.module';\nimport { UsersService } from './users.service';\nimport { UsersController } from './users.controller';\n\n@Module({\n  imports: [UsersModule],\n  providers: [UsersService],\n  controllers: [UsersController]\n})\nexport class UserHttpModule {}"),r.Hb(),r.Hb(),r.Ib(1130,"h3",77),r.lc(1131,"Relations"),r.Hb(),r.Ib(1132,"p"),r.lc(1133,"Relations are associations established between two or more tables. Relations are based on common fields from each table, often involving primary and foreign keys."),r.Hb(),r.Ib(1134,"p");r.lc(1135,"There are three types of relations:"),r.Hb(),r.Ib(1136,"table"),r.Ib(1137,"tr"),r.Ib(1138,"td"),r.Ib(1139,"code"),r.lc(1140,"One-to-one"),r.Hb(),r.Hb(),r.Ib(1141,"td"),r.lc(1142,"Every row in the primary table has one and only one associated row in the foreign table"),r.Hb(),r.Hb(),r.Ib(1143,"tr"),r.Ib(1144,"td"),r.Ib(1145,"code"),r.lc(1146,"One-to-many / Many-to-one"),r.Hb(),r.Hb(),r.Ib(1147,"td"),r.lc(1148,"Every row in the primary table has one or more related rows in the foreign table"),r.Hb(),r.Hb(),r.Ib(1149,"tr"),r.Ib(1150,"td"),r.Ib(1151,"code"),r.lc(1152,"Many-to-many"),r.Hb(),r.Hb(),r.Ib(1153,"td"),r.lc(1154,"Every row in the primary table has many related rows in the foreign table, and every record in the foreign table has many related rows in the primary table"),r.Hb(),r.Hb(),r.Hb(),r.Ib(1155,"p"),r.lc(1156,"To define relations in entities, use the corresponding "),r.Ib(1157,"strong"),r.lc(1158,"decorators"),r.Hb(),r.lc(1159,". For example, to define that each "),r.Ib(1160,"code"),r.lc(1161,"User"),r.Hb(),r.lc(1162," can have multiple photos, use the "),r.Ib(1163,"code"),r.lc(1164,"@HasMany()"),r.Hb(),r.lc(1165," decorator."),r.Hb(),r.Ib(1166,"span",18),r.lc(1167),r.Ub(1168,"extension"),r.Gb(1169,"app-tabs",null,78),r.Hb(),r.Ib(1171,"pre"),r.Ib(1172,"code",20),r.lc(1173,"\nimport { Column, Model, Table, HasMany } from 'sequelize-typescript';\nimport { Photo } from '../photos/photo.model';\n\n@Table\nexport class User extends Model<User> {\n  @Column\n  firstName: string;\n\n  @Column\n  lastName: string;\n\n  @Column({ defaultValue: true })\n  isActive: boolean;\n\n  @HasMany(() => Photo)\n  photos: Photo[];\n}"),r.Hb(),r.Hb(),r.Ib(1174,"blockquote",22),r.Ib(1175,"strong"),r.lc(1176,"Hint"),r.Hb(),r.lc(1177," To learn more about associations in Sequelize, read "),r.Ib(1178,"a",79),r.lc(1179,"this"),r.Hb(),r.lc(1180," chapter.\n"),r.Hb(),r.Ib(1181,"h4",80),r.Ib(1182,"span"),r.lc(1183,"Auto-load models"),r.Hb(),r.Hb(),r.Ib(1184,"p"),r.lc(1185,"Manually adding models to the "),r.Ib(1186,"code"),r.lc(1187,"models"),r.Hb(),r.lc(1188," array of the connection options can be tedious. In addition, referencing models from the root module breaks application domain boundaries and causes leaking implementation details to other parts of the application. To solve this issue, automatically load models by setting both "),r.Ib(1189,"code"),r.lc(1190,"autoLoadModels"),r.Hb(),r.lc(1191," and "),r.Ib(1192,"code"),r.lc(1193,"synchronize"),r.Hb(),r.lc(1194," properties of the configuration object (passed into the "),r.Ib(1195,"code"),r.lc(1196,"forRoot()"),r.Hb(),r.lc(1197," method) to "),r.Ib(1198,"code"),r.lc(1199,"true"),r.Hb(),r.lc(1200,", as shown below:"),r.Hb(),r.Ib(1201,"span",18),r.lc(1202),r.Ub(1203,"extension"),r.Gb(1204,"app-tabs",null,81),r.Hb(),r.Ib(1206,"pre"),r.Ib(1207,"code",20),r.lc(1208,"\nimport { Module } from '@nestjs/common';\nimport { SequelizeModule } from '@nestjs/sequelize';\n\n@Module({\n  imports: [\n    SequelizeModule.forRoot({\n      ...\n      autoLoadModels: true,\n      synchronize: true,\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(1209,"p"),r.lc(1210,"With that option specified, every model registered through the "),r.Ib(1211,"code"),r.lc(1212,"forFeature()"),r.Hb(),r.lc(1213," method will be automatically added to the "),r.Ib(1214,"code"),r.lc(1215,"models"),r.Hb(),r.lc(1216," array of the configuration object."),r.Hb(),r.Ib(1217,"blockquote",26),r.Ib(1218,"strong"),r.lc(1219,"Warning"),r.Hb(),r.lc(1220," Note that models that aren't registered through the "),r.Ib(1221,"code"),r.lc(1222,"forFeature()"),r.Hb(),r.lc(1223," method, but are only referenced from the model (via an association), won't be included.\n"),r.Hb(),r.Ib(1224,"h4",82),r.Ib(1225,"span"),r.lc(1226,"Transactions"),r.Hb(),r.Hb(),r.Ib(1227,"p"),r.lc(1228,"A database transaction symbolizes a unit of work performed within a database management system against a database, and treated in a coherent and reliable way independent of other transactions. A transaction generally represents any change in a database ("),r.Ib(1229,"a",45),r.lc(1230,"learn more"),r.Hb(),r.lc(1231,")."),r.Hb(),r.Ib(1232,"p"),r.lc(1233,"There are many different strategies to handle "),r.Ib(1234,"a",83),r.lc(1235,"Sequelize transactions"),r.Hb(),r.lc(1236,". Below is a sample implementation of a managed transaction (auto-callback)."),r.Hb(),r.Ib(1237,"p"),r.lc(1238,"First, we need to inject the "),r.Ib(1239,"code"),r.lc(1240,"Sequelize"),r.Hb(),r.lc(1241," object into a class in the normal way:"),r.Hb(),r.Ib(1242,"pre"),r.Ib(1243,"code",20),r.lc(1244,"\n@Injectable()\nexport class UsersService {\n  constructor(private sequelize: Sequelize) {}\n}"),r.Hb(),r.Hb(),r.Ib(1245,"blockquote",22),r.Ib(1246,"strong"),r.lc(1247,"Hint"),r.Hb(),r.lc(1248," The "),r.Ib(1249,"code"),r.lc(1250,"Sequelize"),r.Hb(),r.lc(1251," class is imported from the "),r.Ib(1252,"code"),r.lc(1253,"sequelize-typescript"),r.Hb(),r.lc(1254," package.\n"),r.Hb(),r.Ib(1255,"p"),r.lc(1256,"Now, we can use this object to create a transaction."),r.Hb(),r.Ib(1257,"pre"),r.Ib(1258,"code",20),r.lc(1259,"\nasync createMany() {\n  try {\n    await this.sequelize.transaction(async t => {\n      const transactionHost = { transaction: t };\n\n      await this.userModel.create(\n          { firstName: 'Abraham', lastName: 'Lincoln' },\n          transactionHost,\n      );\n      await this.userModel.create(\n          { firstName: 'John', lastName: 'Boothe' },\n          transactionHost,\n      );\n    });\n  } catch (err) {\n    // Transaction has been rolled back\n    // err is whatever rejected the promise chain returned to the transaction callback\n  }\n}"),r.Hb(),r.Hb(),r.Ib(1260,"blockquote",22),r.Ib(1261,"strong"),r.lc(1262,"Hint"),r.Hb(),r.lc(1263," Note that the "),r.Ib(1264,"code"),r.lc(1265,"Sequelize"),r.Hb(),r.lc(1266," instance is used only to start the transaction. However, to test this class would require mocking the entire "),r.Ib(1267,"code"),r.lc(1268,"Sequelize"),r.Hb(),r.lc(1269," object (which exposes several methods). Thus, we recommend using a helper factory class (e.g., "),r.Ib(1270,"code"),r.lc(1271,"TransactionRunner"),r.Hb(),r.lc(1272,") and defining an interface with a limited set of methods required to maintain transactions. This technique makes mocking these methods pretty straightforward.\n"),r.Hb(),r.Ib(1273,"h4",84),r.Ib(1274,"span"),r.lc(1275,"Migrations"),r.Hb(),r.Hb(),r.Ib(1276,"p"),r.Ib(1277,"a",85),r.lc(1278,"Migrations"),r.Hb(),r.lc(1279," provide a way to incrementally update the database schema to keep it in sync with the application's data model while preserving existing data in the database. To generate, run, and revert migrations, Sequelize provides a dedicated "),r.Ib(1280,"a",86),r.lc(1281,"CLI"),r.Hb(),r.lc(1282,"."),r.Hb(),r.Ib(1283,"p"),r.lc(1284,"Migration classes are separate from the Nest application source code. Their lifecycle is maintained by the Sequelize CLI. Therefore, you are not able to leverage dependency injection and other Nest specific features with migrations. To learn more about migrations, follow the guide in the "),r.Ib(1285,"a",86),r.lc(1286,"Sequelize documentation"),r.Hb(),r.lc(1287,"."),r.Hb(),r.Ib(1288,"p"),r.Gb(1289,"app-banner-courses"),r.Hb(),r.Ib(1290,"h4",87),r.Ib(1291,"span"),r.lc(1292,"Multiple databases"),r.Hb(),r.Hb(),r.Ib(1293,"p"),r.lc(1294,"Some projects require multiple database connections. This can also be achieved with this module. To work with multiple connections, first create the connections. In this case, connection naming becomes "),r.Ib(1295,"strong"),r.lc(1296,"mandatory"),r.Hb(),r.lc(1297,"."),r.Hb(),r.Ib(1298,"p"),r.lc(1299,"Suppose you have an "),r.Ib(1300,"code"),r.lc(1301,"Album"),r.Hb(),r.lc(1302," entity stored in its own database."),r.Hb(),r.Ib(1303,"pre"),r.Ib(1304,"code",20),r.lc(1305,"\nconst defaultOptions = {\n  dialect: 'postgres',\n  port: 5432,\n  username: 'user',\n  password: 'password',\n  database: 'db',\n  synchronize: true,\n};\n\n@Module({\n  imports: [\n    SequelizeModule.forRoot({\n      ...defaultOptions,\n      host: 'user_db_host',\n      models: [User],\n    }),\n    SequelizeModule.forRoot({\n      ...defaultOptions,\n      name: 'albumsConnection',\n      host: 'album_db_host',\n      models: [Album],\n    }),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(1306,"blockquote",26),r.Ib(1307,"strong"),r.lc(1308,"Notice"),r.Hb(),r.lc(1309," If you don't set the "),r.Ib(1310,"code"),r.lc(1311,"name"),r.Hb(),r.lc(1312," for a connection, its name is set to "),r.Ib(1313,"code"),r.lc(1314,"default"),r.Hb(),r.lc(1315,". Please note that you shouldn't have multiple connections without a name, or with the same name, otherwise they will get overridden.\n"),r.Hb(),r.Ib(1316,"p"),r.lc(1317,"At this point, you have "),r.Ib(1318,"code"),r.lc(1319,"User"),r.Hb(),r.lc(1320," and "),r.Ib(1321,"code"),r.lc(1322,"Album"),r.Hb(),r.lc(1323," models registered with their own connection. With this setup, you have to tell the "),r.Ib(1324,"code"),r.lc(1325,"SequelizeModule.forFeature()"),r.Hb(),r.lc(1326," method and the "),r.Ib(1327,"code"),r.lc(1328,"@InjectModel()"),r.Hb(),r.lc(1329," decorator which connection should be used. If you do not pass any connection name, the "),r.Ib(1330,"code"),r.lc(1331,"default"),r.Hb(),r.lc(1332," connection is used."),r.Hb(),r.Ib(1333,"pre"),r.Ib(1334,"code",20),r.lc(1335,"\n@Module({\n  imports: [\n    SequelizeModule.forFeature([User]),\n    SequelizeModule.forFeature([Album], 'albumsConnection'),\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(1336,"p"),r.lc(1337,"You can also inject the "),r.Ib(1338,"code"),r.lc(1339,"Sequelize"),r.Hb(),r.lc(1340," instance for a given connection:"),r.Hb(),r.Ib(1341,"pre"),r.Ib(1342,"code",20),r.lc(1343,"\n@Injectable()\nexport class AlbumsService {\n  constructor(\n    @InjectConnection('albumsConnection')\n    private sequelize: Sequelize,\n  ) {}\n}"),r.Hb(),r.Hb(),r.Ib(1344,"h4",88),r.Ib(1345,"span"),r.lc(1346,"Testing"),r.Hb(),r.Hb(),r.Ib(1347,"p"),r.lc(1348,"When it comes to unit testing an application, we usually want to avoid making a database connection, keeping our test suites independent and their execution process as fast as possible. But our classes might depend on models that are pulled from the connection instance. How do we handle that? The solution is to create mock models. In order to achieve that, we set up "),r.Ib(1349,"a",57),r.lc(1350,"custom providers"),r.Hb(),r.lc(1351,". Each registered model is automatically represented by a "),r.Ib(1352,"code"),r.lc(1353,"<ModelName>Model"),r.Hb(),r.lc(1354," token, where "),r.Ib(1355,"code"),r.lc(1356,"ModelName"),r.Hb(),r.lc(1357," is the name of your model class."),r.Hb(),r.Ib(1358,"p"),r.lc(1359,"The "),r.Ib(1360,"code"),r.lc(1361,"@nestjs/sequelize"),r.Hb(),r.lc(1362," package exposes the "),r.Ib(1363,"code"),r.lc(1364,"getModelToken()"),r.Hb(),r.lc(1365," function which returns a prepared token based on a given model."),r.Hb(),r.Ib(1366,"pre"),r.Ib(1367,"code",20),r.lc(1368,"\n@Module({\n  providers: [\n    UsersService,\n    {\n      provide: getModelToken(User),\n      useValue: mockModel,\n    },\n  ],\n})\nexport class UsersModule {}"),r.Hb(),r.Hb(),r.Ib(1369,"p"),r.lc(1370,"Now a substitute "),r.Ib(1371,"code"),r.lc(1372,"mockModel"),r.Hb(),r.lc(1373," will be used as the "),r.Ib(1374,"code"),r.lc(1375,"UserModel"),r.Hb(),r.lc(1376,". Whenever any class asks for "),r.Ib(1377,"code"),r.lc(1378,"UserModel"),r.Hb(),r.lc(1379," using an "),r.Ib(1380,"code"),r.lc(1381,"@InjectModel()"),r.Hb(),r.lc(1382," decorator, Nest will use the registered "),r.Ib(1383,"code"),r.lc(1384,"mockModel"),r.Hb(),r.lc(1385," object."),r.Hb(),r.Ib(1386,"h4",89),r.Ib(1387,"span"),r.lc(1388,"Async configuration"),r.Hb(),r.Hb(),r.Ib(1389,"p"),r.lc(1390,"You may want to pass your "),r.Ib(1391,"code"),r.lc(1392,"SequelizeModule"),r.Hb(),r.lc(1393," options asynchronously instead of statically. In this case, use the "),r.Ib(1394,"code"),r.lc(1395,"forRootAsync()"),r.Hb(),r.lc(1396," method, which provides several ways to deal with async configuration."),r.Hb(),r.Ib(1397,"p"),r.lc(1398,"One approach is to use a factory function:"),r.Hb(),r.Ib(1399,"pre"),r.Ib(1400,"code",20),r.lc(1401,"\nSequelizeModule.forRootAsync({\n  useFactory: () => ({\n    dialect: 'mysql',\n    host: 'localhost',\n    port: 3306,\n    username: 'root',\n    password: 'root',\n    database: 'test',\n    models: [],\n  }),\n});"),r.Hb(),r.Hb(),r.Ib(1402,"p"),r.lc(1403,"Our factory behaves like any other "),r.Ib(1404,"a",61),r.lc(1405,"asynchronous provider"),r.Hb(),r.lc(1406," (e.g., it can be "),r.Ib(1407,"code"),r.lc(1408,"async"),r.Hb(),r.lc(1409," and it's able to inject dependencies through "),r.Ib(1410,"code"),r.lc(1411,"inject"),r.Hb(),r.lc(1412,")."),r.Hb(),r.Ib(1413,"pre"),r.Ib(1414,"code",20),r.lc(1415,"\nSequelizeModule.forRootAsync({\n  imports: [ConfigModule],\n  useFactory: (configService: ConfigService) => ({\n    dialect: 'mysql',\n    host: configService.get('HOST'),\n    port: +configService.get('PORT'),\n    username: configService.get('USERNAME'),\n    password: configService.get('PASSWORD'),\n    database: configService.get('DATABASE'),\n    models: [],\n  }),\n  inject: [ConfigService],\n});"),r.Hb(),r.Hb(),r.Ib(1416,"p"),r.lc(1417,"Alternatively, you can use the "),r.Ib(1418,"code"),r.lc(1419,"useClass"),r.Hb(),r.lc(1420," syntax:"),r.Hb(),r.Ib(1421,"pre"),r.Ib(1422,"code",20),r.lc(1423,"\nSequelizeModule.forRootAsync({\n  useClass: SequelizeConfigService,\n});"),r.Hb(),r.Hb(),r.Ib(1424,"p"),r.lc(1425,"The construction above will instantiate "),r.Ib(1426,"code"),r.lc(1427,"SequelizeConfigService"),r.Hb(),r.lc(1428," inside "),r.Ib(1429,"code"),r.lc(1430,"SequelizeModule"),r.Hb(),r.lc(1431," and use it to provide an options object by calling "),r.Ib(1432,"code"),r.lc(1433,"createSequelizeOptions()"),r.Hb(),r.lc(1434,". Note that this means that the "),r.Ib(1435,"code"),r.lc(1436,"SequelizeConfigService"),r.Hb(),r.lc(1437," has to implement the "),r.Ib(1438,"code"),r.lc(1439,"SequelizeOptionsFactory"),r.Hb(),r.lc(1440," interface, as shown below:"),r.Hb(),r.Ib(1441,"pre"),r.Ib(1442,"code",20),r.lc(1443,"\n@Injectable()\nclass SequelizeConfigService implements SequelizeOptionsFactory {\n  createSequelizeOptions(): SequelizeModuleOptions {\n    return {\n      dialect: 'mysql',\n      host: 'localhost',\n      port: 3306,\n      username: 'root',\n      password: 'root',\n      database: 'test',\n      models: [],\n    };\n  }\n}"),r.Hb(),r.Hb(),r.Ib(1444,"p"),r.lc(1445,"In order to prevent the creation of "),r.Ib(1446,"code"),r.lc(1447,"SequelizeConfigService"),r.Hb(),r.lc(1448," inside "),r.Ib(1449,"code"),r.lc(1450,"SequelizeModule"),r.Hb(),r.lc(1451," and use a provider imported from a different module, you can use the "),r.Ib(1452,"code"),r.lc(1453,"useExisting"),r.Hb(),r.lc(1454," syntax."),r.Hb(),r.Ib(1455,"pre"),r.Ib(1456,"code",20),r.lc(1457,"\nSequelizeModule.forRootAsync({\n  imports: [ConfigModule],\n  useExisting: ConfigService,\n});"),r.Hb(),r.Hb(),r.Ib(1458,"p"),r.lc(1459,"This construction works the same as "),r.Ib(1460,"code"),r.lc(1461,"useClass"),r.Hb(),r.lc(1462," with one critical difference - "),r.Ib(1463,"code"),r.lc(1464,"SequelizeModule"),r.Hb(),r.lc(1465," will lookup imported modules to reuse an existing "),r.Ib(1466,"code"),r.lc(1467,"ConfigService"),r.Hb(),r.lc(1468," instead of instantiating a new one."),r.Hb(),r.Ib(1469,"h4",90),r.Ib(1470,"span"),r.lc(1471,"Example"),r.Hb(),r.Hb(),r.Ib(1472,"p"),r.lc(1473,"A working example is available "),r.Ib(1474,"a",91),r.lc(1475,"here"),r.Hb(),r.lc(1476,"."),r.Hb(),r.Hb()}if(2&e){const e=r.dc(82),t=r.dc(167),o=r.dc(212),n=r.dc(238),s=r.dc(278),c=r.dc(291),a=r.dc(313),l=r.dc(339),i=r.dc(358),b=r.dc(414),d=r.dc(451),p=r.dc(911),u=r.dc(987),h=r.dc(1006),m=r.dc(1046),I=r.dc(1059),H=r.dc(1081),f=r.dc(1107),g=r.dc(1126),y=r.dc(1170),v=r.dc(1205);r.vb(79),r.nc(" ",r.Vb(80,41,"app.module",e.isJsActive),"\n"),r.vb(85),r.nc(" ",r.Vb(165,44,"app.module",t.isJsActive),"\n"),r.vb(12),r.oc("dist/**/*.entity","{"," .ts,.js","}",""),r.vb(33),r.nc(" ",r.Vb(210,47,"app.module",o.isJsActive),"\n"),r.vb(4),r.xb("hide",o.isJsActive),r.vb(3),r.xb("hide",!o.isJsActive),r.vb(19),r.nc(" ",r.Vb(236,50,"user.entity",n.isJsActive),"\n"),r.vb(40),r.nc(" ",r.Vb(276,53,"app.module",s.isJsActive),"\n"),r.vb(13),r.nc(" ",r.Vb(289,56,"users.module",c.isJsActive),"\n"),r.vb(22),r.nc(" ",r.Vb(311,59,"users.service",a.isJsActive),"\n"),r.vb(4),r.xb("hide",a.isJsActive),r.vb(3),r.xb("hide",!a.isJsActive),r.vb(19),r.nc(" ",r.Vb(337,62,"users.module",l.isJsActive),"\n"),r.vb(19),r.nc(" ",r.Vb(356,65,"users-http.module",i.isJsActive),"\n"),r.vb(56),r.nc(" ",r.Vb(412,68,"user.entity",b.isJsActive),"\n"),r.vb(23),r.oc("dist/**/*.entity","{"," .ts,.js","}",""),r.vb(14),r.nc(" ",r.Vb(449,71,"app.module",d.isJsActive),"\n"),r.vb(460),r.nc(" ",r.Vb(909,74,"app.module",p.isJsActive),"\n"),r.vb(76),r.nc(" ",r.Vb(985,77,"app.service",u.isJsActive),"\n"),r.vb(4),r.xb("hide",u.isJsActive),r.vb(3),r.xb("hide",!u.isJsActive),r.vb(12),r.nc(" ",r.Vb(1004,80,"user.model",h.isJsActive),"\n"),r.vb(40),r.nc(" ",r.Vb(1044,83,"app.module",m.isJsActive),"\n"),r.vb(13),r.nc(" ",r.Vb(1057,86,"users.module",I.isJsActive),"\n"),r.vb(22),r.nc(" ",r.Vb(1079,89,"users.service",H.isJsActive),"\n"),r.vb(4),r.xb("hide",H.isJsActive),r.vb(3),r.xb("hide",!H.isJsActive),r.vb(19),r.nc(" ",r.Vb(1105,92,"users.module",f.isJsActive),"\n"),r.vb(19),r.nc(" ",r.Vb(1124,95,"users-http.module",g.isJsActive),"\n"),r.vb(44),r.nc(" ",r.Vb(1168,98,"user.entity",y.isJsActive),"\n"),r.vb(35),r.nc(" ",r.Vb(1203,101,"app.module",v.isJsActive),"\n")}},directives:[s.f,i.a,l.a,g.a,d.a,b.a],pipes:[p.a],encapsulation:2,changeDetection:0}),e})();const z=r.Kb(G);let L=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return _(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-task-scheduling"]],features:[r.tb],decls:575,vars:4,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/task-scheduling.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","task-scheduling"],["rel","nofollow","target","_blank","href","https://en.wikipedia.org/wiki/Cron"],["rel","nofollow","target","_blank","href","https://github.com/kelektiv/node-cron"],["appAnchor","","id","installation"],[1,"language-bash"],[1,"filename"],["app19d240334f73871257be109902bf6c3a0d5fb503",""],[1,"language-typescript"],["href","techniques/task-scheduling#declarative-cron-jobs"],["href","techniques/task-scheduling#declarative-timeouts"],["href","techniques/task-scheduling#declarative-intervals"],["appAnchor","","id","declarative-cron-jobs"],["rel","nofollow","target","_blank","href","http://crontab.org/"],[1,"language-javascript"],[1,"info"],["href","/techniques/task-scheduling#dynamic-schedule-module-api"],["appAnchor","","id","declarative-intervals"],["href","techniques/task-scheduling#dynamic-intervals"],["appAnchor","","id","declarative-timeouts"],["href","techniques/task-scheduling#dynamic-timeouts"],["appAnchor","","id","dynamic-schedule-module-api"],["appAnchor","","id","dynamic-cron-jobs"],[1,"warning"],["appAnchor","","id","dynamic-intervals"],["appAnchor","","id","dynamic-timeouts"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/27-scheduling"]],template:function(e,t){if(1&e){r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"Task Scheduling"),r.Hb(),r.Ib(7,"p"),r.lc(8,"Task scheduling allows you to schedule arbitrary code (methods/functions) to execute at a fixed date/time, at recurring intervals, or once after a specified interval. In the Linux world, this is often handled by packages like "),r.Ib(9,"a",6),r.lc(10,"cron"),r.Hb(),r.lc(11," at the OS level. For Node.js apps, there are several packages that emulate cron-like functionality. Nest provides the "),r.Ib(12,"code"),r.lc(13,"@nestjs/schedule"),r.Hb(),r.lc(14," package, which integrates with the popular Node.js "),r.Ib(15,"a",7),r.lc(16,"node-cron"),r.Hb(),r.lc(17," package. We'll cover this package in the current chapter."),r.Hb(),r.Ib(18,"h4",8),r.Ib(19,"span"),r.lc(20,"Installation"),r.Hb(),r.Hb(),r.Ib(21,"p"),r.lc(22,"To begin using it, we first install the required dependencies."),r.Hb(),r.Ib(23,"pre"),r.Ib(24,"code",9),r.lc(25,"\n$ npm install --save @nestjs/schedule"),r.Hb(),r.Hb(),r.Ib(26,"p"),r.lc(27,"To activate job scheduling, import the "),r.Ib(28,"code"),r.lc(29,"ScheduleModule"),r.Hb(),r.lc(30," into the root "),r.Ib(31,"code"),r.lc(32,"AppModule"),r.Hb(),r.lc(33," and run the "),r.Ib(34,"code"),r.lc(35,"forRoot()"),r.Hb(),r.lc(36," static method as shown below:"),r.Hb(),r.Ib(37,"span",10),r.lc(38),r.Ub(39,"extension"),r.Gb(40,"app-tabs",null,11),r.Hb(),r.Ib(42,"pre"),r.Ib(43,"code",12),r.lc(44,"\nimport { Module } from '@nestjs/common';\nimport { ScheduleModule } from '@nestjs/schedule';\n\n@Module({\n  imports: [\n    ScheduleModule.forRoot()\n  ],\n})\nexport class AppModule {}"),r.Hb(),r.Hb(),r.Ib(45,"p"),r.lc(46,"The "),r.Ib(47,"code"),r.lc(48,".forRoot()"),r.Hb(),r.lc(49," call initializes the scheduler and registers any declarative "),r.Ib(50,"a",13),r.lc(51,"cron jobs"),r.Hb(),r.lc(52,", "),r.Ib(53,"a",14),r.lc(54,"timeouts"),r.Hb(),r.lc(55," and "),r.Ib(56,"a",15),r.lc(57,"intervals"),r.Hb(),r.lc(58," that exist within your app. Registration occurs when the "),r.Ib(59,"code"),r.lc(60,"onApplicationBootstrap"),r.Hb(),r.lc(61," lifecycle hook occurs, ensuring that all modules have loaded and declared any scheduled jobs."),r.Hb(),r.Ib(62,"h4",16),r.Ib(63,"span"),r.lc(64,"Declarative cron jobs"),r.Hb(),r.Hb(),r.Ib(65,"p"),r.lc(66,"A cron job schedules an arbitrary function (method call) to run automatically. Cron jobs can run:"),r.Hb(),r.Ib(67,"ul"),r.Ib(68,"li"),r.lc(69,"Once, at a specified date/time."),r.Hb(),r.Ib(70,"li"),r.lc(71,"On a recurring basis; recurring jobs can run at a specified instant within a specified interval (for example, once per hour, once per week, once every 5 minutes)"),r.Hb(),r.Hb(),r.Ib(72,"p"),r.lc(73,"Declare a cron job with the "),r.Ib(74,"code"),r.lc(75,"@Cron()"),r.Hb(),r.lc(76," decorator preceding the method definition containing the code to be executed, as follows:"),r.Hb(),r.Ib(77,"pre"),r.Ib(78,"code",12),r.lc(79,"\nimport { Injectable, Logger } from '@nestjs/common';\nimport { Cron } from '@nestjs/schedule';\n\n@Injectable()\nexport class TasksService {\n  private readonly logger = new Logger(TasksService.name);\n\n  @Cron('45 * * * * *')\n  handleCron() {\n    this.logger.debug('Called when the current second is 45');\n  }\n}"),r.Hb(),r.Hb(),r.Ib(80,"p"),r.lc(81,"In this example, the "),r.Ib(82,"code"),r.lc(83,"handleCron()"),r.Hb(),r.lc(84," method will be called each time the current second is "),r.Ib(85,"code"),r.lc(86,"45"),r.Hb(),r.lc(87,". In other words, the method will be run once per minute, at the 45 second mark."),r.Hb(),r.Ib(88,"p"),r.lc(89,"The "),r.Ib(90,"code"),r.lc(91,"@Cron()"),r.Hb(),r.lc(92," decorator supports all standard "),r.Ib(93,"a",17),r.lc(94,"cron patterns"),r.Hb(),r.lc(95,":"),r.Hb(),r.Ib(96,"ul"),r.Ib(97,"li"),r.lc(98,"Asterisk (e.g. "),r.Ib(99,"code"),r.lc(100,"*"),r.Hb(),r.lc(101,")"),r.Hb(),r.Ib(102,"li"),r.lc(103,"Ranges (e.g. "),r.Ib(104,"code"),r.lc(105,"1-3,5"),r.Hb(),r.lc(106,")"),r.Hb(),r.Ib(107,"li"),r.lc(108,"Steps (e.g. "),r.Ib(109,"code"),r.lc(110,"*/2"),r.Hb(),r.lc(111,")"),r.Hb(),r.Hb(),r.Ib(112,"p"),r.lc(113,"In the example above, we passed "),r.Ib(114,"code"),r.lc(115,"45 * * * * *"),r.Hb(),r.lc(116," to the decorator. The following key shows how each position in the cron pattern string is interpreted:"),r.Hb(),r.Ib(117,"pre",18),r.Ib(118,"code",18),r.lc(119,"\n* * * * * *\n| | | | | |\n| | | | | day of week\n| | | | month\n| | | day of month\n| | hour\n| minute\nsecond (optional)\n"),r.Hb(),r.Hb(),r.Ib(120,"p"),r.lc(121,"Some sample cron patterns are:"),r.Hb(),r.Ib(122,"table"),r.Ib(123,"tbody"),r.Ib(124,"tr"),r.Ib(125,"td"),r.Ib(126,"code"),r.lc(127,"* * * * * *"),r.Hb(),r.Hb(),r.Ib(128,"td"),r.lc(129,"every second"),r.Hb(),r.Hb(),r.Ib(130,"tr"),r.Ib(131,"td"),r.Ib(132,"code"),r.lc(133,"45 * * * * *"),r.Hb(),r.Hb(),r.Ib(134,"td"),r.lc(135,"every minute, on the 45th second"),r.Hb(),r.Hb(),r.Ib(136,"tr"),r.Ib(137,"td"),r.Ib(138,"code"),r.lc(139,"* 10 * * * *"),r.Hb(),r.Hb(),r.Ib(140,"td"),r.lc(141,"every hour, at the start of the 10th minute"),r.Hb(),r.Hb(),r.Ib(142,"tr"),r.Ib(143,"td"),r.Ib(144,"code"),r.lc(145,"0 */30 9-17 * * *"),r.Hb(),r.Hb(),r.Ib(146,"td"),r.lc(147,"every 30 minutes between 9am and 5pm"),r.Hb(),r.Hb(),r.Ib(148,"tr"),r.Ib(149,"td"),r.Ib(150,"code"),r.lc(151,"0 30 11 * * 1-5"),r.Hb(),r.Hb(),r.Ib(152,"td"),r.lc(153,"Monday to Friday at 11:30am"),r.Hb(),r.Hb(),r.Hb(),r.Hb(),r.Ib(154,"p"),r.lc(155,"The "),r.Ib(156,"code"),r.lc(157,"@nestjs/schedule"),r.Hb(),r.lc(158," package provides a convenience enum with commonly used cron patterns. You can use this enum as follows:"),r.Hb(),r.Ib(159,"pre"),r.Ib(160,"code",12),r.lc(161,"\nimport { Injectable, Logger } from '@nestjs/common';\nimport { Cron, CronExpression } from '@nestjs/schedule';\n\n@Injectable()\nexport class TasksService {\n  private readonly logger = new Logger(TasksService.name);\n\n  @Cron(CronExpression.EVERY_45_SECONDS)\n  handleCron() {\n    this.logger.debug('Called every 45 seconds');\n  }\n}"),r.Hb(),r.Hb(),r.Ib(162,"p"),r.lc(163,"In this example, the "),r.Ib(164,"code"),r.lc(165,"handleCron()"),r.Hb(),r.lc(166," method will be called every "),r.Ib(167,"code"),r.lc(168,"45"),r.Hb(),r.lc(169," seconds."),r.Hb(),r.Ib(170,"p"),r.lc(171,"Alternatively, you can supply a JavaScript "),r.Ib(172,"code"),r.lc(173,"Date"),r.Hb(),r.lc(174," object to the "),r.Ib(175,"code"),r.lc(176,"@Cron()"),r.Hb(),r.lc(177," decorator. Doing so causes the job to execute exactly once, at the specified date."),r.Hb(),r.Ib(178,"blockquote",19),r.Ib(179,"strong"),r.lc(180,"Hint"),r.Hb(),r.lc(181," Use JavaScript date arithmetic to schedule jobs relative to the current date. For example, "),r.Ib(182,"code"),r.lc(183,"@Cron(new Date(Date.now() + 10 * 1000))"),r.Hb(),r.lc(184," to schedule a job to run 10 seconds after the app starts.\n"),r.Hb(),r.Ib(185,"p"),r.lc(186,"You can access and control a cron job after it's been declared, or dynamically create a cron job (where its cron pattern is defined at runtime) with the "),r.Ib(187,"a",20),r.lc(188,"Dynamic API"),r.Hb(),r.lc(189,". To access a declarative cron job via the API, you must associate the job with a name by passing the "),r.Ib(190,"code"),r.lc(191,"name"),r.Hb(),r.lc(192," property in an optional options object as the second argument of the decorator, as shown below:"),r.Hb(),r.Ib(193,"pre"),r.Ib(194,"code",12),r.lc(195,"\n@Cron('* * 8 * * *', {\n  name: 'notifications',\n})\ntriggerNotifications() {}"),r.Hb(),r.Hb(),r.Ib(196,"h4",21),r.Ib(197,"span"),r.lc(198,"Declarative intervals"),r.Hb(),r.Hb(),r.Ib(199,"p"),r.lc(200,"To declare that a method should run at a (recurring) specified interval, prefix the method definition with the "),r.Ib(201,"code"),r.lc(202,"@Interval()"),r.Hb(),r.lc(203," decorator. Pass the interval value, as a number in milliseconds, to the decorator as shown below:"),r.Hb(),r.Ib(204,"pre"),r.Ib(205,"code",12),r.lc(206,"\n@Interval(10000)\nhandleInterval() {\n  this.logger.debug('Called every 10 seconds');\n}"),r.Hb(),r.Hb(),r.Ib(207,"blockquote",19),r.Ib(208,"strong"),r.lc(209,"Hint"),r.Hb(),r.lc(210," This mechanism uses the JavaScript "),r.Ib(211,"code"),r.lc(212,"setInterval()"),r.Hb(),r.lc(213," function under the hood. You can also utilize a cron job to schedule recurring jobs.\n"),r.Hb(),r.Ib(214,"p"),r.lc(215,"If you want to control your declarative interval from outside the declaring class via the "),r.Ib(216,"a",20),r.lc(217,"Dynamic API"),r.Hb(),r.lc(218,", associate the interval with a name using the following construction:"),r.Hb(),r.Ib(219,"pre"),r.Ib(220,"code",12),r.lc(221,"\n@Interval('notifications', 2500)\nhandleInterval() {}"),r.Hb(),r.Hb(),r.Ib(222,"p"),r.lc(223,"The "),r.Ib(224,"a",22),r.lc(225,"Dynamic API"),r.Hb(),r.lc(226," also enables "),r.Ib(227,"strong"),r.lc(228,"creating"),r.Hb(),r.lc(229," dynamic intervals, where the interval's properties are defined at runtime, and "),r.Ib(230,"strong"),r.lc(231,"listing and deleting"),r.Hb(),r.lc(232," them."),r.Hb(),r.Ib(233,"p"),r.Gb(234,"app-banner-enterprise"),r.Hb(),r.Ib(235,"h4",23),r.Ib(236,"span"),r.lc(237,"Declarative timeouts"),r.Hb(),r.Hb(),r.Ib(238,"p"),r.lc(239,"To declare that a method should run (once) at a specified timeout, prefix the method definition with the "),r.Ib(240,"code"),r.lc(241,"@Timeout()"),r.Hb(),r.lc(242," decorator. Pass the relative time offset (in milliseconds), from application startup, to the decorator as shown below:"),r.Hb(),r.Ib(243,"pre"),r.Ib(244,"code",12),r.lc(245,"\n@Timeout(5000)\nhandleTimeout() {\n  this.logger.debug('Called once after 5 seconds');\n}"),r.Hb(),r.Hb(),r.Ib(246,"blockquote",19),r.Ib(247,"strong"),r.lc(248,"Hint"),r.Hb(),r.lc(249," This mechanism uses the JavaScript "),r.Ib(250,"code"),r.lc(251,"setTimeout()"),r.Hb(),r.lc(252," function under the hood.\n"),r.Hb(),r.Ib(253,"p"),r.lc(254,"If you want to control your declarative timeout from outside the declaring class via the "),r.Ib(255,"a",20),r.lc(256,"Dynamic API"),r.Hb(),r.lc(257,", associate the timeout with a name using the following construction:"),r.Hb(),r.Ib(258,"pre"),r.Ib(259,"code",12),r.lc(260,"\n@Timeout('notifications', 2500)\nhandleTimeout() {}"),r.Hb(),r.Hb(),r.Ib(261,"p"),r.lc(262,"The "),r.Ib(263,"a",24),r.lc(264,"Dynamic API"),r.Hb(),r.lc(265," also enables "),r.Ib(266,"strong"),r.lc(267,"creating"),r.Hb(),r.lc(268," dynamic timeouts, where the timeout's properties are defined at runtime, and "),r.Ib(269,"strong"),r.lc(270,"listing and deleting"),r.Hb(),r.lc(271," them."),r.Hb(),r.Ib(272,"h4",25),r.Ib(273,"span"),r.lc(274,"Dynamic schedule module API"),r.Hb(),r.Hb(),r.Ib(275,"p"),r.lc(276,"The "),r.Ib(277,"code"),r.lc(278,"@nestjs/schedule"),r.Hb(),r.lc(279," module provides a dynamic API that enables managing declarative "),r.Ib(280,"a",13),r.lc(281,"cron jobs"),r.Hb(),r.lc(282,", "),r.Ib(283,"a",14),r.lc(284,"timeouts"),r.Hb(),r.lc(285," and "),r.Ib(286,"a",15),r.lc(287,"intervals"),r.Hb(),r.lc(288,". The API also enables creating and managing "),r.Ib(289,"strong"),r.lc(290,"dynamic"),r.Hb(),r.lc(291," cron jobs, timeouts and intervals, where the properties are defined at runtime."),r.Hb(),r.Ib(292,"h4",26),r.Ib(293,"span"),r.lc(294,"Dynamic cron jobs"),r.Hb(),r.Hb(),r.Ib(295,"p"),r.lc(296,"Obtain a reference to a "),r.Ib(297,"code"),r.lc(298,"CronJob"),r.Hb(),r.lc(299," instance by name from anywhere in your code using the "),r.Ib(300,"code"),r.lc(301,"SchedulerRegistry"),r.Hb(),r.lc(302," API. First, inject "),r.Ib(303,"code"),r.lc(304,"SchedulerRegistry"),r.Hb(),r.lc(305," using standard constructor injection:"),r.Hb(),r.Ib(306,"pre"),r.Ib(307,"code",12),r.lc(308,"\nconstructor(private schedulerRegistry: SchedulerRegistry) {}"),r.Hb(),r.Hb(),r.Ib(309,"blockquote",19),r.Ib(310,"strong"),r.lc(311,"Hint"),r.Hb(),r.lc(312," Import the "),r.Ib(313,"code"),r.lc(314,"SchedulerRegistry"),r.Hb(),r.lc(315," from the "),r.Ib(316,"code"),r.lc(317,"@nestjs/schedule"),r.Hb(),r.lc(318," package.\n"),r.Hb(),r.Ib(319,"p"),r.lc(320,"Then use it in a class as follows. Assume a cron job was created with the following declaration:"),r.Hb(),r.Ib(321,"pre"),r.Ib(322,"code",12),r.lc(323,"\n@Cron('* * 8 * * *', {\n  name: 'notifications',\n})\ntriggerNotifications() {}"),r.Hb(),r.Hb(),r.Ib(324,"p"),r.lc(325,"Access this job using the following:"),r.Hb(),r.Ib(326,"pre"),r.Ib(327,"code",12),r.lc(328,"\nconst job = this.schedulerRegistry.getCronJob('notifications');\n\njob.stop();\nconsole.log(job.lastDate());"),r.Hb(),r.Hb(),r.Ib(329,"p"),r.lc(330,"The "),r.Ib(331,"code"),r.lc(332,"getCronJob()"),r.Hb(),r.lc(333," method returns the named cron job. The returned "),r.Ib(334,"code"),r.lc(335,"CronJob"),r.Hb(),r.lc(336," object has the following methods:"),r.Hb(),r.Ib(337,"ul"),r.Ib(338,"li"),r.Ib(339,"code"),r.lc(340,"stop()"),r.Hb(),r.lc(341," - stops a job that is scheduled to run."),r.Hb(),r.Ib(342,"li"),r.Ib(343,"code"),r.lc(344,"start()"),r.Hb(),r.lc(345," - restarts a job that has been stopped."),r.Hb(),r.Ib(346,"li"),r.Ib(347,"code"),r.lc(348,"setTime(time: CronTime)"),r.Hb(),r.lc(349," - stops a job, sets a new time for it, and then starts it"),r.Hb(),r.Ib(350,"li"),r.Ib(351,"code"),r.lc(352,"lastDate()"),r.Hb(),r.lc(353," - returns a string representation of the last date a job executed"),r.Hb(),r.Ib(354,"li"),r.Ib(355,"code"),r.lc(356,"nextDates(count: number)"),r.Hb(),r.lc(357," - returns an array (size "),r.Ib(358,"code"),r.lc(359,"count"),r.Hb(),r.lc(360,") of "),r.Ib(361,"code"),r.lc(362,"moment"),r.Hb(),r.lc(363," objects representing upcoming job execution dates."),r.Hb(),r.Hb(),r.Ib(364,"blockquote",19),r.Ib(365,"strong"),r.lc(366,"Hint"),r.Hb(),r.lc(367," Use "),r.Ib(368,"code"),r.lc(369,"toDate()"),r.Hb(),r.lc(370," on "),r.Ib(371,"code"),r.lc(372,"moment"),r.Hb(),r.lc(373," objects to render them in human readable form.\n"),r.Hb(),r.Ib(374,"p"),r.Ib(375,"strong"),r.lc(376,"Create"),r.Hb(),r.lc(377," a new cron job dynamically using the "),r.Ib(378,"code"),r.lc(379,"SchedulerRegistry.addCronJob()"),r.Hb(),r.lc(380," method, as follows:"),r.Hb(),r.Ib(381,"pre"),r.Ib(382,"code",12),r.lc(383,"\naddCronJob(name: string, seconds: string) {\n  const job = new CronJob(`${seconds} * * * * *`, () => {\n    this.logger.warn(`time (${seconds}) for job ${name} to run!`);\n  });\n\n  this.scheduler.addCronJob(name, job);\n  job.start();\n\n  this.logger.warn(\n    `job ${name} added for each minute at ${seconds} seconds!`,\n  );\n}"),r.Hb(),r.Hb(),r.Ib(384,"p"),r.lc(385,"In this code, we use the "),r.Ib(386,"code"),r.lc(387,"CronJob"),r.Hb(),r.lc(388," object from the "),r.Ib(389,"code"),r.lc(390,"cron"),r.Hb(),r.lc(391," package to create the cron job. The "),r.Ib(392,"code"),r.lc(393,"CronJob"),r.Hb(),r.lc(394," constructor takes a cron pattern (just like the "),r.Ib(395,"code"),r.lc(396,"@Cron()"),r.Hb(),r.Ib(397,"a",13),r.lc(398,"decorator"),r.Hb(),r.lc(399,") as its first argument, and a callback to be executed when the cron timer fires as its second argument. The "),r.Ib(400,"code"),r.lc(401,"SchedulerRegistry.addCronJob()"),r.Hb(),r.lc(402," method takes two arguments: a name for the "),r.Ib(403,"code"),r.lc(404,"CronJob"),r.Hb(),r.lc(405,", and the "),r.Ib(406,"code"),r.lc(407,"CronJob"),r.Hb(),r.lc(408," object itself."),r.Hb(),r.Ib(409,"blockquote",27),r.Ib(410,"strong"),r.lc(411,"Warning"),r.Hb(),r.lc(412," Remember to inject the "),r.Ib(413,"code"),r.lc(414,"SchedulerRegistry"),r.Hb(),r.lc(415," before accessing it. Import "),r.Ib(416,"code"),r.lc(417,"CronJob"),r.Hb(),r.lc(418," from the "),r.Ib(419,"code"),r.lc(420,"cron"),r.Hb(),r.lc(421," package.\n"),r.Hb(),r.Ib(422,"p"),r.Ib(423,"strong"),r.lc(424,"Delete"),r.Hb(),r.lc(425," a named cron job using the "),r.Ib(426,"code"),r.lc(427,"SchedulerRegistry.deleteCronJob()"),r.Hb(),r.lc(428," method, as follows:"),r.Hb(),r.Ib(429,"pre"),r.Ib(430,"code",12),r.lc(431,"\ndeleteCron(name: string) {\n  this.scheduler.deleteCronJob(name);\n  this.logger.warn(`job ${name} deleted!`);\n}"),r.Hb(),r.Hb(),r.Ib(432,"p"),r.Ib(433,"strong"),r.lc(434,"List"),r.Hb(),r.lc(435," all cron jobs using the "),r.Ib(436,"code"),r.lc(437,"SchedulerRegistry.getCronJobs()"),r.Hb(),r.lc(438," method as follows:"),r.Hb(),r.Ib(439,"pre"),r.Ib(440,"code",12),r.lc(441,"\ngetCrons() {\n  const jobs = this.scheduler.getCronJobs();\n  jobs.forEach((value, key, map) => {\n    let next;\n    try {\n      next = value.nextDates().toDate();\n    } catch (e) {\n      next = 'error: next fire date is in the past!';\n    }\n    this.logger.log(`job: ${key} -> next: ${next}`);\n  });\n}"),r.Hb(),r.Hb(),r.Ib(442,"p"),r.lc(443,"The "),r.Ib(444,"code"),r.lc(445,"getCronJobs()"),r.Hb(),r.lc(446," method returns a "),r.Ib(447,"code"),r.lc(448,"map"),r.Hb(),r.lc(449,". In this code, we iterate over the map and attempt to access the "),r.Ib(450,"code"),r.lc(451,"nextDates()"),r.Hb(),r.lc(452," method of each "),r.Ib(453,"code"),r.lc(454,"CronJob"),r.Hb(),r.lc(455,". In the "),r.Ib(456,"code"),r.lc(457,"CronJob"),r.Hb(),r.lc(458," API, if a job has already fired and has no future firing dates, it throws an exception."),r.Hb(),r.Ib(459,"h4",28),r.Ib(460,"span"),r.lc(461,"Dynamic intervals"),r.Hb(),r.Hb(),r.Ib(462,"p"),r.lc(463,"Obtain a reference to an interval with the "),r.Ib(464,"code"),r.lc(465,"SchedulerRegistry.getInterval()"),r.Hb(),r.lc(466," method. As above, inject "),r.Ib(467,"code"),r.lc(468,"SchedulerRegistry"),r.Hb(),r.lc(469," using standard constructor injection:"),r.Hb(),r.Ib(470,"pre"),r.Ib(471,"code",12),r.lc(472,"\nconstructor(private schedulerRegistry: SchedulerRegistry) {}"),r.Hb(),r.Hb(),r.Ib(473,"p"),r.lc(474,"And use it as follows:"),r.Hb(),r.Ib(475,"pre"),r.Ib(476,"code",12),r.lc(477,"\nconst interval = this.schedulerRegistry.getInterval('notifications');\nclearInterval(interval);"),r.Hb(),r.Hb(),r.Ib(478,"p"),r.Ib(479,"strong"),r.lc(480,"Create"),r.Hb(),r.lc(481," a new interval dynamically using the "),r.Ib(482,"code"),r.lc(483,"SchedulerRegistry.addInterval()"),r.Hb(),r.lc(484," method, as follows:"),r.Hb(),r.Ib(485,"pre"),r.Ib(486,"code",12),r.lc(487,"\naddInterval(name: string, seconds: string) {\n  const callback = () => {\n    this.logger.warn(`Interval ${name} executing at time (${seconds})!`);\n  };\n\n  const interval = setInterval(callback, seconds);\n  this.scheduler.addInterval(name, interval);\n}"),r.Hb(),r.Hb(),r.Ib(488,"p"),r.lc(489,"In this code, we create a standard JavaScript interval, then pass it to the "),r.Ib(490,"code"),r.lc(491,"ScheduleRegistry.addInterval()"),r.Hb(),r.lc(492," method.\nThat method takes two arguments: a name for the interval, and the interval itself."),r.Hb(),r.Ib(493,"p"),r.Ib(494,"strong"),r.lc(495,"Delete"),r.Hb(),r.lc(496," a named interval using the "),r.Ib(497,"code"),r.lc(498,"SchedulerRegistry.deleteInterval()"),r.Hb(),r.lc(499," method, as follows:"),r.Hb(),r.Ib(500,"pre"),r.Ib(501,"code",12),r.lc(502,"\ndeleteInterval(name: string) {\n  this.scheduler.deleteInterval(name);\n  this.logger.warn(`Interval ${name} deleted!`);\n}"),r.Hb(),r.Hb(),r.Ib(503,"p"),r.Ib(504,"strong"),r.lc(505,"List"),r.Hb(),r.lc(506," all intervals using the "),r.Ib(507,"code"),r.lc(508,"SchedulerRegistry.getIntervals()"),r.Hb(),r.lc(509," method as follows:"),r.Hb(),r.Ib(510,"pre"),r.Ib(511,"code",12),r.lc(512,"\ngetIntervals() {\n  const intervals = this.scheduler.getIntervals();\n  intervals.forEach(key => this.logger.log(`Interval: ${key}`));\n}"),r.Hb(),r.Hb(),r.Ib(513,"h4",29),r.Ib(514,"span"),r.lc(515,"Dynamic timeouts"),r.Hb(),r.Hb(),r.Ib(516,"p"),r.lc(517,"Obtain a reference to a timeout with the "),r.Ib(518,"code"),r.lc(519,"SchedulerRegistry.getTimeout()"),r.Hb(),r.lc(520," method. As above, inject "),r.Ib(521,"code"),r.lc(522,"SchedulerRegistry"),r.Hb(),r.lc(523," using standard constructor injection:"),r.Hb(),r.Ib(524,"pre"),r.Ib(525,"code",12),r.lc(526,"\nconstructor(private schedulerRegistry: SchedulerRegistry) {}"),r.Hb(),r.Hb(),r.Ib(527,"p"),r.lc(528,"And use it as follows:"),r.Hb(),r.Ib(529,"pre"),r.Ib(530,"code",12),r.lc(531,"\nconst timeout = this.schedulerRegistry.getTimeout('notifications');\nclearTimeout(timeout);"),r.Hb(),r.Hb(),r.Ib(532,"p"),r.Ib(533,"strong"),r.lc(534,"Create"),r.Hb(),r.lc(535," a new timeout dynamically using the "),r.Ib(536,"code"),r.lc(537,"SchedulerRegistry.addTimeout()"),r.Hb(),r.lc(538," method, as follows:"),r.Hb(),r.Ib(539,"pre"),r.Ib(540,"code",12),r.lc(541,"\naddTimeout(name: string, seconds: string) {\n  const callback = () => {\n    this.logger.warn(`Timeout ${name} executing after (${seconds})!`);\n  };\n\n  const timeout = setTimeout(callback, seconds);\n  this.scheduler.addTimeout(name, timeout);\n}"),r.Hb(),r.Hb(),r.Ib(542,"p"),r.lc(543,"In this code, we create a standard JavaScript timeout, then pass it to the "),r.Ib(544,"code"),r.lc(545,"ScheduleRegistry.addTimeout()"),r.Hb(),r.lc(546," method.\nThat method takes two arguments: a name for the timeout, and the timeout itself."),r.Hb(),r.Ib(547,"p"),r.Ib(548,"strong");r.lc(549,"Delete"),r.Hb(),r.lc(550," a named timeout using the "),r.Ib(551,"code"),r.lc(552,"SchedulerRegistry.deleteTimeout()"),r.Hb(),r.lc(553," method, as follows:"),r.Hb(),r.Ib(554,"pre"),r.Ib(555,"code",12),r.lc(556,"\ndeleteTimeout(name: string) {\n  this.scheduler.deleteTimeout(name);\n  this.logger.warn(`Timeout ${name} deleted!`);\n}"),r.Hb(),r.Hb(),r.Ib(557,"p"),r.Ib(558,"strong"),r.lc(559,"List"),r.Hb(),r.lc(560," all timeouts using the "),r.Ib(561,"code"),r.lc(562,"SchedulerRegistry.getTimeouts()"),r.Hb(),r.lc(563," method as follows:"),r.Hb(),r.Ib(564,"pre"),r.Ib(565,"code",12),r.lc(566,"\ngetTimeouts() {\n  const timeouts = this.scheduler.getTimeouts();\n  timeouts.forEach(key => this.logger.log(`Timeout: ${key}`));\n}"),r.Hb(),r.Hb(),r.Ib(567,"h4",30),r.Ib(568,"span"),r.lc(569,"Example"),r.Hb(),r.Hb(),r.Ib(570,"p"),r.lc(571,"A working example is available "),r.Ib(572,"a",31),r.lc(573,"here"),r.Hb(),r.lc(574,"."),r.Hb(),r.Hb()}if(2&e){const e=r.dc(41);r.vb(38),r.nc(" ",r.Vb(39,1,"app.module",e.isJsActive),"\n")}},directives:[l.a,i.a,d.a],pipes:[p.a],encapsulation:2,changeDetection:0}),e})();const _=r.Kb(L);let W=(()=>{class e extends a.a{}return e.\u0275fac=function(t){return D(t||e)},e.\u0275cmp=r.zb({type:e,selectors:[["app-validation"]],features:[r.tb],decls:498,vars:4,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/validation.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","validation"],["rel","nofollow","target","_blank","href","https://github.com/typestack/class-validator"],["appAnchor","","id","overview"],["routerLink","/pipes"],["appAnchor","","id","using-the-built-in-validationpipe"],[1,"info"],[1,"language-typescript"],["appAnchor","","id","auto-validation"],["rel","nofollow","target","_blank","href","https://github.com/typestack/class-validator#validation-decorators"],[1,"language-json"],["appAnchor","","id","disable-detailed-errors"],["appAnchor","","id","stripping-properties"],["appAnchor","","id","transform-payload-objects"],[1,"filename"],["appcf127b70d1078f24561370951f0ca7f7c0aa464c",""],["appAnchor","","id","explicit-conversion"],["appAnchor","","id","parsing-and-validating-arrays"],[1,"language-bash"],["appAnchor","","id","websockets-and-microservices"],["appAnchor","","id","learn-more"]],template:function(e,t){if(1&e&&(r.Ib(0,"div",0,1),r.Ib(2,"div",2),r.Ib(3,"a",3),r.Gb(4,"i",4),r.Hb(),r.Hb(),r.Ib(5,"h3",5),r.lc(6,"Validation"),r.Hb(),r.Ib(7,"p"),r.lc(8,"It is best practice to validate the correctness of any data sent into a web application. To automatically validate incoming requests, Nest provides several pipes available right out-of-the-box:"),r.Hb(),r.Ib(9,"ul"),r.Ib(10,"li"),r.Ib(11,"code"),r.lc(12,"ValidationPipe"),r.Hb(),r.Hb(),r.Ib(13,"li"),r.Ib(14,"code"),r.lc(15,"ParseIntPipe"),r.Hb(),r.Hb(),r.Ib(16,"li"),r.Ib(17,"code"),r.lc(18,"ParseBoolPipe"),r.Hb(),r.Hb(),r.Ib(19,"li"),r.Ib(20,"code"),r.lc(21,"ParseArrayPipe"),r.Hb(),r.Hb(),r.Ib(22,"li"),r.Ib(23,"code"),r.lc(24,"ParseUUIDPipe"),r.Hb(),r.Hb(),r.Hb(),r.Ib(25,"p"),r.lc(26,"The "),r.Ib(27,"code"),r.lc(28,"ValidationPipe"),r.Hb(),r.lc(29," makes use of the powerful "),r.Ib(30,"a",6),r.lc(31,"class-validator"),r.Hb(),r.lc(32," package and its declarative validation decorators. The "),r.Ib(33,"code"),r.lc(34,"ValidationPipe"),r.Hb(),r.lc(35," provides a convenient approach to enforce validation rules for all incoming client payloads, where the specific rules are declared with simple annotations in local class/DTO declarations in each module."),r.Hb(),r.Ib(36,"h4",7),r.Ib(37,"span"),r.lc(38,"Overview"),r.Hb(),r.Hb(),r.Ib(39,"p"),r.lc(40,"In the "),r.Ib(41,"a",8),r.lc(42,"Pipes"),r.Hb(),r.lc(43," chapter, we went through the process of building simple pipes and binding them to controllers, methods or to the global app to demonstrate how the process works. Be sure to review that chapter to best understand the topics of this chapter. Here, we'll focus on various "),r.Ib(44,"strong"),r.lc(45,"real world"),r.Hb(),r.lc(46," use cases of the "),r.Ib(47,"code"),r.lc(48,"ValidationPipe"),r.Hb(),r.lc(49,", and show how to use some of its advanced customization features."),r.Hb(),r.Ib(50,"h4",9),r.Ib(51,"span"),r.lc(52,"Using the built-in ValidationPipe"),r.Hb(),r.Hb(),r.Ib(53,"blockquote",10),r.Ib(54,"strong"),r.lc(55,"Hint"),r.Hb(),r.lc(56," The "),r.Ib(57,"code"),r.lc(58,"ValidationPipe"),r.Hb(),r.lc(59," is imported from the "),r.Ib(60,"code"),r.lc(61,"@nestjs/common"),r.Hb(),r.lc(62," package.\n"),r.Hb(),r.Ib(63,"p"),r.lc(64,"Because this pipe uses the "),r.Ib(65,"code"),r.lc(66,"class-validator"),r.Hb(),r.lc(67," and "),r.Ib(68,"code"),r.lc(69,"class-transformer"),r.Hb(),r.lc(70," libraries, there are many options available. You configure these settings via a configuration object passed to the pipe. Following are the built-in options:"),r.Hb(),r.Ib(71,"pre"),r.Ib(72,"code",11),r.lc(73,"\nexport interface ValidationPipeOptions extends ValidatorOptions {\n  transform?: boolean;\n  disableErrorMessages?: boolean;\n  exceptionFactory?: (errors: ValidationError[]) => any;\n}"),r.Hb(),r.Hb(),r.Ib(74,"p"),r.lc(75,"In addition to these, all "),r.Ib(76,"code"),r.lc(77,"class-validator"),r.Hb(),r.lc(78," options (inherited from the "),r.Ib(79,"code"),r.lc(80,"ValidatorOptions"),r.Hb(),r.lc(81," interface) are available:"),r.Hb(),r.Ib(82,"table"),r.Ib(83,"tr"),r.Ib(84,"th"),r.lc(85,"Option"),r.Hb(),r.Ib(86,"th"),r.lc(87,"Type"),r.Hb(),r.Ib(88,"th"),r.lc(89,"Description"),r.Hb(),r.Hb(),r.Ib(90,"tr"),r.Ib(91,"td"),r.Ib(92,"code"),r.lc(93,"skipMissingProperties"),r.Hb(),r.Hb(),r.Ib(94,"td"),r.Ib(95,"code"),r.lc(96,"boolean"),r.Hb(),r.Hb(),r.Ib(97,"td"),r.lc(98,"If set to true, validator will skip validation of all properties that are missing in the validating object."),r.Hb(),r.Hb(),r.Ib(99,"tr"),r.Ib(100,"td"),r.Ib(101,"code"),r.lc(102,"whitelist"),r.Hb(),r.Hb(),r.Ib(103,"td"),r.Ib(104,"code"),r.lc(105,"boolean"),r.Hb(),r.Hb(),r.Ib(106,"td"),r.lc(107,"If set to true, validator will strip validated (returned) object of any properties that do not use any validation decorators."),r.Hb(),r.Hb(),r.Ib(108,"tr"),r.Ib(109,"td"),r.Ib(110,"code"),r.lc(111,"forbidNonWhitelisted"),r.Hb(),r.Hb(),r.Ib(112,"td"),r.Ib(113,"code"),r.lc(114,"boolean"),r.Hb(),r.Hb(),r.Ib(115,"td"),r.lc(116,"If set to true, instead of stripping non-whitelisted properties validator will throw an exception."),r.Hb(),r.Hb(),r.Ib(117,"tr"),r.Ib(118,"td"),r.Ib(119,"code"),r.lc(120,"forbidUnknownValues"),r.Hb(),r.Hb(),r.Ib(121,"td"),r.Ib(122,"code"),r.lc(123,"boolean"),r.Hb(),r.Hb(),r.Ib(124,"td"),r.lc(125,"If set to true, attempts to validate unknown objects fail immediately."),r.Hb(),r.Hb(),r.Ib(126,"tr"),r.Ib(127,"td"),r.Ib(128,"code"),r.lc(129,"disableErrorMessages"),r.Hb(),r.Hb(),r.Ib(130,"td"),r.Ib(131,"code"),r.lc(132,"boolean"),r.Hb(),r.Hb(),r.Ib(133,"td"),r.lc(134,"If set to true, validation errors will not be returned to the client."),r.Hb(),r.Hb(),r.Ib(135,"tr"),r.Ib(136,"td"),r.Ib(137,"code"),r.lc(138,"errorHttpStatusCode"),r.Hb(),r.Hb(),r.Ib(139,"td"),r.Ib(140,"code"),r.lc(141,"number"),r.Hb(),r.Hb(),r.Ib(142,"td"),r.lc(143,"This setting allows you to specify which exception type will be used in case of an error. By default it throws "),r.Ib(144,"code"),r.lc(145,"BadRequestException"),r.Hb(),r.lc(146,"."),r.Hb(),r.Hb(),r.Ib(147,"tr"),r.Ib(148,"td"),r.Ib(149,"code"),r.lc(150,"exceptionFactory"),r.Hb(),r.Hb(),r.Ib(151,"td"),r.Ib(152,"code"),r.lc(153,"Function"),r.Hb(),r.Hb(),r.Ib(154,"td"),r.lc(155,"Takes an array of the validation errors and returns an exception object to be thrown."),r.Hb(),r.Hb(),r.Ib(156,"tr"),r.Ib(157,"td"),r.Ib(158,"code"),r.lc(159,"groups"),r.Hb(),r.Hb(),r.Ib(160,"td"),r.Ib(161,"code"),r.lc(162,"string[]"),r.Hb(),r.Hb(),r.Ib(163,"td"),r.lc(164,"Groups to be used during validation of the object."),r.Hb(),r.Hb(),r.Ib(165,"tr"),r.Ib(166,"td"),r.Ib(167,"code"),r.lc(168,"dismissDefaultMessages"),r.Hb(),r.Hb(),r.Ib(169,"td"),r.Ib(170,"code"),r.lc(171,"boolean"),r.Hb(),r.Hb(),r.Ib(172,"td"),r.lc(173,"If set to true, the validation will not use default messages. Error message always will be "),r.Ib(174,"code"),r.lc(175,"undefined"),r.Hb(),r.lc(176," if its not explicitly set."),r.Hb(),r.Hb(),r.Ib(177,"tr"),r.Ib(178,"td"),r.Ib(179,"code"),r.lc(180,"validationError.target"),r.Hb(),r.Hb(),r.Ib(181,"td"),r.Ib(182,"code"),r.lc(183,"boolean"),r.Hb(),r.Hb(),r.Ib(184,"td"),r.lc(185,"Indicates if target should be exposed in "),r.Ib(186,"code"),r.lc(187,"ValidationError"),r.Hb(),r.Hb(),r.Hb(),r.Ib(188,"tr"),r.Ib(189,"td"),r.Ib(190,"code"),r.lc(191,"validationError.value"),r.Hb(),r.Hb(),r.Ib(192,"td"),r.Ib(193,"code"),r.lc(194,"boolean"),r.Hb(),r.Hb(),r.Ib(195,"td"),r.lc(196,"Indicates if validated value should be exposed in "),r.Ib(197,"code"),r.lc(198,"ValidationError"),r.Hb(),r.lc(199,"."),r.Hb(),r.Hb(),r.Hb(),r.Ib(200,"blockquote",10),r.Ib(201,"strong"),r.lc(202,"Notice"),r.Hb(),r.lc(203," Find more information about the "),r.Ib(204,"code"),r.lc(205,"class-validator"),r.Hb(),r.lc(206," package in its "),r.Ib(207,"a",6),r.lc(208,"repository"),r.Hb(),r.lc(209,".\n"),r.Hb(),r.Ib(210,"h4",12),r.Ib(211,"span"),r.lc(212,"Auto-validation"),r.Hb(),r.Hb(),r.Ib(213,"p"),r.lc(214,"We'll start by binding "),r.Ib(215,"code"),r.lc(216,"ValidationPipe"),r.Hb(),r.lc(217," at the application level, thus ensuring all endpoints are protected from receiving incorrect data."),r.Hb(),r.Ib(218,"pre"),r.Ib(219,"code",11),r.lc(220,"\nasync function bootstrap() {\n  const app = await NestFactory.create(ApplicationModule);\n  app.useGlobalPipes(new ValidationPipe());\n  await app.listen(3000);\n}\nbootstrap();"),r.Hb(),r.Hb(),r.Ib(221,"p"),r.lc(222,"To test our pipe, let's create a basic endpoint."),r.Hb(),r.Ib(223,"pre"),r.Ib(224,"code",11),r.lc(225,"\n@Post()\ncreate(@Body() createUserDto: CreateUserDto) {\n  return 'This action adds a new user';\n}"),r.Hb(),r.Hb(),r.Ib(226,"blockquote",10),r.Ib(227,"strong"),r.lc(228,"Hint"),r.Hb(),r.lc(229," Since TypeScript does not store metadata about "),r.Ib(230,"strong"),r.lc(231,"generics or interfaces"),r.Hb(),r.lc(232,", when you use them in your DTOs, "),r.Ib(233,"code"),r.lc(234,"ValidationPipe"),r.Hb(),r.lc(235," may not be able to properly validate incoming data. For this reason, consider using concrete classes in your DTOs.\n"),r.Hb(),r.Ib(236,"p"),r.lc(237,"Now we can add a few validation rules in our "),r.Ib(238,"code"),r.lc(239,"CreateUserDto"),r.Hb(),r.lc(240,". We do this using decorators provided by the "),r.Ib(241,"code"),r.lc(242,"class-validator"),r.Hb(),r.lc(243," package, described in detail "),r.Ib(244,"a",13),r.lc(245,"here"),r.Hb(),r.lc(246,". In this fashion, any route that uses the "),r.Ib(247,"code"),r.lc(248,"CreateUserDto"),r.Hb(),r.lc(249," will automatically enforce these validation rules."),r.Hb(),r.Ib(250,"pre"),r.Ib(251,"code",11),r.lc(252,"\nimport { IsEmail, IsNotEmpty } from 'class-validator';\n\nexport class CreateUserDto {\n  @IsEmail()\n  email: string;\n\n  @IsNotEmpty()\n  password: string;\n}"),r.Hb(),r.Hb(),r.Ib(253,"p"),r.lc(254,"With these rules in place, if a request hits our endpoint with an invalid "),r.Ib(255,"code"),r.lc(256,"email"),r.Hb(),r.lc(257," property in the request body, the application will automatically respond with a "),r.Ib(258,"code"),r.lc(259,"400 Bad Request"),r.Hb(),r.lc(260," code, along with the following response body:"),r.Hb(),r.Ib(261,"pre"),r.Ib(262,"code",14),r.lc(263,'\n{\n  "statusCode": 400,\n  "error": "Bad Request",\n  "message": ["email must be an email"]\n}'),r.Hb(),r.Hb(),r.Ib(264,"p"),r.lc(265,"In addition to validating request bodies, the "),r.Ib(266,"code"),r.lc(267,"ValidationPipe"),r.Hb(),r.lc(268," can be used with other request object properties as well. Imagine that we would like to accept "),r.Ib(269,"code"),r.lc(270,":id"),r.Hb(),r.lc(271," in the endpoint path. To ensure that only numbers are accepted for this request parameter, we can use the following construct:"),r.Hb(),r.Ib(272,"pre"),r.Ib(273,"code",11),r.lc(274,"\n@Get(':id')\nfindOne(@Param() params: FindOneParams) {\n  return 'This action returns a user';\n}"),r.Hb(),r.Hb(),r.Ib(275,"p"),r.Ib(276,"code"),r.lc(277,"FindOneParams"),r.Hb(),r.lc(278,", like a DTO, is simply a class that defines validation rules using "),r.Ib(279,"code"),r.lc(280,"class-validator"),r.Hb(),r.lc(281,". It would look like this:"),r.Hb(),r.Ib(282,"pre"),r.Ib(283,"code",11),r.lc(284,"\nimport { IsNumberString } from 'class-validator';\n\nexport class FindOneParams {\n  @IsNumberString()\n  id: number;\n}"),r.Hb(),r.Hb(),r.Ib(285,"h4",15),r.Ib(286,"span"),r.lc(287,"Disable detailed errors"),r.Hb(),r.Hb(),r.Ib(288,"p"),r.lc(289,"Error messages can be helpful to explain what was incorrect in a request. However, some production environments prefer to disable detailed errors. Do this by passing an options object to the "),r.Ib(290,"code"),r.lc(291,"ValidationPipe"),r.Hb(),r.lc(292,":"),r.Hb(),r.Ib(293,"pre"),r.Ib(294,"code",11),r.lc(295,"\napp.useGlobalPipes(\n  new ValidationPipe({\n    disableErrorMessages: true,\n  }),\n);"),r.Hb(),r.Hb(),r.Ib(296,"p"),r.lc(297,"As a result, detailed error messages won't be displayed in the response body."),r.Hb(),r.Ib(298,"h4",16),r.Ib(299,"span"),r.lc(300,"Stripping properties"),r.Hb(),r.Hb(),r.Ib(301,"p"),r.lc(302,"Our "),r.Ib(303,"code"),r.lc(304,"ValidationPipe"),r.Hb(),r.lc(305," can also filter out properties that should not be received by the method handler. In this case, we can "),r.Ib(306,"strong"),r.lc(307,"whitelist"),r.Hb(),r.lc(308," the acceptable properties, and any property not included in the whitelist is automatically stripped from the resulting object. For example, if our handler expects "),r.Ib(309,"code"),r.lc(310,"email"),r.Hb(),r.lc(311," and "),r.Ib(312,"code"),r.lc(313,"password"),r.Hb(),r.lc(314," properties, but a request also includes an "),r.Ib(315,"code"),r.lc(316,"age"),r.Hb(),r.lc(317," property, this property can be automatically removed from the resulting DTO. To enable such behavior, set "),r.Ib(318,"code"),r.lc(319,"whitelist"),r.Hb(),r.lc(320," to "),r.Ib(321,"code"),r.lc(322,"true"),r.Hb(),r.lc(323,"."),r.Hb(),r.Ib(324,"pre"),r.Ib(325,"code",11),r.lc(326,"\napp.useGlobalPipes(\n  new ValidationPipe({\n    whitelist: true,\n  }),\n);"),r.Hb(),r.Hb(),r.Ib(327,"p"),r.lc(328,"When set to true, this will automatically remove non-whitelisted properties (those without any decorator in the validation class)."),r.Hb(),r.Ib(329,"p"),r.lc(330,"Alternatively, you can stop the request from processing when non-whitelisted properties are present, and return an error response to the user. To enable this, set the "),r.Ib(331,"code"),r.lc(332,"forbidNonWhitelisted"),r.Hb(),r.lc(333," option property to "),r.Ib(334,"code"),r.lc(335,"true"),r.Hb(),r.lc(336,", in combination with setting "),r.Ib(337,"code"),r.lc(338,"whitelist"),r.Hb(),r.lc(339," to "),r.Ib(340,"code"),r.lc(341,"true"),r.Hb(),r.lc(342,"."),r.Hb(),r.Ib(343,"p"),r.Gb(344,"app-banner-courses"),r.Hb(),r.Ib(345,"h4",17),r.Ib(346,"span"),r.lc(347,"Transform payload objects"),r.Hb(),r.Hb(),r.Ib(348,"p"),r.lc(349,"Payloads coming in over the network are plain JavaScript objects. The "),r.Ib(350,"code"),r.lc(351,"ValidationPipe"),r.Hb(),r.lc(352," can automatically transform payloads to be objects typed according to their DTO classes. To enable auto-transformation, set "),r.Ib(353,"code"),r.lc(354,"transform"),r.Hb(),r.lc(355," to "),r.Ib(356,"code"),r.lc(357,"true"),r.Hb(),r.lc(358,". This can be done at a method level:"),r.Hb(),r.Ib(359,"span",18),r.lc(360),r.Ub(361,"extension"),r.Gb(362,"app-tabs",null,19),r.Hb(),r.Ib(364,"pre"),r.Ib(365,"code",11),r.lc(366,"\n@Post()\n@UsePipes(new ValidationPipe({ transform: true }))\nasync create(@Body() createCatDto: CreateCatDto) {\n  this.catsService.create(createCatDto);\n}"),r.Hb(),r.Hb(),r.Ib(367,"p"),r.lc(368,"To enable this behavior globally, set the option on a global pipe:"),r.Hb(),r.Ib(369,"pre"),r.Ib(370,"code",11),r.lc(371,"\napp.useGlobalPipes(\n  new ValidationPipe({\n    transform: true,\n  }),\n);"),r.Hb(),r.Hb(),r.Ib(372,"p"),r.lc(373,"With the auto-transformation option enabled, the "),r.Ib(374,"code"),r.lc(375,"ValidationPipe"),r.Hb(),r.lc(376," will also perform conversion of primitive types. In the following example, the "),r.Ib(377,"code"),r.lc(378,"findOne()"),r.Hb(),r.lc(379," method takes one argument which represents an extracted "),r.Ib(380,"code"),r.lc(381,"id"),r.Hb(),r.lc(382," path parameter:"),r.Hb(),r.Ib(383,"pre"),r.Ib(384,"code",11),r.lc(385,"\n@Get(':id')\nfindOne(@Param('id') id: number) {\n  console.log(typeof id === 'number'); // true\n  return 'This action returns a user';\n}"),r.Hb(),r.Hb(),r.Ib(386,"p"),r.lc(387,"By default, every path parameter and query parameter comes over the network as a "),r.Ib(388,"code"),r.lc(389,"string"),r.Hb(),r.lc(390,". In the above example, we specified the "),r.Ib(391,"code"),r.lc(392,"id"),r.Hb(),r.lc(393," type as a "),r.Ib(394,"code"),r.lc(395,"number"),r.Hb(),r.lc(396," (in the method signature). Therefore, the "),r.Ib(397,"code"),r.lc(398,"ValidationPipe"),r.Hb(),r.lc(399," will try to automatically convert a string identifier to a number."),r.Hb(),r.Ib(400,"h4",20),r.Ib(401,"span"),r.lc(402,"Explicit conversion"),r.Hb(),r.Hb(),r.Ib(403,"p"),r.lc(404,"In the above section, we showed how the "),r.Ib(405,"code"),r.lc(406,"ValidationPipe"),r.Hb(),r.lc(407," can implicitly transform query and path parameters based on the expected type. However, this feature requires having auto-transformation enabled."),r.Hb(),r.Ib(408,"p"),r.lc(409,"Alternatively (with auto-transformation disabled), you can explicitly cast values using the "),r.Ib(410,"code"),r.lc(411,"ParseIntPipe"),r.Hb(),r.lc(412," or "),r.Ib(413,"code"),r.lc(414,"ParseBoolPipe"),r.Hb(),r.lc(415," (note that "),r.Ib(416,"code"),r.lc(417,"ParseStringPipe"),r.Hb(),r.lc(418," is not needed because, as mentioned earlier, every path parameter and query parameter comes over the network as a "),r.Ib(419,"code"),r.lc(420,"string"),r.Hb(),r.lc(421," by default)."),r.Hb(),r.Ib(422,"pre"),r.Ib(423,"code",11),r.lc(424,"\n@Get(':id')\nfindOne(\n  @Param('id', ParseIntPipe) id: number,\n  @Query('sort', ParseBoolPipe) sort: boolean,\n) {\n  console.log(typeof id === 'number'); // true\n  console.log(typeof sort === 'boolean'); // true\n  return 'This action returns a user';\n}"),r.Hb(),r.Hb(),r.Ib(425,"blockquote",10),r.Ib(426,"strong"),r.lc(427,"Hint"),r.Hb(),r.lc(428," The "),r.Ib(429,"code"),r.lc(430,"ParseIntPipe"),r.Hb(),r.lc(431," and "),r.Ib(432,"code"),r.lc(433,"ParseBoolPipe"),r.Hb(),r.lc(434," are exported from the "),r.Ib(435,"code"),r.lc(436,"@nestjs/common"),r.Hb(),r.lc(437," package.\n"),r.Hb(),r.Ib(438,"h4",21),r.Ib(439,"span"),r.lc(440,"Parsing and validating arrays"),r.Hb(),r.Hb(),r.Ib(441,"p"),r.lc(442,"TypeScript does not store metadata about generics or interfaces, so when you use them in your DTOs, "),r.Ib(443,"code"),r.lc(444,"ValidationPipe"),r.Hb(),r.lc(445," may not be able to properly validate incoming data. For instance, in the following code, "),r.Ib(446,"code"),r.lc(447,"createUserDtos"),r.Hb(),r.lc(448," won't be correctly validated:"),r.Hb(),r.Ib(449,"pre"),r.Ib(450,"code",11),r.lc(451,"\n@Post()\ncreateBulk(@Body() createUserDtos: CreateUserDto[]) {\n  return 'This action adds new users';\n}"),r.Hb(),r.Hb(),r.Ib(452,"p"),r.lc(453,"To validate the array, create a dedicated class which contains a property that wraps the array, or use the "),r.Ib(454,"code"),r.lc(455,"ParseArrayPipe"),r.Hb(),r.lc(456,"."),r.Hb(),r.Ib(457,"pre"),r.Ib(458,"code",11),r.lc(459,"\n@Post()\ncreateBulk(\n  @Body(new ParseArrayPipe({ items: CreateUserDto }))\n  createUserDtos: CreateUserDto[],\n) {\n  return 'This action adds new users';\n}"),r.Hb(),r.Hb(),r.Ib(460,"p"),r.lc(461,"In addition, the "),r.Ib(462,"code"),r.lc(463,"ParseArrayPipe"),r.Hb(),r.lc(464," may come in handy when parsing query parameters. Let's consider a "),r.Ib(465,"code"),r.lc(466,"findByIds()"),r.Hb(),r.lc(467," method that returns users based on identifiers passed as query parameters."),r.Hb(),r.Ib(468,"pre"),r.Ib(469,"code",11),r.lc(470,"\n@Get()\nfindByIds(\n  @Query('id', new ParseArrayPipe({ items: Number, separator: ',' }))\n  ids: number[],\n) {\n  return 'This action returns users by ids';\n}"),r.Hb(),r.Hb(),r.Ib(471,"p"),r.lc(472,"This construction validates the incoming query parameters from an HTTP "),r.Ib(473,"code"),r.lc(474,"GET"),r.Hb(),r.lc(475," request like the following:"),r.Hb(),r.Ib(476,"pre"),r.Ib(477,"code",22),r.lc(478,"\nGET /?ids=1,2,3"),r.Hb(),r.Hb(),r.Ib(479,"h4",23),r.Ib(480,"span"),r.lc(481,"WebSockets and Microservices"),r.Hb(),r.Hb(),r.Ib(482,"p"),r.lc(483,"While this chapter shows examples using HTTP style applications (e.g., Express or Fastify), the "),r.Ib(484,"code"),r.lc(485,"ValidationPipe"),r.Hb(),r.lc(486," works the same for WebSockets and microservices, regardless of the transport method that is used."),r.Hb(),r.Ib(487,"h4",24),r.Ib(488,"span"),r.lc(489,"Learn more"),r.Hb(),r.Hb(),r.Ib(490,"p"),r.lc(491,"Read more about custom validators, error messages, and available decorators as provided by the "),r.Ib(492,"code"),r.lc(493,"class-validator"),r.Hb(),r.lc(494," package "),r.Ib(495,"a",6),r.lc(496,"here"),r.Hb(),r.lc(497,"."),r.Hb(),r.Hb()),2&e){const e=r.dc(363);r.vb(360),r.nc(" ",r.Vb(361,1,"cats.controller",e.isJsActive),"\n")}},directives:[l.a,s.f,b.a,i.a],pipes:[p.a],encapsulation:2,changeDetection:0}),e})();const D=r.Kb(W),B=[{path:"authentication",component:u,data:{title:"Authentication"}},{path:"mvc",component:C,data:{title:"MVC"}},{path:"serialization",component:F,data:{title:"Serialization"}},{path:"caching",component:m,data:{title:"Caching"}},{path:"validation",component:W,data:{title:"Validation"}},{path:"sql",redirectTo:"database"},{path:"database",component:G,data:{title:"Database"}},{path:"mongodb",component:S,data:{title:"MongoDB"}},{path:"file-upload",component:w,data:{title:"File upload"}},{path:"logger",component:k,data:{title:"Logger"}},{path:"performance",component:U,data:{title:"Performance (Fastify)"}},{path:"http-module",component:A,data:{title:"HTTP module"}},{path:"configuration",component:y,data:{title:"Configuration"}},{path:"security",component:E,data:{title:"Security"}},{path:"task-scheduling",component:L,data:{title:"Task Scheduling"}},{path:"compression",component:H,data:{title:"Compression"}},{path:"queues",component:O,data:{title:"Queues"}},{path:"hot-reload",redirectTo:"/recipes/hot-reload"}];let V=(()=>{class e{}return e.\u0275mod=r.Db({type:e}),e.\u0275inj=r.Cb({factory:function(t){return new(t||e)},imports:[[n.b,c.a,s.g.forChild(B)]]}),e})()}}]);